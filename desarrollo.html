<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convertidor Drive ‚Üí JSON (solo destino)</title>
<style>
  body{font-family:system-ui,Arial;background:#0f2027;color:#f5f5f5;margin:0;min-height:100vh;display:grid;place-items:center}
  .card{background:#000b;border:1px solid #222;padding:22px;border-radius:14px;width:min(92vw,760px);box-shadow:0 10px 30px #0008}
  h1{margin:0 0 12px;color:#ffcc70;font-size:20px}
  label{font-size:13px;opacity:.9}
  input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:none;background:#111;color:#fff;font-size:14px}
  textarea{height:90px;resize:none}
  .row{display:grid;gap:10px;margin:8px 0}
  .btns{display:flex;flex-wrap:wrap;gap:8px}
  button{border:none;border-radius:10px;background:#ffcc70;color:#222;padding:9px 14px;cursor:pointer}
  .chips{display:flex;gap:10px}
  .chip{display:inline-flex;align-items:center;gap:8px;background:#111;border:2px solid transparent;border-radius:999px;padding:7px 12px;cursor:pointer}
  .dot{width:12px;height:12px;border-radius:999px}
  .chip[data-cat="discografia"] .dot{background:#18a558}
  .chip[data-cat="movie"] .dot{background:#d9534f}
  .chip[data-cat="news"] .dot{background:#3b82f6}
  .chip.active[data-cat="discografia"]{border-color:#18a558}
  .chip.active[data-cat="movie"]{border-color:#d9534f}
  .chip.active[data-cat="news"]{border-color:#3b82f6}
  .preview img{max-width:100%;border-radius:10px;border:2px solid #333}
  small{opacity:.8}
</style>
</head>
<body>
<div class="card">
  <h1>üîó Drive ‚Üí URL de imagen ‚Üí JSON (destino)</h1>

  <div class="row">
    <label>Link (o ID) de Google Drive</label>
    <input id="inLink" placeholder="https://drive.google.com/file/d/ID/view... o solo el ID">
    <div class="btns">
      <button id="btnConv">Convertir</button>
      <button id="btnCopyUrl">Copiar URL</button>
    </div>
  </div>

  <div class="row">
    <label>URL directa (resultado)</label>
    <textarea id="outUrl" readonly></textarea>
    <div class="preview" id="preview"></div>
  </div>

  <div class="row">
    <label>Selecciona DESTINO (ad√≥nde navegar√° la tarjeta)</label>
    <div class="chips" id="chips">
      <div class="chip" data-cat="discografia"><span class="dot"></span>Discograf√≠a</div>
      <div class="chip" data-cat="movie"><span class="dot"></span>Movie</div>
      <div class="chip" data-cat="news"><span class="dot"></span>News</div>
    </div>
    <small>Se guarda como <code>"destino": "discografia|movie|news"</code>. Tu web lo mapea con <code>SECTION_MAP</code>.</small>
  </div>

  <div class="row" style="grid-template-columns:1fr 140px;gap:10px">
    <div>
      <label>T√≠tulo (opcional)</label>
      <input id="inTitulo" placeholder="Ej: nueva cancion">
    </div>
    <div>
      <label>Clave (n1, n2...)</label>
      <input id="inClave" value="n1">
    </div>
  </div>

  <div class="row">
    <div class="btns">
      <button id="btnGen">Generar JSON</button>
      <button id="btnCopy">Copiar (sin coma)</button>
      <button id="btnCopyComma">Copiar (con coma)</button>
    </div>
    <label>Fragmento para pegar dentro de <code>"news": { ... }</code></label>
    <textarea id="outJson" readonly></textarea>
  </div>

  <small>Atajo mental: **imagen** (la URL convertida) + **destino** (apodo). Fin. No necesitas ‚Äúcon link‚Äù.</small>
</div>

<script>
  // --- Helpers ---
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // ID de Drive ultrarobusto
  function getDriveId(raw){
    if(!raw) return null;
    const s = raw.trim();
    const solo = s.match(/^[A-Za-z0-9_-]{25,}$/); if(solo) return solo[0];
    try{
      const u = new URL(s);
      const m1 = u.pathname.match(/\/file\/d\/([A-Za-z0-9_-]{10,})/); if(m1) return m1[1];
      const m2 = u.pathname.match(/\/d\/([A-Za-z0-9_-]{10,})/); if(m2) return m2[1];
      const q  = u.searchParams.get('id'); if(q && /^[A-Za-z0-9_-]{10,}$/.test(q)) return q;
    }catch{}
    const any = s.match(/[-\w]{25,}/); return any ? any[0] : null;
  }
  function candidates(id){
    return [
      `https://lh3.googleusercontent.com/d/${id}`,
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/thumbnail?id=${id}`,
      `https://drive.google.com/uc?export=download&id=${id}`
    ];
  }
  function tryLoad(urls, ok){
    if(!urls.length) return ok(null);
    const u = urls[0]; const img = new Image();
    img.onload = ()=>ok(u);
    img.onerror = ()=>tryLoad(urls.slice(1), ok);
    img.src = u + (u.includes('?')?'&':'?')+'cb='+Date.now();
  }
  function copy(el){ el.select(); document.execCommand('copy'); }

  // --- UI chips destino ---
  let destino = localStorage.getItem('tenshi_dest') || 'discografia';
  function renderChips(){
    $$('#chips .chip').forEach(c=>{
      c.classList.toggle('active', c.dataset.cat===destino);
      c.onclick = ()=>{destino=c.dataset.cat; localStorage.setItem('tenshi_dest',destino); renderChips();}
    });
  }
  renderChips();

  // --- Convertir ---
  $('#btnConv').onclick = ()=>{
    $('#preview').innerHTML = ''; $('#outUrl').value = '';
    const id = getDriveId($('#inLink').value);
    if(!id){ alert('‚ùå Link/ID de Drive no v√°lido'); return; }
    tryLoad(candidates(id), url=>{
      if(!url){ alert('No se pudo previsualizar (¬øno es imagen?).'); $('#outUrl').value = candidates(id)[0]; return; }
      $('#outUrl').value = url;
      $('#preview').innerHTML = `<div style="margin-top:8px"><img src="${url}" alt="preview"></div>`;
    });
  };
  $('#btnCopyUrl').onclick = ()=>copy($('#outUrl'));

  // --- Generar JSON (solo destino) ---
  function buildJson(addComma=false){
    const imagen = $('#outUrl').value.trim();
    if(!imagen){ alert('Convierte primero el link para obtener la URL.'); return; }
    const clave  = ($('#inClave').value.trim()||'n1');
    const titulo = $('#inTitulo').value.trim();
    const obj = { imagen, destino };
    if(titulo) obj.titulo = titulo;
    const frag = `"${clave}": ${JSON.stringify(obj, null, 2)}${addComma?',':''}`;
    $('#outJson').value = frag;
    return frag;
  }
  $('#btnGen').onclick = ()=>buildJson(false);
  $('#btnCopy').onclick = ()=>{ if(buildJson(false)) copy($('#outJson')); };
  $('#btnCopyComma').onclick = ()=>{ if(buildJson(true))  copy($('#outJson')); };
</script>
</body>
</html>
