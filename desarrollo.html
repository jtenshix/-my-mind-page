<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Drive → Imagen → JSON (mapita N1–N5 con preview en el tile)</title>
<style>
  :root{
    --bg:#0f2027; --panel:#000b; --ink:#f5f5f5; --muted:#b7c1c7; --acc:#ffcc70;
    --disc:#18a558; --mov:#d9534f; --news:#3b82f6; --card:#111; --bd:#222;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial,sans-serif;}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid #222;border-radius:14px;box-shadow:0 10px 30px #0008;padding:18px}
  h1{margin:0 0 12px; font-size:20px; color:var(--acc)}
  h2{margin:0 0 10px; font-size:16px; color:var(--muted)}
  label{font-size:13px; opacity:.95}
  input,textarea{width:100%; padding:10px 12px; border-radius:10px; border:none; background:var(--card); color:var(--ink); font-size:14px;}
  textarea{height:86px; resize:none}
  .btn{border:none;border-radius:10px;background:var(--acc);color:#222;padding:9px 14px;cursor:pointer}
  .row{display:grid;gap:10px;margin:10px 0}
  .btns{display:flex;flex-wrap:wrap;gap:8px}

  /* layout 2 columnas */
  .grid2{display:grid; grid-template-columns: 1.25fr .95fr; gap:16px;}
  @media (max-width:900px){ .grid2{grid-template-columns: 1fr} }

  /* chips */
  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--card);border:2px solid transparent;border-radius:999px;padding:7px 12px;cursor:pointer;user-select:none}
  .dot{width:12px;height:12px;border-radius:999px}
  .chip[data-cat="discografia"] .dot{background:var(--disc)}
  .chip[data-cat="movie"] .dot{background:var(--mov)}
  .chip[data-cat="news"] .dot{background:var(--news)}
  .chip.active[data-cat="discografia"]{border-color:var(--disc)}
  .chip.active[data-cat="movie"]{border-color:var(--mov)}
  .chip.active[data-cat="news"]{border-color:var(--news)}
  /* chips de N */
  .chipN{background:var(--card); border:2px solid #23303a; color:#dfe6eb}
  .chipN.active{border-color:#4fb3ff; box-shadow:0 0 0 2px #4fb3ff22 inset}

  /* panel derecho */
  .right{background:#0b1116; border:1px solid var(--bd); border-radius:12px; padding:12px}

  /* Mapita N1–N5 (mini NEWS layout) */
  .mini-news{
    display:grid;
    grid-template-columns: 2fr 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap:10px;
    height:260px;
  }
  .mini-news .tile{
    position:relative; border-radius:12px; background:#161b20; border:1px solid #2a2f33;
    display:flex; align-items:center; justify-content:center; color:#dfe6eb; font-weight:600;
    overflow:hidden;
    background-size:cover;          /* para preview como fondo */
    background-position:center;     /* centrado */
    background-repeat:no-repeat;
  }
  .mini-news .tile.big{ grid-column:1/2; grid-row:1/3; }
  .tile.has-bg::after{              /* overlay para legibilidad sobre la imagen */
    content:""; position:absolute; inset:0; background:linear-gradient(180deg,#00000033, #00000066);
  }
  .badge{
    position:absolute; top:8px; left:8px; z-index:1;
    font-size:12px; background:#0008; padding:3px 8px; border-radius:999px; border:1px solid #fff2;
  }
  .lbl{
    position:absolute; bottom:8px; right:8px; z-index:1;
    font-size:11px; background:#0008; padding:3px 8px; border-radius:999px; border:1px solid #fff2;
  }
  .lbl.muted{opacity:.55}

  /* colores del N seleccionado (solo currentN se pinta) */
  .tile.sel-discografia{ box-shadow:inset 0 0 0 2px color-mix(in hsl, var(--disc) 70%, white); }
  .tile.sel-movie{        box-shadow:inset 0 0 0 2px color-mix(in hsl, var(--mov) 70%, white); }
  .tile.sel-news{         box-shadow:inset 0 0 0 2px color-mix(in hsl, var(--news) 70%, white); }

  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .legend .leg{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0c1319;border:1px solid #20303b;font-size:12px}
  .leg .dot{width:10px;height:10px}
  .map-note{font-size:12px;color:#9fb0bb;margin-top:6px}
  code{background:#0b0f12;padding:2px 6px;border-radius:6px;border:1px solid #1f252b}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card grid2">
      <!-- Columna izquierda -->
      <div>
        <h1>🔗 Drive → URL de imagen → JSON (auto-coma por N)</h1>

        <div class="row">
          <label>Link (o ID) de Google Drive</label>
          <input id="inLink" placeholder="https://drive.google.com/file/d/ID/view... o solo el ID">
          <div class="btns">
            <button class="btn" id="btnConv">Convertir</button>
            <button class="btn" id="btnCopyUrl">Copiar URL</button>
          </div>
        </div>

        <div class="row">
          <label>URL directa (resultado)</label>
          <textarea id="outUrl" readonly></textarea>
        </div>

        <div class="row">
          <label>Selecciona DESTINO</label>
          <div class="chips" id="chipsDest">
            <div class="chip" data-cat="discografia"><span class="dot"></span>Discografía</div>
            <div class="chip" data-cat="movie"><span class="dot"></span>Movie</div>
            <div class="chip" data-cat="news"><span class="dot"></span>News</div>
          </div>
          <small>Se guarda como <code>"destino": "discografia|movie|news"</code>. Tu web lo mapea con <code>SECTION_MAP</code>.</small>
        </div>

        <div class="row">
          <label>Selecciona CLAVE (N1–N5)</label>
          <div class="chips" id="chipsN">
            <div class="chip chipN" data-n="n1">N1</div>
            <div class="chip chipN" data-n="n2">N2</div>
            <div class="chip chipN" data-n="n3">N3</div>
            <div class="chip chipN" data-n="n4">N4</div>
            <div class="chip chipN" data-n="n5">N5</div>
          </div>
        </div>

        <div class="row">
          <label>Título (opcional)</label>
          <input id="inTitulo" placeholder="Ej: nueva noticia">
        </div>

        <div class="row">
          <div class="btns">
            <button class="btn" id="btnGen">Generar & Copiar</button>
          </div>
          <label>Fragmento para pegar dentro de <code>"news": { ... }</code></label>
          <textarea id="outJson" readonly></textarea>
        </div>
      </div>

      <!-- Columna derecha: visual -->
      <div class="right">
        <h2>Vista rápida & Mapita N1–N5</h2>
        <div class="mini-news" id="miniNews">
          <div class="tile big" data-k="n1"><span class="badge">N1</span><span class="lbl"></span></div>
          <div class="tile" data-k="n2"><span class="badge">N2</span><span class="lbl"></span></div>
          <div class="tile" data-k="n3"><span class="badge">N3</span><span class="lbl"></span></div>
          <div class="tile" data-k="n4"><span class="badge">N4</span><span class="lbl"></span></div>
          <div class="tile" data-k="n5"><span class="badge">N5</span><span class="lbl"></span></div>
        </div>

        <div class="legend">
          <div class="leg"><span class="dot" style="background:var(--disc)"></span>Discografía</div>
          <div class="leg"><span class="dot" style="background:var(--mov)"></span>Movie</div>
          <div class="leg"><span class="dot" style="background:var(--news)"></span>News</div>
        </div>
        <div class="map-note">El color y la imagen solo marcan el **N seleccionado**. Al generar, se guarda el destino para ese N. N5 se copia sin coma automáticamente.</div>

        <h2 style="margin-top:14px">Alias válidos → URL en tu web</h2>
        <pre style="background:#0b1116;border:1px solid #20303b;border-radius:10px;padding:10px;overflow:auto">
discografia  →  Discography.html
movie        →  movie.html
news         →  https://jtenshix.github.io/J-tenshi-music/news.html
        </pre>
      </div>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  function copy(el){ el.select(); document.execCommand('copy'); }

  // === Obtener ID de Drive (robusto)
  function getDriveId(raw){
    if(!raw) return null;
    const s = raw.trim();
    const solo = s.match(/^[A-Za-z0-9_-]{25,}$/); if(solo) return solo[0];
    try{
      const u = new URL(s);
      const m1 = u.pathname.match(/\/file\/d\/([A-Za-z0-9_-]{10,})/); if(m1) return m1[1];
      const m2 = u.pathname.match(/\/d\/([A-Za-z0-9_-]{10,})/); if(m2) return m2[1];
      const q  = u.searchParams.get('id'); if(q && /^[A-Za-z0-9_-]{10,}$/.test(q)) return q;
    }catch{}
    const any = s.match(/[-\w]{25,}/); return any ? any[0] : null;
  }
  function candidates(id){
    return [
      `https://lh3.googleusercontent.com/d/${id}`,
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/thumbnail?id=${id}`,
      `https://drive.google.com/uc?export=download&id=${id}`
    ];
  }
  function tryLoad(urls, ok){
    if(!urls.length) return ok(null);
    const u = urls[0]; const img = new Image();
    img.onload = ()=>ok(u);
    img.onerror = ()=>tryLoad(urls.slice(1), ok);
    img.src = u + (u.includes('?')?'&':'?')+'cb='+Date.now();
  }

  // === Estado ===
  const saved = { n1:null, n2:null, n3:null, n4:null, n5:null }; // lo “guardado” al generar (destino por N)
  let destinoSel = localStorage.getItem('tenshi_dest') || 'discografia';
  let currentN = 'n1';                // N seleccionado
  let currentPreviewUrl = '';         // URL temporal para mostrar en el tile actual

  // Chips DESTINO
  function renderDestChips(){
    $$('#chipsDest .chip').forEach(c=>{
      c.classList.toggle('active', c.dataset.cat===destinoSel);
      c.onclick = ()=>{ destinoSel=c.dataset.cat; localStorage.setItem('tenshi_dest',destinoSel); renderDestChips(); paintMap(); };
    });
  }
  renderDestChips();

  // Chips N
  function renderNChips(){
    $$('#chipsN .chipN').forEach(c=>{
      c.classList.toggle('active', c.dataset.n===currentN);
      c.onclick = ()=>{ currentN=c.dataset.n; renderNChips(); paintMap(); };
    });
  }
  renderNChips();

  // Pintar mapita:
  // - Solo el N seleccionado se colorea (según destinoSel)
  // - Muestra el destino guardado para cada N como etiqueta gris
  // - Si hay currentPreviewUrl, la pone de fondo en el N seleccionado
  function paintMap() {
    $$('.mini-news .tile').forEach(tile => {
      const k = tile.dataset.k;                 // n1..n5
      const isBig = tile.classList.contains('big');
      const isCurrent = (k === currentN);

      // reset base
      tile.className = 'tile' + (isBig ? ' big' : '');
      tile.style.backgroundImage = 'none';

      // preview temporal solo en el N actual
      if (isCurrent && currentPreviewUrl) {
        tile.style.backgroundImage = `url('${currentPreviewUrl}')`;
        tile.classList.add('has-bg');
      } else {
        tile.classList.remove('has-bg');
      }

      // color solo para el N actual (borde resaltado)
      if (isCurrent) {
        if (destinoSel === 'discografia') tile.classList.add('sel-discografia');
        if (destinoSel === 'movie')       tile.classList.add('sel-movie');
        if (destinoSel === 'news')        tile.classList.add('sel-news');
      }

      const lblText = saved[k] ? saved[k] : '';
      tile.innerHTML = `
        <span class="badge">${k.toUpperCase()}</span>
        <span class="lbl ${saved[k] && !isCurrent ? 'muted' : ''}">${lblText}</span>
      `;
    });
  }
  paintMap();

  // Convertir → fija currentPreviewUrl y repinta (preview dentro del tile)
  $('#btnConv').onclick = ()=>{
    $('#outUrl').value = '';
    currentPreviewUrl = '';
    const id = getDriveId($('#inLink').value);
    if(!id){ alert('❌ Link/ID de Drive no válido'); return; }
    tryLoad(candidates(id), url=>{
      const use = url || candidates(id)[0];
      $('#outUrl').value = use;
      currentPreviewUrl = use;        // preview temporal
      paintMap();
    });
  };
  $('#btnCopyUrl').onclick = ()=>copy($('#outUrl'));

  // Generar & Copiar (N5 sin coma)
  $('#btnGen').onclick = ()=>{
    const imagen = $('#outUrl').value.trim();
    if(!imagen){ alert('Convierte primero el link para obtener la URL.'); return; }
    const titulo = $('#inTitulo').value.trim();

    const obj = { imagen, destino: destinoSel };
    if(titulo) obj.titulo = titulo;

    const frag = `"${currentN}": ${JSON.stringify(obj, null, 2)}${currentN !== 'n5' ? ',' : ''}`;
    $('#outJson').value = frag;
    copy($('#outJson'));

    // Guardar destino para ese N y repintar (la imagen preview sigue siendo temporal)
    saved[currentN] = destinoSel;
    paintMap();
  };
</script>
</body>
</html>
