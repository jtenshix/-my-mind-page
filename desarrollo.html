<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convertidor Links Drive → Imagen (con categorías)</title>
  <style>
    :root{
      --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
      --panel: rgba(0,0,0,.85);
      --txt:#f5f5f5; --accent:#ffcc70; --accent-hover:#ffaa00;
      --disc:#18a558; --movie:#d9534f; --news:#3b82f6;
    }
    *{ box-sizing:border-box }
    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      color: var(--txt); margin:0; padding:0;
      min-height:100vh; display:flex; justify-content:center; align-items:center;
    }
    .container{
      background: var(--panel); padding: 26px; border-radius: 14px;
      width: min(92vw, 780px); box-shadow: 0 10px 30px rgba(0,0,0,.6);
    }
    h1{ font-size: 22px; margin: 0 0 18px; color: var(--accent); text-align:center }
    .row{ display:grid; gap:12px; }
    label{ font-size:13px; opacity:.9 }
    input[type="text"], textarea{
      width: 100%; padding: 10px 12px; border-radius: 10px; border: none;
      font-size: 14px; background: #111; color: #fff; outline: none;
    }
    textarea{ height: 70px; resize: none }
    .btns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px }
    button{
      padding: 9px 14px; border: none; border-radius: 10px;
      background: var(--accent); color:#222; font-size:14px; cursor:pointer; transition:.25s;
    }
    button:hover{ background: var(--accent-hover) }
    .cats{ display:flex; gap:10px; flex-wrap:wrap; margin: 6px 0 2px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px; background:#111; border:2px solid transparent;
      color:#fff; border-radius:999px; padding:7px 12px; cursor:pointer; user-select:none; transition:.2s;
    }
    .chip input{ display:none }
    .dot{ width:12px; height:12px; border-radius:999px }
    .chip[data-cat="discografia"] .dot{ background: var(--disc) }
    .chip[data-cat="movie"] .dot{ background: var(--movie) }
    .chip[data-cat="news"] .dot{ background: var(--news) }
    .chip.active[data-cat="discografia"]{ border-color: var(--disc) }
    .chip.active[data-cat="movie"]{ border-color: var(--movie) }
    .chip.active[data-cat="news"]{ border-color: var(--news) }
    .preview{ margin-top: 14px; text-align:center }
    .preview img{ max-width:100%; border-radius:12px; border:2px solid #444 }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }
    @media (max-width:720px){ .grid2{ grid-template-columns: 1fr } }
    .small{ font-size:12px; opacity:.8; margin-top:3px }
    .outblock{ background:#0b0b0b; padding:12px; border-radius:10px; border:1px solid #222 }
    .title-row{ display:grid; gap:8px; grid-template-columns: 1fr 140px }
    @media (max-width:560px){ .title-row{ grid-template-columns: 1fr } }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔗 Convertidor Google Drive → Imagen</h1>

    <div class="row" style="margin-bottom:14px">
      <label for="driveLink">Pega tu link (cualquier formato de Google Drive o solo el ID)</label>
      <input id="driveLink" type="text" placeholder="https://drive.google.com/file/d/ID/view?usp=sharing • open?id=ID • uc?id=ID • lh3 • solo ID…" />
      <div class="btns">
        <button id="btnConvertir">Convertir</button>
        <button id="btnCopiarUrl">Copiar URL directa</button>
      </div>
    </div>

    <div class="row outblock">
      <label>Resultado (URL directa de imagen)</label>
      <textarea id="resultado" readonly></textarea>
      <div class="small" id="notaModo"></div>
      <div class="preview" id="preview"></div>
    </div>

    <div class="row" style="margin-top:16px">
      <label>Selecciona la categoría (colores):</label>
      <div class="cats" id="cats">
        <label class="chip" data-cat="discografia"><input type="radio" name="cat" value="discografia"><span class="dot"></span> Discografía</label>
        <label class="chip" data-cat="movie"><input type="radio" name="cat" value="movie"><span class="dot"></span> Movie</label>
        <label class="chip" data-cat="news"><input type="radio" name="cat" value="news"><span class="dot"></span> News</label>
      </div>
      <div class="small">Esto solo define el campo <code>"destino"</code> para pegarlo en tu <code>catalogo.json</code>.</div>
    </div>

    <div class="row grid2" style="margin-top:10px">
      <div class="outblock">
        <div class="title-row">
          <div>
            <label for="titulo">Título (opcional, para tu JSON)</label>
            <input id="titulo" type="text" placeholder="Ej: Nuevo wallpaper / Nueva canción" />
          </div>
          <div>
            <label for="clave">Clave de noticia</label>
            <input id="clave" type="text" value="n1" />
          </div>
        </div>
        <div class="btns" style="margin-top:10px">
          <button id="btnGenerarJson">Generar JSON</button>
          <button id="btnCopiarJson">Copiar JSON</button>
        </div>
        <label class="small">Fragmento para <code>"news"</code> en tu <code>catalogo.json</code>:</label>
        <textarea id="salidaJson" readonly></textarea>
      </div>

      <div class="outblock">
        <label>Destino directo (si prefieres forzar URL en vez de alias)</label>
        <div class="btns" style="margin-top:6px">
          <button id="btnDestinoDisc">discografia</button>
          <button id="btnDestinoMovie">movie</button>
          <button id="btnDestinoNews">news</button>
        </div>
        <div class="small">También puedes usar <code>"link"</code> directo (por ejemplo tu página de news absoluta).</div>
        <div class="btns" style="margin-top:10px">
          <button id="btnGenerarJsonLink">Generar JSON con link</button>
          <button id="btnCopiarJsonLink">Copiar JSON con link</button>
        </div>
        <textarea id="salidaJsonLink" readonly></textarea>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <div class="small">Alias válidos y cómo los usas en tu web:</div>
      <div class="outblock">
        <pre style="margin:0; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12.5px; color:#ddd">
discografia → "Discography.html"
movie       → "movie.html"
news        → "https://jtenshix.github.io/J-tenshi-music/news.html"
        </pre>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utils ----------
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    // Extrae ID de casi cualquier link de Drive (o acepta ID directo)
    function extraerIdDrive(raw){
      if(!raw) return null;
      const s = raw.trim();

      // 0) Si pegaste solo el ID (25+ chars alfanum/guion/guion bajo)
      const soloId = s.match(/^[A-Za-z0-9_-]{25,}$/);
      if (soloId) return soloId[0];

      // 1) Si ya es un lh3.googleusercontent con /d/ID
      try {
        const u = new URL(s);

        // /file/d/ID/...
        const mFile = u.pathname.match(/\/file\/d\/([A-Za-z0-9_-]{10,})/);
        if (mFile) return mFile[1];

        // /d/ID/...
        const mD = u.pathname.match(/\/d\/([A-Za-z0-9_-]{10,})/);
        if (mD) return mD[1];

        // ?id=ID (uc, open, thumbnail, export=download…)
        const byId = u.searchParams.get('id');
        if (byId && /^[A-Za-z0-9_-]{10,}$/.test(byId)) return byId;

        // A veces viene “resourcekey” además; no nos importa para ID.

      } catch (e) {
        // No era URL válida; seguimos abajo con regex global
      }

      // 2) Fallback: busca un token largo tipo ID en toda la cadena
      const any = s.match(/[-\w]{25,}/);
      return any ? any[0] : null;
    }

    // Genera candidatos de URL directa (intentamos en cascada)
    function candidatosDirectos(id){
      return [
        { url: `https://lh3.googleusercontent.com/d/${id}`, note: 'lh3 (rápido)' },
        { url: `https://drive.google.com/uc?export=view&id=${id}`, note: 'uc?export=view' },
        { url: `https://drive.google.com/thumbnail?id=${id}`, note: 'thumbnail' },
        { url: `https://drive.google.com/uc?export=download&id=${id}`, note: 'uc?export=download' }
      ];
    }

    // Intenta cargar la imagen con fallback entre candidatos
    function probarCandidatos(cands, onOk, onFail){
      if (!cands.length) { onFail?.(); return; }
      const { url, note } = cands[0];
      const img = new Image();
      img.onload = () => onOk(url, note);
      img.onerror = () => probarCandidatos(cands.slice(1), onOk, onFail);
      img.referrerPolicy = 'no-referrer';
      img.src = url + (url.includes('?') ? '&' : '?') + 'cachebust=' + Date.now();
    }

    function copiarTexto(el){
      el.select();
      document.execCommand("copy");
    }

    // ---------- Categorías (chips) ----------
    const CAT_KEY = "tenshi_cat";
    function getCat(){ return localStorage.getItem(CAT_KEY) || "discografia"; }
    function setCat(cat){ localStorage.setItem(CAT_KEY, cat); }

    (function initChips(){
      const catInicial = getCat();
      const chips = $$("#cats .chip");
      chips.forEach(ch => {
        const val = ch.getAttribute("data-cat");
        const input = ch.querySelector('input[type="radio"]');
        if(val === catInicial) { ch.classList.add("active"); input.checked = true; }
        ch.addEventListener("click", () => {
          chips.forEach(c => c.classList.remove("active"));
          ch.classList.add("active");
          input.checked = true;
          setCat(val);
        });
      });
    })();

    // ---------- Botones ----------
    $("#btnConvertir").addEventListener("click", () => {
      $("#preview").innerHTML = "";
      $("#resultado").value = "";
      $("#notaModo").textContent = "";

      const link = $("#driveLink").value.trim();
      const id = extraerIdDrive(link);

      if(!id){
        alert("❌ Link no válido. Asegúrate de pegar un link/ID de *archivo* de Google Drive (no carpeta).");
        return;
      }

      const cands = candidatosDirectos(id);
      probarCandidatos(
        cands,
        (okUrl, note) => {
          $("#resultado").value = okUrl;
          $("#notaModo").textContent = `Modo: ${note}`;
          $("#preview").innerHTML = `<p style="margin:6px 0 8px">Vista previa:</p><img src="${okUrl}" alt="Preview">`;
        },
        () => {
          $("#resultado").value = cands[0].url; // igualmente te dejo la primera
          $("#notaModo").textContent = "No se pudo previsualizar (¿no es imagen?). URL generada igualmente.";
          $("#preview").innerHTML = "";
        }
      );
    });

    $("#btnCopiarUrl").addEventListener("click", () => copiarTexto($("#resultado")));

    // ---------- JSON con destino (alias) ----------
    $("#btnGenerarJson").addEventListener("click", () => {
      const url = $("#resultado").value.trim();
      if(!url){ alert("Convierte primero el link para obtener la URL directa."); return; }
      const titulo = $("#titulo").value.trim();
      const clave  = $("#clave").value.trim() || "n1";
      const destino = getCat();

      const obj = { imagen: url, destino };
      if(titulo) obj.titulo = titulo;

      const json = `"${clave}": ${JSON.stringify(obj, null, 2)}`;
      $("#salidaJson").value = json;
    });
    $("#btnCopiarJson").addEventListener("click", () => copiarTexto($("#salidaJson")));

    // ---------- JSON con link directo ----------
    const DESTINOS = {
      discografia: "Discography.html",
      movie: "movie.html",
      news: "https://jtenshix.github.io/J-tenshi-music/news.html"
    };
    $("#btnDestinoDisc").addEventListener("click", ()=> setCat("discografia"));
    $("#btnDestinoMovie").addEventListener("click", ()=> setCat("movie"));
    $("#btnDestinoNews").addEventListener("click", ()=> setCat("news"));

    $("#btnGenerarJsonLink").addEventListener("click", () => {
      const url = $("#resultado").value.trim();
      if(!url){ alert("Convierte primero el link para obtener la URL directa."); return; }
      const titulo = $("#titulo").value.trim();
      const clave  = $("#clave").value.trim() || "n1";
      const cat    = getCat();
      const link   = DESTINOS[cat] || "#";

      const obj = { imagen: url, link };
      if(titulo) obj.titulo = titulo;

      $("#salidaJsonLink").value = `"${clave}": ${JSON.stringify(obj, null, 2)}`;
    });
    $("#btnCopiarJsonLink").addEventListener("click", () => copiarTexto($("#salidaJsonLink")));
  </script>
</body>
</html>
