<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notas Oce√°nicas - Polaroid</title>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <style>
    
    /* A√±ade este bloque para eliminar las sombras */
    .grid-stack-item,
    .grid-stack-item-content,
    .card-wrapper,
    .text-card,
    .note-content {
        box-shadow: none !important; }
    
    .grid-stack-item[data-note-type="imagen"].grid-stack-item-dragging,
    .grid-stack-item[data-note-type="imagen"].grid-stack-item-dragging .grid-stack-item-content {
      opacity: 0.7 !important;
      border: 3px dashed red !important;
      background-color: rgba(255, 0, 0, 0.3) !important;
      box-shadow: none !important;
    }
    .grid-stack-item[data-note-type="texto"].grid-stack-item-dragging,
    .grid-stack-item[data-note-type="texto"].grid-stack-item-dragging .grid-stack-item-content {
      opacity: 0.7 !important;
      border: 3px dashed #a2dff7 !important;
      background-color: rgba(162, 223, 247, 0.3) !important;
      box-shadow: none !important;
    }
    .grid-stack-placeholder {
      display: none !important;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(to bottom, #a2dff7 0%, #a2dff7 40%, #03254c 100%);
      font-family: Arial, sans-serif;
    }
    .container {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    #notaDisplay {
      flex-grow: 1;
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      min-width: 1000px;
    }
    .grid-stack-item {
      transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      overflow: visible !important;
      margin-bottom: 0px;
    }
    .grid-stack-item-content {
      overflow: visible !important;
      height: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    .card-wrapper, .text-card {
      background-color: #fff;
      border: 2px solid #0077a3;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      position: relative;
      box-sizing: border-box;
    }
    .image-container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: relative;
      flex-shrink: 0;
    }
    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .note-content {
      background-color: #fff;
      padding: 10px;
      text-align: left;
      font-size: 16px;
      color: #333;
      min-height: 50px;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow: hidden;
      flex-grow: 1;
    }
    .note-content a {
      color: #0077a3;
      text-decoration: underline;
    }
    .menu-bar {
      background-color: #0288D1;
      padding: 5px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      border-top: 1px solid #0077a3;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
    }
    .menu-icon {
      background: none;
      border: none;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      padding: 2px 4px;
    }
    .bubble-icon {
      color: #FFCD05;
      font-size: 22px;
    }
    .menu-actions {
      display: flex;
      gap: 4px;
    }
    #addNoteButton {
      position: absolute;
      bottom: 30px;
      right: 30px;
      background-color: #006994;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, transform 0.3s ease;
      z-index: 1001;
    }
    #addNoteButton:hover {
      background-color: #005577;
      transform: scale(1.05);
    }
    #addNoteOptions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.85);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 25px;
      padding: 25px;
      z-index: 1002;
    }
    #addNoteOptions .card {
      background-color: #2c2c2c;
      border: 1px solid #0077a3;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 180px;
    }
    #addNoteOptions .card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 119, 163, 0.5);
    }
    #addNoteOptions .card h2 {
      color: #36a2eb;
      margin-bottom: 10px;
    }
    #addNoteOptions .card p {
      color: #ccc;
      font-size: 14px;
    }
    #inputArea {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ffffff;
      padding: 25px 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      gap: 15px;
      width: 90%;
      max-width: 550px;
      z-index: 1002;
    }
    #inputArea label {
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
      font-size: 14px;
    }
    #inputArea textarea, #inputArea input[type="text"] {
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
      line-height: 1.5;
      font-size: 16px;
    }
    #inputArea textarea {
      min-height: 80px;
    }
    #inputArea textarea#textNote {
      min-height: 120px;
    }
    #inputArea button {
      padding: 10px 20px;
      background-color: #006994;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      align-self: flex-end;
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
    }
    #inputArea button:hover {
      background-color: #005577;
    }
    #inputArea button:active {
      transform: scale(0.98);
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .calendar-icon {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 45px;
      height: 45px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .calendar-widget {
      position: absolute;
      bottom: 85px;
      left: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      padding: 15px;
      display: none;
      z-index: 1001;
      width: 320px;
      min-height: 300px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .calendar-header button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #0077a3;
      padding: 5px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    .calendar-header button:hover:not(:disabled) {
      background-color: #e0f7fa;
    }
    .calendar-header button:disabled {
      color: #ccc;
      cursor: default;
    }
    .calendar-header span {
      font-weight: bold;
      color: #333;
      font-size: 18px;
    }
    .calendar-days-header, .calendar-dates-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 6px;
    }
    .calendar-days-header {
      margin-bottom: 10px;
      font-weight: bold;
      color: #555;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    .calendar-day {
      padding: 3px;
    }
    .calendar-date {
      padding: 0;
      border-radius: 50%;
      color: #333;
      border: 2px solid transparent;
      cursor: pointer;
      position: relative;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      line-height: 1;
      font-size: 14px;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .calendar-date.empty {
      background: none;
      cursor: default;
      opacity: 0;
    }
    .calendar-date:not(.empty):hover {
      background-color: #e0f7fa;
      border-color: #b3e5fc;
    }
    .calendar-date.today {
      border-color: #0077a3;
      font-weight: bold;
      color: #005577;
    }
    .calendar-date.drag-over {
      background-color: #a2dff7 !important;
      border-color: #0077a3 !important;
    }
    .assigned-bubble {
      color: #FFCD05;
      font-size: 11px;
      position: absolute;
      bottom: 3px;
      left: 50%;
      transform: translateX(-50%);
      line-height: 1;
      text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }
    .calendar-date .assigned-bubble + .assigned-bubble {
      bottom: -2px;
    }
    .blur-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      z-index: 1000;
      cursor: pointer;
    }
    @media (max-width: 575.98px) {
      #inputArea {
        width: 95%;
      }
      #addNoteOptions {
        flex-direction: column;
        gap: 15px;
        padding: 20px;
      }
      #addNoteOptions .card {
        width: 150px;
      }
    }
    @media (max-width: 576px) {

}
  </style>
</head>
<body>
  <div id="auth-section" style="padding: 15px; background-color: #f0f0f0; border-bottom: 1px solid #ccc; text-align: center; margin-bottom: 10px;">
  <div id="login-form">
    <input type="email" id="login-email" placeholder="Correo" style="padding: 8px; margin-right: 5px;">
    <input type="password" id="login-password" placeholder="Contrase√±a" style="padding: 8px; margin-right: 5px;">
    <button id="login-button" style="padding: 8px 12px;">Entrar</button>
  </div>
  <div id="user-info" style="display: none;">
    <span>Conectado como: <strong id="user-email-display"></strong></span>
    <button id="logout-button" style="padding: 8px 12px; margin-left: 15px;">Salir</button>
  </div>
</div>
  <div class="container">
    <div id="notaDisplay" class="grid-stack"></div>
    <button id="addNoteButton" title="A√±adir nueva nota o imagen">+</button>
    <div id="addNoteOptions">
      <div class="card" id="addImageLinkOption" title="A√±adir una nota con imagen desde un enlace web">
        <h2>üñºÔ∏è Imagen</h2>
        <p>Guardar link de imagen.</p>
      </div>
      <div class="card" id="addTextNoteOption" title="A√±adir una nota de texto simple">
        <h2>üìù Nota</h2>
        <p>Subir nota de texto.</p>
      </div>
    </div>
    <div id="inputArea">
      <div id="imageLinkInputArea" style="display: none;">
        <div class="input-group">
          <label for="imageLink">Link de la imagen:</label>
          <input type="text" id="imageLink" placeholder="Pega aqu√≠ la URL de la imagen (ej: https://...)" />
        </div>
        <div class="input-group">
          <label for="imageNoteText">Texto adicional (opcional):</label>
          <textarea id="imageNoteText" placeholder="Escribe aqu√≠ una descripci√≥n o nota relacionada con la imagen..." rows="3"></textarea>
        </div>
        <button id="saveImageLink">Guardar Imagen</button>
      </div>
      <div id="textNoteInputArea" style="display: none;">
        <div class="input-group">
          <label for="textNote">Nota:</label>
          <textarea id="textNote" placeholder="Escribe tu nota aqu√≠..." rows="5"></textarea>
        </div>
        <button id="saveTextNote">Guardar Nota</button>
      </div>
    </div>
    <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">üìÖ</div>
    <div id="calendarWidget" class="calendar-widget"></div>
    <div class="blur-background"></div>
  </div>
  <script>
    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(?<!href=["'])(https?:\/\/[^\s<>"']+)/g;
      const replacedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return replacedText.replace(/\n/g, '<br>');
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCHa373WgLLHsy8wZXK9zr_HVieQvlrhUs",
      authDomain: "oasis-b036d.firebaseapp.com",
      projectId: "oasis-b036d",
      storageBucket: "oasis-b036d.appspot.com",
      messagingSenderId: "141546637821",
      appId: "1:141546637821:web:0a861aeb13831774ed3194",
      measurementId: "G-HB2P17H5YL"
    };

    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) {
      console.error("Error inicializando Firebase:", e);
    }

    const db = firebase.firestore();
    const auth = firebase.auth();

    let grid;
    try {
      grid = GridStack.init({
        column: 12,
        margin: 5,
        cellHeight: 'auto',
        disableResize: true,
        float: true,
        overlap: false,
        animate: true,
        alwaysShowResizeHandle: false,
        draggable: {
          handle: '.menu-bar',
          scroll: true,
          appendTo: 'body'
        }
      });
    } catch (e) {
      console.error("Error inicializando GridStack:", e);
      alert("Error al iniciar el √°rea de notas.");
    }

    const gridStackElement = document.getElementById('notaDisplay');
    let currentColumnCount = 12;
    const breakpoints = [
      { width: 992, cols: 12 },
      { width: 576, cols: 6 },
      { width: 0, cols: 3 }
    ];

    function adjustGridColumns() {
      const screenWidth = window.innerWidth;
      let newColumnCount = 12;
      for (const bp of breakpoints) {
        if (screenWidth >= bp.width) {
          newColumnCount = bp.cols;
          break;
        }
      }
      if (newColumnCount !== currentColumnCount) {
        if (grid) {
          grid.column(newColumnCount, true);
        }
        currentColumnCount = newColumnCount;
      }
    }

    adjustGridColumns();
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(adjustGridColumns, 100);
    });

    if (grid) {
      grid.on('change', function (event, items) {
        console.log("Evento 'change' de GridStack disparado.");
        items.forEach(function (item) {
          const noteId = item.el?.getAttribute('data-note-id') || item.id || '(desconocido)';
          console.log(` - Nota ID: ${noteId}, Posici√≥n final seg√∫n GridStack: x=${item.x}, y=${item.y}, w=${item.w}, h=${item.h}`);
          const noteIdToSave = item.el?.getAttribute('data-note-id');
          if (noteIdToSave && typeof item.x === 'number' && typeof item.y === 'number') {
            console.log(`¬† ¬†(Considerando guardar x:${item.x}, y:${item.y} para ${noteIdToSave} en Firestore desde 'change')`);
            db.collection('notas').doc(noteIdToSave).update({
              x: item.x,
              y: item.y
            }).catch(err => console.error(`Error guardando posici√≥n desde 'change': ${err}`));
          }
        });
      });

      grid.on('dragstop', function (event, element) {
        const node = grid.engine.nodes.find(n => n.el === element);
        if (node) {
          const noteId = node.el?.getAttribute('data-note-id') || node.id || '(desconocido)';
          console.log(`Evento 'dragstop': Nota ID: ${noteId} soltada en x=${node.x}, y=${node.y}`);
        }
      });
      console.log(">>> LISTENER ATTACHED TO GRID <<<");
    }

    const gridContainer = document.getElementById('notaDisplay');
    if (gridContainer) gridContainer.addEventListener('wheel', (event) => {}, { passive: true });

    function autoResizeTextarea(el) {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight + 2) + 'px';
    }

    const textNoteInputElem = document.getElementById('textNote');
    const imageNoteTextElem = document.getElementById('imageNoteText');
    if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
    if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));

    const displayedNotes = new Map();

    function mostrarNotaEnPantalla(doc) {
      const notaData = doc.data();
      const noteId = doc.id;
      let gridItem = document.createElement('div');
      gridItem.classList.add('grid-stack-item');
      gridItem.setAttribute('data-note-id', noteId);
      gridItem.setAttribute('data-note-type', notaData.tipo);
      const content = document.createElement('div');
      content.classList.add('grid-stack-item-content');
      let card;
      let noteContentElement;

      if (notaData.url) {
        card = document.createElement('div');
        card.classList.add('card-wrapper');
        const imageContainer = document.createElement('div');
        imageContainer.classList.add('image-container');
        const img = document.createElement('img');
        img.src = notaData.url;
        img.alt = notaData.texto || 'Imagen de la nota';
        img.loading = 'lazy';
        img.onerror = () => {
          imageContainer.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; background-color:#eee; color:red; text-align:center; padding:10px;">‚ö†Ô∏è<br/>Error al<br/>cargar imagen</div>`;
        };
        imageContainer.appendChild(img);
        card.appendChild(imageContainer);
        if (notaData.texto) {
          noteContentElement = document.createElement('div');
          noteContentElement.classList.add('note-content');
          noteContentElement.innerHTML = linkify(notaData.texto);
          card.appendChild(noteContentElement);
        }
      } else if (notaData.nota) {
        card = document.createElement('div');
        card.classList.add('text-card');
        noteContentElement = document.createElement('div');
        noteContentElement.classList.add('note-content');
        noteContentElement.innerHTML = linkify(notaData.nota);
        card.appendChild(noteContentElement);
      } else {
        return null;
      }

      if (noteContentElement) {
        Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        });
      }

      const menuBar = document.createElement('div');
      menuBar.classList.add('menu-bar');
      const bubbleButton = document.createElement('button');
      bubbleButton.classList.add('menu-icon', 'bubble-icon');
      bubbleButton.innerHTML = '‚óè';
      bubbleButton.setAttribute('draggable', 'true');
      bubbleButton.id = `bubble-${noteId}`;
      bubbleButton.title = "Arrastrar al calendario";
      bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';
      bubbleButton.addEventListener('dragstart', (e) => {
        var imgGhost = new Image();
        imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
        e.dataTransfer.setDragImage(imgGhost, 0, 0);
        e.dataTransfer.setData("application/note-id", noteId);
        e.dataTransfer.effectAllowed = "move";
        openCalendar();
      });
      bubbleButton.addEventListener('click', (e) => {
        e.stopPropagation();
        openCalendar();
      });

      const menuActions = document.createElement('div');
      menuActions.classList.add('menu-actions');
      const editButton = document.createElement('button');
      editButton.classList.add('menu-icon');
      editButton.innerHTML = '‚úé';
      editButton.title = "Editar";
      const deleteButton = document.createElement('button');
      deleteButton.classList.add('menu-icon');
      deleteButton.innerHTML = '‚úñ';
      deleteButton.title = "Eliminar";
      deleteButton.onclick = (e) => {
        e.stopPropagation();
        if (typeof deleteNote === 'function') deleteNote(noteId, gridItem);
        else {
          console.error("Funci√≥n deleteNote no encontrada");
          alert("Error interno al eliminar.");
        }
      };
      editButton.onclick = (e) => {
        e.stopPropagation();
        if (typeof editNoteContent === 'function') editNoteContent(card, noteId, notaData, menuActions, editButton, deleteButton);
        else console.error("Funci√≥n editNoteContent no encontrada");
      };
      menuActions.appendChild(editButton);
      menuActions.appendChild(deleteButton);
      menuBar.appendChild(bubbleButton);
      menuBar.appendChild(menuActions);
      card.appendChild(menuBar);
      content.appendChild(card);
      gridItem.appendChild(content);

      const pos = {
        x: notaData.x,
        y: notaData.y,
        w: notaData.w || 2,
        h: notaData.h || 0,
        id: noteId,
        autoPosition: (notaData.x === undefined || notaData.y === undefined)
      };
      gridItem.docData = notaData;
      return {
        element: gridItem,
        position: pos
      };
    }

    function editNoteContent(card, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
      let targetElement = card.querySelector('.note-content');
      if (!targetElement && notaData.url) {
        targetElement = document.createElement('div');
        targetElement.classList.add('note-content');
        card.insertBefore(targetElement, card.querySelector('.menu-bar'));
      } else if (!targetElement && !notaData.url) {
        console.error("Error: No se encontr√≥ .note-content para editar texto en nota:", noteId);
        return;
      }
      const isImageNote = !!notaData.url;
      const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');
      targetElement.innerHTML = '';
      const editInput = document.createElement('textarea');
      editInput.value = currentText;
      editInput.style.cssText = "width:100%; min-height:80px; height:auto; box-sizing:border-box; border:1px dashed #ccc; resize:vertical;";
      targetElement.appendChild(editInput);
      autoResizeTextarea(editInput);
      editInput.addEventListener('input', () => autoResizeTextarea(editInput));
      editInput.focus();
      const saveEditButton = document.createElement('button');
      saveEditButton.classList.add('menu-icon');
      saveEditButton.innerHTML = 'üíæ';
      saveEditButton.title = "Guardar";
      saveEditButton.onclick = (e) => {
        e.stopPropagation();
        const newText = editInput.value.trim();
        const updateData = isImageNote ? { texto: newText || null } : { nota: newText };
        saveEditButton.disabled = true;
        saveEditButton.innerHTML = '‚è≥';
        db.collection('notas').doc(noteId).update(updateData)
          .then(() => {
            menuActionsContainer.replaceChild(editButton, saveEditButton);
            menuActionsContainer.appendChild(deleteButton);
          })
          .catch((error) => {
            console.error('Error al actualizar:', error);
            alert("Error al guardar.");
            saveEditButton.disabled = false;
            saveEditButton.innerHTML = 'üíæ';
            menuActionsContainer.replaceChild(editButton, saveEditButton);
            menuActionsContainer.appendChild(deleteButton);
          });
      };
      menuActionsContainer.innerHTML = '';
      menuActionsContainer.appendChild(saveEditButton);
    }

    function deleteNote(noteId, gridItem) {
      console.log("Eliminando nota:", noteId);
      db.collection('notas').doc(noteId).delete()
        .then(() => {
          console.log(`Nota ${noteId} eliminada de Firestore.`);
          displayedNotes.delete(noteId);
          document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
        })
        .catch((error) => {
          console.error("Error al eliminar:", error);
          alert("Error al eliminar la nota.");
        });
    }
    const addNoteButtonElem = document.getElementById('addNoteButton');
    const addNoteOptionsElem = document.getElementById('addNoteOptions');
    const addImageLinkOptionElem = document.getElementById('addImageLinkOption');
    const addTextNoteOptionElem = document.getElementById('addTextNoteOption');
    const inputAreaElem = document.getElementById('inputArea');
    const imageLinkInputAreaElem = document.getElementById('imageLinkInputArea');
    const imageLinkInputElem = document.getElementById('imageLink');
    const saveImageLinkButtonElem = document.getElementById('saveImageLink');
    const textNoteInputAreaElem = document.getElementById('textNoteInputArea');
    const saveTextNoteButtonElem = document.getElementById('saveTextNote');
    const blurBackgroundElem = document.querySelector('.blur-background');

    function hideMenus() {
      if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
      if (inputAreaElem) inputAreaElem.style.display = 'none';
      if (blurBackgroundElem) blurBackgroundElem.style.display = 'none';
      if (imageLinkInputElem) imageLinkInputElem.value = '';
      if (imageNoteTextElem) {
        imageNoteTextElem.value = '';
        autoResizeTextarea(imageNoteTextElem);
      }
      if (textNoteInputElem) {
        textNoteInputElem.value = '';
        autoResizeTextarea(textNoteInputElem);
      }
    }

    if (addNoteButtonElem) addNoteButtonElem.onclick = (e) => {
      e.stopPropagation();
      if (addNoteOptionsElem && addNoteOptionsElem.style.display === 'flex') {
        hideMenus();
      } else if (addNoteOptionsElem && blurBackgroundElem) {
        hideMenus();
        addNoteOptionsElem.style.display = 'flex';
        blurBackgroundElem.style.display = 'block';
      }
    };

    if (addImageLinkOptionElem) addImageLinkOptionElem.onclick = (e) => {
      e.stopPropagation();
      if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
      if (imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'block';
      if (textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'none';
      if (inputAreaElem) inputAreaElem.style.display = 'flex';
      if (blurBackgroundElem) blurBackgroundElem.style.display = 'block';
      if (imageLinkInputElem) imageLinkInputElem.focus();
    };

    if (addTextNoteOptionElem) addTextNoteOptionElem.onclick = (e) => {
      e.stopPropagation();
      if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
      if (imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'none';
      if (textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'block';
      if (inputAreaElem) inputAreaElem.style.display = 'flex';
      if (blurBackgroundElem) blurBackgroundElem.style.display = 'block';
      if (textNoteInputElem) textNoteInputElem.focus();
    };

    if (blurBackgroundElem) blurBackgroundElem.onclick = hideMenus;

    function guardarLinkDeImagen() {
      if (!imageLinkInputElem) return;
      let link = imageLinkInputElem.value.trim();
      const texto = imageNoteTextElem ? imageNoteTextElem.value.trim() : '';
      if (link) {
        if (saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = true;
        db.collection('notas').add({
          url: link,
          texto: texto || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tipo: 'imagen',
          w: 1,
          h: 1
        }).then(() => {
          hideMenus();
        }).catch((error) => {
          console.error('Error al guardar link:', error);
          alert("Error al guardar imagen.");
        }).finally(() => {
          if (saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = false;
        });
      } else {
        alert("Introduce un link v√°lido.");
        imageLinkInputElem.focus();
      }
    }

    function guardarNotaTexto() {
      if (!textNoteInputElem) return;
      const nota = textNoteInputElem.value.trim();
      if (nota) {
        if (saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = true;
        db.collection('notas').add({
          nota: nota,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tipo: 'texto',
          w: 1,
          h: 1,
        }).then(() => {
          hideMenus();
        }).catch((error) => {
          console.error('Error al guardar nota:', error);
          alert("Error al guardar nota.");
        }).finally(() => {
          if (saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = false;
        });
      } else {
        alert("Escribe algo en la nota.");
        textNoteInputElem.focus();
      }
    }

    if (saveImageLinkButtonElem) saveImageLinkButtonElem.onclick = guardarLinkDeImagen;
    if (saveTextNoteButtonElem) saveTextNoteButtonElem.onclick = guardarNotaTexto;

    let currentCalendarMonth, currentCalendarYear;
    let assignedDatesCache = {};
    let notesDataCache = {};

    function getChileDate() {
      try {
        const opts = {
          timeZone: 'America/Santiago',
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric',
          hour12: false
        };
        const fmt = new Intl.DateTimeFormat('en-CA', opts);
        const p = fmt.formatToParts(new Date());
        const d = {};
        p.forEach(({ type, value }) => d[type] = parseInt(value, 10));
        return new Date(Date.UTC(d.year, d.month - 1, d.day, d.hour, d.minute, d.second));
      } catch (e) {
        console.warn("Intl fallback", e);
        return new Date();
      }
    }

    function initCalendarDate() {
      let today = getChileDate();
      let year = today.getFullYear();
      let month = today.getMonth();
      const minY = 2024;
      const minM = 11;
      if (year < minY || (year === minY && month < minM)) {
        return {
          month: minM,
          year: minY
        };
      }
      return {
        month,
        year
      };
    }

    function getMonthName(idx) {
      const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      return months[idx % 12] || '';
    }

    async function fetchAllAssignedNotes() {
      assignedDatesCache = {};
      notesDataCache = {};
      try {
        const snap = await db.collection('notas').where('assignedDate', '!=', null).get();
        snap.forEach(doc => {
          const d = doc.data();
          const id = doc.id;
          notesDataCache[id] = d;
          const dateStr = d.assignedDate;
          if (dateStr) {
            if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = [];
            if (!assignedDatesCache[dateStr].includes(id)) assignedDatesCache[dateStr].push(id);
          }
        });
      } catch (err) {
        console.error("Error fetch dates:", err);
      }
    }

    async function generateCalendar(month, year) {
      if (Object.keys(notesDataCache).length === 0) await fetchAllAssignedNotes();
      const calDiv = document.getElementById('calendarWidget');
      if (!calDiv) return;
      calDiv.innerHTML = '';
      const today = getChileDate();
      const hdr = document.createElement('div');
      hdr.className = 'calendar-header';
      const pBtn = document.createElement('button');
      pBtn.innerHTML = '&lt;';
      const minY = 2024;
      const minM = 11;
      if (year === minY && month === minM) pBtn.disabled = true;
      else pBtn.onclick = () => generateCalendar(month === 0 ? 11 : month - 1, month === 0 ? year - 1 : year);
      const nBtn = document.createElement('button');
      nBtn.innerHTML = '&gt;';
      nBtn.onclick = () => generateCalendar(month === 11 ? 0 : month + 1, month === 11 ? year + 1 : year);
      const title = document.createElement('span');
      title.textContent = `${getMonthName(month)} ${year}`;
      hdr.appendChild(pBtn);
      hdr.appendChild(title);
      hdr.appendChild(nBtn);
      calDiv.appendChild(hdr);
      const daysHdr = document.createElement('div');
      daysHdr.className = 'calendar-days-header';
      ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'S√°'].forEach(day => {
        const d = document.createElement('div');
        d.className = 'calendar-day';
        d.textContent = day;
        daysHdr.appendChild(d);
      });
      calDiv.appendChild(daysHdr);
      const datesG = document.createElement('div');
      datesG.className = 'calendar-dates-grid';
      const firstD = new Date(year, month, 1).getDay();
      const daysInM = new Date(year, month + 1, 0).getDate();
      for (let i = 0; i < firstD; i++) {
        const e = document.createElement('div');
        e.className = 'calendar-date empty';
        datesG.appendChild(e);
      }
      for (let date = 1; date <= daysInM; date++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-date';
        cell.textContent = date;
        const dStr = `${date}/${month + 1}/${year}`;
        if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cell.classList.add('today');
        if (assignedDatesCache[dStr]) {
          assignedDatesCache[dStr].forEach(id => {
            const b = document.createElement("span");
            b.className = "assigned-bubble";
            b.setAttribute("data-note", id);
            b.textContent = "‚óè";
            cell.appendChild(b);
          });
        }
        cell.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          cell.classList.add('drag-over');
        });
        cell.addEventListener('dragleave', (e) => {
          cell.classList.remove('drag-over');
        });
        cell.addEventListener('drop', async (e) => {
          e.preventDefault();
          cell.classList.remove('drag-over');
          const noteId = e.dataTransfer.getData("application/note-id");
          if (noteId) {
            const oldDStr = notesDataCache[noteId]?.assignedDate;
            try {
              await db.collection('notas').doc(noteId).update({
                assignedDate: dStr
              });
              if (notesDataCache[noteId]) notesDataCache[noteId].assignedDate = dStr;
              else notesDataCache[noteId] = {
                assignedDate: dStr
              };
              if (oldDStr && assignedDatesCache[oldDStr]) {
                assignedDatesCache[oldDStr] = assignedDatesCache[oldDStr].filter(id => id !== noteId);
                if (assignedDatesCache[oldDStr].length === 0) delete assignedDatesCache[oldDStr];
              }
              if (!assignedDatesCache[dStr]) assignedDatesCache[dStr] = [];
              if (!assignedDatesCache[dStr].includes(noteId)) assignedDatesCache[dStr].push(noteId);
              const bubbleInC = document.getElementById(`bubble-${noteId}`);
              if (bubbleInC) bubbleInC.style.display = 'none';
              generateCalendar(currentCalendarMonth, currentCalendarYear);
            } catch (err) {
              console.error(`Err assign date ${noteId}:`, err);
              alert("Error.");
            }
          }
        });
        datesG.appendChild(cell);
      }
      const totalC = firstD + daysInM;
      const cellsN = totalC <= 35 ? 35 : 42;
      for (let i = totalC; i < cellsN; i++) {
        const e = document.createElement('div');
        e.className = 'calendar-date empty';
        datesG.appendChild(e);
      }
      calDiv.appendChild(datesG);
      currentCalendarMonth = month;
      currentCalendarYear = year;
    }

    const calendarIconElem = document.getElementById('calendarIcon');
    const calendarWidgetElem = document.getElementById('calendarWidget');
    let calendarTimeout;

    function showCalendar() {
      if (!calendarWidgetElem) return;
      clearTimeout(calendarTimeout);
      if (calendarWidgetElem.style.display !== 'block') {
        const { month, year } = initCalendarDate();
        generateCalendar(month, year);
        calendarWidgetElem.style.display = 'block';
      }
    }

    function hideCalendar() {
      if (!calendarWidgetElem) return;
      calendarTimeout = setTimeout(() => {
        calendarWidgetElem.style.display = 'none';
      }, 300);
    }

    if (calendarIconElem) {
      calendarIconElem.addEventListener('mouseenter', showCalendar);
      calendarIconElem.addEventListener('mouseleave', hideCalendar);
    }

    if (calendarWidgetElem) {
      calendarWidgetElem.addEventListener('mouseenter', () => clearTimeout(calendarTimeout));
      calendarWidgetElem.addEventListener('mouseleave', hideCalendar);
    }

    function openCalendar() {
      showCalendar();
    }

    let originalDragX = null;
    let originalDragY = null;
    
    // --- NUEVO C√ìDIGO PARA LOGIN/LOGOUT ---

// Referencias a los elementos HTML del login/logout que a√±adiste antes
const loginFormDiv = document.getElementById('login-form');
const userInfoDiv = document.getElementById('user-info');
const userEmailDisplay = document.getElementById('user-email-display');
const loginButton = document.getElementById('login-button');
const logoutButton = document.getElementById('logout-button');
const emailInput = document.getElementById('login-email');
const passwordInput = document.getElementById('login-password');

let unsubscribeFirestore = null; // Importante: para poder parar de escuchar notas

// Esto se ejecuta AUTOM√ÅTICAMENTE cuando alguien inicia o cierra sesi√≥n
auth.onAuthStateChanged(user => {
  if (user) {
   // Pega ESTO COMPLETO dentro del if(user), despu√©s de userEmailDisplay.textContent = ...;

if (!unsubscribeFirestore) { // Para evitar iniciar m√∫ltiples listeners
    console.log("(Auth) Iniciando listener de Firestore..."); // Log para saber que empieza

    unsubscribeFirestore = db.collection('notas').onSnapshot((snapshot) => {
        if (!grid) {
          console.error("(Auth) GridStack no inicializado dentro del listener.");
          return;
        }
        console.log("(Auth) Datos recibidos de Firestore."); // Log para saber que llegan datos
        let needsCalendarUpdate = false;

        snapshot.docChanges().forEach((change) => {
          const noteId = change.doc.id;
          const notaData = change.doc.data();
          console.log(`(Auth) Cambio detectado: Tipo=${change.type}, ID=${noteId}`);

          const widgetElement = grid.engine.nodes.find(n => n.id === noteId)?.el; // Busca el elemento una vez

          if (change.type === "added") {
            if (!widgetElement) {
              console.log(`(Auth) A√±adiendo widget para ${noteId}`);
              const result = mostrarNotaEnPantalla(change.doc); // Usas tu funci√≥n
              if (result) {
                grid.addWidget(result.element, result.position);
                notesDataCache[noteId] = notaData; // Guarda en cach√©
                if (notaData.assignedDate) needsCalendarUpdate = true;
              }
            } else {
              console.log(`(Auth) 'added' pero widget ${noteId} ya exist√≠a. Actualizando datos por si acaso.`);
              // Actualiza por si acaso hubo un error antes
              if (widgetElement) widgetElement.docData = notaData;
              notesDataCache[noteId] = notaData;
            }
          } else if (change.type === "modified") {
            console.log(`(Auth) Modificando widget para ${noteId}`);
            if (widgetElement) {
              const oldData = widgetElement.docData || {};
              // --- Tu l√≥gica de modificar el widget (texto, imagen, burbuja, etc.) ---
              const noteContentElement = widgetElement.querySelector('.note-content');
              const newText = notaData.url ? (notaData.texto || '') : (notaData.nota || '');
              if (noteContentElement && newText !== (oldData.texto || oldData.nota || '')) { // Compara con data vieja
                 console.log(`(Auth) - Actualizando texto para ${noteId}`);
                 noteContentElement.innerHTML = linkify(newText); // Usa tu funci√≥n
                 // ... c√≥digo para links target=_blank ...
              }
              if (notaData.url && notaData.url !== oldData.url) {
                 // ... c√≥digo para actualizar imagen ...
              }
              const bubbleButton = widgetElement.querySelector(`#bubble-${noteId}`);
              // ... c√≥digo para mostrar/ocultar burbuja ...
              // --- Fin l√≥gica de modificar ---
              if (notaData.assignedDate !== oldData.assignedDate) {
                 needsCalendarUpdate = true;
              }
              widgetElement.docData = notaData; // Guarda data nueva en el elemento
              notesDataCache[noteId] = notaData; // Actualiza cach√©
            } else {
              console.warn(`(Auth) Se recibi√≥ 'modified' para ${noteId}, pero no se encontr√≥ widget.`);
            }
          } else if (change.type === "removed") {
            console.log(`(Auth) Eliminando widget para ${noteId}`);
            if (widgetElement) {
              grid.removeWidget(widgetElement);
              if (notesDataCache[noteId]?.assignedDate) needsCalendarUpdate = true;
              delete notesDataCache[noteId]; // Elimina de cach√©
              displayedNotes.delete(noteId); // Elimina del Map si lo usas as√≠
            } else {
              console.warn(`(Auth) Se recibi√≥ 'removed' para ${noteId}, pero no se encontr√≥ widget.`);
            }
          }
        }); // Fin forEach

        // L√≥gica para actualizar calendario (igual que antes)
        if (needsCalendarUpdate && typeof generateCalendar === 'function' && currentCalendarMonth !== undefined) {
           console.log("(Auth) Actualizando calendario...");
           if (typeof fetchAllAssignedNotes === 'function') {
               fetchAllAssignedNotes().then(() => {
                  generateCalendar(currentCalendarMonth, currentCalendarYear);
               });
           } else { console.error("Funcion fetchAllAssignedNotes no definida"); }
        } else if (needsCalendarUpdate && typeof fetchAllAssignedNotes === 'function') {
           fetchAllAssignedNotes();
        }

    }, (error) => { // Manejo de error del listener
        console.error("(Auth) Error escuchando Firestore:", error);
        alert("Error al cargar/actualizar notas: " + error.message);
        // Si el error es de permisos, cerramos sesi√≥n para evitar problemas
        if (error.code === 'permission-denied') {
            console.warn("Permiso denegado por Firestore. Cerrando sesi√≥n.");
            auth.signOut();
        }
    }); // Fin del onSnapshot
} // Fin del if (!unsubscribeFirestore)
// Aseg√∫rate que estas variables est√©n definidas ANTES de este bloque:
    const loginFormDiv = document.getElementById('login-form');
    const userInfoDiv = document.getElementById('user-info');
    const userEmailDisplay = document.getElementById('user-email-display');
    let unsubscribeFirestore = null; // Debe estar definida afuera para que persista
    // const grid = ... // Tu variable grid ya debe existir
    // const displayedNotes = ... // Tu Map ya debe existir
    // const notesDataCache = ... // Tu objeto cache ya debe existir
    // const assignedDatesCache = ... // Tu objeto cache calendario ya debe existir
    // const calendarWidgetElem = ... // El elemento del calendario ya debe existir

    // --- COMIENZA EL BLOQUE onAuthStateChanged COMPLETO Y CORREGIDO ---
    auth.onAuthStateChanged(user => {
      if (user) {
        // --- USUARIO CONECTADO ---
        console.log('Usuario conectado:', user.email);
        // Actualiza la UI para mostrar estado logueado
        if (loginFormDiv) loginFormDiv.style.display = 'none';
        if (userInfoDiv) userInfoDiv.style.display = 'block';
        if (userEmailDisplay) userEmailDisplay.textContent = user.email;

        // Iniciar listener de notas si no est√° activo
        if (!unsubscribeFirestore) {
            console.log("(Auth) Iniciando listener de Firestore...");

            unsubscribeFirestore = db.collection('notas').onSnapshot((snapshot) => {
                // Verifica si grid existe aqu√≠ tambi√©n, por si acaso
                if (!grid) {
                  console.error("(Auth) GridStack no inicializado dentro del listener.");
                  return;
                }
                console.log("(Auth) Datos recibidos de Firestore.");
                let needsCalendarUpdate = false; // Resetear flag en cada snapshot

                snapshot.docChanges().forEach((change) => {
                  const noteId = change.doc.id;
                  const notaData = change.doc.data();
                  console.log(`(Auth) Cambio detectado: Tipo=${change.type}, ID=${noteId}`);

                  const widgetElement = grid.engine.nodes.find(n => n.id === noteId)?.el; // Busca el elemento una vez

                  if (change.type === "added") {
                    if (!widgetElement) {
                      console.log(`(Auth) A√±adiendo widget para ${noteId}`);
                      // Aseg√∫rate que mostrarNotaEnPantalla est√© definida antes
                      if (typeof mostrarNotaEnPantalla === 'function') {
                          const result = mostrarNotaEnPantalla(change.doc);
                          if (result) {
                            grid.addWidget(result.element, result.position);
                            // Actualiza tus caches/registros internos
                            notesDataCache[noteId] = notaData;
                            displayedNotes.set(noteId, result.element);
                            if (notaData.assignedDate) needsCalendarUpdate = true;
                          }
                      } else { console.error("Funci√≥n mostrarNotaEnPantalla no definida"); }
                    } else {
                      console.log(`(Auth) 'added' pero widget ${noteId} ya exist√≠a. Verificando/actualizando datos.`);
                      // Si ya existe, asegura que la data interna est√© actualizada
                      if (widgetElement) widgetElement.docData = notaData;
                      notesDataCache[noteId] = notaData;
                      // Compara fecha por si cambi√≥ justo y necesitas actualizar calendario
                      if (notaData.assignedDate !== (widgetElement?.docData?.assignedDate)) {
                          needsCalendarUpdate = true;
                      }
                    }
                  } else if (change.type === "modified") {
                    console.log(`(Auth) Modificando widget para ${noteId}`);
                    if (widgetElement) {
                      const oldData = widgetElement.docData || {};
                      // --- L√≥gica para actualizar el widget existente ---
                       const noteContentElement = widgetElement.querySelector('.note-content');
                       const newText = notaData.url ? (notaData.texto || '') : (notaData.nota || '');
                       // Compara data vieja con nueva antes de actualizar DOM innecesariamente
                       if (noteContentElement && newText !== (oldData.texto || oldData.nota || '')) {
                           console.log(`(Auth) - Actualizando texto para ${noteId}`);
                           // Aseg√∫rate que linkify est√© definida
                           if(typeof linkify === 'function') {
                               noteContentElement.innerHTML = linkify(newText);
                               Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
                                    link.setAttribute('target', '_blank');
                                    link.setAttribute('rel', 'noopener noreferrer');
                               });
                           } else { console.error("Funci√≥n linkify no definida"); noteContentElement.textContent = newText; }
                       }
                       if (notaData.url && notaData.url !== oldData.url) {
                           console.log(`(Auth) - Actualizando URL imagen para ${noteId}`);
                           const img = widgetElement.querySelector('.image-container img');
                           if (img) img.src = notaData.url;
                       }
                       // Actualiza visibilidad de burbuja de calendario
                       const bubbleButton = widgetElement.querySelector(`#bubble-${noteId}`);
                       if (bubbleButton) {
                            const needsBubble = !notaData.assignedDate;
                            const isBubbleVisible = bubbleButton.style.display !== 'none';
                            if (needsBubble && !isBubbleVisible) {
                                console.log(`(Auth) - Mostrando burbuja para ${noteId}`);
                                bubbleButton.style.display = 'inline-block';
                            } else if (!needsBubble && isBubbleVisible) {
                                console.log(`(Auth) - Ocultando burbuja para ${noteId}`);
                                bubbleButton.style.display = 'none';
                            }
                       }
                      // --- Fin l√≥gica modificar ---
                      if (notaData.assignedDate !== oldData.assignedDate) {
                         needsCalendarUpdate = true; // Marcar para actualizar calendario si fecha cambi√≥
                      }
                      widgetElement.docData = notaData; // Actualiza data en el elemento DOM
                      notesDataCache[noteId] = notaData; // Actualiza cach√© general
                    } else {
                      console.warn(`(Auth) Se recibi√≥ 'modified' para ${noteId}, pero widget no encontrado.`);
                      // Actualiza el cache de todos modos
                      notesDataCache[noteId] = notaData;
                      // Podr√≠as intentar a√±adirlo si no existe, o marcar para recargar calendario
                      needsCalendarUpdate = true;
                    }
                  } else if (change.type === "removed") {
                     console.log(`(Auth) Eliminando widget para ${noteId}`);
                     if (widgetElement) {
                        grid.removeWidget(widgetElement); // Elimina del grid
                        if (notesDataCache[noteId]?.assignedDate) needsCalendarUpdate = true;
                        delete notesDataCache[noteId]; // Elimina de cach√© general
                        displayedNotes.delete(noteId); // Elimina del Map si lo usas
                        // Aseg√∫rate de quitar burbujas del calendario si exist√≠an
                        document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
                     } else {
                       console.warn(`(Auth) Se recibi√≥ 'removed' para ${noteId}, pero widget no encontrado en grid.`);
                       // Limpia caches por si acaso
                       delete notesDataCache[noteId];
                       displayedNotes.delete(noteId);
                       document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
                       needsCalendarUpdate = true; // Forzar update calendario
                     }
                  }
                }); // Fin forEach

                // L√≥gica para actualizar calendario si hubo cambios relevantes
                if (needsCalendarUpdate && typeof generateCalendar === 'function' && currentCalendarMonth !== undefined) {
                  console.log("(Auth) Actualizando calendario porque needsCalendarUpdate es true.");
                  // Llama a tus funciones de calendario
                  if (typeof fetchAllAssignedNotes === 'function') {
                      fetchAllAssignedNotes().then(() => {
                         // Aseg√∫rate que generateCalendar est√© definida
                         generateCalendar(currentCalendarMonth, currentCalendarYear);
                      });
                  } else { console.error("Funcion fetchAllAssignedNotes no definida"); }
                } else if (needsCalendarUpdate && typeof fetchAllAssignedNotes === 'function') {
                   // Si el calendario no est√° visible pero hubo cambios, al menos recarga los datos
                  fetchAllAssignedNotes();
                }

            }, (error) => { // Manejo de error del listener onSnapshot
                console.error("(Auth) Error escuchando Firestore:", error);
                alert("Error al cargar/actualizar notas: " + error.message);
                // Si el error es por falta de permisos, cerramos sesi√≥n autom√°ticamente
                if (error.code === 'permission-denied') {
                    console.warn("Permiso denegado por Firestore. Cerrando sesi√≥n.");
                    auth.signOut(); // Cierra sesi√≥n para evitar bucle de errores
                }
            }); // Fin del onSnapshot
            console.log("(Auth) Listener de Firestore ACTIVADO.");
        } // Fin del if (!unsubscribeFirestore)

      } else {
        // --- USUARIO DESCONECTADO ---
        console.log('Nadie conectado. Limpiando...');
        // Actualiza la UI para mostrar estado no logueado
        if (loginFormDiv) loginFormDiv.style.display = 'block';
        if (userInfoDiv) userInfoDiv.style.display = 'none';

        // Detener listener y limpiar pantalla/caches
        if (unsubscribeFirestore) {
          unsubscribeFirestore(); // Llama a la funci√≥n para detener escucha
          unsubscribeFirestore = null; // Resetea la variable
          console.log("Listener de notas DETENIDO.");
        }
        if (grid) {
          grid.removeAll(true); // Limpia todas las notas del grid (true para no animar)
          console.log("Grid limpiado.");
        }
        // Limpia variables/caches internos
        displayedNotes.clear(); // Limpia Map si lo usas
        notesDataCache = {};
        assignedDatesCache = {};
        // Opcional: resetear calendario
        if (calendarWidgetElem) calendarWidgetElem.style.display = 'none';
      } 
    // Fin del else (usuario desconectado)
    }); // Fin del onAuthStateChanged
    // --- FIN BLOQUE onAuthStateChanged ---

// --- C√≥digo para los Botones de Login/Logout (ASEG√öRATE DE TENERLO) ---

    // Estas variables ya deber√≠an estar definidas m√°s arriba con los getElementById
    // const loginButton = document.getElementById('login-button');
    // const logoutButton = document.getElementById('logout-button');
    // const emailInput = document.getElementById('login-email');
    // const passwordInput = document.getElementById('login-password');

     /* if (loginButton && emailInput && passwordInput) {
        loginButton.addEventListener('click', () => {
          const email = emailInput.value;
          const password = passwordInput.value;
          if (!email || !password) {
              return alert('Ingresa correo y contrase√±a');
          }
          // Intenta iniciar sesi√≥n
          auth.signInWithEmailAndPassword(email, password)
              .then(userCredential => {
                  console.log('Login OK desde bot√≥n para:', userCredential.user.email);
                  // No necesitas hacer nada m√°s aqu√≠, onAuthStateChanged se encarga
              })
              .catch(error => {
                  console.error('Error Login Bot√≥n:', error);
                  alert('Error al iniciar sesi√≥n: ' + error.message);
              });
        });
    } else {
        console.error("Error: Falta el bot√≥n de login o los inputs en el HTML o en las variables JS.");
    }

    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
          // Intenta cerrar sesi√≥n
          auth.signOut()
              .then(() => {
                 console.log('Logout OK desde bot√≥n.');
                 // No necesitas hacer nada m√°s aqu√≠, onAuthStateChanged se encarga
              })
              .catch(error => {
                 console.error('Error Logout Bot√≥n:', error);
                 alert('Error al cerrar sesi√≥n.');
              });
        });
    } else {
        console.error("Error: Falta el bot√≥n de logout en el HTML o en la variable JS.");
    }  // --- FIN C√≥digo para los Botones ---
  </script>
</body>
</html>
