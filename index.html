<!DOCTYPE html>
<html lang="es">

<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Notas OceÃ¡nicas - Polaroid</title>
Â  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
Â  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
Â <style>

Â  Â 
/* Estilo para notas de IMAGEN mientras se arrastran: SOMBRA A (distinta) */
.grid-stack-item[data-note-type="imagen"].grid-stack-item-dragging {
Â  opacity: 0.7 !important;
Â  border: 3px dashed red !important; /* Borde rojo claro */
Â  background-color: rgba(255, 0, 0, 0.3) !important; /* Fondo rojo semi-transparente */
Â  box-shadow: none !important;
}

/* Estilo para notas de TEXTO (con o sin link) mientras se arrastran: SOMBRA B (igual) */
.grid-stack-item[data-note-type="texto"].grid-stack-item-dragging {
Â  opacity: 0.7 !important;
Â  border: 3px dashed green !important; /* Borde verde */
Â  background-color: rgba(0, 255, 0, 0.3) !important; /* Fondo verde semi-transparente */
Â  box-shadow: none !important;
}
/* Ocultar el placeholder de GridStack */
.grid-stack-placeholder {
Â  display: none !important;
}
/* Estilos CSS base y layout */
html,
body {
Â  margin: 0;
Â  padding: 0;
Â  height: 100vh;
Â  overflow: hidden;
Â  background: linear-gradient(to bottom, #a2dff7 0%, #a2dff7 40%, #03254c 100%);
Â  font-family: Arial, sans-serif;
}

.container {
Â  height: 100%;
Â  width: 100%;
Â  display: flex;
Â  flex-direction: column;
Â  position: relative;
Â  overflow: hidden;
}

#notaDisplay {
Â  flex-grow: 1;
Â  width: 100%;
Â  overflow-y: auto;
Â  overflow-x: hidden;
Â  position: relative;
Â  min-width: 1000px;
}

.grid-stack-item {
Â  transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
Â  overflow: visible !important;
Â  margin-bottom: 1cm; /* Espacio adicional debajo de cada nota */
}

.grid-stack-item-content {
Â  overflow: visible !important;
Â  height: auto;
Â  width: 100%;
Â  display: flex;
Â  flex-direction: column;
}

.card-wrapper,
.text-card {
Â  background-color: #fff;
Â  border: 2px solid #0077a3;
Â  border-radius: 8px;
Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
Â  /* Eliminado width/height fijo */
Â  display: flex;
Â  flex-direction: column;
Â  position: relative;
Â  box-sizing: border-box;
}

.image-container {
Â  width: 100%;
Â  height: 100%; /* Cambiado a 100% para que se ajuste a GridStack item */
Â  overflow: hidden;
Â  position: relative;
Â  flex-shrink: 0;
}

.image-container img {
Â  width: 100%;
Â  height: 100%;
Â  object-fit: cover;
Â  display: block;
}

.note-content {
Â  background-color: #fff;
Â  padding: 10px;
Â  text-align: left;
Â  font-size: 16px;
Â  color: #333;
Â  min-height: 50px;
Â  box-sizing: border-box;
Â  word-wrap: break-word;
Â  overflow: hidden;
Â  flex-grow: 1;
}

.note-content a {
Â  color: #0077a3;
Â  text-decoration: underline;
}

.menu-bar {
Â  background-color: #0288D1;
Â  padding: 5px 8px;
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  flex-shrink: 0;
Â  border-top: 1px solid #0077a3;
Â  border-bottom-left-radius: 6px;
Â  border-bottom-right-radius: 6px;
}

.menu-icon {
Â  background: none;
Â  border: none;
Â  font-size: 20px;
Â  color: #fff;
Â  cursor: pointer;
Â  padding: 2px 4px;
}

.bubble-icon {
Â  color: #FFCD05;
Â  font-size: 22px;
}

.menu-actions {
Â  display: flex;
Â  gap: 4px;
}

#addNoteButton {
Â  position: absolute;
Â  bottom: 30px;
Â  right: 30px;
Â  background-color: #006994;
Â  color: #fff;
Â  border: none;
Â  border-radius: 50%;
Â  width: 60px;
Â  height: 60px;
Â  font-size: 30px;
Â  display: flex;
Â  justify-content: center;
Â  align-items: center;
Â  cursor: pointer;
Â  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
Â  transition: background-color 0.3s ease, transform 0.3s ease;
Â  z-index: 1001;
}

#addNoteButton:hover {
Â  background-color: #005577;
Â  transform: scale(1.05);
}

#addNoteOptions {
Â  position: fixed;
Â  top: 50%;
Â  left: 50%;
Â  transform: translate(-50%, -50%);
Â  background-color: rgba(0, 0, 0, 0.85);
Â  border-radius: 10px;
Â  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
Â  display: none;
Â  flex-direction: row;
Â  justify-content: center;
Â  align-items: center;
Â  gap: 25px;
Â  padding: 25px;
Â  z-index: 1002;
}

#addNoteOptions .card {
Â  background-color: #2c2c2c;
Â  border: 1px solid #0077a3;
Â  border-radius: 8px;
Â  padding: 20px;
Â  text-align: center;
Â  cursor: pointer;
Â  transition: transform 0.2s ease, box-shadow 0.2s ease;
Â  width: 180px;
}

#addNoteOptions .card:hover {
Â  transform: translateY(-5px) scale(1.03);
Â  box-shadow: 0 6px 12px rgba(0, 119, 163, 0.5);
}

#addNoteOptions .card h2 {
Â  color: #36a2eb;
Â  margin-bottom: 10px;
}

#addNoteOptions .card p {
Â  color: #ccc;
Â  font-size: 14px;
}

#inputArea {
Â  position: fixed;
Â  top: 50%;
Â  left: 50%;
Â  transform: translate(-50%, -50%);
Â  background-color: #ffffff;
Â  padding: 25px 30px;
Â  border-radius: 8px;
Â  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
Â  display: none;
Â  flex-direction: column;
Â  gap: 15px;
Â  width: 90%;
Â  max-width: 550px;
Â  z-index: 1002;
}

#inputArea label {
Â  font-weight: bold;
Â  color: #333;
Â  margin-bottom: 3px;
Â  font-size: 14px;
}

#inputArea textarea,
#inputArea input[type="text"] {
Â  padding: 12px;
Â  border: 1px solid #ccc;
Â  border-radius: 4px;
Â  resize: vertical;
Â  width: 100%;
Â  box-sizing: border-box;
Â  line-height: 1.5;
Â  font-size: 16px;
}

#inputArea textarea {
Â  min-height: 80px;
}

#inputArea textarea#textNote {
Â  min-height: 120px;
}

#inputArea button {
Â  padding: 10px 20px;
Â  background-color: #006994;
Â  color: #fff;
Â  border: none;
Â  border-radius: 4px;
Â  cursor: pointer;
Â  transition: background-color 0.3s ease, transform 0.1s ease;
Â  align-self: flex-end;
Â  margin-top: 10px;
Â  font-size: 16px;
Â  font-weight: bold;
}

#inputArea button:hover {
Â  background-color: #005577;
}

#inputArea button:active {
Â  transform: scale(0.98);
}

.input-group {
Â  display: flex;
Â  flex-direction: column;
Â  gap: 5px;
}

.calendar-icon {
Â  position: absolute;
Â  bottom: 30px;
Â  left: 30px;
Â  width: 45px;
Â  height: 45px;
Â  background-color: #fff;
Â  border: 1px solid #ccc;
Â  border-radius: 50%;
Â  display: flex;
Â  justify-content: center;
Â  align-items: center;
Â  color: #333;
Â  font-size: 24px;
Â  cursor: pointer;
Â  z-index: 1001;
Â  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.calendar-widget {
Â  position: absolute;
Â  bottom: 85px;
Â  left: 20px;
Â  background: #fff;
Â  border: 1px solid #ddd;
Â  border-radius: 6px;
Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
Â  padding: 15px;
Â  display: none;
Â  z-index: 1001;
Â  width: 320px;
Â  min-height: 300px;
}

.calendar-header {
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  margin-bottom: 15px;
}

.calendar-header button {
Â  background: none;
Â  border: none;
Â  cursor: pointer;
Â  font-size: 20px;
Â  color: #0077a3;
Â  padding: 5px 8px;
Â  border-radius: 4px;
Â  transition: background-color 0.2s ease;
}

.calendar-header button:hover:not(:disabled) {
Â  background-color: #e0f7fa;
}

.calendar-header button:disabled {
Â  color: #ccc;
Â  cursor: default;
}

.calendar-header span {
Â  font-weight: bold;
Â  color: #333;
Â  font-size: 18px;
}

.calendar-days-header,
.calendar-dates-grid {
Â  display: grid;
Â  grid-template-columns: repeat(7, 1fr);
Â  text-align: center;
Â  gap: 6px;
}

.calendar-days-header {
Â  margin-bottom: 10px;
Â  font-weight: bold;
Â  color: #555;
Â  padding-bottom: 8px;
Â  border-bottom: 1px solid #eee;
Â  font-size: 13px;
}

.calendar-day {
Â  padding: 3px;
}

.calendar-date {
Â  padding: 0;
Â  border-radius: 50%;
Â  color: #333;
Â  border: 2px solid transparent;
Â  cursor: pointer;
Â  position: relative;
Â  width: 36px;
Â  height: 36px;
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;
Â  margin: 0 auto;
Â  line-height: 1;
Â  font-size: 14px;
Â  transition: background-color 0.2s ease, border-color 0.2s ease;
}

.calendar-date.empty {
Â  background: none;
Â  cursor: default;
Â  opacity: 0;
}

.calendar-date:not(.empty):hover {
Â  background-color: #e0f7fa;
Â  border-color: #b3e5fc;
}

.calendar-date.today {
Â  border-color: #0077a3;
Â  font-weight: bold;
Â  color: #005577;
}

.calendar-date.drag-over {
Â  background-color: #a2dff7 !important;
Â  border-color: #0077a3 !important;
}

.assigned-bubble {
Â  color: #FFCD05;
Â  font-size: 11px;
Â  position: absolute;
Â  bottom: 3px;
Â  left: 50%;
Â  transform: translateX(-50%);
Â  line-height: 1;
Â  text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
Â  pointer-events: none;
}

.calendar-date .assigned-bubble+.assigned-bubble {
Â  bottom: -2px;
}

.blur-background {
Â  position: fixed;
Â  top: 0;
Â  left: 0;
Â  width: 100%;
Â  height: 100%;
Â  background: rgba(0, 0, 0, 0.6);
Â  backdrop-filter: blur(6px);
Â  -webkit-backdrop-filter: blur(6px);
Â  display: none;
Â  z-index: 1000;
Â  cursor: pointer;
}
</style>
</head>

<body>
Â  <div class="container">
Â  Â  <div id="notaDisplay" class="grid-stack"></div>
Â  Â  <button id="addNoteButton" title="AÃ±adir nueva nota o imagen">+</button>
Â  Â  <div id="addNoteOptions">
Â  Â  Â  <div class="card" id="addImageLinkOption" title="AÃ±adir una nota con imagen desde un enlace web">
Â  Â  Â  Â  <h2>ğŸ–¼ï¸ Imagen</h2>
Â  Â  Â  Â  <p>Guardar link de imagen.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="card" id="addTextNoteOption" title="AÃ±adir una nota de texto simple">
Â  Â  Â  Â  <h2>ğŸ“ Nota</h2>
Â  Â  Â  Â  <p>Subir nota de texto.</p>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="inputArea">
Â  Â  Â  <div id="imageLinkInputArea" style="display: none;">
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="imageLink">Link de la imagen:</label>
Â  Â  Â  Â  Â  <input type="text" id="imageLink" placeholder="Pega aquÃ­ la URL de la imagen (ej: https://...)" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="imageNoteText">Texto adicional (opcional):</label>
Â  Â  Â  Â  Â  <textarea id="imageNoteText" placeholder="Escribe aquÃ­ una descripciÃ³n o nota relacionada con la imagen..." rows="3"></textarea>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="saveImageLink">Guardar Imagen</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="textNoteInputArea" style="display: none;">
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="textNote">Nota:</label>
Â  Â  Â  Â  Â  <textarea id="textNote" placeholder="Escribe tu nota aquÃ­..." rows="5"></textarea>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="saveTextNote">Guardar Nota</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">ğŸ“…</div>
Â  Â  <div id="calendarWidget" class="calendar-widget"></div>
Â  Â  <div class="blur-background"></div>
Â  </div>
Â  <script>
Â  Â  /****************** Utilidades y ConfiguraciÃ³n de Firebase ******************/
Â  Â  function linkify(text) {
Â  Â  Â  if (!text) return "";
Â  Â  Â  const urlRegex = /(?<!href=["'])(https?:\/\/[^\s<>"']+)/g;
Â  Â  Â  const replacedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
Â  Â  Â  return replacedText.replace(/\n/g, '<br>');
Â  Â  }
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCHa373WgLLHsy8wZXK9zr_HVieQvlrhUs",
Â  Â  Â  authDomain: "oasis-b036d.firebaseapp.com",
Â  Â  Â  projectId: "oasis-b036d",
Â  Â  Â  storageBucket: "oasis-b036d.appspot.com",
Â  Â  Â  messagingSenderId: "141546637821",
Â  Â  Â  appId: "1:141546637821:web:0a861aeb13831774ed3194",
Â  Â  Â  measurementId: "G-HB2P17H5YL"
Â  Â  };
Â  Â  try {
Â  Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  } catch (e) {
Â  Â  Â  console.error("Error inicializando Firebase:", e);
Â  Â  }
Â  Â  const db = firebase.firestore();
Â  Â  /****************** InicializaciÃ³n de GridStack ******************/
Â  Â  let grid;
Â  Â  try {
Â  Â  Â  grid = GridStack.init({
Â  Â  Â  Â  column: 12, // Permitir movimiento horizontal
Â  Â  Â  Â  margin: 10, // Margen entre elementos
Â  Â  Â  Â  cellHeight: '80px', // Altura de cada celda
Â  Â  Â  Â  disableResize: true, // Deshabilitar redimensionamiento
Â  Â  Â  Â  float: true,
Â  Â  Â  Â  animate: true,
Â  Â  Â  Â  alwaysShowResizeHandle: false,
Â  Â  Â  Â  draggable: {
Â  Â  Â  Â  Â  handle: '.menu-bar',
Â  Â  Â  Â  Â  scroll: true,
Â  Â  Â  Â  Â  appendTo: 'body'
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  } catch (e) {
Â  Â  Â  console.error("Error inicializando GridStack:", e);
Â  Â  Â  alert("Error al iniciar el Ã¡rea de notas.");
Â  Â  }
Â  Â  /****************** Escucha de Cambios en GridStack (Drag/Drop) ******************/
Â  Â  if (grid) { // AsegÃºrate que grid se inicializÃ³ bien
Â  Â  Â  // Listener para el evento 'change' (cuando algo cambia en el grid, INCLUYENDO drag/drop)
Â  Â  Â  grid.on('change', function (event, items) {
Â  Â  Â  Â  console.log("Evento 'change' de GridStack disparado.");
Â  Â  Â  Â  items.forEach(function (item) {
Â  Â  Â  Â  Â  // Intentamos obtener el ID de la nota del atributo data-note-id
Â  Â  Â  Â  Â  const noteId = item.el?.getAttribute('data-note-id') || item.id || '(desconocido)';
Â  Â  Â  Â  Â  console.log(` - Nota ID: <span class="math-inline">\{noteId\}, PosiciÃ³n final segÃºn GridStack\: x\=</span>{item.x}, y=<span class="math-inline">\{item\.y\}, w\=</span>{item.w}, h=${item.h}`);
Â  Â  Â  Â  Â  // IMPORTANTE: AquÃ­ es donde deberÃ­amos guardar la posiciÃ³n final en Firestore
Â  Â  Â  Â  Â  // si GridStack es quien decide la posiciÃ³n final despuÃ©s de un drag/drop.
Â  Â  Â  Â  Â  const noteIdToSave = item.el?.getAttribute('data-note-id');
Â  Â  Â  Â  Â  // Guardamos si tenemos datos vÃ¡lidos. PodrÃ­amos necesitar mÃ¡s lÃ³gica para evitar guardar
Â  Â  Â  Â  Â  // en cambios que no son de drag/drop si eso causa problemas.
Â  Â  Â  Â  Â  if (noteIdToSave && typeof item.x === 'number' && typeof item.y === 'number') {
Â  Â  Â  Â  Â  Â  console.log(`Â  Â (Considerando guardar x:<span class="math-inline">\{item\.x\}, y\:</span>{item.y} para ${noteIdToSave} en Firestore desde 'change')`);
Â  Â  Â  Â  Â  Â  // DESCOMENTA la lÃ­nea de abajo para activar el guardado automÃ¡tico desde aquÃ­ (QUITANDO // ):
Â  Â  Â  Â  Â  Â  db.collection('notas').doc(noteIdToSave).update({
Â  Â  Â  Â  Â  Â  Â  x: item.x,
Â  Â  Â  Â  Â  Â  Â  y: item.y
Â  Â  Â  Â  Â  Â  }).catch(err => console.error(`Error guardando posiciÃ³n desde 'change': ${err}`));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  // Listener para 'dragstop' (solo para ver dÃ³nde se suelta inicialmente)
Â  Â  Â  grid.on('dragstop', function (event, element) {
Â  Â  Â  Â  const node = grid.engine.nodes.find(n => n.el === element); //
Â  Â  Â  Â  if (node) {
Â  Â  Â  Â  Â  const noteId = node.el?.getAttribute('data-note-id') || node.id || '(desconocido)';
Â  Â  Â  Â  Â  console.log(`Evento 'dragstop': Nota ID: <span class="math-inline">\{noteId\} soltada en x\=</span>{node.x}, y=${node.y}`);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  // LÃ­nea de verificaciÃ³n para saber si estos listeners se aÃ±adieron
Â  Â  Â  console.log(">>> LISTENER ATTACHED TO GRID <<<");
Â  Â  } // Fin del if (grid)
Â  Â  /****************** Utilidades UI (Scroll, Resize Textarea) ******************/
Â  Â  const gridContainer = document.getElementById('notaDisplay');
Â  Â  if (gridContainer) gridContainer.addEventListener('wheel', (event) => {}, { passive: true });
Â  Â  function autoResizeTextarea(el) { if (!el) return; el.style.height = 'auto'; el.style.height = (el.scrollHeight + 2) + 'px'; }
Â  Â  const textNoteInputElem = document.getElementById('textNote');
Â  Â  const imageNoteTextElem = document.getElementById('imageNoteText');
Â  Â  if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
Â  Â  if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));
Â  Â  /****************** RenderizaciÃ³n, EdiciÃ³n y EliminaciÃ³n de Notas ******************/
Â  Â  const displayedNotes = new Map();
Â  Â  // --- FUNCIÃ“N PARA MOSTRAR NOTA ---
Â  Â  function mostrarNotaEnPantalla(doc) {
Â  Â  Â  const notaData = doc.data();
Â  Â  Â  const noteId = doc.id;
Â  Â  Â  let gridItem = document.createElement('div');
Â  Â  Â  gridItem.classList.add('grid-stack-item');
Â  Â  Â  gridItem.setAttribute('data-note-id', noteId);
Â  Â  Â  gridItem.setAttribute('data-note-type', notaData.tipo); //
Â  Â  Â  const content = document.createElement('div');
Â  Â  Â  content.classList.add('grid-stack-item-content');
Â  Â  Â  let card;
Â  Â  Â  let noteContentElement;
Â  Â  Â  if (notaData.url) { // Tarjeta Imagen
Â  Â  Â  Â  card = document.createElement('div');
Â  Â  Â  Â  card.classList.add('card-wrapper');
Â  Â  Â  Â  const imageContainer = document.createElement('div');
Â  Â  Â  Â  imageContainer.classList.add('image-container');
Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  img.src = notaData.url;
Â  Â  Â  Â  img.alt = notaData.texto || 'Imagen de la nota';
Â  Â  Â  Â  img.loading = 'lazy';
Â  Â  Â  Â  img.onerror = () => { imageContainer.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; background-color:#eee; color:red; text-align:center; padding:10px;">âš ï¸<br/>Error al<br/>cargar imagen</div>`; }
Â  Â  Â  Â  imageContainer.appendChild(img);
Â  Â  Â  Â  card.appendChild(imageContainer);
Â  Â  Â  Â  if (notaData.texto) {
Â  Â  Â  Â  Â  noteContentElement = document.createElement('div');
Â  Â  Â  Â  Â  noteContentElement.classList.add('note-content');
Â  Â  Â  Â  Â  noteContentElement.innerHTML = linkify(notaData.texto);
Â  Â  Â  Â  Â  card.appendChild(noteContentElement);
Â  Â  Â  Â  }
Â  Â  Â  } else if (notaData.nota) { // Tarjeta Texto
Â  Â  Â  Â  card = document.createElement('div');
Â  Â  Â  Â  card.classList.add('text-card');
Â  Â  Â  Â  noteContentElement = document.createElement('div');
Â  Â  Â  Â  noteContentElement.classList.add('note-content');
Â  Â  Â  Â  noteContentElement.innerHTML = linkify(notaData.nota);
Â  Â  Â  Â  card.appendChild(noteContentElement);
Â  Â  Â  } else {
Â  Â  Â  Â  return null;
Â  Â  Â  } // Nota vacÃ­a
Â  Â  Â  if (noteContentElement) {
Â  Â  Â  Â  Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
Â  Â  Â  Â  Â  link.setAttribute('target', '_blank');
Â  Â  Â  Â  Â  link.setAttribute('rel', 'noopener noreferrer');
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  // Barra de MenÃº
Â  Â  Â  const menuBar = document.createElement('div');
Â  Â  Â  menuBar.classList.add('menu-bar');
Â  Â  Â  const bubbleButton = document.createElement('button');
Â  Â  Â  bubbleButton.classList.add('menu-icon', 'bubble-icon');
Â  Â  Â  bubbleButton.innerHTML = 'â—';
Â  Â  Â  bubbleButton.setAttribute('draggable', 'true');
Â  Â  Â  bubbleButton.id = `bubble-${noteId}`;
Â  Â  Â  bubbleButton.title = "Arrastrar al calendario";
Â  Â  Â  bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';
Â  Â  Â  bubbleButton.addEventListener('dragstart', (e) => {
Â  Â  Â  Â  var imgGhost = new Image();
Â  Â  Â  Â  imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAABAAAAAECAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
Â  Â  Â  Â  e.dataTransfer.setDragImage(imgGhost, 0, 0);
Â  Â  Â  Â  e.dataTransfer.setData("application/note-id", noteId);
Â  Â  Â  Â  e.dataTransfer.effectAllowed = "move";
Â  Â  Â  Â  openCalendar();
Â  Â  Â  });
Â  Â  Â  bubbleButton.addEventListener('click', (e) => {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  openCalendar();
Â  Â  Â  });
Â  Â  Â  const menuActions = document.createElement('div');
Â  Â  Â  menuActions.classList.add('menu-actions');
Â  Â  Â  const editButton = document.createElement('button');
Â  Â  Â  editButton.classList.add('menu-icon');
Â  Â  Â  editButton.innerHTML = 'âœ';
Â  Â  Â  editButton.title = "Editar";
Â  Â  Â  const deleteButton = document.createElement('button');
Â  Â  Â  deleteButton.classList.add('menu-icon');
Â  Â  Â  deleteButton.innerHTML = 'âœ–';
Â  Â  Â  deleteButton.title = "Eliminar";
Â  Â  Â  // onclick de deleteButton (SIN confirmaciÃ³n)
Â  Â  Â  deleteButton.onclick = (e) => {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  if (typeof deleteNote === 'function') deleteNote(noteId, gridItem);
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  console.error("FunciÃ³n deleteNote no encontrada");
Â  Â  Â  Â  Â  alert("Error interno al eliminar.");
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  editButton.onclick = (e) => {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  if (typeof editNoteContent === 'function') editNoteContent(card, noteId, notaData, menuActions, editButton, deleteButton);
Â  Â  Â  Â  else console.error("FunciÃ³n editNoteContent no encontrada");
Â  Â  Â  };
Â  Â  Â  menuActions.appendChild(editButton);
Â  Â  Â  menuActions.appendChild(deleteButton);
Â  Â  Â  menuBar.appendChild(bubbleButton);
Â  Â  Â  menuBar.appendChild(menuActions);
Â  Â  Â  card.appendChild(menuBar);
Â  Â  Â  content.appendChild(card);
Â  Â  Â  gridItem.appendChild(content);
Â  Â  Â  // PosiciÃ³n Gridstack
Â  Â  Â  const pos = {
Â  Â  Â  Â  x: notaData.x,
Â  Â  Â  Â  y: notaData.y,
Â  Â  Â  Â  w: notaData.w || 2,
Â  Â  Â  Â  h: notaData.h || 4,
Â  Â  Â  Â  id: noteId,
Â  Â  Â  Â  autoPosition: (notaData.x === undefined || notaData.y === undefined)
Â  Â  Â  };
Â  Â  Â  gridItem.docData = notaData; // Guardar datos para referencia
Â  Â  Â  return {
Â  Â  Â  Â  element: gridItem,
Â  Â  Â  Â  position: pos
Â  Â  Â  };
Â  Â  }
Â  Â  // --- FUNCIÃ“N PARA EDITAR NOTA ---
Â  Â  function editNoteContent(card, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
Â  Â  Â  let targetElement = card.querySelector('.note-content');
Â  Â  Â  if (!targetElement && notaData.url) { // Solo crear si es nota de imagen sin texto previo
Â  Â  Â  Â  targetElement = document.createElement('div');
Â  Â  Â  Â  targetElement.classList.add('note-content');
Â  Â  Â  Â  card.insertBefore(targetElement, card.querySelector('.menu-bar'));
Â  Â  Â  } else if (!targetElement && !notaData.url) { // Si es nota de texto, deberÃ­a existir; si no, hay error
Â  Â  Â  Â  console.error("Error: No se encontrÃ³ .note-content para editar texto en nota:", noteId);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const isImageNote = !!notaData.url;
Â  Â  Â  const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');
Â  Â  Â  targetElement.innerHTML = '';
Â  Â  Â  const editInput = document.createElement('textarea');
Â  Â  Â  editInput.value = currentText;
Â  Â  Â  editInput.style.cssText = "width:100%; min-height:80px; height:auto; box-sizing:border-box; border:1px dashed #ccc; resize:vertical;";
Â  Â  Â  targetElement.appendChild(editInput);
Â  Â  Â  autoResizeTextarea(editInput
