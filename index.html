<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notas Oce√°nicas - Polaroid</title>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
  <style>
    /* Estilos CSS (sin cambios) */
    /* ... (mant√©n tus estilos CSS aqu√≠) ... */
    .card-wrapper, .text-card {
      background-color: #fff;
      border: 2px solid #0077a3; /* Borde azul */
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      width: 240px; /* Ancho fijo de la tarjeta */
      display: flex;
      flex-direction: column;
      position: relative;
      height: 100%; /* Ocupar altura del contenedor .grid-stack-item-content */
      box-sizing: border-box;
    }
    /* Otros estilos... */
  </style>
</head>
<body>
  <div class="container">
    <div id="notaDisplay" class="grid-stack"></div>

    <button id="addNoteButton" title="A√±adir nueva nota o imagen">+</button>

    <div id="addNoteOptions">
      <div class="card" id="addImageLinkOption" title="A√±adir una nota con imagen desde un enlace web">
        <h2>üñºÔ∏è Imagen</h2>
        <p>Guardar link de imagen.</p>
      </div>
      <div class="card" id="addTextNoteOption" title="A√±adir una nota de texto simple">
        <h2>üìù Nota</h2>
        <p>Subir nota de texto.</p>
      </div>
    </div>

    <div id="inputArea">
      <div id="imageLinkInputArea" style="display: none;">
        <div class="input-group">
          <label for="imageLink">Link de la imagen:</label>
          <input type="text" id="imageLink" placeholder="Pega aqu√≠ la URL de la imagen (ej: https://...)" />
        </div>
        <div class="input-group">
          <label for="imageNoteText">Texto adicional (opcional):</label>
          <textarea id="imageNoteText" placeholder="Escribe aqu√≠ una descripci√≥n o nota relacionada con la imagen..." rows="3"></textarea>
        </div>
        <button id="saveImageLink">Guardar Imagen</button>
      </div>
      <div id="textNoteInputArea" style="display: none;">
       <div class="input-group">
          <label for="textNote">Nota:</label>
          <textarea id="textNote" placeholder="Escribe tu nota aqu√≠..." rows="5"></textarea>
        </div>
        <button id="saveTextNote">Guardar Nota</button>
      </div>
    </div>

    <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">üìÖ</div>
    <div id="calendarWidget" class="calendar-widget"></div>

    <div class="blur-background"></div>
  </div>

  <script>
    /****************** Utilidades y Configuraci√≥n de Firebase ******************/

    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(?<!href=["'])(https?:\/\/[^\s<>"']+)/g;
      const replacedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return replacedText.replace(/\n/g, '<br>');
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCHa373WgLLHsy8wZXK9zr_HVieQvlrhUs", // ¬°Considera mover a un entorno seguro!
      authDomain: "oasis-b036d.firebaseapp.com",
      projectId: "oasis-b036d",
      storageBucket: "oasis-b036d.appspot.com",
      messagingSenderId: "141546637821",
      appId: "1:141546637821:web:0a861aeb13831774ed3194",
      measurementId: "G-HB2P17H5YL"
    }; // Reemplaza con tu configuraci√≥n real
    try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Error inicializando Firebase:", e); }
    const db = firebase.firestore();

    /****************** Inicializaci√≥n de GridStack ******************/
    let grid;
    try {
        grid = GridStack.init({
          margin: 75, cellHeight: 'auto', disableResize: true, float: false, animate: true, alwaysShowResizeHandle: false,
          draggable: { handle: '.menu-bar', scroll: true, appendTo: 'body' }
        });
    } catch (e) { console.error("Error inicializando GridStack:", e); alert("Error al iniciar el √°rea de notas."); }

    /****************** Utilidades UI (Scroll, Resize Textarea) ******************/
    const gridContainer = document.getElementById('notaDisplay');
    if (gridContainer) gridContainer.addEventListener('wheel', (event) => {}, { passive: true });
    function autoResizeTextarea(el) { if (!el) return; el.style.height = 'auto'; el.style.height = (el.scrollHeight + 2) + 'px'; }
    const textNoteInputElem = document.getElementById('textNote');
    const imageNoteTextElem = document.getElementById('imageNoteText');
    if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
    if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));

    /****************** Renderizaci√≥n, Edici√≥n y Eliminaci√≥n de Notas ******************/
    const displayedNotes = new Map();

    // --- FUNCI√ìN PARA MOSTRAR NOTA ---
    function mostrarNotaEnPantalla(doc) {
      const notaData = doc.data(); const noteId = doc.id;
      let gridItem = document.createElement('div'); gridItem.classList.add('grid-stack-item'); gridItem.setAttribute('data-note-id', noteId);
      const content = document.createElement('div'); content.classList.add('grid-stack-item-content');
      let card; let noteContentElement;

      if (notaData.url) { // Tarjeta Imagen
            card = document.createElement('div'); card.classList.add('card-wrapper');
            const imageContainer = document.createElement('div'); imageContainer.classList.add('image-container');
            const img = document.createElement('img');
            img.src = notaData.url;
            img.alt = notaData.texto || 'Imagen de la nota'; img.loading = 'lazy';
            img.onerror = () => { imageContainer.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; background-color:#eee; color:red; text-align:center; padding:10px;">‚ö†Ô∏è<br/>Error al<br/>cargar imagen</div>`; }
            imageContainer.appendChild(img); card.appendChild(imageContainer);
            if(notaData.texto) { noteContentElement = document.createElement('div'); noteContentElement.classList.add('note-content'); noteContentElement.innerHTML = linkify(notaData.texto); card.appendChild(noteContentElement); }
      } else if (notaData.nota) { // Tarjeta Texto
            card = document.createElement('div'); card.classList.add('text-card');
            noteContentElement = document.createElement('div'); noteContentElement.classList.add('note-content'); noteContentElement.innerHTML = linkify(notaData.nota); card.appendChild(noteContentElement);
      } else { return null; } // Nota vac√≠a

      if (noteContentElement) { Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => { link.setAttribute('target', '_blank'); link.setAttribute('rel', 'noopener noreferrer'); }); }

      // Barra de Men√∫
      const menuBar = document.createElement('div'); menuBar.classList.add('menu-bar');
      const bubbleButton = document.createElement('button'); bubbleButton.classList.add('menu-icon', 'bubble-icon'); bubbleButton.innerHTML = '‚óè'; bubbleButton.setAttribute('draggable', 'true'); bubbleButton.id = `bubble-${noteId}`; bubbleButton.title = "Arrastrar al calendario"; bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';
      bubbleButton.addEventListener('dragstart', (e) => {
          var imgGhost = new Image(); imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; e.dataTransfer.setDragImage(imgGhost, 0, 0);
          e.dataTransfer.setData("application/note-id", noteId); e.dataTransfer.effectAllowed = "move"; openCalendar();
       });
      bubbleButton.addEventListener('click', (e) => { e.stopPropagation(); openCalendar(); });
      const menuActions = document.createElement('div'); menuActions.classList.add('menu-actions');
      const editButton = document.createElement('button'); editButton.classList.add('menu-icon'); editButton.innerHTML = '‚úé'; editButton.title = "Editar";
      const deleteButton = document.createElement('button'); deleteButton.classList.add('menu-icon'); deleteButton.innerHTML = '‚úñ'; deleteButton.title = "Eliminar";

      // onclick de deleteButton (SIN confirmaci√≥n)
      deleteButton.onclick = (e) => {
          e.stopPropagation();
          if (typeof deleteNote === 'function') deleteNote(noteId, gridItem);
          else { console.error("Funci√≥n deleteNote no encontrada"); alert("Error interno al eliminar."); }
      };

      editButton.onclick = (e) => { e.stopPropagation(); if (typeof editNoteContent === 'function') editNoteContent(card, noteId, notaData, menuActions, editButton, deleteButton); else console.error("Funci√≥n editNoteContent no encontrada"); };

      menuActions.appendChild(editButton); menuActions.appendChild(deleteButton);
      menuBar.appendChild(bubbleButton); menuBar.appendChild(menuActions);
      card.appendChild(menuBar); content.appendChild(card); gridItem.appendChild(content);

      // Posici√≥n Gridstack
      const pos = { x: notaData.x, y: notaData.y, w: notaData.w || 2, id: noteId, autoPosition: (notaData.x === undefined || notaData.y === undefined) };
      gridItem.docData = notaData; // Guardar datos para referencia
      return { element: gridItem, position: pos };
    }

    // --- FUNCI√ìN PARA EDITAR NOTA ---
     function editNoteContent(card, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
        let targetElement = card.querySelector('.note-content');
        if (!targetElement && notaData.url) { // Solo crear si es nota de imagen sin texto previo
             targetElement = document.createElement('div'); targetElement.classList.add('note-content'); card.insertBefore(targetElement, card.querySelector('.menu-bar'));
        } else if (!targetElement && !notaData.url) { // Si es nota de texto, deber√≠a existir; si no, hay error
             console.error("Error: No se encontr√≥ .note-content para editar texto en nota:", noteId); return;
        }
        const isImageNote = !!notaData.url; const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');
        targetElement.innerHTML = '';
        const editInput = document.createElement('textarea'); editInput.value = currentText; editInput.style.cssText = "width:100%; min-height:80px; height:auto; box-sizing:border-box; border:1px dashed #ccc; resize:vertical;";
        targetElement.appendChild(editInput); autoResizeTextarea(editInput); editInput.addEventListener('input', () => autoResizeTextarea(editInput)); editInput.focus();
        const saveEditButton = document.createElement('button'); saveEditButton.classList.add('menu-icon'); saveEditButton.innerHTML = 'üíæ'; saveEditButton.title = "Guardar";
        saveEditButton.onclick = (e) => {
            e.stopPropagation(); const newText = editInput.value.trim(); const updateData = isImageNote ? { texto: newText || null } : { nota: newText };
            saveEditButton.disabled = true; saveEditButton.innerHTML = '‚è≥';
            db.collection('notas').doc(noteId).update(updateData)
              .then(() => { menuActionsContainer.replaceChild(editButton, saveEditButton); menuActionsContainer.appendChild(deleteButton); }) // Restaurar botones originales
              .catch((error) => { console.error('Error al actualizar:', error); alert("Error al guardar."); saveEditButton.disabled = false; saveEditButton.innerHTML = 'üíæ'; menuActionsContainer.replaceChild(editButton, saveEditButton); menuActionsContainer.appendChild(deleteButton); }); // Restaurar botones en error
        };
        menuActionsContainer.innerHTML = ''; menuActionsContainer.appendChild(saveEditButton); // Mostrar solo guardar
    }

    // --- FUNCI√ìN PARA ELIMINAR NOTA ---
    function deleteNote(noteId, gridItem) {
        console.log("Eliminando nota:", noteId);
        db.collection('notas').doc(noteId).delete()
          .then(() => {
               console.log(`Nota ${noteId} eliminada de Firestore.`);
               if (gridItem && grid && grid.engine.nodes.get(gridItem)) grid.removeWidget(gridItem); // Opcional: quitar r√°pido del DOM
               displayedNotes.delete(noteId);
               document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove()); // Quitar del calendario
          })
          .catch((error) => { console.error("Error al eliminar:", error); alert("Error al eliminar la nota."); });
    }

    /****************** Escucha de Cambios en Firestore (SIMPLIFICADA) ******************/
    if (db && typeof db.collection === 'function') {
        db.collection('notas')
          .onSnapshot((snapshot) => {
              if (!grid) { console.error("GridStack no inicializado."); return; }
              grid.removeAll(); displayedNotes.clear();
              snapshot.forEach((doc) => { const result = mostrarNotaEnPantalla(doc); if (result) { grid.addWidget(result.element, result.position); displayedNotes.set(doc.id, result.element); } });
              if (currentCalendarMonth !== undefined) { fetchAllAssignedNotes().then(() => generateCalendar(currentCalendarMonth, currentCalendarYear)); } else { fetchAllAssignedNotes(); }
          }, (error) => { console.error("Error Firestore:", error); alert("Error al cargar notas."); });
    } else { console.error("Firestore (db) no inicializado."); alert("Error: No se pudo conectar a la base de datos."); }

    /****************** Manejo de la Interfaz para Agregar Notas ******************/
    const addNoteButtonElem = document.getElementById('addNoteButton');
    const addNoteOptionsElem = document.getElementById('addNoteOptions');
    const addImageLinkOptionElem = document.getElementById('addImageLinkOption');
    const addTextNoteOptionElem = document.getElementById('addTextNoteOption');
    const inputAreaElem = document.getElementById('inputArea');
    const imageLinkInputAreaElem = document.getElementById('imageLinkInputArea');
    const imageLinkInputElem = document.getElementById('imageLink');
    const saveImageLinkButtonElem = document.getElementById('saveImageLink');
    const textNoteInputAreaElem = document.getElementById('textNoteInputArea');
    const saveTextNoteButtonElem = document.getElementById('saveTextNote');
    const blurBackgroundElem = document.querySelector('.blur-background');

    function hideMenus() {
        if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
        if(inputAreaElem) inputAreaElem.style.display = 'none';
        if(blurBackgroundElem) blurBackgroundElem.style.display = 'none';
        if(imageLinkInputElem) imageLinkInputElem.value = '';
        if(imageNoteTextElem) { imageNoteTextElem.value = ''; autoResizeTextarea(imageNoteTextElem); }
        if(textNoteInputElem) { textNoteInputElem.value = ''; autoResizeTextarea(textNoteInputElem); }
    }
    if (addNoteButtonElem) addNoteButtonElem.onclick = (e) => {
        e.stopPropagation();
        if (addNoteOptionsElem && addNoteOptionsElem.style.display === 'flex') { hideMenus(); }
        else if (addNoteOptionsElem && blurBackgroundElem) { hideMenus(); addNoteOptionsElem.style.display = 'flex'; blurBackgroundElem.style.display = 'block'; }
    };
    if (addImageLinkOptionElem) addImageLinkOptionElem.onclick = (e) => {
        e.stopPropagation(); if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if(imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'block'; if(textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'none'; if(inputAreaElem) inputAreaElem.style.display = 'flex'; if(blurBackgroundElem) blurBackgroundElem.style.display = 'block'; if(imageLinkInputElem) imageLinkInputElem.focus();
    };
    if (addTextNoteOptionElem) addTextNoteOptionElem.onclick = (e) => {
        e.stopPropagation(); if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if(imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'none'; if(textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'block'; if(inputAreaElem) inputAreaElem.style.display = 'flex'; if(blurBackgroundElem) blurBackgroundElem.style.display = 'block'; if(textNoteInputElem) textNoteInputElem.focus();
    };
    if (blurBackgroundElem) blurBackgroundElem.onclick = hideMenus;

    function guardarLinkDeImagen() {
        if (!imageLinkInputElem) return; let link = imageLinkInputElem.value.trim(); const texto = imageNoteTextElem ? imageNoteTextElem.value.trim() : '';
        if (link) { if(saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = true;
            db.collection('notas').add({ url: link, texto: texto || null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tipo: 'imagen' })
              .then(() => { hideMenus(); }).catch((error) => { console.error('Error al guardar link:', error); alert("Error al guardar imagen."); })
              .finally(() => { if(saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = false; });
        } else {
            alert("Introduce un link v√°lido.");
            imageLinkInputElem.focus();
        }
    }
    function guardarNotaTexto() {
        if (!textNoteInputElem) return; const nota = textNoteInputElem.value.trim();
        if (nota) { if(saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = true;
            db.collection('notas').add({ nota: nota, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tipo: 'texto' })
              .then(() => { hideMenus(); }).catch((error) => { console.error('Error al guardar nota:', error); alert("Error al guardar nota."); })
              .finally(() => { if(saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = false; });
        } else { alert("Escribe algo en la nota."); textNoteInputElem.focus(); }
    }
    if(saveImageLinkButtonElem) saveImageLinkButtonElem.onclick = guardarLinkDeImagen;
    if(saveTextNoteButtonElem) saveTextNoteButtonElem.onclick = guardarNotaTexto;

    /****************** Calendario y Asignaci√≥n de la Bolita ******************/
    let currentCalendarMonth, currentCalendarYear; let assignedDatesCache = {}; let notesDataCache = {};
    function getChileDate() { try { const opts = { timeZone: 'America/Santiago', year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false }; const fmt = new Intl.DateTimeFormat('en-CA', opts); const p = fmt.formatToParts(new Date()); const d = {}; p.forEach(({ type, value }) => d[type] = parseInt(value, 10)); return new Date(Date.UTC(d.year, d.month - 1, d.day, d.hour, d.minute, d.second)); } catch (e) { console.warn("Intl fallback", e); return new Date(); } }
    function initCalendarDate() { let today = getChileDate(); let year = today.getFullYear(); let month = today.getMonth(); const minY = 2024; const minM = 11; if (year < minY || (year === minY && month < minM)) { return { month: minM, year: minY }; } return { month, year }; }
    function getMonthName(idx) { const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; return months[idx % 12] || ''; }
    async function fetchAllAssignedNotes() { assignedDatesCache = {}; notesDataCache = {}; try { const snap = await db.collection('notas').where('assignedDate', '!=', null).get(); snap.forEach(doc => { const d = doc.data(); const id = doc.id; notesDataCache[id] = d; const dateStr = d.assignedDate; if (dateStr) { if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = []; if (!assignedDatesCache[dateStr].includes(id)) assignedDatesCache[dateStr].push(id); } }); } catch (err) { console.error("Error fetch dates:", err); } }
    async function generateCalendar(month, year) { if (Object.keys(notesDataCache).length === 0) await fetchAllAssignedNotes(); const calDiv = document.getElementById('calendarWidget'); if (!calDiv) return; calDiv.innerHTML = ''; const today = getChileDate(); const hdr = document.createElement('div'); hdr.className = 'calendar-header'; const pBtn = document.createElement('button'); pBtn.innerHTML = '&lt;'; const minY = 2024; const minM = 11; if (year === minY && month === minM) pBtn.disabled = true; else pBtn.onclick = () => generateCalendar(month === 0 ? 11 : month - 1, month === 0 ? year - 1 : year); const nBtn = document.createElement('button'); nBtn.innerHTML = '&gt;'; nBtn.onclick = () => generateCalendar(month === 11 ? 0 : month + 1, month === 11 ? year + 1 : year); const title = document.createElement('span'); title.textContent = `${getMonthName(month)} ${year}`; hdr.appendChild(pBtn); hdr.appendChild(title); hdr.appendChild(nBtn); calDiv.appendChild(hdr); const daysHdr = document.createElement('div'); daysHdr.className = 'calendar-days-header'; ['Do','Lu','Ma','Mi','Ju','Vi','S√°'].forEach(day => { const d = document.createElement('div'); d.className = 'calendar-day'; d.textContent = day; daysHdr.appendChild(d); }); calDiv.appendChild(daysHdr); const datesG = document.createElement('div'); datesG.className = 'calendar-dates-grid'; const firstD = new Date(year, month, 1).getDay(); const daysInM = new Date(year, month + 1, 0).getDate(); for (let i = 0; i < firstD; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesG.appendChild(e); } for (let date = 1; date <= daysInM; date++) { const cell = document.createElement('div'); cell.className = 'calendar-date'; cell.textContent = date; const dStr = `${date}/${month + 1}/${year}`; if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cell.classList.add('today'); if (assignedDatesCache[dStr]) { assignedDatesCache[dStr].forEach(id => { const b = document.createElement("span"); b.className = "assigned-bubble"; b.setAttribute("data-note", id); b.textContent = "‚óè"; cell.appendChild(b); }); } cell.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; cell.classList.add('drag-over'); }); cell.addEventListener('dragleave', (e) => { cell.classList.remove('drag-over'); }); cell.addEventListener('drop', async (e) => { e.preventDefault(); cell.classList.remove('drag-over'); const noteId = e.dataTransfer.getData("application/note-id"); if (noteId) { const oldDStr = notesDataCache[noteId]?.assignedDate; try { await db.collection('notas').doc(noteId).update({ assignedDate: dStr }); if(notesDataCache[noteId]) notesDataCache[noteId].assignedDate = dStr; else notesDataCache[noteId] = { assignedDate: dStr }; if (oldDStr && assignedDatesCache[oldDStr]) { assignedDatesCache[oldDStr] = assignedDatesCache[oldDStr].filter(id => id !== noteId); if (assignedDatesCache[oldDStr].length === 0) delete assignedDatesCache[oldDStr]; } if (!assignedDatesCache[dStr]) assignedDatesCache[dStr] = []; if (!assignedDatesCache[dStr].includes(noteId)) assignedDatesCache[dStr].push(noteId); const bubbleInC = document.getElementById(`bubble-${noteId}`); if (bubbleInC) bubbleInC.style.display = 'none'; generateCalendar(currentCalendarMonth, currentCalendarYear); } catch (err) { console.error(`Err assign date ${noteId}:`, err); alert("Error."); } } }); datesG.appendChild(cell); } const totalC = firstD + daysInM; const cellsN = totalC <= 35 ? 35 : 42; for (let i = totalC; i < cellsN; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesG.appendChild(e); } calDiv.appendChild(datesG); currentCalendarMonth = month; currentCalendarYear = year; }
    const calendarIconElem = document.getElementById('calendarIcon'); const calendarWidgetElem = document.getElementById('calendarWidget'); let calendarTimeout; function showCalendar() { if (!calendarWidgetElem) return; clearTimeout(calendarTimeout); if (calendarWidgetElem.style.display !== 'block') { const { month, year } = initCalendarDate(); generateCalendar(month, year); calendarWidgetElem.style.display = 'block'; } } function hideCalendar() { if (!calendarWidgetElem) return; calendarTimeout = setTimeout(() => { calendarWidgetElem.style.display = 'none'; }, 300); } if (calendarIconElem) { calendarIconElem.addEventListener('mouseenter', showCalendar); calendarIconElem.addEventListener('mouseleave', hideCalendar); } if (calendarWidgetElem) { calendarWidgetElem.addEventListener('mouseenter', () => clearTimeout(calendarTimeout)); calendarWidgetElem.addEventListener('mouseleave', hideCalendar); } function openCalendar() { showCalendar(); }

    /****************** Otros Event Listeners y Setup Inicial ******************/
    if (addNoteOptionsElem) addNoteOptionsElem.addEventListener('click', (e) => e.stopPropagation());
    if (inputAreaElem) inputAreaElem.addEventListener('click', (e) => e.stopPropagation());

    // --- Funci√≥n para obtener el margen de colisi√≥n ---
    function getCollisionMargin(element) {
        if (element.classList.contains('text-card')) {
            // Margen de 2 cm para notas de texto
            return 40; // 40px aproximadamente equivalen a 2 cm
        } else if (element.classList.contains('card-wrapper')) {
            // Margen m√°s ajustado para notas de imagen
            return 10; // Ajusta este valor seg√∫n sea necesario
        }
        return 0; // Margen predeterminado
    }

    // --- Funci√≥n para detectar colisiones ---
    function isColliding(elem1, elem2) {
        const margin1 = getCollisionMargin(elem1);
        const margin2 = getCollisionMargin(elem2);

        const rect1 = elem1.getBoundingClientRect();
        const rect2 = elem2.getBoundingClientRect();

        return !(
            rect1.right + margin1 < rect2.left - margin2 ||
            rect1.left - margin1 > rect2.right + margin2 ||
            rect1.bottom + margin1 < rect2.top - margin2 ||
            rect1.top - margin1 > rect2.bottom + margin2
        );
    }

    // --- Funci√≥n para manejar el arrastre ---
    function onDrag(event, draggedElement) {
        const elements = document.querySelectorAll('.grid-stack-item');

        elements.forEach(element => {
            if (element !== draggedElement && isColliding(draggedElement, element)) {
                // Ajustar la posici√≥n de draggedElement para evitar la colisi√≥n
                console.log('Colisi√≥n detectada con', element);
                // Aqu√≠ puedes implementar la l√≥gica para ajustar la posici√≥n
                // Por ejemplo, puedes mover el elemento arrastrado a una nueva posici√≥n
                // o simplemente evitar que se superponga.
            }
        });
    }

    // --- Ejemplo de c√≥mo podr√≠as llamar a onDrag al arrastrar un elemento ---
    grid.on('drag', (event, element) => onDrag(event, element.el));

  </script>
</body>
</html>
