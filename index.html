<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Notas OceÃ¡nicas - Polaroid</title>
Â  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
Â  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
Â  <style>
Â  Â  /* ===================== Estilos Globales ===================== */
Â  Â  html, body {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  height: 100vh;
Â  Â  Â  overflow: hidden; /* Evita scroll en el body */
Â  Â  Â  background: linear-gradient(to bottom, #a2dff7 0%, #a2dff7 40%, #03254c 100%);
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  }
Â  Â  .container {
Â  Â  Â  height: 100%;
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 2cm;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  display: flex; /* Usar flexbox */
Â  Â  Â  flex-direction: column; /* Alinear contenido verticalmente */
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden; /* Ocultar overflow del contenedor principal */
Â  Â  }
Â  Â  #notaDisplay {
Â  Â  Â  flex-grow: 1; /* Permitir que el Ã¡rea de notas crezca */
Â  Â  Â  width: 100%;
Â  Â  Â  overflow-y: auto; /* Permitir scroll DENTRO del Ã¡rea de notas */
Â  Â  Â  overflow-x: hidden;
Â  Â  Â  position: relative; /* Necesario para algunos cÃ¡lculos de GridStack */
Â  Â  }
Â  Â  .grid-stack-placeholder { display: none !important; }
Â  Â  .grid-stack-item {
Â  Â  Â  Â  transition: transform 0.4s cubic-bezier(0.25,1,0.5,1);
Â  Â  Â  Â  /* === Margen inferior para espaciado vertical mÃ­nimo === */
Â  Â  Â  Â  /* Ajustado a 150px (aprox 4cm) segÃºn solicitado previamente */
Â  Â  Â  Â  margin-bottom: 150px !important;
Â  Â  Â  Â  /* Importante: Asegurar que el item tenga overflow visible por si el contenido crece */
Â  Â  Â  Â  overflow: visible !important;
Â  Â  }
Â  Â  Â /* Contenedor interno de Gridstack */
Â  Â  .grid-stack-item-content {
Â  Â  Â  Â  overflow: visible !important; /* Permitir que el contenido se desborde si es necesario */
Â  Â  Â  Â  height: 100%; /* Ocupar toda la altura del item */
Â  Â  Â  Â  display: flex; /* Usar flex para la tarjeta interna */
Â  Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  /* Ajuste para que el contenedor GridStack no interfiera con el margen inferior del Ãºltimo item */
Â  Â  .grid-stack {
Â  Â  Â  Â  padding-bottom: 1px; /* PequeÃ±o padding para asegurar espacio visual al final */
Â  Â  }

Â  Â  /* ===================== Tarjetas de Nota ===================== */
Â  Â  .card-wrapper, .text-card {
Â  Â  Â  background-color: #fff;
Â  Â  Â  border: 2px solid #0077a3;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
Â  Â  Â  width: 240px; /* Ancho fijo de la tarjeta */
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  position: relative;
Â  Â  Â  height: 100%; /* Ocupar altura del contenedor .grid-stack-item-content */
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  /* No se necesita .card-content si usamos flex en .card-wrapper/.text-card */
Â  Â  .image-container {
Â  Â  Â  width: 100%; /* Ajustar al ancho de la tarjeta */
Â  Â  Â  height: 240px; /* Altura fija para la imagen */
Â  Â  Â  overflow: hidden;
Â  Â  Â  position: relative;
Â  Â  Â  flex-shrink: 0; /* Evitar que se encoja */
Â  Â  }
Â  Â  .image-container img {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  object-fit: cover;
Â  Â  Â  display: block;
Â  Â  }
Â  Â  .note-content {
Â  Â  Â  background-color: #fff; /* Redundante si la tarjeta es blanca */
Â  Â  Â  padding: 10px;
Â  Â  Â  text-align: left;
Â  Â  Â  font-size: 16px;
Â  Â  Â  color: #333;
Â  Â  Â  min-height: 50px;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  word-wrap: break-word;
Â  Â  Â  overflow: hidden; /* Ocultar overflow del texto */
Â  Â  Â  flex-grow: 1; /* Permitir que crezca para llenar espacio */
Â  Â  Â  /* Considerar aÃ±adir overflow-y: auto si el texto es muy largo */
Â  Â  Â  /* max-height: 300px; */ /* Opcional: limitar altura mÃ¡xima */
Â  Â  }
Â  Â  .note-content a { color: #0077a3; text-decoration: underline; }

Â  Â  /* ===================== Ãrea de Controles de la Nota ===================== */
Â  Â  .menu-bar {
Â  Â  Â  background-color: #0288D1;
Â  Â  Â  padding: 5px 8px; /* Ajustar padding */
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between; /* Distribuir elementos */
Â  Â  Â  align-items: center;
Â  Â  Â  flex-shrink: 0;
Â  Â  Â  border-top: 1px solid #0077a3; /* LÃ­nea separadora opcional */
Â  Â  Â  border-bottom-left-radius: 6px; /* Redondear esquinas inferiores */
Â  Â  Â  border-bottom-right-radius: 6px;
Â  Â  }
Â  Â  .menu-icon {
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  font-size: 20px;
Â  Â  Â  color: #fff;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 2px 4px; /* Ãrea de clic un poco mayor */
Â  Â  }
Â  Â  .bubble-icon {
Â  Â  Â  color: #FFCD05;
Â  Â  Â  font-size: 22px;
Â  Â  Â  /* margin-right ya no es necesario con space-between */
Â  Â  }
Â  Â  /* Contenedor para botones de la derecha */
Â  Â  .menu-actions {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 4px;
Â  Â  }

Â  Â  /* ===================== BotÃ³n Principal para Agregar Nota/Imagen ===================== */
Â  Â  #addNoteButton {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 30px; /* Un poco mÃ¡s arriba */
Â  Â  Â  right: 30px;
Â  Â  Â  background-color: #006994;
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 60px;
Â  Â  Â  height: 60px;
Â  Â  Â  font-size: 30px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  cursor: pointer;
Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* Sombra mÃ¡s pronunciada */
Â  Â  Â  transition: background-color 0.3s ease, transform 0.3s ease;
Â  Â  Â  z-index: 1001;
Â  Â  }
Â  Â  #addNoteButton:hover {
Â  Â  Â  background-color: #005577;
Â  Â  Â  transform: scale(1.05);
Â  Â  }

Â  Â  /* ===================== MenÃº Emergente ===================== */
Â  Â  #addNoteOptions {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 50%;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  background-color: rgba(0,0,0,0.85); /* Ligeramente mÃ¡s oscuro */
Â  Â  Â  border-radius: 10px;
Â  Â  Â  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
Â  Â  Â  display: none;
Â  Â  Â  flex-direction: row;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 25px; /* MÃ¡s espacio */
Â  Â  Â  padding: 25px;
Â  Â  Â  z-index: 1002;
Â  Â  }
Â  Â  #addNoteOptions .card {
Â  Â  Â  background-color: #2c2c2c; /* Fondo de tarjeta mÃ¡s oscuro */
Â  Â  Â  border: 1px solid #0077a3; /* Borde mÃ¡s sutil */
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 20px;
Â  Â  Â  text-align: center;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: transform 0.2s ease, box-shadow 0.2s ease;
Â  Â  Â  width: 180px; /* Ligeramente mÃ¡s estrechas */
Â  Â  }
Â  Â  #addNoteOptions .card:hover {
Â  Â  Â  Â  transform: translateY(-5px) scale(1.03); /* Efecto hover */
Â  Â  Â  Â  box-shadow: 0 6px 12px rgba(0, 119, 163, 0.5);
Â  Â  Â }
Â  Â  #addNoteOptions .card h2 { color: #36a2eb; margin-bottom: 10px; } /* Color de tÃ­tulo */
Â  Â  #addNoteOptions .card p { color: #ccc; font-size: 14px; } /* Color de texto */

Â  Â  /* ===================== SubmenÃº para Ingresar Datos ===================== */
Â  Â  #inputArea {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 50%;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  background-color: #ffffff; /* Fondo blanco */
Â  Â  Â  padding: 25px 30px; /* MÃ¡s padding */
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
Â  Â  Â  display: none; /* Oculto por defecto */
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 15px; /* Espacio entre elementos */
Â  Â  Â  width: 90%; /* MÃ¡s ancho en mÃ³viles */
Â  Â  Â  max-width: 550px; /* Ancho mÃ¡ximo */
Â  Â  Â  z-index: 1002;
Â  Â  }
Â  Â  #inputArea label {
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  margin-bottom: 3px; /* Espacio debajo de la etiqueta */
Â  Â  Â  Â  font-size: 14px;
Â  Â  }
Â  Â  #inputArea textarea,
Â  Â  #inputArea input[type="text"] {
Â  Â  Â  padding: 12px; /* MÃ¡s padding interno */
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  resize: vertical;
Â  Â  Â  width: 100%;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  line-height: 1.5;
Â  Â  Â  font-size: 16px; /* TamaÃ±o de fuente */
Â  Â  }
Â  Â  #inputArea textarea { min-height: 80px; }
Â  Â  #inputArea textarea#textNote { min-height: 120px; }

Â  Â  #inputArea button {
Â  Â  Â  padding: 10px 20px; /* MÃ¡s padding horizontal */
Â  Â  Â  background-color: #006994;
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.3s ease, transform 0.1s ease;
Â  Â  Â  align-self: flex-end;
Â  Â  Â  margin-top: 10px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  Â #inputArea button:hover { background-color: #005577; }
Â  Â  Â #inputArea button:active { transform: scale(0.98); } /* Efecto al presionar */
Â  Â  .input-group { display: flex; flex-direction: column; gap: 5px; width: 100%;}


Â  Â  /* ===================== Calendario ===================== */
Â  Â  .calendar-icon {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 30px; /* Alinear con botÃ³n Add */
Â  Â  Â  left: 30px;
Â  Â  Â  width: 45px; /* Ligeramente mÃ¡s grande */
Â  Â  Â  height: 45px;
Â  Â  Â  background-color: #fff;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  color: #333;
Â  Â  Â  font-size: 24px; /* Icono mÃ¡s grande */
Â  Â  Â  cursor: pointer;
Â  Â  Â  z-index: 1001;
Â  Â  Â  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  .calendar-widget {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 85px; /* Ajustar posiciÃ³n sobre el icono */
Â  Â  Â  left: 20px; /* Ajustar alineaciÃ³n */
Â  Â  Â  background: #fff;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
Â  Â  Â  padding: 15px; /* MÃ¡s padding */
Â  Â  Â  display: none;
Â  Â  Â  z-index: 1001;
Â  Â  Â  width: 320px; /* Ancho ajustado */
Â  Â  Â  min-height: 300px; /* Altura ajustada */
Â  Â  }
Â  Â  .calendar-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }
Â  Â  .calendar-header button {
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 20px;
Â  Â  Â  color: #0077a3;
Â  Â  Â  padding: 5px 8px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  transition: background-color 0.2s ease;
Â  Â  }
Â  Â  Â .calendar-header button:hover:not(:disabled) { background-color: #e0f7fa; }
Â  Â  Â .calendar-header button:disabled { color: #ccc; cursor: default; }
Â  Â  .calendar-header span { font-weight: bold; color: #333; font-size: 18px; } /* TÃ­tulo mÃ¡s grande */

Â  Â  .calendar-days-header,
Â  Â  .calendar-dates-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(7, 1fr);
Â  Â  Â  text-align: center;
Â  Â  Â  gap: 6px; /* Espacio entre celdas */
Â  Â  }
Â  Â  .calendar-days-header {
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  padding-bottom: 8px;
Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  font-size: 13px; /* TamaÃ±o de dÃ­as */
Â  Â  Â }
Â  Â  .calendar-day { padding: 3px; }

Â  Â  .calendar-date {
Â  Â  Â  padding: 0; /* Quitar padding para controlar tamaÃ±o con width/height */
Â  Â  Â  border-radius: 50%;
Â  Â  Â  color: #333;
Â  Â  Â  border: 2px solid transparent; /* Borde para hover/today */
Â  Â  Â  cursor: pointer;
Â  Â  Â  position: relative;
Â  Â  Â  width: 36px; /* TamaÃ±o fijo */
Â  Â  Â  height: 36px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  line-height: 1;
Â  Â  Â  font-size: 14px; /* TamaÃ±o nÃºmero */
Â  Â  Â  transition: background-color 0.2s ease, border-color 0.2s ease;
Â  Â  }
Â  Â  .calendar-date.empty {
Â  Â  Â  Â  background: none;
Â  Â  Â  Â  cursor: default;
Â  Â  Â  Â  opacity: 0;
Â  Â  Â }
Â  Â  .calendar-date:not(.empty):hover {
Â  Â  Â  Â  Â background-color: #e0f7fa;
Â  Â  Â  Â  Â border-color: #b3e5fc;
Â  Â  }
Â  Â  .calendar-date.today {
Â  Â  Â  Â  border-color: #0077a3; /* Borde azul para hoy */
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #005577;
Â  Â  }
Â  Â  /* Drop target feedback */
Â  Â  .calendar-date.drag-over {
Â  Â  Â  Â  background-color: #a2dff7 !important; /* Color fuerte al arrastrar sobre */
Â  Â  Â  Â  border-color: #0077a3 !important;
Â  Â  }


Â  Â  /* Indicador de la bolita asignada en el calendario */
Â  Â  .assigned-bubble {
Â  Â  Â  color: #FFCD05; /* Amarillo */
Â  Â  Â  font-size: 11px; /* TamaÃ±o ajustado */
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 3px; /* PosiciÃ³n */
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  line-height: 1;
Â  Â  Â  text-shadow: 0 0 1px rgba(0,0,0,0.5); /* Sombra para visibilidad */
Â  Â  Â  pointer-events: none; /* No interferir con clics en la fecha */
Â  Â  }
Â  Â  /* Permitir mÃºltiples bolitas (simple apilado vertical) */
Â  Â  .calendar-date .assigned-bubble + .assigned-bubble {
Â  Â  Â  Â  bottom: -2px; /* Ajustar posiciÃ³n si hay mÃ¡s de una */
Â  Â  }


Â  Â  /* ===================== Capa para Cerrar MenÃºs (Blur) ===================== */
Â  Â  .blur-background {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: rgba(0,0,0,0.6); /* MÃ¡s oscuro */
Â  Â  Â  backdrop-filter: blur(6px);
Â  Â  Â  -webkit-backdrop-filter: blur(6px);
Â  Â  Â  display: none;
Â  Â  Â  z-index: 1000;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <div id="notaDisplay" class="grid-stack"></div>

Â  Â  <button id="addNoteButton" title="AÃ±adir nueva nota o imagen">+</button>

Â  Â  <div id="addNoteOptions">
Â  Â  Â  <div class="card" id="addImageLinkOption" title="AÃ±adir una nota con imagen desde un enlace web">
Â  Â  Â  Â  <h2>ğŸ–¼ï¸ Imagen</h2>
Â  Â  Â  Â  <p>Guardar link de imagen.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="card" id="addTextNoteOption" title="AÃ±adir una nota de texto simple">
Â  Â  Â  Â  <h2>ğŸ“ Nota</h2>
Â  Â  Â  Â  <p>Subir nota de texto.</p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="inputArea">
Â  Â  Â  <div id="imageLinkInputArea" style="display: none;">
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="imageLink">Link de la imagen:</label>
Â  Â  Â  Â  Â  <input type="text" id="imageLink" placeholder="Pega aquÃ­ la URL de la imagen (ej: https://...)" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  <label for="imageNoteText">Texto adicional (opcional):</label>
Â  Â  Â  Â  Â  <textarea id="imageNoteText" placeholder="Escribe aquÃ­ una descripciÃ³n o nota relacionada con la imagen..." rows="3"></textarea>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="saveImageLink">Guardar Imagen</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="textNoteInputArea" style="display: none;">
Â  Â  Â  Â <div class="input-group">
Â  Â  Â  Â  Â  <label for="textNote">Nota:</label>
Â  Â  Â  Â  Â  <textarea id="textNote" placeholder="Escribe tu nota aquÃ­..." rows="5"></textarea>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="saveTextNote">Guardar Nota</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">ğŸ“…</div>
Â  Â  <div id="calendarWidget" class="calendar-widget"></div>

Â  Â  <div class="blur-background"></div>
Â  </div>

Â  <script>
Â  Â  /****************** Utilidades y ConfiguraciÃ³n de Firebase ******************/
Â  Â  function transformDriveLink(url) {
Â  Â  Â  Â  if (!url || !url.includes("drive.google.com")) return url; // Salir si no es link de Drive

Â  Â  Â  Â  // Ya estÃ¡ en formato correcto?
Â  Â  Â  Â  if (url.includes("/uc?export=view&id=")) return url;

Â  Â  Â  Â  let fileId = null;
Â  Â  Â  Â  // Patrones comunes de Google Drive
Â  Â  Â  Â  const patterns = [
Â  Â  Â  Â  Â  Â  /\/file\/d\/([a-zA-Z0-9_-]+)\//,Â  Â  Â  Â  Â // /file/d/FILE_ID/...
Â  Â  Â  Â  Â  Â  /[?&]id=([a-zA-Z0-9_-]+)(?:&|$)/,Â  Â  Â  // ...?id=FILE_ID... o ...&id=FILE_ID...
Â  Â  Â  Â  Â  Â  /open\?id=([a-zA-Z0-9_-]+)(?:&|$)/,Â  Â  Â // ...open?id=FILE_ID...
Â  Â  Â  Â  Â  Â  /\/d\/([a-zA-Z0-9_-]+)\/(?:edit|view)/Â  Â  // /d/FILE_ID/edit... o /d/FILE_ID/view...
Â  Â  Â  Â  ];

Â  Â  Â  Â  for (const regex of patterns) {
Â  Â  Â  Â  Â  Â  const match = url.match(regex);
Â  Â  Â  Â  Â  Â  if (match && match[1]) {
Â  Â  Â  Â  Â  Â  Â  Â  fileId = match[1];
Â  Â  Â  Â  Â  Â  Â  Â  break; // Encontramos el ID
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : url; // Devuelve formato directo o URL original si no hay ID
Â  Â  }

Â  Â  function linkify(text) {
Â  Â  Â  if (!text) return "";
Â  Â  Â  const urlRegex = /(?<!href=["'])(https?:\/\/[^\s<>"']+)/g;
Â  Â  Â  const replacedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
Â  Â  Â  return replacedText.replace(/\n/g, '<br>');
Â  Â  }

Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCHa373WgLLHsy8wZXK9zr_HVieQvlrhUs", // Â¡Considera mover a un entorno seguro!
Â  Â  Â  authDomain: "oasis-b036d.firebaseapp.com",
Â  Â  Â  projectId: "oasis-b036d",
Â  Â  Â  storageBucket: "oasis-b036d.appspot.com",
Â  Â  Â  messagingSenderId: "141546637821",
Â  Â  Â  appId: "1:141546637821:web:0a861aeb13831774ed3194",
Â  Â  Â  measurementId: "G-HB2P17H5YL"
Â  Â  };
Â  Â  try {
Â  Â  Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error inicializando Firebase:", e);
Â  Â  Â  Â  // Considera mostrar un mensaje al usuario aquÃ­
Â  Â  }
Â  Â  const db = firebase.firestore();

Â  Â  /****************** InicializaciÃ³n de GridStack ******************/
Â  Â  let grid; // Declarar grid aquÃ­ para acceso global en el script
Â  Â  try {
Â  Â  Â  Â  grid = GridStack.init({
Â  Â  Â  Â  Â  margin: 76, // AquÃ­ estÃ¡ el cambio para el espaciado de 2cm
Â  Â  Â  Â  Â  cellHeight: 'auto', // Altura de celda basada en contenido
Â  Â  Â  Â  Â  disableResize: true,
Â  Â  Â  Â  Â  float: false, // Mantenido en false para filas predecibles
Â  Â  Â  Â  Â  animate: true,
Â  Â  Â  Â  Â  alwaysShowResizeHandle: false,
Â  Â  Â  Â  Â  draggable: {
Â  Â  Â  Â  Â  Â  Â  handle: '.menu-bar',
Â  Â  Â  Â  Â  Â  Â  scroll: true,
Â  Â  Â  Â  Â  Â  Â  appendTo: 'body'
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error inicializando GridStack:", e);
Â  Â  Â  Â  // Considera mostrar un mensaje al usuario
Â  Â  Â  Â  alert("Error al iniciar el Ã¡rea de notas. La pÃ¡gina puede no funcionar correctamente.");
Â  Â  }

Â  Â  // --- Ajuste para permitir scroll dentro del grid ---
Â  Â  const gridContainer = document.getElementById('notaDisplay');
Â  Â  if (gridContainer) {
Â  Â  Â  Â  gridContainer.addEventListener('wheel', function(event) {
Â  Â  Â  Â  Â  Â  // No prevenir scroll vertical
Â  Â  Â  Â  }, { passive: true });
Â  Â  }

Â  Â  // FunciÃ³n para autoajustar altura de textareas
Â  Â  function autoResizeTextarea(el) {
Â  Â  Â  Â  if (!el) return;
Â  Â  Â  Â  el.style.height = 'auto';
Â  Â  Â  Â  // AÃ±adir 2px extra para evitar scrollbar innecesario a veces
Â  Â  Â  Â  el.style.height = (el.scrollHeight + 2) + 'px';
Â  Â  }
Â  Â  // Aplicar a los textareas del modal de input
Â  Â  const textNoteInputElem = document.getElementById('textNote'); // Re-declarar para asegurar alcance
Â  Â  const imageNoteTextElem = document.getElementById('imageNoteText'); // Re-declarar para asegurar alcance
Â  Â  if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
Â  Â  if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));


Â  Â  /****************** RenderizaciÃ³n de Notas, EdiciÃ³n y EliminaciÃ³n ******************/

Â  Â  // Cache local para referencia rÃ¡pida (opcional)
Â  Â  const displayedNotes = new Map();

Â  Â  // --- FUNCIÃ“N PARA MOSTRAR NOTA ---
Â  Â  function mostrarNotaEnPantalla(doc) {
Â  Â  Â  const notaData = doc.data();
Â  Â  Â  const noteId = doc.id;

Â  Â  Â  let gridItem = document.createElement('div');
Â  Â  Â  gridItem.classList.add('grid-stack-item');
Â  Â  Â  gridItem.setAttribute('data-note-id', noteId); // Para referencia

Â  Â  Â  const content = document.createElement('div');
Â  Â  Â  content.classList.add('grid-stack-item-content'); // Necesario para Gridstack

Â  Â  Â  let card;
Â  Â  Â  let noteContentElement;

Â  Â  Â  // --- Tarjeta de Imagen ---
Â  Â  Â  if (notaData.url) {
Â  Â  Â  Â  Â  card = document.createElement('div');
Â  Â  Â  Â  Â  card.classList.add('card-wrapper');

Â  Â  Â  Â  Â  const imageContainer = document.createElement('div');
Â  Â  Â  Â  Â  imageContainer.classList.add('image-container');
Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  img.src = transformDriveLink(notaData.url);
Â  Â  Â  Â  Â  img.alt = notaData.texto || 'Imagen de la nota'; // Usar texto como alt
Â  Â  Â  Â  Â  img.loading = 'lazy'; // Carga diferida
Â  Â  Â  Â  Â  img.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  img.alt = 'Error al cargar imagen';
Â  Â  Â  Â  Â  Â  Â  imageContainer.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; background-color:#eee; color:red; text-align:center; padding:10px;">âš ï¸<br/>Error al<br/>cargar imagen</div>`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  imageContainer.appendChild(img);
Â  Â  Â  Â  Â  card.appendChild(imageContainer);

Â  Â  Â  Â  Â  // AÃ±adir Ã¡rea de texto solo si existe texto
Â  Â  Â  Â  Â  if(notaData.texto) {
Â  Â  Â  Â  Â  Â  Â  noteContentElement = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  noteContentElement.classList.add('note-content');
Â  Â  Â  Â  Â  Â  Â  noteContentElement.innerHTML = linkify(notaData.texto);
Â  Â  Â  Â  Â  Â  Â  card.appendChild(noteContentElement);
Â  Â  Â  Â  Â  }

Â  Â  Â  // --- Tarjeta de Texto ---
Â  Â  Â  } else if (notaData.nota) {
Â  Â  Â  Â  Â  card = document.createElement('div');
Â  Â  Â  Â  Â  card.classList.add('text-card');

Â  Â  Â  Â  Â  noteContentElement = document.createElement('div');
Â  Â  Â  Â  Â  noteContentElement.classList.add('note-content');
Â  Â  Â  Â  Â  noteContentElement.innerHTML = linkify(notaData.nota);
Â  Â  Â  Â  Â  card.appendChild(noteContentElement);
Â  Â  Â  } else {
Â  Â  Â  Â  Â  console.warn("Nota sin contenido visible (URL o Texto):", noteId);
Â  Â  Â  Â  Â  return null; // No aÃ±adir si no hay nada que mostrar
Â  Â  Â  }

Â  Â  Â  // Linkify en el contenido textual si existe
Â  Â  Â  if (noteContentElement) {
Â  Â  Â  Â  Â  Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
Â  Â  Â  Â  Â  Â  Â  link.setAttribute('target', '_blank');
Â  Â  Â  Â  Â  Â  Â  link.setAttribute('rel', 'noopener noreferrer');
Â  Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // --- Barra de MenÃº ---
Â  Â  Â  const menuBar = document.createElement('div');
Â  Â  Â  menuBar.classList.add('menu-bar');

Â  Â  Â  // BotÃ³n Bolita
Â  Â  Â  const bubbleButton = document.createElement('button');
Â  Â  Â  bubbleButton.classList.add('menu-icon', 'bubble-icon');
Â  Â  Â  bubbleButton.innerHTML = 'â—';
Â  Â  Â  bubbleButton.setAttribute('draggable', 'true');
Â  Â  Â  bubbleButton.id = `bubble-${noteId}`;
Â  Â  Â  bubbleButton.title = "Arrastrar al calendario para asignar fecha";
Â  Â  Â  bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';

Â  Â  Â  bubbleButton.addEventListener('dragstart', (e) => {
Â  Â  Â  Â  Â  var imgGhost = new Image();
Â  Â  Â  Â  Â  imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
Â  Â  Â  Â  Â  e.dataTransfer.setDragImage(imgGhost, 0, 0);
Â  Â  Â  Â  Â  e.dataTransfer.setData("application/note-id", noteId);
Â  Â  Â  Â  Â  e.dataTransfer.effectAllowed = "move";
Â  Â  Â  Â  Â  openCalendar();
Â  Â  Â  });
Â  Â  Â  bubbleButton.addEventListener('click', (e) => { e.stopPropagation(); openCalendar(); });

Â  Â  Â  // Contenedor Acciones (derecha)
Â  Â  Â  const menuActions = document.createElement('div');
Â  Â  Â  menuActions.classList.add('menu-actions');

Â  Â  Â  // BotÃ³n Editar
Â  Â  Â  const editButton = document.createElement('button');
Â  Â  Â  editButton.classList.add('menu-icon');
Â  Â  Â  editButton.innerHTML = 'âœ';
Â  Â  Â  editButton.title = "Editar nota";
Â  Â  Â  // BotÃ³n Eliminar (declarado aquÃ­ para poder pasarlo a editNoteContent)
Â  Â  Â  const deleteButton = document.createElement('button');
Â  Â  Â  editButton.onclick = (e) => {
Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  if (typeof editNoteContent === 'function') {
Â  Â  Â  Â  Â  Â  Â  editNoteContent(card, noteId, notaData, menuActions, editButton, deleteButton); // Pasar deleteButton
Â  Â  Â  Â  Â  } else { console.error("FunciÃ³n editNoteContent no encontrada"); }
Â  Â  Â  };

Â  Â  Â  // BotÃ³n Eliminar (SIN CONFIRMACIÃ“N)
Â  Â  Â  deleteButton.classList.add('menu-icon');
Â  Â  Â  deleteButton.innerHTML = 'âœ–';
Â  Â  Â  deleteButton.title = "Eliminar nota";
Â  Â  Â  deleteButton.onclick = (e) => {
Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  // Llamar a deleteNote directamente SIN confirmaciÃ³n
Â  Â  Â  Â  Â  if (typeof deleteNote === 'function') {
Â  Â  Â  Â  Â  Â  Â  deleteNote(noteId, gridItem); // Se elimina directamente
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.error("FunciÃ³n deleteNote no encontrada");
Â  Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  // --- FIN DEL CAMBIO: EliminaciÃ³n de confirm() --- (Este comentario es del original)

Â  Â  Â  menuActions.appendChild(editButton);
Â  Â  Â  menuActions.appendChild(deleteButton);
Â  Â  Â  menuBar.appendChild(bubbleButton); // Bolita a la izquierda
Â  Â  Â  menuBar.appendChild(menuActions); // Acciones a la derecha

Â  Â  Â  card.appendChild(menuBar);
Â  Â  Â  content.appendChild(card);
Â  Â  Â  gridItem.appendChild(content);

Â  Â  Â  // --- PosiciÃ³n para GridStack ---
Â  Â  Â  const pos = {
Â  Â  Â  Â  Â  x: notaData.x, y: notaData.y,
Â  Â  Â  Â  Â  w: notaData.w || 2, // Ancho por defecto
Â  Â  Â  Â  Â  // h: se deja que 'auto' lo calcule
Â  Â  Â  Â  Â  id: noteId, // ID para GridStack
Â  Â  Â  Â  Â  autoPosition: (notaData.x === undefined || notaData.y === undefined)
Â  Â  Â  };

Â  Â  Â  // Guardar datos en el elemento para referencia
Â  Â  Â  gridItem.docData = notaData;

Â  Â  Â  return { element: gridItem, position: pos };
Â  Â  }

Â  Â  // --- FUNCIÃ“N PARA EDITAR NOTA ---
Â  Â  function editNoteContent(card, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
Â  Â  Â  Â  const noteContentElement = card.querySelector('.note-content');
Â  Â  Â  Â  // Si no hay Ã¡rea de texto (ej. imagen sin texto), crear una
Â  Â  Â  Â  let targetElement = noteContentElement;
Â  Â  Â  Â  if (!targetElement) {
Â  Â  Â  Â  Â  Â  targetElement = document.createElement('div');
Â  Â  Â  Â  Â  Â  targetElement.classList.add('note-content');
Â  Â  Â  Â  Â  Â  // Insertar ANTES de la barra de menÃº
Â  Â  Â  Â  Â  Â  card.insertBefore(targetElement, card.querySelector('.menu-bar'));
Â  Â  Â  Â  }

Â  Â  Â  Â  const isImageNote = !!notaData.url;
Â  Â  Â  Â  const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');

Â  Â  Â  Â  targetElement.innerHTML = ''; // Limpiar

Â  Â  Â  Â  const editInput = document.createElement('textarea');
Â  Â  Â  Â  editInput.value = currentText;
Â  Â  Â  Â  editInput.style.width = '100%';
Â  Â  Â  Â  editInput.style.minHeight = '80px';
Â  Â  Â  Â  editInput.style.height = 'auto'; // Permitir auto-resize
Â  Â  Â  Â  editInput.style.boxSizing = 'border-box';
Â  Â  Â  Â  editInput.style.border = '1px dashed #ccc'; // Borde distintivo
Â  Â  Â  Â  editInput.style.resize = 'vertical';
Â  Â  Â  Â  targetElement.appendChild(editInput);
Â  Â  Â  Â  autoResizeTextarea(editInput);
Â  Â  Â  Â  editInput.addEventListener('input', () => autoResizeTextarea(editInput));
Â  Â  Â  Â  editInput.focus();

Â  Â  Â  Â  // Crear botÃ³n Guardar EdiciÃ³n
Â  Â  Â  Â  const saveEditButton = document.createElement('button');
Â  Â  Â  Â  saveEditButton.classList.add('menu-icon');
Â  Â  Â  Â  saveEditButton.innerHTML = 'ğŸ’¾';
Â  Â  Â  Â  saveEditButton.title = "Guardar cambios";
Â  Â  Â  Â  saveEditButton.onclick = (e) => {
Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  const newText = editInput.value.trim(); // Quitar espacios extra
Â  Â  Â  Â  Â  Â  const updateData = isImageNote ? { texto: newText || null } : { nota: newText }; // Guardar null si estÃ¡ vacÃ­o

Â  Â  Â  Â  Â  Â  // Deshabilitar botÃ³n mientras guarda
Â  Â  Â  Â  Â  Â  saveEditButton.disabled = true;
Â  Â  Â  Â  Â  Â  saveEditButton.innerHTML = 'â³'; // Indicador de carga

Â  Â  Â  Â  Â  Â  db.collection('notas').doc(noteId).update(updateData)
Â  Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Nota actualizada en Firestore.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  // La vista se actualizarÃ¡ por onSnapshot. Solo restauramos botones.
Â  Â  Â  Â  Â  Â  Â  Â  Â  menuActionsContainer.replaceChild(editButton, saveEditButton);
Â  Â  Â  Â  Â  Â  Â  Â  Â  menuActionsContainer.appendChild(deleteButton); // Re-aÃ±adir delete por si acaso
Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al actualizar la nota:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Error al guardar los cambios.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  saveEditButton.disabled = false; // Rehabilitar botÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  Â  saveEditButton.innerHTML = 'ğŸ’¾';
Â  Â  Â  Â  Â  Â  Â  Â  Â  // Opcional: restaurar botones originales
Â  Â  Â  Â  Â  Â  Â  Â  Â  menuActionsContainer.replaceChild(editButton, saveEditButton);
Â  Â  Â  Â  Â  Â  Â  Â  Â  menuActionsContainer.appendChild(deleteButton);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  // Reemplazar botones Editar/Eliminar con Guardar
Â  Â  Â  Â  menuActionsContainer.innerHTML = ''; // Limpiar acciones actuales
Â  Â  Â  Â  menuActionsContainer.appendChild(saveEditButton);
Â  Â  }

Â  Â  // --- FUNCIÃ“N PARA ELIMINAR NOTA ---
Â  Â  function deleteNote(noteId, gridItem) {
Â  Â  Â  Â  console.log("Eliminando nota:", noteId); // Log para confirmar acciÃ³n
Â  Â  Â  Â  db.collection('notas').doc(noteId).delete()
Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â console.log(`Nota ${noteId} eliminada de Firestore.`);
Â  Â  Â  Â  Â  Â  Â  Â // Opcional: eliminar inmediatamente del DOM para feedback rÃ¡pido
Â  Â  Â  Â  Â  Â  Â  Â // aunque onSnapshot lo harÃ¡ eventualmente.
Â  Â  Â  Â  Â  Â  Â  Â if (gridItem && grid && grid.engine.nodes.get(gridItem)) { // <-- Esta es la lÃ­nea que causaba conflicto con onSnapshot
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â grid.removeWidget(gridItem);
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â displayedNotes.delete(noteId); // Eliminar del cache local si se usa
Â  Â  Â  Â  Â  Â  Â  Â // Quitar burbujas del calendario asociadas a esta nota
Â  Â  Â  Â  Â  Â  Â  Â document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â console.error("Error al eliminar la nota: ", error);
Â  Â  Â  Â  Â  Â  Â  Â alert("Error al eliminar la nota.");
Â  Â  Â  Â  Â  });
Â  Â  }


Â  Â  /****************** Escucha de Cambios en Firestore (SIMPLIFICADA) ******************/

Â  Â  if (db && typeof db.collection === 'function') { // Verificar que db estÃ¡ inicializado
Â  Â  Â  Â  db.collection('notas')
Â  Â  Â  Â  Â  // .orderBy('createdAt', 'desc') // Opcional: Ordenar
Â  Â  Â  Â  Â  .onSnapshot((snapshot) => {
Â  Â  Â  Â  Â  Â  Â  console.log("Snapshot recibido. Redibujando notas...");
Â  Â  Â  Â  Â  Â  Â  if (!grid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("GridStack no estÃ¡ inicializado. No se pueden mostrar notas.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  grid.removeAll(); // Limpiar completamente el grid visual
Â  Â  Â  Â  Â  Â  Â  displayedNotes.clear(); // Limpiar el cache de referencia

Â  Â  Â  Â  Â  Â  Â  snapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const noteId = doc.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = mostrarNotaEnPantalla(doc); // Llama a la funciÃ³n que crea el HTML

Â  Â  Â  Â  Â  Â  Â  Â  Â  if (result && result.element && result.position) { // Verificar que devuelve lo esperado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid.addWidget(result.element, result.position); // AÃ±adir al grid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayedNotes.set(noteId, result.element); // Guardar referencia
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  console.log(`Notas redibujadas: ${displayedNotes.size}`);

Â  Â  Â  Â  Â  Â  Â  // Actualizar calendario despuÃ©s de redibujar todo (por si cambiaron fechas)
Â  Â  Â  Â  Â  Â  Â  if (currentCalendarMonth !== undefined && currentCalendarYear !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â fetchAllAssignedNotes().then(() => { // Recargar cache de fechas
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â generateCalendar(currentCalendarMonth, currentCalendarYear);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â fetchAllAssignedNotes(); // Cargar cache inicial si calendario no estÃ¡ visible
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  console.error("Error crÃ­tico al obtener notas de Firestore:", error);
Â  Â  Â  Â  Â  Â  Â  alert("Error al cargar las notas. Por favor, revisa la consola (F12) y considera recargar la pÃ¡gina.");
Â  Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  console.error("Firestore (db) no estÃ¡ inicializado correctamente.");
Â  Â  Â  Â  alert("Error: No se pudo conectar a la base de datos. Las notas no se cargarÃ¡n.");
Â  Â  }


Â  Â  /****************** Manejo de la Interfaz para Agregar Notas ******************/
Â  Â  const addNoteButtonElem = document.getElementById('addNoteButton');
Â  Â  const addNoteOptionsElem = document.getElementById('addNoteOptions');
Â  Â  const addImageLinkOptionElem = document.getElementById('addImageLinkOption');
Â  Â  const addTextNoteOptionElem = document.getElementById('addTextNoteOption');
Â  Â  const inputAreaElem = document.getElementById('inputArea');
Â  Â  const imageLinkInputAreaElem = document.getElementById('imageLinkInputArea');
Â  Â  const imageLinkInputElem = document.getElementById('imageLink');
Â  Â  // const imageNoteTextElem = Ya declarada arriba
Â  Â  const saveImageLinkButtonElem = document.getElementById('saveImageLink');
Â  Â  const textNoteInputAreaElem = document.getElementById('textNoteInputArea');
Â  Â  // const textNoteInputElem = Ya declarada arriba
Â  Â  const saveTextNoteButtonElem = document.getElementById('saveTextNote');
Â  Â  const blurBackgroundElem = document.querySelector('.blur-background');

Â  Â  function hideMenus() {
Â  Â  Â  if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
Â  Â  Â  if(inputAreaElem) inputAreaElem.style.display = 'none';
Â  Â  Â  if(blurBackgroundElem) blurBackgroundElem.style.display = 'none';
Â  Â  Â  // Limpiar campos
Â  Â  Â  if(imageLinkInputElem) imageLinkInputElem.value = '';
Â  Â  Â  if(imageNoteTextElem) { imageNoteTextElem.value = ''; autoResizeTextarea(imageNoteTextElem); }
Â  Â  Â  if(textNoteInputElem) { textNoteInputElem.value = ''; autoResizeTextarea(textNoteInputElem); }
Â  Â  }

Â  Â  if (addNoteButtonElem) {
Â  Â  Â  Â  addNoteButtonElem.onclick = function (event) {
Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  Â  Â  if (addNoteOptionsElem && addNoteOptionsElem.style.display === 'flex') {
Â  Â  Â  Â  Â  Â  Â  Â  hideMenus();
Â  Â  Â  Â  Â  Â  } else if (addNoteOptionsElem && blurBackgroundElem) {
Â  Â  Â  Â  Â  Â  Â  Â  hideMenus(); // Asegurar que otros menÃºs estÃ©n cerrados
Â  Â  Â  Â  Â  Â  Â  Â  addNoteOptionsElem.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  blurBackgroundElem.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  }

Â  Â  if (addImageLinkOptionElem) {
Â  Â  Â  Â  addImageLinkOptionElem.onclick = function (event) {
Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  Â  Â  if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
Â  Â  Â  Â  Â  Â  if(imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'block';
Â  Â  Â  Â  Â  Â  if(textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'none';
Â  Â  Â  Â  Â  Â  if(inputAreaElem) inputAreaElem.style.display = 'flex';
Â  Â  Â  Â  Â  Â  if(blurBackgroundElem) blurBackgroundElem.style.display = 'block';
Â  Â  Â  Â  Â  Â  if(imageLinkInputElem) imageLinkInputElem.focus();
Â  Â  Â  Â  };
Â  Â  }

Â  Â  if (addTextNoteOptionElem) {
Â  Â  Â  Â  addTextNoteOptionElem.onclick = function (event) {
Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  Â  Â  if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
Â  Â  Â  Â  Â  Â  if(imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'none';
Â  Â  Â  Â  Â  Â  if(textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'block';
Â  Â  Â  Â  Â  Â  if(inputAreaElem) inputAreaElem.style.display = 'flex';
Â  Â  Â  Â  Â  Â  if(blurBackgroundElem) blurBackgroundElem.style.display = 'block';
Â  Â  Â  Â  Â  Â  if(textNoteInputElem) textNoteInputElem.focus();
Â  Â  Â  Â  };
Â  Â  }

Â  Â  if (blurBackgroundElem) {
Â  Â  Â  Â  blurBackgroundElem.onclick = hideMenus;
Â  Â  }

Â  Â  // --- Guardar Notas ---
Â  Â  function guardarLinkDeImagen() {
Â  Â  Â  if (!imageLinkInputElem) return;
Â  Â  Â  let link = imageLinkInputElem.value.trim();
Â  Â  Â  const texto = imageNoteTextElem ? imageNoteTextElem.value.trim() : '';
Â  Â  Â  if (link) {
Â  Â  Â  Â  link = transformDriveLink(link);
Â  Â  Â  Â  // Deshabilitar botÃ³n mientras guarda
Â  Â  Â  Â  if(saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = true;
Â  Â  Â  Â  db.collection('notas').add({
Â  Â  Â  Â  Â  url: link,
Â  Â  Â  Â  Â  texto: texto || null,
Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  tipo: 'imagen'
Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .then(() => { hideMenus(); })
Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  console.error('Error al guardar el link de imagen: ', error);
Â  Â  Â  Â  Â  Â  Â  alert("Error al guardar la imagen.");
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .finally(() => {
Â  Â  Â  Â  Â  Â  Â  Â // Rehabilitar botÃ³n
Â  Â  Â  Â  Â  Â  Â  Â if(saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = false;
Â  Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert("Por favor, introduce un link para la imagen.");
Â  Â  Â  Â  Â  imageLinkInputElem.focus();
Â  Â  Â  }
Â  Â  }

Â  Â  function guardarNotaTexto() {
Â  Â  Â  if (!textNoteInputElem) return;
Â  Â  Â  const nota = textNoteInputElem.value.trim();
Â  Â  Â  if (nota) {
Â  Â  Â  Â  Â  // Deshabilitar botÃ³n mientras guarda
Â  Â  Â  Â  Â  if(saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = true;
Â  Â  Â  Â  db.collection('notas').add({
Â  Â  Â  Â  Â  Â  nota: nota,
Â  Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  Â  tipo: 'texto'
Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .then(() => { hideMenus(); })
Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  console.error('Error al guardar la nota de texto: ', error);
Â  Â  Â  Â  Â  Â  Â  alert("Error al guardar la nota.");
Â  Â  Â  Â  Â  Â })
Â  Â  Â  Â  Â  Â .finally(() => {
Â  Â  Â  Â  Â  Â  Â  Â // Rehabilitar botÃ³n
Â  Â  Â  Â  Â  Â  Â  Â if(saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = false;
Â  Â  Â  Â  Â  Â });
Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert("Por favor, escribe algo en la nota.");
Â  Â  Â  Â  Â  textNoteInputElem.focus();
Â  Â  Â  }
Â  Â  }

Â  Â  if(saveImageLinkButtonElem) saveImageLinkButtonElem.onclick = guardarLinkDeImagen;
Â  Â  if(saveTextNoteButtonElem) saveTextNoteButtonElem.onclick = guardarNotaTexto;

Â  Â  // --- Guardar posiciÃ³n al mover ---
Â  Â  if (grid) {
Â  Â  Â  Â  grid.on('dragstop', function (event, el) {
Â  Â  Â  Â  Â  Â  const node = el.gridstackNode;
Â  Â  Â  Â  Â  Â  const noteId = el.getAttribute('data-note-id');

Â  Â  Â  Â  Â  Â  if (noteId && node) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { // Usar timeout pequeÃ±o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentNode = grid.engine.nodes.get(el);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(currentNode){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // console.log(`Guardando posiciÃ³n para ${noteId}: x=${currentNode.x}, y=${currentNode.y}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â db.collection('notas').doc(noteId).update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â x: currentNode.x, y: currentNode.y
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }).catch(error => console.error("Error guardando posiciÃ³n:", error));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 150); // Aumentar ligeramente el timeout
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }


Â  Â  /****************** Calendario y AsignaciÃ³n de la Bolita ******************/
Â  Â  let currentCalendarMonth, currentCalendarYear;
Â  Â  let assignedDatesCache = {}; // Cache { 'D/M/YYYY': [noteId1, noteId2] }
Â  Â  let notesDataCache = {}; // Cache { noteId: { assignedDate: '...', ... } }

Â  Â  function getChileDate() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const options = { timeZone: 'America/Santiago', year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false };
Â  Â  Â  Â  Â  Â  const formatter = new Intl.DateTimeFormat('en-CA', options);
Â  Â  Â  Â  Â  Â  const parts = formatter.formatToParts(new Date());
Â  Â  Â  Â  Â  Â  const dateMap = {};
Â  Â  Â  Â  Â  Â  parts.forEach(({ type, value }) => dateMap[type] = parseInt(value, 10));
Â  Â  Â  Â  Â  Â  return new Date(Date.UTC(dateMap.year, dateMap.month - 1, dateMap.day, dateMap.hour, dateMap.minute, dateMap.second));
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.warn("Intl.DateTimeFormat con TimeZone no soportado o fallÃ³, usando hora local.", e);
Â  Â  Â  Â  Â  Â  return new Date();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function initCalendarDate() {
Â  Â  Â  Â  let today = getChileDate();
Â  Â  Â  Â  let year = today.getFullYear();
Â  Â  Â  Â  let month = today.getMonth();
Â  Â  Â  Â  const minYear = 2024; const minMonth = 11;
Â  Â  Â  Â  if (year < minYear || (year === minYear && month < minMonth)) {
Â  Â  Â  Â  Â  Â  return { month: minMonth, year: minYear };
Â  Â  Â  Â  }
Â  Â  Â  Â  return { month, year };
Â  Â  }

Â  Â  function getMonthName(monthIndex) {
Â  Â  Â  Â  const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
Â  Â  Â  Â  return months[monthIndex % 12] || '';
Â  Â  }

Â  Â  async function fetchAllAssignedNotes() {
Â  Â  Â  Â  assignedDatesCache = {}; notesDataCache = {};
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const snapshot = await db.collection('notas').where('assignedDate', '!=', null).get();
Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = doc.data(); const noteId = doc.id;
Â  Â  Â  Â  Â  Â  Â  Â  notesDataCache[noteId] = data; const dateStr = data.assignedDate;
Â  Â  Â  Â  Â  Â  Â  Â  if (dateStr) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!assignedDatesCache[dateStr].includes(noteId)) assignedDatesCache[dateStr].push(noteId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (error) { console.error("Error fetching assigned notes:", error); }
Â  Â  }

Â  Â  async function generateCalendar(month, year) {
Â  Â  Â  Â  if (Object.keys(notesDataCache).length === 0) await fetchAllAssignedNotes(); // Cargar si cache estÃ¡ vacÃ­o

Â  Â  Â  Â  const calendarDiv = document.getElementById('calendarWidget');
Â  Â  Â  Â  if (!calendarDiv) return;
Â  Â  Â  Â  calendarDiv.innerHTML = '';
Â  Â  Â  Â  const today = getChileDate();

Â  Â  Â  Â  // Cabecera
Â  Â  Â  Â  const header = document.createElement('div'); header.className = 'calendar-header';
Â  Â  Â  Â  const prevBtn = document.createElement('button'); prevBtn.innerHTML = '&lt;';
Â  Â  Â  Â  const minYear = 2024; const minMonth = 11;
Â  Â  Â  Â  if (year === minYear && month === minMonth) prevBtn.disabled = true;
Â  Â  Â  Â  else prevBtn.onclick = () => generateCalendar(month === 0 ? 11 : month - 1, month === 0 ? year - 1 : year);
Â  Â  Â  Â  const nextBtn = document.createElement('button'); nextBtn.innerHTML = '&gt;';
Â  Â  Â  Â  nextBtn.onclick = () => generateCalendar(month === 11 ? 0 : month + 1, month === 11 ? year + 1 : year);
Â  Â  Â  Â  const title = document.createElement('span'); title.textContent = `${getMonthName(month)} ${year}`;
Â  Â  Â  Â  header.appendChild(prevBtn); header.appendChild(title); header.appendChild(nextBtn);
Â  Â  Â  Â  calendarDiv.appendChild(header);

Â  Â  Â  Â  // DÃ­as semana
Â  Â  Â  Â  const daysHeader = document.createElement('div'); daysHeader.className = 'calendar-days-header';
Â  Â  Â  Â  ['Do','Lu','Ma','Mi','Ju','Vi','SÃ¡'].forEach(day => { const d = document.createElement('div'); d.className = 'calendar-day'; d.textContent = day; daysHeader.appendChild(d); });
Â  Â  Â  Â  calendarDiv.appendChild(daysHeader);

Â  Â  Â  Â  // Grid fechas
Â  Â  Â  Â  const datesGrid = document.createElement('div'); datesGrid.className = 'calendar-dates-grid';
Â  Â  Â  Â  const firstDayOfMonth = new Date(year, month, 1).getDay();
Â  Â  Â  Â  const daysInMonth = new Date(year, month + 1, 0).getDate();

Â  Â  Â  Â  for (let i = 0; i < firstDayOfMonth; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesGrid.appendChild(e); }
Â  Â  Â  Â  for (let date = 1; date <= daysInMonth; date++) {
Â  Â  Â  Â  Â  Â  const dateCell = document.createElement('div'); dateCell.className = 'calendar-date'; dateCell.textContent = date;
Â  Â  Â  Â  Â  Â  const dateStr = `${date}/${month + 1}/${year}`;
Â  Â  Â  Â  Â  Â  if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dateCell.classList.add('today');

Â  Â  Â  Â  Â  Â  if (assignedDatesCache[dateStr]) { // Bolitas
Â  Â  Â  Â  Â  Â  Â  Â  assignedDatesCache[dateStr].forEach(noteId => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const b = document.createElement("span"); b.className = "assigned-bubble"; b.setAttribute("data-note", noteId); b.textContent = "â—"; dateCell.appendChild(b);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Eventos Drag & Drop
Â  Â  Â  Â  Â  Â  dateCell.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; dateCell.classList.add('drag-over'); });
Â  Â  Â  Â  Â  Â  dateCell.addEventListener('dragleave', (e) => { dateCell.classList.remove('drag-over'); });
Â  Â  Â  Â  Â  Â  dateCell.addEventListener('drop', async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault(); dateCell.classList.remove('drag-over');
Â  Â  Â  Â  Â  Â  Â  Â  const noteId = e.dataTransfer.getData("application/note-id");
Â  Â  Â  Â  Â  Â  Â  Â  if (noteId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oldDateStr = notesDataCache[noteId]?.assignedDate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await db.collection('notas').doc(noteId).update({ assignedDate: dateStr });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Actualizar Caches ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(notesDataCache[noteId]) notesDataCache[noteId].assignedDate = dateStr; else notesDataCache[noteId] = { assignedDate: dateStr };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (oldDateStr && assignedDatesCache[oldDateStr]) { assignedDatesCache[oldDateStr] = assignedDatesCache[oldDateStr].filter(id => id !== noteId); if (assignedDatesCache[oldDateStr].length === 0) delete assignedDatesCache[oldDateStr]; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = []; if (!assignedDatesCache[dateStr].includes(noteId)) assignedDatesCache[dateStr].push(noteId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Actualizar UI ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bubbleInCard = document.getElementById(`bubble-${noteId}`); if (bubbleInCard) bubbleInCard.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  generateCalendar(currentCalendarMonth, currentCalendarYear); // Regenerar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) { console.error(`Error al asignar fecha a nota ${noteId}:`, error); alert("Error al asignar la fecha."); }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  datesGrid.appendChild(dateCell);
Â  Â  Â  Â  }
Â  Â  Â  Â  const totalCells = firstDayOfMonth + daysInMonth; // Celdas vacÃ­as final
Â  Â  Â  Â  const cellsNeeded = totalCells <= 35 ? 35 : 42;
Â  Â  Â  Â  for (let i = totalCells; i < cellsNeeded; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesGrid.appendChild(e); }
Â  Â  Â  Â  calendarDiv.appendChild(datesGrid);
Â  Â  Â  Â  currentCalendarMonth = month; currentCalendarYear = year;
Â  Â  }

Â  Â  // --- Mostrar/ocultar calendario ---
Â  Â  const calendarIconElem = document.getElementById('calendarIcon');
Â  Â  const calendarWidgetElem = document.getElementById('calendarWidget');
Â  Â  let calendarTimeout;

Â  Â  function showCalendar() {
Â  Â  Â  Â  if (!calendarWidgetElem) return; clearTimeout(calendarTimeout);
Â  Â  Â  Â  if (calendarWidgetElem.style.display !== 'block') {
Â  Â  Â  Â  Â  Â  const { month, year } = initCalendarDate(); generateCalendar(month, year); calendarWidgetElem.style.display = 'block';
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function hideCalendar() { if (!calendarWidgetElem) return; calendarTimeout = setTimeout(() => { calendarWidgetElem.style.display = 'none'; }, 300); }

Â  Â  if (calendarIconElem) { calendarIconElem.addEventListener('mouseenter', showCalendar); calendarIconElem.addEventListener('mouseleave', hideCalendar); }
Â  Â  if (calendarWidgetElem) { calendarWidgetElem.addEventListener('mouseenter', () => clearTimeout(calendarTimeout)); calendarWidgetElem.addEventListener('mouseleave', hideCalendar); }
Â  Â  function openCalendar() { showCalendar(); }


Â  Â  /****************** Otros Event Listeners y Setup Inicial ******************/
Â  Â  if (addNoteOptionsElem) addNoteOptionsElem.addEventListener('click', (e) => e.stopPropagation());
Â  Â  if (inputAreaElem) inputAreaElem.addEventListener('click', (e) => e.stopPropagation());

Â  Â  // --- Fin del Script ---
Â  </script>
</body>
</html>
