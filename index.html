<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notas Oceánicas - Polaroid</title>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
  <style>
    /* --- Estilos para el Menú Superior --- */
#top-menu-bar {
  background-color: #03254c; /* Un color oscuro, ajusta como quieras */
  padding: 5px 15px;
  position: sticky; /* O 'fixed' si quieres que siempre esté arriba */
  top: 0;
  left: 0;
  width: 100%;
  z-index: 1010; /* Más alto que otros elementos fijos */
  box-sizing: border-box;
  display: flex; /* Para alinear el botón */
  align-items: center;
}

#menu-toggle-button {
  background: none;
  border: none;
  color: #fff; /* Color del ícono */
  font-size: 28px; /* Tamaño del ícono */
  cursor: pointer;
  padding: 5px;
  line-height: 1; /* Ajusta la altura */
}

#top-menu-options {
  position: absolute; /* Se posiciona relativo a la barra */
  top: 100%; /* Justo debajo de la barra */
  left: 0;
  background-color: #f8f9fa; /* Fondo claro */
  border: 1px solid #ccc;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  min-width: 200px; /* Ancho mínimo */
  z-index: 1011; /* Encima de la barra pero debajo del botón si se superponen */
}

#top-menu-options a {
  display: block;
  padding: 10px 15px;
  color: #333;
  text-decoration: none;
  border-bottom: 1px solid #eee;
}

#top-menu-options a:last-child {
  border-bottom: none;
}

#top-menu-options a:hover {
  background-color: #e9ecef;
}
/* --- Fin Estilos Menú Superior --- */
    /* Estilos CSS (sin cambios respecto a tu versión original, excepto los botones) */
    .grid-stack-item,
    .grid-stack-item-content,
    .card-wrapper,
    .text-card,
    .note-content {
      box-shadow: none !important;
    }
    .grid-stack-item[data-note-type="imagen"].grid-stack-item-dragging,
    .grid-stack-item[data-note-type="imagen"].grid-stack-item-dragging .grid-stack-item-content {
      opacity: 0.7 !important;
      border: 3px dashed red !important;
      background-color: rgba(255, 0, 0, 0.3) !important;
      box-shadow: none !important;
    }
    .grid-stack-item[data-note-type="texto"].grid-stack-item-dragging,
    .grid-stack-item[data-note-type="texto"].grid-stack-item-dragging .grid-stack-item-content {
      opacity: 0.7 !important;
      border: 3px dashed #a2dff7 !important;
      background-color: rgba(162, 223, 247, 0.3) !important;
      box-shadow: none !important;
    }
    .grid-stack-placeholder {
      display: none !important;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden; /* Evita scroll en el body principal */
      background: linear-gradient(to bottom, #a2dff7 0%, #a2dff7 40%, #03254c 100%);
      font-family: Arial, sans-serif;
    }
    .container {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden; /* Evita que el container cause scroll si no es necesario */
    }
    #notaDisplay {
      flex-grow: 1;
      width: 100%;
      overflow-y: auto; /* Permite scroll SOLO en el área de notas */
      overflow-x: hidden;
      position: relative; /* Mantiene contexto para gridstack */
      /* min-width: 1000px; /* Eliminado o ajustado si causa problemas */
    }
    .grid-stack-item {
      transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      overflow: visible !important;
      margin-bottom: 0px;
    }
    .grid-stack-item-content {
      overflow: visible !important;
      height: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    .card-wrapper, .text-card {
      background-color: #fff;
      border: 2px solid #0077a3;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      position: relative;
      box-sizing: border-box;
      height: 100%;
    }
    .image-container {
      width: 100%;
      height: auto;
      max-height: 200px;
      overflow: hidden;
      position: relative;
      flex-shrink: 0;
    }
    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .note-content {
      background-color: #fff;
      padding: 10px;
      text-align: left;
      font-size: 16px;
      color: #333;
      min-height: 50px;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow: hidden;
      flex-grow: 1;
    }
    .note-content a {
      color: #0077a3;
      text-decoration: underline;
    }
    .menu-bar {
      background-color: #0288D1;
      padding: 5px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      border-top: 1px solid #0077a3;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      margin-top: auto;
    }
    .menu-icon {
      background: none;
      border: none;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      padding: 2px 4px;
    }
    .bubble-icon {
      color: #FFCD05;
      font-size: 22px;
    }
    .menu-actions {
      display: flex;
      gap: 4px;
    }
    /* --- CAMBIO AQUÍ: Botón Añadir Nota Fijo --- */
    #addNoteButton {
      position: fixed; /* Cambiado a fixed */
      bottom: 30px;
      right: 30px;
      background-color: #006994;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, transform 0.3s ease;
      z-index: 1001; /* Asegura que esté sobre otros elementos */
    }
    #addNoteButton:hover {
      background-color: #005577;
      transform: scale(1.05);
    }
    #addNoteOptions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.85);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 25px;
      padding: 25px;
      z-index: 1002;
    }
    #addNoteOptions .card {
      background-color: #2c2c2c;
      border: 1px solid #0077a3;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 180px;
    }
    #addNoteOptions .card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 119, 163, 0.5);
    }
    #addNoteOptions .card h2 {
      color: #36a2eb;
      margin-bottom: 10px;
    }
    #addNoteOptions .card p {
      color: #ccc;
      font-size: 14px;
    }
    #inputArea {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ffffff;
      padding: 25px 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      gap: 15px;
      width: 90%;
      max-width: 550px;
      z-index: 1002;
    }
    #inputArea label {
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
      font-size: 14px;
    }
    #inputArea textarea, #inputArea input[type="text"] {
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
      line-height: 1.5;
      font-size: 16px;
    }
    #inputArea textarea {
      min-height: 80px;
    }
    #inputArea textarea#textNote {
      min-height: 120px;
    }
    #inputArea button {
      padding: 10px 20px;
      background-color: #006994;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      align-self: flex-end;
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
    }
    #inputArea button:hover {
      background-color: #005577;
    }
    #inputArea button:active {
      transform: scale(0.98);
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    /* --- CAMBIO AQUÍ: Icono Calendario Fijo --- */
    .calendar-icon {
      position: fixed; /* Cambiado a fixed */
      bottom: 30px;
      left: 30px;
      width: 45px;
      height: 45px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001; /* Asegura que esté sobre otros elementos */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .calendar-widget {
      position: fixed; /* Cambiado a fixed para que se muestre relativo al icono fijo */
      bottom: 85px; /* Posición sobre el icono */
      left: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      padding: 15px;
      display: none;
      z-index: 1001; /* Mismo nivel que los iconos */
      width: 320px;
      min-height: 300px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .calendar-header button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #0077a3;
      padding: 5px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    .calendar-header button:hover:not(:disabled) {
      background-color: #e0f7fa;
    }
    .calendar-header button:disabled {
      color: #ccc;
      cursor: default;
    }
    .calendar-header span {
      font-weight: bold;
      color: #333;
      font-size: 18px;
    }
    .calendar-days-header, .calendar-dates-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 6px;
    }
    .calendar-days-header {
      margin-bottom: 10px;
      font-weight: bold;
      color: #555;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    .calendar-day {
      padding: 3px;
    }
    .calendar-date {
      padding: 0;
      border-radius: 50%;
      color: #333;
      border: 2px solid transparent;
      cursor: pointer;
      position: relative;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      line-height: 1;
      font-size: 14px;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .calendar-date.empty {
      background: none;
      cursor: default;
      opacity: 0;
    }
    .calendar-date:not(.empty):hover {
      background-color: #e0f7fa;
      border-color: #b3e5fc;
    }
    .calendar-date.today {
      border-color: #0077a3;
      font-weight: bold;
      color: #005577;
    }
    .calendar-date.drag-over {
      background-color: #a2dff7 !important;
      border-color: #0077a3 !important;
    }
    .assigned-bubble {
      color: #FFCD05;
      font-size: 11px;
      position: absolute;
      bottom: 3px;
      left: 50%;
      transform: translateX(-50%);
      line-height: 1;
      text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }
    .calendar-date .assigned-bubble + .assigned-bubble {
      bottom: -2px;
    }
    .blur-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      z-index: 1000;
      cursor: pointer;
    }
    @media (max-width: 575.98px) {
      #inputArea {
        width: 95%;
      }
      #addNoteOptions {
        flex-direction: column;
        gap: 15px;
        padding: 20px;
      }
      #addNoteOptions .card {
        width: 150px;
      }
      .calendar-widget {
        width: 90%;
        left: 5%;
        bottom: 75px;
      }
      /* Ajusta posición de botones fijos en pantallas pequeñas si es necesario */
      #addNoteButton {
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
          font-size: 24px;
      }
      .calendar-icon {
          bottom: 20px;
          left: 20px;
          width: 40px;
          height: 40px;
          font-size: 20px;
      }
    }
    @media (max-width: 576px) {
      /* Ajustes adicionales si se necesitan */
    }
  </style>
</head>
<body>

  <div id="top-menu-bar">
    <button id="menu-toggle-button" title="Menú">☰</button>
    <div id="top-menu-options" style="display: none;">
      <a href="calendario_grande.html" target="_blank">Ver Calendario Grande</a>
      </div>
  </div>

  <div id="auth-section" style="...">...</div>
  <div class="container">...</div>
  ...
  <div id="auth-section" style="padding: 15px; background-color: #f0f0f0; border-bottom: 1px solid #ccc; text-align: center; margin-bottom: 10px;">
    <div id="login-form">
      <input type="email" id="login-email" placeholder="Correo" style="padding: 8px; margin-right: 5px;">
      <input type="password" id="login-password" placeholder="Contraseña" style="padding: 8px; margin-right: 5px;">
      <button id="login-button" style="padding: 8px 12px;">Entrar</button>
    </div>
    <div id="user-info" style="display: none;">
      <span>Conectado como: <strong id="user-email-display"></strong></span>
      <button id="logout-button" style="padding: 8px 12px; margin-left: 15px;">Salir</button>
    </div>
  </div>

  <div class="container">
    <div id="notaDisplay" class="grid-stack"></div>
    <button id="addNoteButton" title="Añadir nueva nota o imagen">+</button>
    <div id="addNoteOptions">
      <div class="card" id="addImageLinkOption" title="Añadir una nota con imagen desde un enlace web">
        <h2>🖼️ Imagen</h2>
        <p>Guardar link de imagen.</p>
      </div>
      <div class="card" id="addTextNoteOption" title="Añadir una nota de texto simple">
        <h2>📝 Nota</h2>
        <p>Subir nota de texto.</p>
      </div>
    </div>
    <div id="inputArea">
      <div id="imageLinkInputArea" style="display: none;">
        <div class="input-group">
          <label for="imageLink">Link de la imagen:</label>
          <input type="text" id="imageLink" placeholder="Pega aquí la URL de la imagen (ej: https://...)" />
        </div>
        <div class="input-group">
          <label for="imageNoteText">Texto adicional (opcional):</label>
          <textarea id="imageNoteText" placeholder="Escribe aquí una descripción o nota relacionada con la imagen..." rows="3"></textarea>
        </div>
        <button id="saveImageLink">Guardar Imagen</button>
      </div>
      <div id="textNoteInputArea" style="display: none;">
        <div class="input-group">
          <label for="textNote">Nota:</label>
          <textarea id="textNote" placeholder="Escribe tu nota aquí..." rows="5"></textarea>
        </div>
        <button id="saveTextNote">Guardar Nota</button>
      </div>
    </div>
    <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">📅</div>
    <div id="calendarWidget" class="calendar-widget"></div>
    <div class="blur-background"></div>
  </div>

  <script>
    // --- Funciones Utilitarias (sin cambios) ---
    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(?<!href=["'])(https?:\/\/[^\s<>"']+)/g;
      const replacedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return replacedText.replace(/\n/g, '<br>');
    }
    function autoResizeTextarea(el) {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight + 2) + 'px';
    }

    // --- Configuración de Firebase (sin cambios) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCHa373WgLLHsy8wZXK9zr_HVieQvlrhUs",
      authDomain: "oasis-b036d.firebaseapp.com",
      projectId: "oasis-b036d",
      storageBucket: "oasis-b036d.appspot.com",
      messagingSenderId: "141546637821",
      appId: "1:141546637821:web:0a861aeb13831774ed3194",
      measurementId: "G-HB2P17H5YL"
    };
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) {
      console.error("Error inicializando Firebase:", e);
      alert("Error crítico: No se pudo inicializar la conexión a la base de datos.");
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Variables Globales y Configuración de Gridstack (sin cambios) ---
    let grid;
    try {
      grid = GridStack.init({
        column: 12, margin: 5, cellHeight: 'auto', disableResize: true, float: true,
        overlap: false, animate: true, alwaysShowResizeHandle: false,
        draggable: { handle: '.menu-bar', scroll: true, appendTo: 'body' }
      });
    } catch (e) {
      console.error("Error inicializando GridStack:", e);
      alert("Error crítico: No se pudo inicializar el área de notas.");
    }

    // --- Responsividad del Grid (sin cambios) ---
    const gridStackElement = document.getElementById('notaDisplay');
    let currentColumnCount = 12;
    const breakpoints = [ { width: 992, cols: 12 }, { width: 576, cols: 6 }, { width: 0, cols: 3 } ];
    function adjustGridColumns() {
      const screenWidth = window.innerWidth;
      let newColumnCount = 12;
      for (const bp of breakpoints) { if (screenWidth >= bp.width) { newColumnCount = bp.cols; break; } }
      if (grid && newColumnCount !== currentColumnCount) { grid.column(newColumnCount, true); currentColumnCount = newColumnCount; console.log("Grid ajustado a", newColumnCount, "columnas"); }
    }
    adjustGridColumns();
    let resizeTimer;
    window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(adjustGridColumns, 150); });

    // --- Eventos de Gridstack para Guardar Posición (sin cambios) ---
    if (grid) {
      grid.on('change', function (event, items) {
        items.forEach(function (item) {
          const noteIdToSave = item.el?.getAttribute('data-note-id');
          if (noteIdToSave && typeof item.x === 'number' && typeof item.y === 'number') {
            db.collection('notas').doc(noteIdToSave).update({ x: item.x, y: item.y })
              .catch(err => console.error(`Error guardando posición (${noteIdToSave}) desde 'change': ${err.message}`));
          }
        });
      });
      grid.on('dragstop', function (event, element) {
        const node = grid.engine.nodes.find(n => n.el === element);
        if (node) { const noteId = node.el?.getAttribute('data-note-id') || node.id; console.log(`Dragstop: ${noteId} en x=${node.x}, y=${node.y}`); }
      });
    } else { console.error("Grid no inicializado."); }

    // --- Referencias a Elementos del DOM (sin cambios) ---
    const textNoteInputElem = document.getElementById('textNote');
    const imageNoteTextElem = document.getElementById('imageNoteText');
    const addNoteButtonElem = document.getElementById('addNoteButton');
    const addNoteOptionsElem = document.getElementById('addNoteOptions');
    const addImageLinkOptionElem = document.getElementById('addImageLinkOption');
    const addTextNoteOptionElem = document.getElementById('addTextNoteOption');
    const inputAreaElem = document.getElementById('inputArea');
    const imageLinkInputAreaElem = document.getElementById('imageLinkInputArea');
    const imageLinkInputElem = document.getElementById('imageLink');
    const saveImageLinkButtonElem = document.getElementById('saveImageLink');
    const textNoteInputAreaElem = document.getElementById('textNoteInputArea');
    const saveTextNoteButtonElem = document.getElementById('saveTextNote');
    const blurBackgroundElem = document.querySelector('.blur-background');
    const calendarIconElem = document.getElementById('calendarIcon');
    const calendarWidgetElem = document.getElementById('calendarWidget');
    const loginFormDiv = document.getElementById('login-form');
    const userInfoDiv = document.getElementById('user-info');
    const userEmailDisplay = document.getElementById('user-email-display');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const emailInput = document.getElementById('login-email');
    const passwordInput = document.getElementById('login-password');

    // --- Variables Globales para Estado (sin cambios) ---
    const displayedNotes = new Map();
    let currentCalendarMonth, currentCalendarYear;
    let assignedDatesCache = {};
    let notesDataCache = {};
    let calendarTimeout;
    let unsubscribeFirestore = null;

    // --- Listener para auto-resize de textareas (sin cambios) ---
    if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
    if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));

    // --- Función para Crear/Actualizar Notas en el Grid (CORREGIDA) ---
    function mostrarNotaEnPantalla(doc) {
      const notaData = doc.data();
      const noteId = doc.id;
      let gridItem = document.createElement('div');
      gridItem.classList.add('grid-stack-item');
      gridItem.setAttribute('data-note-id', noteId);
      gridItem.setAttribute('data-note-type', notaData.tipo);
      const content = document.createElement('div');
      content.classList.add('grid-stack-item-content');
      let card;
      let noteContentElement = null;

      if (notaData.url) {
        card = document.createElement('div');
        card.classList.add('card-wrapper');
        const imageContainer = document.createElement('div');
        imageContainer.classList.add('image-container');
        const img = document.createElement('img');
        img.src = notaData.url;
        img.alt = notaData.texto || 'Imagen de la nota';
        img.loading = 'lazy';
        img.onerror = () => { imageContainer.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; background-color:#eee; color:red; text-align:center; padding:10px;">⚠️<br/>Error al<br/>cargar imagen</div>`; };
        imageContainer.appendChild(img);
        card.appendChild(imageContainer);
        if (notaData.texto) {
          noteContentElement = document.createElement('div');
          noteContentElement.classList.add('note-content');
          noteContentElement.innerHTML = linkify(notaData.texto);
          card.appendChild(noteContentElement);
        }
      } else if (notaData.nota) {
        card = document.createElement('div');
        card.classList.add('text-card');
        noteContentElement = document.createElement('div');
        noteContentElement.classList.add('note-content');
        noteContentElement.innerHTML = linkify(notaData.nota);
        card.appendChild(noteContentElement);
      } else { return null; }

      if (noteContentElement) {
        Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        }); // CORREGIDO: Punto y coma añadido
      }

      const menuBar = document.createElement('div');
      menuBar.classList.add('menu-bar');
      const bubbleButton = document.createElement('button');
      bubbleButton.classList.add('menu-icon', 'bubble-icon');
      bubbleButton.innerHTML = '●';
      bubbleButton.setAttribute('draggable', 'true');
      bubbleButton.id = `bubble-${noteId}`;
      bubbleButton.title = "Arrastrar al calendario";
      bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';
      bubbleButton.addEventListener('dragstart', (e) => {
        var imgGhost = new Image(); imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
        e.dataTransfer.setDragImage(imgGhost, 0, 0);
        e.dataTransfer.setData("application/note-id", noteId);
        e.dataTransfer.effectAllowed = "move";
        if (typeof openCalendar === 'function') openCalendar();
      });
      bubbleButton.addEventListener('click', (e) => { e.stopPropagation(); if (typeof openCalendar === 'function') openCalendar(); });

      const menuActions = document.createElement('div');
      menuActions.classList.add('menu-actions');
      const editButton = document.createElement('button');
      editButton.classList.add('menu-icon'); editButton.innerHTML = '✎'; editButton.title = "Editar";
      const deleteButton = document.createElement('button');
      deleteButton.classList.add('menu-icon'); deleteButton.innerHTML = '✖'; deleteButton.title = "Eliminar";

      deleteButton.onclick = (e) => {
        e.stopPropagation();
        if (typeof deleteNote === 'function') { if (confirm(`¿Seguro que quieres eliminar esta nota?`)) { deleteNote(noteId, gridItem); } }
        else { console.error("Función deleteNote no encontrada"); alert("Error interno al eliminar."); }
      };
      editButton.onclick = (e) => {
        e.stopPropagation();
        if (typeof editNoteContent === 'function') { editNoteContent(card, noteId, notaData, menuActions, editButton, deleteButton); }
        else { console.error("Función editNoteContent no encontrada"); }
      };

      menuActions.appendChild(editButton); menuActions.appendChild(deleteButton);
      menuBar.appendChild(bubbleButton); menuBar.appendChild(menuActions);
      card.appendChild(menuBar);
      content.appendChild(card);
      gridItem.appendChild(content);

      const pos = { x: notaData.x, y: notaData.y, w: notaData.w || 2, h: notaData.h || 'auto', id: noteId, autoPosition: (notaData.x === undefined || notaData.y === undefined) };
      gridItem.docData = notaData;
      return { element: gridItem, position: pos };
    } // --- Fin de mostrarNotaEnPantalla ---

    // --- Función para Editar Contenido de Notas (sin cambios funcionales) ---
    function editNoteContent(card, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
      let targetElement = card.querySelector('.note-content');
      if (!targetElement && notaData.url) { targetElement = document.createElement('div'); targetElement.classList.add('note-content'); card.insertBefore(targetElement, card.querySelector('.menu-bar')); }
      else if (!targetElement && !notaData.url) { console.error("Error: No se encontró .note-content para editar texto en nota:", noteId); return; }
      const isImageNote = !!notaData.url;
      const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');
      targetElement.innerHTML = '';
      const editInput = document.createElement('textarea');
      editInput.value = currentText;
      editInput.style.cssText = "width:100%; min-height:80px; height:auto; box-sizing:border-box; border:1px dashed #ccc; resize:vertical; margin-bottom: 5px;";
      targetElement.appendChild(editInput);
      autoResizeTextarea(editInput);
      editInput.addEventListener('input', () => autoResizeTextarea(editInput));
      editInput.focus();
      const saveEditButton = document.createElement('button');
      saveEditButton.classList.add('menu-icon'); saveEditButton.innerHTML = '💾'; saveEditButton.title = "Guardar Cambios";
      saveEditButton.onclick = (e) => {
        e.stopPropagation();
        const newText = editInput.value.trim();
        const updateData = isImageNote ? { texto: newText || firebase.firestore.FieldValue.delete() } : { nota: newText };
        if (!isImageNote && !newText) { alert("La nota de texto no puede quedar vacía."); return; }
        saveEditButton.disabled = true; saveEditButton.innerHTML = '⏳';
        db.collection('notas').doc(noteId).update(updateData)
          .then(() => { console.log("Nota actualizada:", noteId); /* onSnapshot actualizará UI */ })
          .catch((error) => { console.error('Error al actualizar nota:', error); alert("Error al guardar."); saveEditButton.disabled = false; saveEditButton.innerHTML = '💾'; });
      };
      menuActionsContainer.innerHTML = ''; menuActionsContainer.appendChild(saveEditButton);
    } // --- Fin de editNoteContent ---

    // --- Función para Eliminar Notas (sin cambios funcionales) ---
    function deleteNote(noteId, gridItem) {
      console.log("Intentando eliminar nota:", noteId);
      db.collection('notas').doc(noteId).delete()
        .then(() => { console.log(`Nota ${noteId} eliminada de Firestore.`); /* onSnapshot quitará del grid */ })
        .catch((error) => { console.error("Error al eliminar nota:", error); alert("Error al eliminar la nota."); });
    } // --- Fin de deleteNote ---

    // --- Funciones UI (Popups, etc.) (sin cambios funcionales) ---
    function hideMenus() {
      if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
      if (inputAreaElem) inputAreaElem.style.display = 'none';
      if (blurBackgroundElem) blurBackgroundElem.style.display = 'none';
      if (imageLinkInputElem) imageLinkInputElem.value = '';
      if (imageNoteTextElem) { imageNoteTextElem.value = ''; autoResizeTextarea(imageNoteTextElem); }
      if (textNoteInputElem) { textNoteInputElem.value = ''; autoResizeTextarea(textNoteInputElem); }
    }
    if (addNoteButtonElem) { addNoteButtonElem.onclick = (e) => { e.stopPropagation(); if (addNoteOptionsElem && addNoteOptionsElem.style.display === 'flex') { hideMenus(); } else if (addNoteOptionsElem && blurBackgroundElem) { hideMenus(); addNoteOptionsElem.style.display = 'flex'; blurBackgroundElem.style.display = 'block'; } }; }
    if (addImageLinkOptionElem) { addImageLinkOptionElem.onclick = (e) => { e.stopPropagation(); if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if (imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'block'; if (textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'none'; if (inputAreaElem) inputAreaElem.style.display = 'flex'; if (blurBackgroundElem) blurBackgroundElem.style.display = 'block'; if (imageLinkInputElem) imageLinkInputElem.focus(); }; }
    if (addTextNoteOptionElem) { addTextNoteOptionElem.onclick = (e) => { e.stopPropagation(); if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if (imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'none'; if (textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'block'; if (inputAreaElem) inputAreaElem.style.display = 'flex'; if (blurBackgroundElem) blurBackgroundElem.style.display = 'block'; if (textNoteInputElem) textNoteInputElem.focus(); }; }
    if (blurBackgroundElem) { blurBackgroundElem.onclick = hideMenus; }

    // --- Funciones para Guardar Nuevas Notas (sin cambios funcionales) ---
    function guardarLinkDeImagen() {
      if (!imageLinkInputElem || !db) return;
      let link = imageLinkInputElem.value.trim();
      const texto = imageNoteTextElem ? imageNoteTextElem.value.trim() : '';
      if (link && (link.startsWith('http://') || link.startsWith('https://'))) {
        if (saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = true;
        db.collection('notas').add({ url: link, texto: texto || null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tipo: 'imagen', w: 2, h: 'auto' })
          .then(() => { console.log("Imagen guardada."); hideMenus(); })
          .catch((error) => { console.error('Error al guardar link:', error); alert("Error al guardar imagen: " + error.message); })
          .finally(() => { if (saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = false; });
      } else { alert("Introduce un link válido (http:// o https://)."); imageLinkInputElem.focus(); }
    }
    function guardarNotaTexto() {
      if (!textNoteInputElem || !db) return;
      const nota = textNoteInputElem.value.trim();
      if (nota) {
        if (saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = true;
        db.collection('notas').add({ nota: nota, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tipo: 'texto', w: 2, h: 'auto' })
          .then(() => { console.log("Nota de texto guardada."); hideMenus(); })
          .catch((error) => { console.error('Error al guardar nota:', error); alert("Error al guardar nota: " + error.message); })
          .finally(() => { if (saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = false; });
      } else { alert("Escribe algo en la nota."); textNoteInputElem.focus(); }
    }
    if (saveImageLinkButtonElem) saveImageLinkButtonElem.onclick = guardarLinkDeImagen;
    if (saveTextNoteButtonElem) saveTextNoteButtonElem.onclick = guardarNotaTexto;

    // --- Lógica del Calendario (REINTEGRADA Y CORREGIDA) ---
    function getChileDate() {
      try {
        const opts = { timeZone: 'America/Santiago', year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false };
        const fmt = new Intl.DateTimeFormat('en-CA', opts);
        const p = fmt.formatToParts(new Date()); const d = {}; p.forEach(({ type, value }) => d[type] = parseInt(value, 10));
        return new Date(Date.UTC(d.year, d.month - 1, d.day, d.hour, d.minute, d.second));
      } catch (e) { console.warn("Intl fallback", e); return new Date(); }
    }
    function initCalendarDate() { let today = getChileDate(); return { month: today.getMonth(), year: today.getFullYear() }; }
    function getMonthName(idx) { const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']; return months[idx] || ''; }
    async function fetchAllAssignedNotes() {
      console.log("Fetching assigned notes..."); assignedDatesCache = {};
      try {
        const snap = await db.collection('notas').where('assignedDate', '!=', null).get();
        snap.forEach(doc => {
          const d = doc.data(); const id = doc.id; if (!notesDataCache[id]) notesDataCache[id] = d;
          const dateStr = d.assignedDate; if (dateStr) { if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = []; if (!assignedDatesCache[dateStr].includes(id)) assignedDatesCache[dateStr].push(id); }
        }); console.log("Assigned dates cache updated:", assignedDatesCache);
      } catch (err) { console.error("Error fetching assigned notes:", err); }
    }
    async function generateCalendar(month, year) {
      if (Object.keys(assignedDatesCache).length === 0) await fetchAllAssignedNotes();
      if (!calendarWidgetElem) return; calendarWidgetElem.innerHTML = '';
      const today = getChileDate(); const currentMonth = today.getMonth(); const currentYear = today.getFullYear(); const currentDate = today.getDate();
      const hdr = document.createElement('div'); hdr.className = 'calendar-header';
      const pBtn = document.createElement('button'); pBtn.innerHTML = '&lt;'; pBtn.title = "Mes Anterior"; pBtn.onclick = () => generateCalendar(month === 0 ? 11 : month - 1, month === 0 ? year - 1 : year);
      const nBtn = document.createElement('button'); nBtn.innerHTML = '&gt;'; nBtn.title = "Mes Siguiente"; nBtn.onclick = () => generateCalendar(month === 11 ? 0 : month + 1, month === 11 ? year + 1 : year);
      const title = document.createElement('span'); title.textContent = `${getMonthName(month)} ${year}`;
      hdr.appendChild(pBtn); hdr.appendChild(title); hdr.appendChild(nBtn); calendarWidgetElem.appendChild(hdr);
      const daysHdr = document.createElement('div'); daysHdr.className = 'calendar-days-header';
      ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sá'].forEach(day => { const d = document.createElement('div'); d.className = 'calendar-day'; d.textContent = day; daysHdr.appendChild(d); });
      calendarWidgetElem.appendChild(daysHdr);
      const datesG = document.createElement('div'); datesG.className = 'calendar-dates-grid';
      const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
      for (let i = 0; i < firstDayOfMonth; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesG.appendChild(e); }
      for (let date = 1; date <= daysInMonth; date++) {
        const cell = document.createElement('div'); cell.className = 'calendar-date'; cell.textContent = date;
        const dateString = `${date}/${month + 1}/${year}`;
        if (date === currentDate && month === currentMonth && year === currentYear) cell.classList.add('today');
        if (assignedDatesCache[dateString]) {
          assignedDatesCache[dateString].forEach(noteId => { const b = document.createElement("span"); b.className = "assigned-bubble"; b.setAttribute("data-note", noteId); b.textContent = "●"; cell.appendChild(b); });
        }
        cell.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; cell.classList.add('drag-over'); });
        cell.addEventListener('dragleave', () => { cell.classList.remove('drag-over'); });
        cell.addEventListener('drop', async (e) => {
          e.preventDefault(); cell.classList.remove('drag-over'); const noteId = e.dataTransfer.getData("application/note-id");
          if (noteId) {
            console.log(`Nota ${noteId} soltada en fecha ${dateString}`); const oldDateStr = notesDataCache[noteId]?.assignedDate;
            try {
              await db.collection('notas').doc(noteId).update({ assignedDate: dateString }); console.log(`Nota ${noteId} actualizada con fecha ${dateString}`);
              if (notesDataCache[noteId]) notesDataCache[noteId].assignedDate = dateString; else notesDataCache[noteId] = { assignedDate: dateString };
              if (oldDateStr && assignedDatesCache[oldDateStr]) { assignedDatesCache[oldDateStr] = assignedDatesCache[oldDateStr].filter(id => id !== noteId); if (assignedDatesCache[oldDateStr].length === 0) delete assignedDatesCache[oldDateStr]; }
              if (!assignedDatesCache[dateString]) assignedDatesCache[dateString] = []; if (!assignedDatesCache[dateString].includes(noteId)) assignedDatesCache[dateString].push(noteId);
              const bubbleInCard = document.getElementById(`bubble-${noteId}`); if (bubbleInCard) bubbleInCard.style.display = 'none';
              generateCalendar(currentCalendarMonth, currentCalendarYear);
            } catch (err) { console.error(`Error asignando fecha a nota ${noteId}:`, err); alert("Error al asignar la fecha."); }
          }
        });
        datesG.appendChild(cell);
      }
      const totalCells = firstDayOfMonth + daysInMonth; const cellsNeeded = totalCells <= 35 ? 35 : 42;
      for (let i = totalCells; i < cellsNeeded; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesG.appendChild(e); }
      calendarWidgetElem.appendChild(datesG);
      currentCalendarMonth = month; currentCalendarYear = year;
    } // --- Fin de generateCalendar ---

    function showCalendar() {
      if (!calendarWidgetElem) return; clearTimeout(calendarTimeout);
      if (calendarWidgetElem.style.display !== 'block') { const { month, year } = initCalendarDate(); generateCalendar(month, year); calendarWidgetElem.style.display = 'block'; }
    }
    function hideCalendar() { if (!calendarWidgetElem) return; calendarTimeout = setTimeout(() => { calendarWidgetElem.style.display = 'none'; }, 300); }
    if (calendarIconElem) { calendarIconElem.addEventListener('mouseenter', showCalendar); calendarIconElem.addEventListener('mouseleave', hideCalendar); calendarIconElem.addEventListener('click', () => { if (calendarWidgetElem && calendarWidgetElem.style.display === 'block') { hideCalendar(); } else { showCalendar(); } }); }
    if (calendarWidgetElem) { calendarWidgetElem.addEventListener('mouseenter', () => clearTimeout(calendarTimeout)); calendarWidgetElem.addEventListener('mouseleave', hideCalendar); }
    function openCalendar() { showCalendar(); }

    // --- Lógica Central de Autenticación y Carga/Limpieza de Datos (CORREGIDA Y COMPLETA) ---
    auth.onAuthStateChanged(user => {
      if (user) {
        // --- USUARIO CONECTADO ---
        console.log('Usuario conectado:', user.email);
        if (loginFormDiv) loginFormDiv.style.display = 'none';
        if (userInfoDiv) userInfoDiv.style.display = 'block';
        if (userEmailDisplay) userEmailDisplay.textContent = user.email;

        // Iniciar el listener de Firestore para las notas SI NO está ya activo
        if (!unsubscribeFirestore) {
            console.log("(Auth) Iniciando listener de Firestore para notas...");
            unsubscribeFirestore = db.collection('notas')
              // .orderBy('createdAt', 'desc') // Opcional: Ordenar
              .onSnapshot((snapshot) => {
                if (!grid) { console.error("(Auth) GridStack no está listo."); return; }
                console.log("(Auth) Datos de notas recibidos/actualizados.");
                let needsCalendarUpdate = false;

                // Usa un Set para rastrear IDs que ya procesaste en este snapshot
                const processedIds = new Set();

                snapshot.docChanges().forEach((change) => {
                  const noteId = change.doc.id;
                  const notaData = change.doc.data();
                  processedIds.add(noteId); // Marca como procesado
                  console.log(`(Auth) Cambio: Tipo=${change.type}, ID=${noteId}`);
                  const existingWidgetElement = displayedNotes.get(noteId);

                  if (change.type === "added") {
                    if (!existingWidgetElement) {
                      console.log(`(Auth) Añadiendo widget para ${noteId}`);
                      if (typeof mostrarNotaEnPantalla === 'function') {
                          const result = mostrarNotaEnPantalla(change.doc);
                          if (result) {
                            grid.addWidget(result.element, result.position);
                            notesDataCache[noteId] = notaData;
                            displayedNotes.set(noteId, result.element);
                            if (notaData.assignedDate) needsCalendarUpdate = true;
                          }
                      } else { console.error("Función mostrarNotaEnPantalla no definida"); }
                    } else {
                      console.log(`(Auth) 'added' pero widget ${noteId} ya estaba. Actualizando datos.`);
                      existingWidgetElement.docData = notaData;
                      notesDataCache[noteId] = notaData;
                      if (notaData.assignedDate !== (existingWidgetElement.docData?.assignedDate)) { needsCalendarUpdate = true; }
                    }
                  } else if (change.type === "modified") {
                    console.log(`(Auth) Modificando widget para ${noteId}`);
                    if (existingWidgetElement) {
                      const oldData = existingWidgetElement.docData || {};
                      // --- Actualiza el widget ---
                      const noteContentElement = existingWidgetElement.querySelector('.note-content');
                      const newText = notaData.url ? (notaData.texto || '') : (notaData.nota || '');
                      if (noteContentElement && newText !== (oldData.texto || oldData.nota || '')) {
                        if(typeof linkify === 'function') { noteContentElement.innerHTML = linkify(newText); Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => { link.setAttribute('target', '_blank'); link.setAttribute('rel', 'noopener noreferrer'); }); } else { noteContentElement.textContent = newText; }
                      }
                      if (notaData.url && notaData.url !== oldData.url) { const img = existingWidgetElement.querySelector('.image-container img'); if (img) img.src = notaData.url; }
                      const bubbleButton = existingWidgetElement.querySelector(`#bubble-${noteId}`);
                      if (bubbleButton) { const needsBubble = !notaData.assignedDate; const isBubbleVisible = bubbleButton.style.display !== 'none'; if (needsBubble && !isBubbleVisible) { bubbleButton.style.display = 'inline-block'; } else if (!needsBubble && isBubbleVisible) { bubbleButton.style.display = 'none'; } }
                      // --- Fin actualizar ---
                      if (notaData.assignedDate !== oldData.assignedDate) { needsCalendarUpdate = true; }
                      existingWidgetElement.docData = notaData;
                      notesDataCache[noteId] = notaData;
                    } else { console.warn(`(Auth) 'modified' para ${noteId}, pero no encontrado.`); notesDataCache[noteId] = notaData; needsCalendarUpdate = true; }
                  } else if (change.type === "removed") {
                     console.log(`(Auth) Eliminando widget para ${noteId}`);
                     if (existingWidgetElement) {
                        grid.removeWidget(existingWidgetElement);
                        displayedNotes.delete(noteId);
                        if (notesDataCache[noteId]?.assignedDate) needsCalendarUpdate = true;
                        delete notesDataCache[noteId];
                        document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
                     } else { console.warn(`(Auth) 'removed' para ${noteId}, pero no encontrado.`); delete notesDataCache[noteId]; document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove()); needsCalendarUpdate = true; }
                  }
                }); // Fin forEach docChanges

                /* // Limpia del grid/mapa notas que ya no existen en Firestore pero sí en pantalla (raro, pero seguro)
                displayedNotes.forEach((element, noteId) => {
                    if (!processedIds.has(noteId)) {
                        console.warn(`(Auth) Limpiando widget ${noteId} que ya no existe en snapshot.`);
                        grid.removeWidget(element);
                        displayedNotes.delete(noteId);
                        delete notesDataCache[noteId];
                         document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
                        needsCalendarUpdate = true;
                    }
                });
              */

                // Actualiza calendario si es necesario Y está visible
                if (needsCalendarUpdate && typeof generateCalendar === 'function' && calendarWidgetElem && calendarWidgetElem.style.display === 'block') {
                  console.log("(Auth) Actualizando calendario (visible) porque needsCalendarUpdate es true.");
                  if (typeof fetchAllAssignedNotes === 'function') { fetchAllAssignedNotes().then(() => { generateCalendar(currentCalendarMonth, currentCalendarYear); }); }
                  else { console.error("Funcion fetchAllAssignedNotes no definida"); }
                } else if (needsCalendarUpdate && typeof fetchAllAssignedNotes === 'function') { fetchAllAssignedNotes(); }

            }, (error) => { // Manejo de error del listener onSnapshot
                console.error("(Auth) Error crítico escuchando Firestore:", error);
                alert("Error grave al obtener notas: " + error.message + ". Intenta recargar.");
                if (error.code === 'permission-denied') { console.warn("Permiso denegado. Cerrando sesión."); auth.signOut(); }
            }); // Fin onSnapshot
            console.log("(Auth) Listener de Firestore para notas ACTIVADO.");
        } // Fin if (!unsubscribeFirestore)

      } else {
        // --- USUARIO DESCONECTADO ---
        console.log('Nadie conectado. Limpiando estado...');
        if (loginFormDiv) loginFormDiv.style.display = 'block';
        if (userInfoDiv) userInfoDiv.style.display = 'none';

        if (unsubscribeFirestore) { unsubscribeFirestore(); unsubscribeFirestore = null; console.log("Listener de notas DETENIDO."); }
        if (grid) { grid.removeAll(true); console.log("Grid limpiado."); }
        displayedNotes.clear(); notesDataCache = {}; assignedDatesCache = {};
        if (calendarWidgetElem) calendarWidgetElem.style.display = 'none';

      } // Fin del else (usuario desconectado)
    }); // --- FIN BLOQUE onAuthStateChanged ---

    // --- Listeners para los Botones de Login/Logout ---
    if (loginButton && emailInput && passwordInput) {
      loginButton.addEventListener('click', () => {
        const email = emailInput.value; const password = passwordInput.value;
        if (!email || !password) { return alert('Ingresa correo y contraseña'); }
        console.log("Intentando iniciar sesión para:", email);
        auth.signInWithEmailAndPassword(email, password)
          .then(userCredential => { console.log('Login OK para:', userCredential.user.email); })
          .catch(error => {
            console.error('Error Login Botón:', error.code, error.message);
            let msg = 'Error al iniciar sesión.';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { msg = 'Correo o contraseña incorrectos.'; }
            else if (error.code === 'auth/invalid-email') { msg = 'El formato del correo no es válido.'; }
            alert(msg);
          });
      });
    } else { console.error("Error crítico: Elementos de login no encontrados."); }

    if (logoutButton) {
      logoutButton.addEventListener('click', () => {
        console.log("Intentando cerrar sesión...");
        auth.signOut()
          .then(() => { console.log('Logout OK.'); })
          .catch(error => { console.error('Error Logout Botón:', error); alert('Error al cerrar sesión: ' + error.message); });
      });
    } else { console.error("Error crítico: Botón de logout no encontrado."); }
    
    // --- FIN Código para los Botones ---
    // --- Lógica para el Menú Superior ---
const menuToggleButton = document.getElementById('menu-toggle-button');
const topMenuOptions = document.getElementById('top-menu-options');

if (menuToggleButton && topMenuOptions) {
  menuToggleButton.addEventListener('click', (event) => {
    event.stopPropagation(); // Evita que el click cierre el menú inmediatamente si se propaga
    const isVisible = topMenuOptions.style.display === 'block';
    topMenuOptions.style.display = isVisible ? 'none' : 'block';
  });

  // Opcional: Cerrar el menú si se hace click fuera de él
  document.addEventListener('click', (event) => {
    if (topMenuOptions.style.display === 'block' && !topMenuOptions.contains(event.target) && event.target !== menuToggleButton) {
      topMenuOptions.style.display = 'none';
    }
  });
}
// --- Fin Lógica Menú Superior ---
  </script>
</body>
</html>
```

**Resumen de Cambios Clave (además de la corrección del `forEach`):**

1.  **Reintegración del Calendario:** Todas las funciones y la lógica del calendario (`getChileDate`, `initCalendarDate`, `getMonthName`, `fetchAllAssignedNotes`, `generateCalendar`, `showCalendar`, `hideCalendar`, `openCalendar`) están de vuelta.
2.  **Llamadas al Calendario:** Se asegura que `generateCalendar` se llame cuando sea necesario (al mostrar el widget, al asignar fecha a una nota). `fetchAllAssignedNotes` se llama para asegurar que los datos estén actualizados.
3.  **Visibilidad de Burbuja:** Se corrigió la lógica para mostrar/ocultar la burbuja amarilla (●) en la nota y en el calendario cuando se asigna/quita una fecha.
4.  **Limpieza:** Se asegura que los caches del calendario (`assignedDatesCache`) también se limpien al cerrar sesión.
5.  **Comentarios y Estructura:** Se reorganizaron un poco los comentarios y la definición de variables para mayor claridad.

Pruébalo ahora. Debería funcionar el login Y el calendario. Lamento mucho el descuido anteri
