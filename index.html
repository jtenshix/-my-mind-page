<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notas Oce√°nicas - Polaroid</title>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
  <style>
    /* Estilos CSS (Incluyendo los del calendario) */
    .grid-stack-item,
    .grid-stack-item-content,
    .card-wrapper,
    .text-card,
    .note-content {
      box-shadow: none !important;
    }
    .grid-stack-item[data-note-type="imagen"].grid-stack-item-dragging,
    .grid-stack-item[data-note-type="imagen"].grid-stack-item-dragging .grid-stack-item-content {
      opacity: 0.7 !important;
      border: 3px dashed red !important;
      background-color: rgba(255, 0, 0, 0.3) !important;
      box-shadow: none !important;
    }
    .grid-stack-item[data-note-type="texto"].grid-stack-item-dragging,
    .grid-stack-item[data-note-type="texto"].grid-stack-item-dragging .grid-stack-item-content {
      opacity: 0.7 !important;
      border: 3px dashed #a2dff7 !important;
      background-color: rgba(162, 223, 247, 0.3) !important;
      box-shadow: none !important;
    }
    .grid-stack-placeholder {
      display: none !important;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(to bottom, #a2dff7 0%, #a2dff7 40%, #03254c 100%);
      font-family: Arial, sans-serif;
    }
    .container {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    #notaDisplay {
      flex-grow: 1;
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      min-width: 1000px; /* Considera si este min-width es necesario */
    }
    .grid-stack-item {
      transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      overflow: visible !important;
      margin-bottom: 0px;
    }
    .grid-stack-item-content {
      overflow: visible !important;
      height: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    .card-wrapper, .text-card {
      background-color: #fff;
      border: 2px solid #0077a3;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      position: relative;
      box-sizing: border-box;
      height: 100%;
    }
    .image-container {
      width: 100%;
      height: auto;
      max-height: 200px;
      overflow: hidden;
      position: relative;
      flex-shrink: 0;
    }
    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .note-content {
      background-color: #fff;
      padding: 10px;
      text-align: left;
      font-size: 16px;
      color: #333;
      min-height: 50px;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow: hidden;
      flex-grow: 1;
    }
    .note-content a {
      color: #0077a3;
      text-decoration: underline;
    }
    .menu-bar {
      background-color: #0288D1;
      padding: 5px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      border-top: 1px solid #0077a3;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      margin-top: auto;
    }
    .menu-icon {
      background: none;
      border: none;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      padding: 2px 4px;
    }
    .bubble-icon {
      color: #FFCD05;
      font-size: 22px;
    }
    .menu-actions {
      display: flex;
      gap: 4px;
    }
    #addNoteButton {
      position: absolute;
      bottom: 30px;
      right: 30px;
      background-color: #006994;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, transform 0.3s ease;
      z-index: 1001;
    }
    #addNoteButton:hover {
      background-color: #005577;
      transform: scale(1.05);
    }
    #addNoteOptions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.85);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 25px;
      padding: 25px;
      z-index: 1002;
    }
    #addNoteOptions .card {
      background-color: #2c2c2c;
      border: 1px solid #0077a3;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 180px;
    }
    #addNoteOptions .card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 119, 163, 0.5);
    }
    #addNoteOptions .card h2 {
      color: #36a2eb;
      margin-bottom: 10px;
    }
    #addNoteOptions .card p {
      color: #ccc;
      font-size: 14px;
    }
    #inputArea {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ffffff;
      padding: 25px 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      gap: 15px;
      width: 90%;
      max-width: 550px;
      z-index: 1002;
    }
    #inputArea label {
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
      font-size: 14px;
    }
    #inputArea textarea, #inputArea input[type="text"] {
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
      line-height: 1.5;
      font-size: 16px;
    }
    #inputArea textarea {
      min-height: 80px;
    }
    #inputArea textarea#textNote {
      min-height: 120px;
    }
    #inputArea button {
      padding: 10px 20px;
      background-color: #006994;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      align-self: flex-end;
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
    }
    #inputArea button:hover {
      background-color: #005577;
    }
    #inputArea button:active {
      transform: scale(0.98);
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .calendar-icon {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 45px;
      height: 45px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .calendar-widget {
      position: absolute;
      bottom: 85px; /* Posici√≥n sobre el icono */
      left: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      padding: 15px;
      display: none; /* Oculto por defecto */
      z-index: 1001;
      width: 320px;
      min-height: 300px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .calendar-header button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #0077a3;
      padding: 5px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    .calendar-header button:hover:not(:disabled) {
      background-color: #e0f7fa;
    }
    .calendar-header button:disabled {
      color: #ccc;
      cursor: default;
    }
    .calendar-header span {
      font-weight: bold;
      color: #333;
      font-size: 18px;
    }
    .calendar-days-header, .calendar-dates-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 6px; /* Espacio entre d√≠as */
    }
    .calendar-days-header {
      margin-bottom: 10px;
      font-weight: bold;
      color: #555;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    .calendar-day {
      padding: 3px;
    }
    .calendar-date {
      padding: 0;
      border-radius: 50%;
      color: #333;
      border: 2px solid transparent; /* Borde transparente por defecto */
      cursor: pointer;
      position: relative;
      width: 36px; /* Tama√±o fijo para celdas */
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      line-height: 1;
      font-size: 14px;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .calendar-date.empty {
      background: none;
      cursor: default;
      opacity: 0; /* Oculta celdas vac√≠as */
    }
    .calendar-date:not(.empty):hover {
      background-color: #e0f7fa; /* Resaltado suave al pasar el mouse */
      border-color: #b3e5fc;
    }
    .calendar-date.today {
      border-color: #0077a3; /* Borde especial para el d√≠a actual */
      font-weight: bold;
      color: #005577;
    }
    .calendar-date.drag-over {
      background-color: #a2dff7 !important; /* Resaltado fuerte al arrastrar sobre */
      border-color: #0077a3 !important;
    }
    .assigned-bubble {
      color: #FFCD05; /* Color de la burbuja de nota asignada */
      font-size: 11px;
      position: absolute;
      bottom: 3px; /* Posici√≥n de la burbuja */
      left: 50%;
      transform: translateX(-50%);
      line-height: 1;
      text-shadow: 0 0 1px rgba(0, 0, 0, 0.5); /* Sombra ligera para visibilidad */
      pointer-events: none; /* Para no interferir con el drop */
    }
    /* Estilo para m√∫ltiples burbujas (si se implementa) */
    .calendar-date .assigned-bubble + .assigned-bubble {
      bottom: -2px; /* Ajusta posici√≥n si hay m√°s de una */
    }
    .blur-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      z-index: 1000; /* Detr√°s de los popups */
      cursor: pointer;
    }
    /* Media Queries para responsividad */
    @media (max-width: 575.98px) {
      #inputArea {
        width: 95%;
      }
      #addNoteOptions {
        flex-direction: column;
        gap: 15px;
        padding: 20px;
      }
      #addNoteOptions .card {
        width: 150px;
      }
      .calendar-widget { /* Ajusta calendario en pantallas peque√±as */
        width: 90%;
        left: 5%;
        bottom: 75px;
      }
    }
    @media (max-width: 576px) {
      /* Puedes a√±adir m√°s ajustes si es necesario */
    }
  </style>
</head>
<body>
  <div id="auth-section" style="padding: 15px; background-color: #f0f0f0; border-bottom: 1px solid #ccc; text-align: center; margin-bottom: 10px;">
    <div id="login-form">
      <input type="email" id="login-email" placeholder="Correo" style="padding: 8px; margin-right: 5px;">
      <input type="password" id="login-password" placeholder="Contrase√±a" style="padding: 8px; margin-right: 5px;">
      <button id="login-button" style="padding: 8px 12px;">Entrar</button>
    </div>
    <div id="user-info" style="display: none;">
      <span>Conectado como: <strong id="user-email-display"></strong></span>
      <button id="logout-button" style="padding: 8px 12px; margin-left: 15px;">Salir</button>
    </div>
  </div>

  <div class="container">
    <div id="notaDisplay" class="grid-stack"></div>
    <button id="addNoteButton" title="A√±adir nueva nota o imagen">+</button>
    <div id="addNoteOptions">
      <div class="card" id="addImageLinkOption" title="A√±adir una nota con imagen desde un enlace web">
        <h2>üñºÔ∏è Imagen</h2>
        <p>Guardar link de imagen.</p>
      </div>
      <div class="card" id="addTextNoteOption" title="A√±adir una nota de texto simple">
        <h2>üìù Nota</h2>
        <p>Subir nota de texto.</p>
      </div>
    </div>
    <div id="inputArea">
      <div id="imageLinkInputArea" style="display: none;">
        <div class="input-group">
          <label for="imageLink">Link de la imagen:</label>
          <input type="text" id="imageLink" placeholder="Pega aqu√≠ la URL de la imagen (ej: https://...)" />
        </div>
        <div class="input-group">
          <label for="imageNoteText">Texto adicional (opcional):</label>
          <textarea id="imageNoteText" placeholder="Escribe aqu√≠ una descripci√≥n o nota relacionada con la imagen..." rows="3"></textarea>
        </div>
        <button id="saveImageLink">Guardar Imagen</button>
      </div>
      <div id="textNoteInputArea" style="display: none;">
        <div class="input-group">
          <label for="textNote">Nota:</label>
          <textarea id="textNote" placeholder="Escribe tu nota aqu√≠..." rows="5"></textarea>
        </div>
        <button id="saveTextNote">Guardar Nota</button>
      </div>
    </div>
    <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">üìÖ</div>
    <div id="calendarWidget" class="calendar-widget"></div>
    <div class="blur-background"></div>
  </div>

  <script>
    // --- Funciones Utilitarias ---
    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(?<!href=["'])(https?:\/\/[^\s<>"']+)/g;
      const replacedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return replacedText.replace(/\n/g, '<br>');
    }

    function autoResizeTextarea(el) {
      if (!el) return;
      el.style.height = 'auto'; // Resetea altura
      el.style.height = (el.scrollHeight + 2) + 'px'; // Ajusta a contenido
    }

    // --- Configuraci√≥n de Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCHa373WgLLHsy8wZXK9zr_HVieQvlrhUs", // Considera proteger esta clave en producci√≥n
      authDomain: "oasis-b036d.firebaseapp.com",
      projectId: "oasis-b036d",
      storageBucket: "oasis-b036d.appspot.com",
      messagingSenderId: "141546637821",
      appId: "1:141546637821:web:0a861aeb13831774ed3194",
      measurementId: "G-HB2P17H5YL"
    };

    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) {
      console.error("Error inicializando Firebase:", e);
      alert("Error cr√≠tico: No se pudo inicializar la conexi√≥n a la base de datos.");
    }

    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Variables Globales y Configuraci√≥n de Gridstack ---
    let grid; // Variable para la instancia de GridStack
    try {
      grid = GridStack.init({
        column: 12, // N√∫mero inicial de columnas
        margin: 5, // Margen entre items
        cellHeight: 'auto', // Altura autom√°tica basada en contenido
        disableResize: true, // Deshabilita redimensionar notas
        float: true, // Permite que los elementos floten
        overlap: false, // No permite superposici√≥n
        animate: true, // Anima movimientos
        alwaysShowResizeHandle: false,
        draggable: {
          handle: '.menu-bar', // Solo se puede arrastrar desde la barra de men√∫
          scroll: true,
          appendTo: 'body' // Evita problemas de z-index al arrastrar
        }
      });
    } catch (e) {
      console.error("Error inicializando GridStack:", e);
      alert("Error cr√≠tico: No se pudo inicializar el √°rea de notas.");
      // Podr√≠as deshabilitar la funcionalidad si GridStack falla
    }

    // --- Variables y L√≥gica para Responsividad del Grid ---
    const gridStackElement = document.getElementById('notaDisplay');
    let currentColumnCount = 12; // Columna actual
    const breakpoints = [ // Puntos de quiebre para columnas
      { width: 992, cols: 12 }, // Escritorio grande
      { width: 576, cols: 6 },  // Tablets / Escritorio peque√±o
      { width: 0, cols: 3 }     // M√≥viles
    ];

    function adjustGridColumns() {
      const screenWidth = window.innerWidth;
      let newColumnCount = 12; // Por defecto
      // Busca el n√∫mero de columnas adecuado para el ancho actual
      for (const bp of breakpoints) {
        if (screenWidth >= bp.width) {
          newColumnCount = bp.cols;
          break;
        }
      }
      // Si el n√∫mero de columnas cambi√≥, actualiza GridStack
      if (grid && newColumnCount !== currentColumnCount) {
        grid.column(newColumnCount, true); // Ajusta columnas y redibuja
        currentColumnCount = newColumnCount;
        console.log("Grid ajustado a", newColumnCount, "columnas");
      }
    }

    adjustGridColumns(); // Ajusta al cargar la p√°gina
    let resizeTimer; // Timer para evitar ajustes continuos al redimensionar
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(adjustGridColumns, 150); // Espera 150ms antes de ajustar
    });

    // --- Eventos de Gridstack para Guardar Posici√≥n ---
    if (grid) {
      // Evento 'change': Se dispara cuando items se a√±aden, eliminan o mueven (despu√©s de soltar)
      grid.on('change', function (event, items) {
        console.log("GridStack 'change' event:", items.length, "items changed/moved");
        items.forEach(function (item) {
          const noteIdToSave = item.el?.getAttribute('data-note-id');
          // Guarda la nueva posici√≥n (x, y) en Firestore
          if (noteIdToSave && typeof item.x === 'number' && typeof item.y === 'number') {
            console.log(`   -> Guardando posici√≥n para ${noteIdToSave}: x=${item.x}, y=${item.y}`);
            db.collection('notas').doc(noteIdToSave).update({
              x: item.x,
              y: item.y
            }).catch(err => console.error(`Error guardando posici√≥n (${noteIdToSave}) desde 'change': ${err.message}`));
          }
        });
      });

      // Evento 'dragstop': Se dispara justo cuando se suelta un item (√∫til para logs)
      grid.on('dragstop', function (event, element) {
        const node = grid.engine.nodes.find(n => n.el === element);
        if (node) {
          const noteId = node.el?.getAttribute('data-note-id') || node.id || '(desconocido)';
          console.log(`GridStack 'dragstop': Nota ID: ${noteId} soltada en x=${node.x}, y=${node.y}`);
        }
      });
    } else {
      console.error("Grid no fue inicializado, los eventos de grid no se adjuntar√°n.");
    }

    // --- Referencias a Elementos del DOM (ya definidas arriba) ---
    // Se obtienen una vez para mejorar rendimiento
    const textNoteInputElem = document.getElementById('textNote');
    const imageNoteTextElem = document.getElementById('imageNoteText');
    const addNoteButtonElem = document.getElementById('addNoteButton');
    const addNoteOptionsElem = document.getElementById('addNoteOptions');
    const addImageLinkOptionElem = document.getElementById('addImageLinkOption');
    const addTextNoteOptionElem = document.getElementById('addTextNoteOption');
    const inputAreaElem = document.getElementById('inputArea');
    const imageLinkInputAreaElem = document.getElementById('imageLinkInputArea');
    const imageLinkInputElem = document.getElementById('imageLink');
    const saveImageLinkButtonElem = document.getElementById('saveImageLink');
    const textNoteInputAreaElem = document.getElementById('textNoteInputArea');
    const saveTextNoteButtonElem = document.getElementById('saveTextNote');
    const blurBackgroundElem = document.querySelector('.blur-background');
    const calendarIconElem = document.getElementById('calendarIcon');
    const calendarWidgetElem = document.getElementById('calendarWidget');
    const loginFormDiv = document.getElementById('login-form');
    const userInfoDiv = document.getElementById('user-info');
    const userEmailDisplay = document.getElementById('user-email-display');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const emailInput = document.getElementById('login-email');
    const passwordInput = document.getElementById('login-password');

    // --- Variables Globales para Estado ---
    const displayedNotes = new Map(); // Mapa para rastrear widgets: noteId -> gridItemElement
    let currentCalendarMonth, currentCalendarYear; // Estado del calendario
    let assignedDatesCache = {}; // Cache: "D/M/YYYY" -> [noteId1, noteId2]
    let notesDataCache = {}; // Cache: noteId -> {notaData}
    let calendarTimeout; // Timer para ocultar calendario
    let unsubscribeFirestore = null; // Funci√≥n para detener el listener de Firestore

    // --- Listener para auto-resize de textareas ---
    if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
    if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));

    // --- Funci√≥n para Crear/Actualizar Notas en el Grid ---
    function mostrarNotaEnPantalla(doc) {
      const notaData = doc.data();
      const noteId = doc.id;

      let gridItem = document.createElement('div');
      gridItem.classList.add('grid-stack-item');
      gridItem.setAttribute('data-note-id', noteId);
      gridItem.setAttribute('data-note-type', notaData.tipo);

      const content = document.createElement('div');
      content.classList.add('grid-stack-item-content');

      let card;
      let noteContentElement = null;

      if (notaData.url) {
        card = document.createElement('div');
        card.classList.add('card-wrapper');
        const imageContainer = document.createElement('div');
        imageContainer.classList.add('image-container');
        const img = document.createElement('img');
        img.src = notaData.url;
        img.alt = notaData.texto || 'Imagen de la nota';
        img.loading = 'lazy';
        img.onerror = () => {
          imageContainer.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; background-color:#eee; color:red; text-align:center; padding:10px;">‚ö†Ô∏è<br/>Error al<br/>cargar imagen</div>`;
        };
        imageContainer.appendChild(img);
        card.appendChild(imageContainer);
        if (notaData.texto) {
          noteContentElement = document.createElement('div');
          noteContentElement.classList.add('note-content');
          noteContentElement.innerHTML = linkify(notaData.texto);
          card.appendChild(noteContentElement);
        }
      } else if (notaData.nota) {
        card = document.createElement('div');
        card.classList.add('text-card');
        noteContentElement = document.createElement('div');
        noteContentElement.classList.add('note-content');
        noteContentElement.innerHTML = linkify(notaData.nota);
        card.appendChild(noteContentElement);
      } else {
        console.warn("Nota sin contenido v√°lido:", noteId);
        return null;
      }

      if (noteContentElement) {
        Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        }); // CORREGIDO: Punto y coma a√±adido
      }

      const menuBar = document.createElement('div');
      menuBar.classList.add('menu-bar');
      const bubbleButton = document.createElement('button');
      bubbleButton.classList.add('menu-icon', 'bubble-icon');
      bubbleButton.innerHTML = '‚óè';
      bubbleButton.setAttribute('draggable', 'true');
      bubbleButton.id = `bubble-${noteId}`;
      bubbleButton.title = "Arrastrar al calendario";
      bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';
      bubbleButton.addEventListener('dragstart', (e) => {
        var imgGhost = new Image();
        imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
        e.dataTransfer.setDragImage(imgGhost, 0, 0);
        e.dataTransfer.setData("application/note-id", noteId);
        e.dataTransfer.effectAllowed = "move";
        if (typeof openCalendar === 'function') openCalendar();
      });
      bubbleButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (typeof openCalendar === 'function') openCalendar();
      });

      const menuActions = document.createElement('div');
      menuActions.classList.add('menu-actions');
      const editButton = document.createElement('button');
      editButton.classList.add('menu-icon');
      editButton.innerHTML = '‚úé';
      editButton.title = "Editar";
      const deleteButton = document.createElement('button');
      deleteButton.classList.add('menu-icon');
      deleteButton.innerHTML = '‚úñ';
      deleteButton.title = "Eliminar";

      deleteButton.onclick = (e) => {
        e.stopPropagation();
        if (typeof deleteNote === 'function') {
          if (confirm(`¬øSeguro que quieres eliminar esta nota?`)) {
            deleteNote(noteId, gridItem);
          }
        } else {
          console.error("Funci√≥n deleteNote no encontrada");
          alert("Error interno al eliminar.");
        }
      };
      editButton.onclick = (e) => {
        e.stopPropagation();
        if (typeof editNoteContent === 'function') {
          editNoteContent(card, noteId, notaData, menuActions, editButton, deleteButton);
        } else {
          console.error("Funci√≥n editNoteContent no encontrada");
        }
      };

      menuActions.appendChild(editButton);
      menuActions.appendChild(deleteButton);
      menuBar.appendChild(bubbleButton);
      menuBar.appendChild(menuActions);
      card.appendChild(menuBar);
      content.appendChild(card);
      gridItem.appendChild(content);

      const pos = {
        x: notaData.x,
        y: notaData.y,
        w: notaData.w || 2,
        h: notaData.h || 'auto', // Usar 'auto' puede ser mejor que 0
        id: noteId,
        autoPosition: (notaData.x === undefined || notaData.y === undefined)
      };
      gridItem.docData = notaData; // Adjunta los datos al elemento DOM

      return {
        element: gridItem,
        position: pos
      };
    } // --- Fin de mostrarNotaEnPantalla ---

    // --- Funci√≥n para Editar Contenido de Notas ---
    function editNoteContent(card, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
      let targetElement = card.querySelector('.note-content');
      if (!targetElement && notaData.url) {
        targetElement = document.createElement('div');
        targetElement.classList.add('note-content');
        card.insertBefore(targetElement, card.querySelector('.menu-bar'));
      } else if (!targetElement && !notaData.url) {
        console.error("Error: No se encontr√≥ .note-content para editar texto en nota:", noteId);
        return;
      }
      const isImageNote = !!notaData.url;
      const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');
      targetElement.innerHTML = '';
      const editInput = document.createElement('textarea');
      editInput.value = currentText;
      editInput.style.cssText = "width:100%; min-height:80px; height:auto; box-sizing:border-box; border:1px dashed #ccc; resize:vertical; margin-bottom: 5px;";
      targetElement.appendChild(editInput);
      autoResizeTextarea(editInput);
      editInput.addEventListener('input', () => autoResizeTextarea(editInput));
      editInput.focus();
      const saveEditButton = document.createElement('button');
      saveEditButton.classList.add('menu-icon');
      saveEditButton.innerHTML = 'üíæ';
      saveEditButton.title = "Guardar Cambios";
      saveEditButton.onclick = (e) => {
        e.stopPropagation();
        const newText = editInput.value.trim();
        const updateData = isImageNote ? { texto: newText || firebase.firestore.FieldValue.delete() } : { nota: newText };
        if (!isImageNote && !newText) {
            alert("La nota de texto no puede quedar vac√≠a. Si quieres borrarla, usa el bot√≥n '‚úñ'.");
            return;
        }
        saveEditButton.disabled = true;
        saveEditButton.innerHTML = '‚è≥';
        db.collection('notas').doc(noteId).update(updateData)
          .then(() => {
            console.log("Nota actualizada:", noteId);
            // La UI se actualizar√° por el listener onSnapshot, no es necesario restaurar botones aqu√≠
          })
          .catch((error) => {
            console.error('Error al actualizar nota:', error);
            alert("Error al guardar los cambios.");
            // Si falla, reactiva el bot√≥n y considera restaurar UI original
            saveEditButton.disabled = false;
            saveEditButton.innerHTML = 'üíæ';
            // Podr√≠amos restaurar botones aqu√≠ si el error es persistente
            // menuActionsContainer.innerHTML = '';
            // menuActionsContainer.appendChild(editButton);
            // menuActionsContainer.appendChild(deleteButton);
          });
      };
      menuActionsContainer.innerHTML = '';
      menuActionsContainer.appendChild(saveEditButton);
    } // --- Fin de editNoteContent ---

    // --- Funci√≥n para Eliminar Notas ---
    function deleteNote(noteId, gridItem) {
      console.log("Intentando eliminar nota:", noteId);
      db.collection('notas').doc(noteId).delete()
        .then(() => {
          console.log(`Nota ${noteId} eliminada de Firestore.`);
          // El listener onSnapshot se encargar√° de quitarla del grid y limpiar caches
        })
        .catch((error) => {
          console.error("Error al eliminar nota de Firestore:", error);
          alert("Error al eliminar la nota.");
        });
    } // --- Fin de deleteNote ---

    // --- Funciones para Mostrar/Ocultar Men√∫s y Popups ---
    function hideMenus() {
      if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
      if (inputAreaElem) inputAreaElem.style.display = 'none';
      if (blurBackgroundElem) blurBackgroundElem.style.display = 'none';
      if (imageLinkInputElem) imageLinkInputElem.value = '';
      if (imageNoteTextElem) {
        imageNoteTextElem.value = '';
        autoResizeTextarea(imageNoteTextElem);
      }
      if (textNoteInputElem) {
        textNoteInputElem.value = '';
        autoResizeTextarea(textNoteInputElem);
      }
    }

    // --- Listeners para Botones de UI (A√±adir Nota, etc.) ---
    if (addNoteButtonElem) {
      addNoteButtonElem.onclick = (e) => {
        e.stopPropagation();
        if (addNoteOptionsElem && addNoteOptionsElem.style.display === 'flex') {
          hideMenus();
        } else if (addNoteOptionsElem && blurBackgroundElem) {
          hideMenus();
          addNoteOptionsElem.style.display = 'flex';
          blurBackgroundElem.style.display = 'block';
        }
      };
    }
    if (addImageLinkOptionElem) {
      addImageLinkOptionElem.onclick = (e) => {
        e.stopPropagation();
        if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
        if (imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'block';
        if (textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'none';
        if (inputAreaElem) inputAreaElem.style.display = 'flex';
        if (blurBackgroundElem) blurBackgroundElem.style.display = 'block';
        if (imageLinkInputElem) imageLinkInputElem.focus();
      };
    }
    if (addTextNoteOptionElem) {
      addTextNoteOptionElem.onclick = (e) => {
        e.stopPropagation();
        if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
        if (imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'none';
        if (textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'block';
        if (inputAreaElem) inputAreaElem.style.display = 'flex';
        if (blurBackgroundElem) blurBackgroundElem.style.display = 'block';
        if (textNoteInputElem) textNoteInputElem.focus();
      };
    }
    if (blurBackgroundElem) {
      blurBackgroundElem.onclick = hideMenus;
    }

    // --- Funciones para Guardar Nuevas Notas ---
    function guardarLinkDeImagen() {
      if (!imageLinkInputElem || !db) return;
      let link = imageLinkInputElem.value.trim();
      const texto = imageNoteTextElem ? imageNoteTextElem.value.trim() : '';
      if (link && (link.startsWith('http://') || link.startsWith('https://'))) {
        if (saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = true;
        db.collection('notas').add({
          url: link,
          texto: texto || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tipo: 'imagen',
          w: 2, h: 'auto' // Tama√±o inicial
        }).then(() => {
          console.log("Imagen guardada.");
          hideMenus();
        }).catch((error) => {
          console.error('Error al guardar link:', error);
          alert("Error al guardar imagen: " + error.message);
        }).finally(() => {
          if (saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = false;
        });
      } else {
        alert("Introduce un link v√°lido (http:// o https://).");
        imageLinkInputElem.focus();
      }
    }
    function guardarNotaTexto() {
      if (!textNoteInputElem || !db) return;
      const nota = textNoteInputElem.value.trim();
      if (nota) {
        if (saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = true;
        db.collection('notas').add({
          nota: nota,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tipo: 'texto',
          w: 2, h: 'auto' // Tama√±o inicial
        }).then(() => {
          console.log("Nota de texto guardada.");
          hideMenus();
        }).catch((error) => {
          console.error('Error al guardar nota:', error);
          alert("Error al guardar nota: " + error.message);
        }).finally(() => {
          if (saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = false;
        });
      } else {
        alert("Escribe algo en la nota.");
        textNoteInputElem.focus();
      }
    }
    if (saveImageLinkButtonElem) saveImageLinkButtonElem.onclick = guardarLinkDeImagen;
    if (saveTextNoteButtonElem) saveTextNoteButtonElem.onclick = guardarNotaTexto;

    // --- L√≥gica del Calendario ---
    function getChileDate() {
      try {
        const opts = { timeZone: 'America/Santiago', year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false };
        const fmt = new Intl.DateTimeFormat('en-CA', opts);
        const p = fmt.formatToParts(new Date());
        const d = {};
        p.forEach(({ type, value }) => d[type] = parseInt(value, 10));
        return new Date(Date.UTC(d.year, d.month - 1, d.day, d.hour, d.minute, d.second));
      } catch (e) {
        console.warn("Intl timezone fallback, usando hora local.", e);
        return new Date();
      }
    }
    function initCalendarDate() {
      let today = getChileDate();
      return { month: today.getMonth(), year: today.getFullYear() };
    }
    function getMonthName(idx) {
      const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      return months[idx] || '';
    }
    async function fetchAllAssignedNotes() {
      console.log("Fetching assigned notes...");
      assignedDatesCache = {};
      try {
        const snap = await db.collection('notas').where('assignedDate', '!=', null).get();
        snap.forEach(doc => {
          const d = doc.data();
          const id = doc.id;
          if (!notesDataCache[id]) notesDataCache[id] = d; // Actualiza cach√© general si no estaba
          const dateStr = d.assignedDate;
          if (dateStr) {
            if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = [];
            if (!assignedDatesCache[dateStr].includes(id)) assignedDatesCache[dateStr].push(id);
          }
        });
        console.log("Assigned dates cache updated:", assignedDatesCache);
      } catch (err) {
        console.error("Error fetching assigned notes:", err);
      }
    }
    async function generateCalendar(month, year) {
      if (Object.keys(assignedDatesCache).length === 0) await fetchAllAssignedNotes();
      if (!calendarWidgetElem) return;
      calendarWidgetElem.innerHTML = '';
      const today = getChileDate();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const currentDate = today.getDate();
      const hdr = document.createElement('div');
      hdr.className = 'calendar-header';
      const pBtn = document.createElement('button');
      pBtn.innerHTML = '&lt;';
      pBtn.title = "Mes Anterior";
      pBtn.onclick = () => generateCalendar(month === 0 ? 11 : month - 1, month === 0 ? year - 1 : year);
      const nBtn = document.createElement('button');
      nBtn.innerHTML = '&gt;';
      nBtn.title = "Mes Siguiente";
      nBtn.onclick = () => generateCalendar(month === 11 ? 0 : month + 1, month === 11 ? year + 1 : year);
      const title = document.createElement('span');
      title.textContent = `${getMonthName(month)} ${year}`;
      hdr.appendChild(pBtn);
      hdr.appendChild(title);
      hdr.appendChild(nBtn);
      calendarWidgetElem.appendChild(hdr);
      const daysHdr = document.createElement('div');
      daysHdr.className = 'calendar-days-header';
      ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'S√°'].forEach(day => {
        const d = document.createElement('div');
        d.className = 'calendar-day';
        d.textContent = day;
        daysHdr.appendChild(d);
      });
      calendarWidgetElem.appendChild(daysHdr);
      const datesG = document.createElement('div');
      datesG.className = 'calendar-dates-grid';
      const firstDayOfMonth = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      for (let i = 0; i < firstDayOfMonth; i++) {
        const e = document.createElement('div');
        e.className = 'calendar-date empty';
        datesG.appendChild(e);
      }
      for (let date = 1; date <= daysInMonth; date++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-date';
        cell.textContent = date;
        const dateString = `${date}/${month + 1}/${year}`;
        if (date === currentDate && month === currentMonth && year === currentYear) {
          cell.classList.add('today');
        }
        if (assignedDatesCache[dateString]) {
          assignedDatesCache[dateString].forEach(noteId => {
            const bubble = document.createElement("span");
            bubble.className = "assigned-bubble";
            bubble.setAttribute("data-note", noteId);
            bubble.textContent = "‚óè";
            cell.appendChild(bubble);
          });
        }
        cell.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          cell.classList.add('drag-over');
        });
        cell.addEventListener('dragleave', () => {
          cell.classList.remove('drag-over');
        });
        cell.addEventListener('drop', async (e) => {
          e.preventDefault();
          cell.classList.remove('drag-over');
          const noteId = e.dataTransfer.getData("application/note-id");
          if (noteId) {
            console.log(`Nota ${noteId} soltada en fecha ${dateString}`);
            const oldDateStr = notesDataCache[noteId]?.assignedDate;
            try {
              await db.collection('notas').doc(noteId).update({ assignedDate: dateString });
              console.log(`Nota ${noteId} actualizada con fecha ${dateString}`);
              if (notesDataCache[noteId]) notesDataCache[noteId].assignedDate = dateString;
              else notesDataCache[noteId] = { assignedDate: dateString };
              if (oldDateStr && assignedDatesCache[oldDateStr]) {
                assignedDatesCache[oldDateStr] = assignedDatesCache[oldDateStr].filter(id => id !== noteId);
                if (assignedDatesCache[oldDateStr].length === 0) delete assignedDatesCache[oldDateStr];
              }
              if (!assignedDatesCache[dateString]) assignedDatesCache[dateString] = [];
              if (!assignedDatesCache[dateString].includes(noteId)) assignedDatesCache[dateString].push(noteId);
              const bubbleInCard = document.getElementById(`bubble-${noteId}`);
              if (bubbleInCard) bubbleInCard.style.display = 'none';
              generateCalendar(currentCalendarMonth, currentCalendarYear); // Regenera para mostrar cambio
            } catch (err) {
              console.error(`Error asignando fecha a nota ${noteId}:`, err);
              alert("Error al asignar la fecha a la nota.");
            }
          }
        });
        datesG.appendChild(cell);
      }
      const totalCells = firstDayOfMonth + daysInMonth;
      const cellsNeeded = totalCells <= 35 ? 35 : 42;
      for (let i = totalCells; i < cellsNeeded; i++) {
        const e = document.createElement('div');
        e.className = 'calendar-date empty';
        datesG.appendChild(e);
      }
      calendarWidgetElem.appendChild(datesG);
      currentCalendarMonth = month;
      currentCalendarYear = year;
    } // --- Fin de generateCalendar ---

    function showCalendar() {
      if (!calendarWidgetElem) return;
      clearTimeout(calendarTimeout);
      if (calendarWidgetElem.style.display !== 'block') {
        const { month, year } = initCalendarDate();
        generateCalendar(month, year);
        calendarWidgetElem.style.display = 'block';
      }
    }
    function hideCalendar() {
      if (!calendarWidgetElem) return;
      calendarTimeout = setTimeout(() => {
        calendarWidgetElem.style.display = 'none';
      }, 300);
    }
    if (calendarIconElem) {
      calendarIconElem.addEventListener('mouseenter', showCalendar);
      calendarIconElem.addEventListener('mouseleave', hideCalendar);
      calendarIconElem.addEventListener('click', () => { // Click tambi√©n togglea
          if (calendarWidgetElem && calendarWidgetElem.style.display === 'block') {
              hideCalendar();
          } else {
              showCalendar();
          }
      });
    }
    if (calendarWidgetElem) {
      calendarWidgetElem.addEventListener('mouseenter', () => clearTimeout(calendarTimeout));
      calendarWidgetElem.addEventListener('mouseleave', hideCalendar);
    }
    function openCalendar() { // Llamada desde dragstart
      showCalendar();
    }

    // --- L√≥gica Central de Autenticaci√≥n y Carga/Limpieza de Datos ---
    auth.onAuthStateChanged(user => {
      if (user) {
        // --- USUARIO CONECTADO ---
        console.log('Usuario conectado:', user.email);
        if (loginFormDiv) loginFormDiv.style.display = 'none';
        if (userInfoDiv) userInfoDiv.style.display = 'block';
        if (userEmailDisplay) userEmailDisplay.textContent = user.email;

        // Iniciar el listener de Firestore para las notas SI NO est√° ya activo
        if (!unsubscribeFirestore) {
            console.log("(Auth) Iniciando listener de Firestore para notas...");
            unsubscribeFirestore = db.collection('notas')
              // Opcional: Ordenar notas (ej. por fecha de creaci√≥n descendente)
              // .orderBy('createdAt', 'desc')
              .onSnapshot((snapshot) => {
                if (!grid) {
                  console.error("(Auth) GridStack no est√° listo dentro del listener onSnapshot.");
                  return;
                }
                console.log("(Auth) Datos de notas recibidos/actualizados.");
                let needsCalendarUpdate = false;

                snapshot.docChanges().forEach((change) => {
                  const noteId = change.doc.id;
                  const notaData = change.doc.data();
                  console.log(`(Auth) Cambio: Tipo=${change.type}, ID=${noteId}`);

                  const widgetElement = displayedNotes.get(noteId); // Busca en nuestro Map

                  if (change.type === "added") {
                    if (!widgetElement) {
                      console.log(`(Auth) A√±adiendo widget para ${noteId}`);
                      if (typeof mostrarNotaEnPantalla === 'function') {
                          const result = mostrarNotaEnPantalla(change.doc);
                          if (result) {
                            grid.addWidget(result.element, result.position);
                            notesDataCache[noteId] = notaData;
                            displayedNotes.set(noteId, result.element); // Registra en el Map
                            if (notaData.assignedDate) needsCalendarUpdate = true;
                          }
                      } else { console.error("Funci√≥n mostrarNotaEnPantalla no definida"); }
                    } else {
                      console.log(`(Auth) 'added' pero widget ${noteId} ya estaba en el Map. Verificando datos.`);
                      widgetElement.docData = notaData; // Asegura data actualizada
                      notesDataCache[noteId] = notaData;
                      if (notaData.assignedDate !== (widgetElement.docData?.assignedDate)) {
                          needsCalendarUpdate = true;
                      }
                    }
                  } else if (change.type === "modified") {
                    console.log(`(Auth) Modificando widget para ${noteId}`);
                    if (widgetElement) {
                      const oldData = widgetElement.docData || {};
                      // --- Actualiza el contenido del widget existente ---
                      const noteContentElement = widgetElement.querySelector('.note-content');
                      const newText = notaData.url ? (notaData.texto || '') : (notaData.nota || '');
                      if (noteContentElement && newText !== (oldData.texto || oldData.nota || '')) {
                        console.log(`(Auth) - Actualizando texto para ${noteId}`);
                        if(typeof linkify === 'function') {
                            noteContentElement.innerHTML = linkify(newText);
                            Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
                                link.setAttribute('target', '_blank');
                                link.setAttribute('rel', 'noopener noreferrer');
                            });
                        } else { noteContentElement.textContent = newText; }
                      }
                      if (notaData.url && notaData.url !== oldData.url) {
                        console.log(`(Auth) - Actualizando URL imagen para ${noteId}`);
                        const img = widgetElement.querySelector('.image-container img');
                        if (img) img.src = notaData.url;
                      }
                      const bubbleButton = widgetElement.querySelector(`#bubble-${noteId}`);
                      if (bubbleButton) {
                        const needsBubble = !notaData.assignedDate;
                        const isBubbleVisible = bubbleButton.style.display !== 'none';
                        if (needsBubble && !isBubbleVisible) {
                            bubbleButton.style.display = 'inline-block';
                        } else if (!needsBubble && isBubbleVisible) {
                            bubbleButton.style.display = 'none';
                        }
                      }
                      // --- Fin actualizar widget ---
                      if (notaData.assignedDate !== oldData.assignedDate) {
                         needsCalendarUpdate = true;
                      }
                      widgetElement.docData = notaData;
                      notesDataCache[noteId] = notaData;
                    } else {
                      console.warn(`(Auth) Se recibi√≥ 'modified' para ${noteId}, pero widget no encontrado en Map.`);
                      notesDataCache[noteId] = notaData;
                      needsCalendarUpdate = true;
                    }
                  } else if (change.type === "removed") {
                     console.log(`(Auth) Eliminando widget para ${noteId}`);
                     if (widgetElement) {
                        grid.removeWidget(widgetElement);
                        displayedNotes.delete(noteId);
                        if (notesDataCache[noteId]?.assignedDate) needsCalendarUpdate = true;
                        delete notesDataCache[noteId];
                        document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
                     } else {
                       console.warn(`(Auth) Se recibi√≥ 'removed' para ${noteId}, pero no encontrado en Map.`);
                       delete notesDataCache[noteId];
                       document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
                       needsCalendarUpdate = true;
                     }
                  }
                }); // Fin forEach docChanges

                // Actualiza calendario si es necesario Y est√° visible
                if (needsCalendarUpdate && typeof generateCalendar === 'function' && calendarWidgetElem && calendarWidgetElem.style.display === 'block') {
                  console.log("(Auth) Actualizando calendario (visible) porque needsCalendarUpdate es true.");
                  if (typeof fetchAllAssignedNotes === 'function') {
                      fetchAllAssignedNotes().then(() => {
                         generateCalendar(currentCalendarMonth, currentCalendarYear);
                      });
                  } else { console.error("Funcion fetchAllAssignedNotes no definida"); }
                } else if (needsCalendarUpdate && typeof fetchAllAssignedNotes === 'function') {
                  fetchAllAssignedNotes(); // Recarga datos aunque no est√© visible
                }

            }, (error) => { // Manejo de error del listener onSnapshot
                console.error("(Auth) Error cr√≠tico escuchando Firestore:", error);
                alert("Error grave al obtener notas: " + error.message + ". Intenta recargar la p√°gina.");
                if (error.code === 'permission-denied') {
                    console.warn("Permiso denegado. Cerrando sesi√≥n.");
                    auth.signOut();
                }
            }); // Fin del onSnapshot
            console.log("(Auth) Listener de Firestore para notas ACTIVADO.");
        } // Fin del if (!unsubscribeFirestore)

      } else {
        // --- USUARIO DESCONECTADO ---
        console.log('Nadie conectado. Limpiando estado...');
        if (loginFormDiv) loginFormDiv.style.display = 'block';
        if (userInfoDiv) userInfoDiv.style.display = 'none';

        // Detener el listener de Firestore si est√° activo
        if (unsubscribeFirestore) {
          unsubscribeFirestore();
          unsubscribeFirestore = null;
          console.log("Listener de notas DETENIDO.");
        }
        // Limpiar el grid y los caches
        if (grid) {
          grid.removeAll(true); // true para no animar
          console.log("Grid limpiado.");
        }
        displayedNotes.clear();
        notesDataCache = {};
        assignedDatesCache = {};
        if (calendarWidgetElem) calendarWidgetElem.style.display = 'none';

      } // Fin del else (usuario desconectado)
    }); // --- FIN BLOQUE onAuthStateChanged ---

    // --- Listeners para los Botones de Login/Logout ---
    if (loginButton && emailInput && passwordInput) {
      loginButton.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
          return alert('Ingresa correo y contrase√±a');
        }
        console.log("Intentando iniciar sesi√≥n para:", email);
        auth.signInWithEmailAndPassword(email, password)
          .then(userCredential => {
            console.log('Login OK desde bot√≥n para:', userCredential.user.email);
            // onAuthStateChanged se encarga del resto
          })
          .catch(error => {
            console.error('Error Login Bot√≥n:', error.code, error.message);
            let mensajeError = 'Error al iniciar sesi√≥n.';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                mensajeError = 'Correo o contrase√±a incorrectos.';
            } else if (error.code === 'auth/invalid-email') {
                mensajeError = 'El formato del correo no es v√°lido.';
            }
            alert(mensajeError);
          });
      });
    } else {
      console.error("Error cr√≠tico: No se encontraron elementos para el formulario de login.");
    }

    if (logoutButton) {
      logoutButton.addEventListener('click', () => {
        console.log("Intentando cerrar sesi√≥n...");
        auth.signOut()
          .then(() => {
            console.log('Logout OK desde bot√≥n.');
            // onAuthStateChanged se encarga del resto
          })
          .catch(error => {
            console.error('Error Logout Bot√≥n:', error);
            alert('Error al cerrar sesi√≥n: ' + error.message);
          });
      });
    } else {
      console.error("Error cr√≠tico: No se encontr√≥ el bot√≥n de logout.");
    }
    // --- FIN C√≥digo para los Botones ---
  </script>
</body>
</html>
```

Este c√≥digo es funcionalmente id√©ntico al anterior, solo que sin los espacios en blanco entre bloques o funciones. Es m√°s dif√≠cil de leer para un humano, pero ocupa menos l√≠neas si eso es lo que necesit
