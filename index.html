<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notas Oceánicas - Polaroid (Original Corregido v1.1)</title>

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
    <style>
    /* =========================================== */
    /* <<< INICIO: ESTILOS CSS ORIGINALES (TEMA OCÉANO) >>> */
    /* =========================================== */
    html, body { margin: 0; padding: 0; height: 100vh; overflow: hidden; background: linear-gradient(to bottom, #a2dff7 0%, #a2dff7 40%, #03254c 100%); font-family: Arial, sans-serif; }
    .container { height: 100%; width: 100%; padding: 2cm; box-sizing: border-box; display: flex; flex-direction: column; position: relative; overflow: hidden; }
    #notaDisplay { flex-grow: 1; width: 100%; overflow-y: auto; overflow-x: hidden; position: relative; background-color: rgba(255, 255, 255, 0.05); border-radius: 5px; }
    .grid-stack-placeholder { display: none !important; }
    .grid-stack-item { transition: transform 0.4s cubic-bezier(0.25,1,0.5,1); overflow: visible !important; }
    .grid-stack-item-content { overflow: visible !important; height:auto; width: 100%; display: flex; flex-direction: column; }
    .grid-stack { padding-bottom: 1px; }
    .card-wrapper, .text-card { background-color: #fff; border: 2px solid #0077a3; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); width: 240px; display: flex; flex-direction: column; position: relative; height: auto; box-sizing: border-box; margin: 5px; }
    .image-container { width: 100%; height: 240px; overflow: hidden; position: relative; flex-shrink: 0; background-color: #eee; }
    .image-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .image-error-placeholder { padding: 10px; text-align: center; font-size: 13px; color: #c0392b; font-weight: bold; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f9eaea; box-sizing: border-box; }
    .image-error-placeholder span { font-size: 24px; margin-bottom: 5px; }
    .note-content { background-color: #fff; padding: 10px; text-align: left; font-size: 16px; color: #333; min-height: 50px; box-sizing: border-box; word-wrap: break-word; overflow: hidden; flex-grow: 1; }
    .note-content a { color: #0077a3; text-decoration: underline; }
    .menu-bar { background-color: #0288D1; padding: 5px 8px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-top: 1px solid #0077a3; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; cursor: grab; }
    .menu-bar:active { cursor: grabbing; }
    .menu-icon { background: none; border: none; font-size: 20px; color: #fff; cursor: pointer; padding: 2px 4px; }
    .bubble-icon { color: #FFCD05; font-size: 22px; }
    .menu-actions { display: flex; gap: 4px; }
    #addNoteButton { position: absolute; bottom: 30px; right: 30px; background-color: #006994; color: #fff; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: background-color 0.3s ease, transform 0.3s ease; z-index: 1001; }
    #addNoteButton:hover { background-color: #005577; transform: scale(1.05); }
    #addNoteOptions { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.85); border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); display: none; flex-direction: row; justify-content: center; align-items: center; gap: 25px; padding: 25px; z-index: 1002; }
    #addNoteOptions .card { background-color: #2c2c2c; border: 1px solid #0077a3; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; width: 180px; }
    #addNoteOptions .card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 6px 12px rgba(0, 119, 163, 0.5); }
    #addNoteOptions .card h2 { color: #36a2eb; margin-bottom: 10px; }
    #addNoteOptions .card p { color: #ccc; font-size: 14px; }
    #inputArea { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #ffffff; padding: 25px 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; flex-direction: column; gap: 15px; width: 90%; max-width: 550px; z-index: 1002; }
    #inputArea label { font-weight: bold; color: #333; margin-bottom: 3px; font-size: 14px; }
    #inputArea textarea, #inputArea input[type="text"] { padding: 12px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; width: 100%; box-sizing: border-box; line-height: 1.5; font-size: 16px; }
    #inputArea textarea { min-height: 80px; } #inputArea textarea#textNote { min-height: 120px; }
    #inputArea button { padding: 10px 20px; background-color: #006994; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; align-self: flex-end; margin-top: 10px; font-size: 16px; font-weight: bold; }
    #inputArea button:hover { background-color: #005577; } #inputArea button:active { transform: scale(0.98); }
    .input-group { display: flex; flex-direction: column; gap: 5px; width: 100%;}
    .calendar-icon { position: absolute; bottom: 30px; left: 30px; width: 45px; height: 45px; background-color: #fff; border: 1px solid #ccc; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #333; font-size: 24px; cursor: pointer; z-index: 1001; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .calendar-widget { position: absolute; bottom: 85px; left: 20px; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); padding: 15px; display: none; z-index: 1001; width: 320px; min-height: 300px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .calendar-header button { background: none; border: none; cursor: pointer; font-size: 20px; color: #0077a3; padding: 5px 8px; border-radius: 4px; transition: background-color 0.2s ease; }
    .calendar-header button:hover:not(:disabled) { background-color: #e0f7fa; } .calendar-header button:disabled { color: #ccc; cursor: default; }
    .calendar-header span { font-weight: bold; color: #333; font-size: 18px; }
    .calendar-days-header, .calendar-dates-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 6px; }
    .calendar-days-header { margin-bottom: 10px; font-weight: bold; color: #555; padding-bottom: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
    .calendar-day { padding: 3px; }
    .calendar-date { padding: 0; border-radius: 50%; color: #333; border: 2px solid transparent; cursor: pointer; position: relative; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; margin: 0 auto; line-height: 1; font-size: 14px; transition: background-color 0.2s ease, border-color 0.2s ease; }
    .calendar-date.empty { background: none; cursor: default; opacity: 0; }
    .calendar-date:not(.empty):hover { background-color: #e0f7fa; border-color: #b3e5fc; }
    .calendar-date.today { border-color: #0077a3; font-weight: bold; color: #005577; }
    .calendar-date.drag-over { background-color: #a2dff7 !important; border-color: #0077a3 !important; }
    .assigned-bubble { color: #FFCD05; font-size: 11px; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); line-height: 1; text-shadow: 0 0 1px rgba(0,0,0,0.5); pointer-events: none; }
    .calendar-date .assigned-bubble + .assigned-bubble { bottom: -2px; }
    .blur-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); display: none; z-index: 1000; cursor: pointer; }
    /* ========================================= */
    /* <<< FIN: ESTILOS CSS ORIGINALES >>> */
    /* ========================================= */
  </style>
</head>
<body>
  <div class="container">
        <div id="notaDisplay" class="grid-stack"></div>
    <button id="addNoteButton" title="Añadir nueva nota o imagen">+</button>
    <div id="addNoteOptions">
      <div class="card" id="addImageLinkOption" title="Añadir una nota con imagen desde un enlace web"><h2>🖼️ Imagen</h2><p>Guardar link de imagen.</p></div>
      <div class="card" id="addTextNoteOption" title="Añadir una nota de texto simple"><h2>📝 Nota</h2><p>Subir nota de texto.</p></div>
    </div>
    <div id="inputArea">
      <div id="imageLinkInputArea" style="display: none;"><div class="input-group"><label for="imageLink">Link de la imagen:</label><input type="text" id="imageLink" placeholder="Pega aquí la URL de la imagen (ej: https://...)" /></div><div class="input-group"><label for="imageNoteText">Texto adicional (opcional):</label><textarea id="imageNoteText" placeholder="Escribe aquí una descripción o nota relacionada con la imagen..." rows="3"></textarea></div><button id="saveImageLink">Guardar Imagen</button></div>
      <div id="textNoteInputArea" style="display: none;"><div class="input-group"><label for="textNote">Nota:</label><textarea id="textNote" placeholder="Escribe tu nota aquí..." rows="5"></textarea></div><button id="saveTextNote">Guardar Nota</button></div>
    </div>
    <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">📅</div>
    <div id="calendarWidget" class="calendar-widget"></div>
    <div class="blur-background"></div>
  </div>

  <script>
    // ===========================================
    // <<< INICIO: JAVASCRIPT ORIGINAL (Corregido) >>>
    // ===========================================
    /****************** Utilidades y Configuración de Firebase ******************/

    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(?<!href=["']|src=["'])(https?:\/\/[^\s<>"']+)/g; // Regex mejorada
      const replacedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return replacedText.replace(/\n/g, '<br>');
    }

    const firebaseConfig = {
      // ¡¡¡ USA TU API KEY REAL !!! (Esta es la que venía en tu código original)
      apiKey: "AIzaSyCHa373WgLLHsy8wZXK9zr_HVieQvlrhUs",
      authDomain: "oasis-b036d.firebaseapp.com",
      projectId: "oasis-b036d",
      storageBucket: "oasis-b036d.appspot.com",
      messagingSenderId: "141546637821",
      appId: "1:141546637821:web:0a861aeb13831774ed3194",
      measurementId: "G-HB2P17H5YL"
    };
    let db;
    try {
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); console.log("Firebase inicializado (Original)."); }
        else { firebase.app(); console.log("Firebase ya inicializado (Original)."); }
        db = firebase.firestore();
    } catch (e) { console.error("Error inicializando Firebase (Original):", e); alert("Error conectando a Firebase."); }

    /****************** Inicialización de GridStack ******************/
    let grid;
    try {
        grid = GridStack.init({
            column: 36, margin: 10, cellHeight: 'auto', disableResize: true,
            float: false, animate: true, alwaysShowResizeHandle: false,
            draggable: { handle: '.menu-bar', scroll: true, appendTo: 'body' }
        });
      console.log("GridStack inicializado (Original).");
    } catch (e) { console.error("Error inicializando GridStack (Original):", e); alert("Error al iniciar área de notas."); }

    /****************** Escucha de Cambios en GridStack (Drag/Drop) ******************/
    if (grid) {
        grid.on('change', function(event, items) {
            console.log("GridStack 'change' (Original).");
            items.forEach(function(item) {
                const noteId = item.el?.getAttribute('data-note-id') || item.id || '?';
                console.log(` - Nota ${noteId}, Pos: x=${item.x}, y=${item.y}`);
                const noteIdToSave = item.el?.getAttribute('data-note-id');
                if (noteIdToSave && typeof item.x === 'number' && typeof item.y === 'number' && db) {
                     console.log(`   (Guardando pos x:${item.x}, y:${item.y} para ${noteIdToSave})`);
                     // La línea original para guardar estaba comentada, la dejo así:
                    // db.collection('notas').doc(noteIdToSave).update({ x: item.x, y: item.y }).catch(err => console.error(`Error save pos: ${err}`));
                }
            });
        });
        grid.on('dragstop', function(event, element) {
             const node = grid.engine.nodes.find(n => n.el === element);
             if (node) { const noteId = node.el?.getAttribute('data-note-id') || '?'; console.log(`Dragstop: ${noteId} @ x=${node.x}, y=${node.y}`); }
        });
        console.log(">>> Listeners GridStack adjuntados (Original) <<<");
    }

    /****************** Utilidades UI (Scroll, Resize Textarea) ******************/
    const gridContainer = document.getElementById('notaDisplay');
    if (gridContainer) gridContainer.addEventListener('wheel', (event) => {}, { passive: true });
    function autoResizeTextarea(el) { if (!el) return; el.style.height = 'auto'; el.style.height = (el.scrollHeight + 2) + 'px'; }
    const textNoteInputElem = document.getElementById('textNote');
    const imageNoteTextElem = document.getElementById('imageNoteText');
    if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
    if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));
    
    /****************** Renderización, Edición y Eliminación de Notas ******************/
    const displayedNotes = new Map(); // Caché original

    // --- FUNCIÓN PARA MOSTRAR NOTA (Original) ---
    function mostrarNotaEnPantalla(doc) {
      const notaData = doc.data(); const noteId = doc.id;
      console.log(`Intentando mostrar nota ${noteId} (Original)`);
      let gridItem = document.createElement('div'); gridItem.classList.add('grid-stack-item'); gridItem.setAttribute('data-note-id', noteId); gridItem.setAttribute('gs-id', noteId);
      const content = document.createElement('div'); content.classList.add('grid-stack-item-content');
      let card; let noteContentElement;

      if (notaData.url) { // Tarjeta Imagen
            card = document.createElement('div'); card.classList.add('card-wrapper');
            const imageContainer = document.createElement('div'); imageContainer.classList.add('image-container');
            const img = document.createElement('img'); img.src = notaData.url; img.alt = notaData.texto || 'Imagen'; img.loading = 'lazy';
            img.onerror = () => { console.error(`Error img load (Original): ${img.src}`); imageContainer.innerHTML = `<div class="image-error-placeholder"><span>🖼️</span>Error Imagen</div>`; }
            imageContainer.appendChild(img); card.appendChild(imageContainer);
            if(notaData.texto) { noteContentElement = document.createElement('div'); noteContentElement.classList.add('note-content'); noteContentElement.innerHTML = linkify(notaData.texto); card.appendChild(noteContentElement); }
      } else if (notaData.nota) { // Tarjeta Texto
            card = document.createElement('div'); card.classList.add('text-card');
            noteContentElement = document.createElement('div'); noteContentElement.classList.add('note-content'); noteContentElement.innerHTML = linkify(notaData.nota); card.appendChild(noteContentElement);
      } else { console.warn(`Nota ${noteId} sin contenido (Original).`); return null; }

      if (noteContentElement) { Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => { link.setAttribute('target', '_blank'); link.setAttribute('rel', 'noopener noreferrer'); }); }

      // Barra de Menú (Original)
      const menuBar = document.createElement('div'); menuBar.classList.add('menu-bar');
      const bubbleButton = document.createElement('button'); bubbleButton.classList.add('menu-icon', 'bubble-icon'); bubbleButton.innerHTML = '●'; bubbleButton.setAttribute('draggable', 'true'); bubbleButton.id = `bubble-${noteId}`; bubbleButton.title = "Arrastrar al calendario"; bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';
      bubbleButton.addEventListener('dragstart', (e) => { var imgGhost = new Image(); imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; e.dataTransfer.setDragImage(imgGhost, 0, 0); e.dataTransfer.setData("application/note-id", noteId); e.dataTransfer.effectAllowed = "move"; openCalendar(); });
      bubbleButton.addEventListener('click', (e) => { e.stopPropagation(); openCalendar(); });
      const menuActions = document.createElement('div'); menuActions.classList.add('menu-actions');
      const editButton = document.createElement('button'); editButton.classList.add('menu-icon'); editButton.innerHTML = '✎'; editButton.title = "Editar";
      const deleteButton = document.createElement('button'); deleteButton.classList.add('menu-icon'); deleteButton.innerHTML = '✖'; deleteButton.title = "Eliminar";
      deleteButton.onclick = (e) => { e.stopPropagation(); if (typeof deleteNote === 'function') deleteNote(noteId, gridItem); else { console.error("deleteNote no definida"); alert("Error interno."); } };
      editButton.onclick = (e) => { e.stopPropagation(); if (typeof editNoteContent === 'function') editNoteContent(card, noteId, notaData, menuActions, editButton, deleteButton); else console.error("editNoteContent no definida"); };
      menuActions.appendChild(editButton); menuActions.appendChild(deleteButton); menuBar.appendChild(bubbleButton); menuBar.appendChild(menuActions); card.appendChild(menuBar); content.appendChild(card); gridItem.appendChild(content);

      // Posición Gridstack (Original)
      const pos = { x: notaData.x, y: notaData.y, w: notaData.w || 2, id: noteId, autoPosition: (notaData.x === undefined || notaData.y === undefined) };
      gridItem.docData = notaData;
      console.log(`   -> Widget HTML creado ${noteId} (Original)`);
      return { element: gridItem, position: pos };
    }

    // --- FUNCIÓN PARA EDITAR NOTA (Original) ---
    function editNoteContent(card, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
        let targetElement = card.querySelector('.note-content');
        if (!targetElement && notaData.url) { targetElement = document.createElement('div'); targetElement.classList.add('note-content'); card.insertBefore(targetElement, card.querySelector('.menu-bar')); }
      else if (!targetElement && !notaData.url) { console.error("Error: No .note-content:", noteId); return; }
        const isImageNote = !!notaData.url; const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');
        targetElement.innerHTML = '';
        const editInput = document.createElement('textarea'); editInput.value = currentText; editInput.style.cssText = "width:100%; min-height:80px; height:auto; box-sizing:border-box; border:1px dashed #ccc; resize:vertical;";
        targetElement.appendChild(editInput); autoResizeTextarea(editInput); editInput.addEventListener('input', () => autoResizeTextarea(editInput)); editInput.focus();
        const saveEditButton = document.createElement('button'); saveEditButton.classList.add('menu-icon'); saveEditButton.innerHTML = '💾'; saveEditButton.title = "Guardar";
        saveEditButton.onclick = (e) => {
            e.stopPropagation(); const newText = editInput.value.trim(); const updateData = isImageNote ? { texto: newText || null } : { nota: newText };
            saveEditButton.disabled = true; saveEditButton.innerHTML = '⏳';
          if (!db) { console.error("DB no disponible edit"); alert("Error conexión"); saveEditButton.disabled=false; saveEditButton.innerHTML = '💾'; return; }
            db.collection('notas').doc(noteId).update(updateData)
              .then(() => { targetElement.innerHTML = linkify(newText); menuActionsContainer.innerHTML = ''; menuActionsContainer.appendChild(editButton); menuActionsContainer.appendChild(deleteButton); console.log(`Update OK ${noteId} (Original).`); })
              .catch((error) => { console.error('Error update (Original):', error); alert("Error guardando."); targetElement.innerHTML = linkify(currentText); menuActionsContainer.innerHTML = ''; menuActionsContainer.appendChild(editButton); menuActionsContainer.appendChild(deleteButton); saveEditButton.disabled = false; saveEditButton.innerHTML = '💾'; });
        };
        menuActionsContainer.innerHTML = ''; menuActionsContainer.appendChild(saveEditButton);
    }

    // --- FUNCIÓN PARA ELIMINAR NOTA (Original) ---
    function deleteNote(noteId, gridItem) {
        console.log("Eliminando nota (Original):", noteId);
      if (!db) { console.error("DB no disponible delete"); alert("Error conexión"); return; }
        db.collection('notas').doc(noteId).delete()
          .then(() => {
               console.log(`Delete OK ${noteId} Firestore (Original).`);
              if (grid && gridItem) { try { grid.removeWidget(gridItem, false); } catch(e) { console.warn("Error leve quitando widget:", e); } }
               displayedNotes.delete(noteId);
               document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
          })
          .catch((error) => { console.error("Error delete (Original):", error); alert("Error eliminando."); });
    }

    /****************** Escucha de Cambios en Firestore (Original con logs) ******************/
    if (db && typeof db.collection === 'function') {
      console.log("Adjuntando listener Firestore (Original)...");
        db.collection('notas') // Sin ordenar por defecto en el original
          .onSnapshot((snapshot) => {
            console.log(`Snapshot (Original). Cambios: ${snapshot.docChanges().length}`);
            if (!grid) { console.error("GridStack no init en listener (Original)."); return; }
            let needsCalendarUpdate = false; // (Lógica calendario original)
            let notesToAdd = []; // Procesar añadidos al final

            snapshot.docChanges().forEach((change) => {
              const noteId = change.doc.id;
              const notaData = change.doc.data();
              console.log(`  -> Cambio: ${change.type}, ID=${noteId} (Original)`);
              const widgetElement = grid.engine.nodes.find(n => n.id === noteId)?.el;

              try {
                if (change.type === "added") {
                    if (!widgetElement) {
                        const result = mostrarNotaEnPantalla(change.doc);
                        if (result) {
                            notesToAdd.push(result); // Añadir a la lista para procesar después
                            if (notaData.assignedDate) needsCalendarUpdate = true;
                        } else { console.warn(`    Widget ${noteId} no renderizado (Original).`);}
                    } else { console.log(`    Widget ${noteId} ya existía (added, Original).`); }
                } else if (change.type === "modified") {
                  console.log(`    Modificando ${noteId} (Original)`);
                  if (widgetElement) {
                      widgetElement.docData = notaData; // Actualizar datos cacheados
                      // Actualizar UI simplificado
                      const noteContent = widgetElement.querySelector('.note-content');
                      if (noteContent && !widgetElement.querySelector('textarea')) {
                          const newText = notaData.url ? (notaData.texto || '') : (notaData.nota || '');
                          noteContent.innerHTML = linkify(newText);
                      }
                      const bubble = widgetElement.querySelector(`#bubble-${noteId}`);
                      if(bubble) bubble.style.display = notaData.assignedDate ? 'none' : 'inline-block';
                      if (widgetElement.docData?.assignedDate !== notaData.assignedDate) needsCalendarUpdate = true;
                  } else { console.warn(`    Widget ${noteId} no encontrado para mod (Original).`); }
                } else if (change.type === "removed") {
                  console.log(`    Eliminando ${noteId} (Original)`);
                  if (widgetElement) {
                      try { grid.removeWidget(widgetElement, false); console.log(`    ✅ Widget ${noteId} eliminado (Original).`); if (notesDataCache[noteId]?.assignedDate) needsCalendarUpdate = true; delete notesDataCache[noteId]; displayedNotes.delete(noteId); document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove()); }
                      catch(e) { console.warn(`    Error leve eliminando ${noteId} (Original):`, e); }
                  } else { console.log(`    Widget ${noteId} no encontrado para eliminar (Original).`); }
                }
              } catch (error) { console.error(`❌ Error procesando ${change.type} para ${noteId} (Original):`, error); }
          }); // Fin forEach

          // Añadir widgets nuevos al grid DESPUÉS de procesar todos los cambios
          if (notesToAdd.length > 0) {
              console.log(`Añadiendo ${notesToAdd.length} nuevos widgets al grid...`);
              grid.batchUpdate(); // Iniciar actualización por lotes
              notesToAdd.forEach(result => {
                  try {
                      if (!grid.engine.nodes.find(n => n.id === result.position.id)) {
                           grid.addWidget(result.element, result.position);
                           console.log(`    ✅ Widget ${result.position.id} añadido (batch, Original).`);
                      } else {
                           console.warn(`    Widget ${result.position.id} ya existía (batch, Original).`);
                      }
                  } catch (addError) {
                      console.error(`    ❌ Error añadiendo widget ${result.position.id} (batch, Original):`, addError);
                  }
              });
              grid.commit(); // Finalizar actualización por lotes
          }

          // Actualiza calendario si es necesario
          if (needsCalendarUpdate && currentCalendarMonth !== undefined) { console.log("Actualizando calendario (Original)..."); fetchAllAssignedNotes().then(() => { generateCalendar(currentCalendarMonth, currentCalendarYear); }); }
          else if (needsCalendarUpdate) { fetchAllAssignedNotes(); }
          console.log("Snapshot procesado (Original).");
        
          }, (error) => { console.error("Error Firestore Listener (Original):", error); alert("Error al cargar notas."); });
    } else { console.error("Firestore (db) o Gridstack no inicializado (Original). Listener no activo."); }

    /****************** Manejo UI Agregar Notas (Original) ******************/
    // (Listeners y funciones originales sin cambios)
    const addNoteButtonElem = document.getElementById('addNoteButton'); const addNoteOptionsElem = document.getElementById('addNoteOptions'); const addImageLinkOptionElem = document.getElementById('addImageLinkOption'); const addTextNoteOptionElem = document.getElementById('addTextNoteOption'); const inputAreaElem = document.getElementById('inputArea'); const imageLinkInputAreaElem = document.getElementById('imageLinkInputArea'); const imageLinkInputElem = document.getElementById('imageLink'); const saveImageLinkButtonElem = document.getElementById('saveImageLink'); const textNoteInputAreaElem = document.getElementById('textNoteInputArea'); const saveTextNoteButtonElem = document.getElementById('saveTextNote'); const blurBackgroundElem = document.querySelector('.blur-background');
    function hideMenus() { if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if(inputAreaElem) inputAreaElem.style.display = 'none'; if(blurBackgroundElem) blurBackgroundElem.style.display = 'none'; if(imageLinkInputElem) imageLinkInputElem.value = ''; if(imageNoteTextElem) { imageNoteTextElem.value = ''; autoResizeTextarea(imageNoteTextElem); } if(textNoteInputElem) { textNoteInputElem.value = ''; autoResizeTextarea(textNoteInputElem); } if(saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = false; if(saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = false; }
    if (addNoteButtonElem) addNoteButtonElem.onclick = (e) => { e.stopPropagation(); if (addNoteOptionsElem && addNoteOptionsElem.style.display === 'flex') { hideMenus(); } else if (addNoteOptionsElem && blurBackgroundElem) { hideMenus(); addNoteOptionsElem.style.display = 'flex'; blurBackgroundElem.style.display = 'block'; } };
    if (addImageLinkOptionElem) addImageLinkOptionElem.onclick = (e) => { e.stopPropagation(); if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if(imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'block'; if(textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'none'; if(inputAreaElem) inputAreaElem.style.display = 'flex'; if(blurBackgroundElem) blurBackgroundElem.style.display = 'block'; if(imageLinkInputElem) imageLinkInputElem.focus(); };
    if (addTextNoteOptionElem) addTextNoteOptionElem.onclick = (e) => { e.stopPropagation(); if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if(imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'none'; if(textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'block'; if(inputAreaElem) inputAreaElem.style.display = 'flex'; if(blurBackgroundElem) blurBackgroundElem.style.display = 'block'; if(textNoteInputElem) textNoteInputElem.focus(); };
    if (blurBackgroundElem) blurBackgroundElem.onclick = hideMenus;
    function guardarLinkDeImagen() { if (!imageLinkInputElem || !db) { alert("Error guardando imagen."); return; } let link = imageLinkInputElem.value.trim(); const texto = imageNoteTextElem ? imageNoteTextElem.value.trim() : ''; if (link && (link.startsWith('http://') || link.startsWith('https://'))) { if(saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = true; db.collection('notas').add({ url: link, texto: texto || null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tipo: 'imagen' }).then(() => { console.log("Imagen guardada (Original)."); hideMenus(); }).catch((error) => { console.error('Error guardando link (Original):', error); alert("Error al guardar imagen."); }).finally(() => { if(saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = false; }); } else { alert("Introduce un link válido."); imageLinkInputElem.focus(); } }
    function guardarNotaTexto() { if (!textNoteInputElem || !db) { alert("Error guardando nota."); return; } const nota = textNoteInputElem.value.trim(); if (nota) { if(saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = true; db.collection('notas').add({ nota: nota, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tipo: 'texto' }).then(() => { console.log("Nota guardada (Original)."); hideMenus(); }).catch((error) => { console.error('Error guardando nota (Original):', error); alert("Error al guardar nota."); }).finally(() => { if(saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = false; }); } else { alert("Escribe algo en la nota."); textNoteInputElem.focus(); } }
    if(saveImageLinkButtonElem) saveImageLinkButtonElem.onclick = guardarLinkDeImagen;
    if(saveTextNoteButtonElem) saveTextNoteButtonElem.onclick = guardarNotaTexto;

    /****************** Calendario y Asignación (Original) ******************/
    // (Funciones originales sin cambios)
    let currentCalendarMonth, currentCalendarYear; let assignedDatesCache = {}; let notesDataCache = {};
    function getChileDate() { try { const opts = { timeZone: 'America/Santiago', year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false }; const fmt = new Intl.DateTimeFormat('en-CA', opts); const p = fmt.formatToParts(new Date()); const d = {}; p.forEach(({ type, value }) => d[type] = parseInt(value, 10)); return new Date(Date.UTC(d.year, d.month - 1, d.day, d.hour, d.minute, d.second)); } catch (e) { console.warn("Intl fallback (Original)", e); return new Date(); } }
    function initCalendarDate() { let today = getChileDate(); let year = today.getFullYear(); let month = today.getMonth(); const minY = 2024; const minM = 11; if (year < minY || (year === minY && month < minM)) { return { month: minM, year: minY }; } return { month, year }; }
    function getMonthName(idx) { const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; return months[idx % 12] || ''; }
    async function fetchAllAssignedNotes() { console.log("Fetch assigned (Original)..."); assignedDatesCache = {}; notesDataCache = {}; if (!db) { console.error("DB no disponible fetch assigned (Original)."); return; } try { const snap = await db.collection('notas').where('assignedDate', '!=', null).get(); snap.forEach(doc => { const d = doc.data(); const id = doc.id; notesDataCache[id] = d; const dateStr = d.assignedDate; if (dateStr) { if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = []; if (!assignedDatesCache[dateStr].includes(id)) assignedDatesCache[dateStr].push(id); } }); console.log("Cache assigned OK (Original)."); } catch (err) { console.error("Error fetch dates (Original):", err); } }
    async function generateCalendar(month, year) { console.log(`Generando calendario ${month+1}/${year} (Original)`); if (Object.keys(notesDataCache).length === 0) await fetchAllAssignedNotes(); const calDiv = document.getElementById('calendarWidget'); if (!calDiv) return; calDiv.innerHTML = ''; const today = getChileDate(); const hdr = document.createElement('div'); hdr.className = 'calendar-header'; const pBtn = document.createElement('button'); pBtn.innerHTML = '&lt;'; const minY = 2024; const minM = 11; if (year === minY && month === minM) pBtn.disabled = true; else pBtn.onclick = () => generateCalendar(month === 0 ? 11 : month - 1, month === 0 ? year - 1 : year); const nBtn = document.createElement('button'); nBtn.innerHTML = '&gt;'; nBtn.onclick = () => generateCalendar(month === 11 ? 0 : month + 1, month === 11 ? year + 1 : year); const title = document.createElement('span'); title.textContent = `${getMonthName(month)} ${year}`; hdr.appendChild(pBtn); hdr.appendChild(title); hdr.appendChild(nBtn); calDiv.appendChild(hdr); const daysHdr = document.createElement('div'); daysHdr.className = 'calendar-days-header'; ['Do','Lu','Ma','Mi','Ju','Vi','Sá'].forEach(day => { const d = document.createElement('div'); d.className = 'calendar-day'; d.textContent = day; daysHdr.appendChild(d); }); calDiv.appendChild(daysHdr); const datesG = document.createElement('div'); datesG.className = 'calendar-dates-grid'; const firstD = new Date(year, month, 1).getDay(); const daysInM = new Date(year, month + 1, 0).getDate(); for (let i = 0; i < firstD; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesG.appendChild(e); } for (let date = 1; date <= daysInM; date++) { const cell = document.createElement('div'); cell.className = 'calendar-date'; cell.textContent = date; const dStr = `${date}/${month + 1}/${year}`; if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cell.classList.add('today'); if (assignedDatesCache[dStr]) { assignedDatesCache[dStr].forEach(id => { const b = document.createElement("span"); b.className = "assigned-bubble"; b.setAttribute("data-note", id); b.textContent = "●"; cell.appendChild(b); }); } cell.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; cell.classList.add('drag-over'); }); cell.addEventListener('dragleave', (e) => { cell.classList.remove('drag-over'); }); cell.addEventListener('drop', async (e) => { e.preventDefault(); cell.classList.remove('drag-over'); const noteId = e.dataTransfer.getData("application/note-id"); if (noteId && db) { const oldDStr = notesDataCache[noteId]?.assignedDate; try { await db.collection('notas').doc(noteId).update({ assignedDate: dStr }); if(notesDataCache[noteId]) notesDataCache[noteId].assignedDate = dStr; else notesDataCache[noteId] = { assignedDate: dStr }; if (oldDStr && assignedDatesCache[oldDStr]) { assignedDatesCache[oldDStr] = assignedDatesCache[oldDStr].filter(id => id !== noteId); if (assignedDatesCache[oldDStr].length === 0) delete assignedDatesCache[oldDStr]; } if (!assignedDatesCache[dStr]) assignedDatesCache[dStr] = []; if (!assignedDatesCache[dStr].includes(noteId)) assignedDatesCache[dStr].push(noteId); const bubbleInC = document.getElementById(`bubble-${noteId}`); if (bubbleInC) bubbleInC.style.display = 'none'; generateCalendar(currentCalendarMonth, currentCalendarYear); } catch (err) { console.error(`Err assign date ${noteId} (Original):`, err); alert("Error asignando fecha."); } } }); datesG.appendChild(cell); } const totalC = firstD + daysInM; const cellsN = totalC <= 35 ? 35 : 42; for (let i = totalC; i < cellsN; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesG.appendChild(e); } calDiv.appendChild(datesG); currentCalendarMonth = month; currentCalendarYear = year; }
    const calendarIconElem = document.getElementById('calendarIcon'); const calendarWidgetElem = document.getElementById('calendarWidget'); let calendarTimeout; function showCalendar() { if (!calendarWidgetElem) return; clearTimeout(calendarTimeout); if (calendarWidgetElem.style.display !== 'block') { const { month, year } = initCalendarDate(); generateCalendar(month, year); calendarWidgetElem.style.display = 'block'; } } function hideCalendar() { if (!calendarWidgetElem) return; calendarTimeout = setTimeout(() => { calendarWidgetElem.style.display = 'none'; }, 300); } if (calendarIconElem) { calendarIconElem.addEventListener('mouseenter', showCalendar); calendarIconElem.addEventListener('mouseleave', hideCalendar); } if (calendarWidgetElem) { calendarWidgetElem.addEventListener('mouseenter', () => clearTimeout(calendarTimeout)); calendarWidgetElem.addEventListener('mouseleave', hideCalendar); } function openCalendar() { showCalendar(); }
    let originalDragX = null; let originalDragY = null;

    // Código para añadir nota de prueba (comentado por defecto)
    /*
    function addSampleNoteOnLoad() {
        if (!db) { setTimeout(addSampleNoteOnLoad, 1000); return; }
        console.log("Intentando añadir nota de prueba (Original)...");
        const sampleNote = { nota: "Nota de prueba automática!", tipo: "texto", createdAt: firebase.firestore.FieldValue.serverTimestamp() };
        db.collection("notas").add(sampleNote)
            .then((docRef) => { console.log("✅ Nota prueba añadida ID:", docRef.id); })
            .catch((error) => { console.error("❌ Error nota prueba:", error); });
    }
    // Descomenta la siguiente línea para activar la prueba:
    // setTimeout(addSampleNoteOnLoad, 2000);
    */

    // ===========================================
    // <<< FIN: JAVASCRIPT ORIGINAL >>>
    // ===========================================
  </script>

</body>
</html>
```

**Cambios Realizados:**

1.  **Código Base:** Usé el HTML y JS que me proporcionaste originalmente.
2.  **CSS Verificado:** Confirmé que los estilos CSS para el tema océano están incluidos en la sección `<style>`.
3.  **Funciones Originales Restauradas:** Me aseguré de que las funciones `editNoteContent` y `deleteNote` estén presentes con su lógica original (la que estaba en tu primer código).
4.  **`linkify` Incluido:** Añadí la función `linkify` que era necesaria para mostrar el texto correctamente.
5.  **Corrección Error:** Corregí el cierre de la etiqueta `</script>` y eliminé caracteres sueltos para evitar que el código se muestre como texto en la página.
6.  **Nota de Prueba (Comentada):** Dejé el código para añadir una nota de prueba, pero comentado. Puedes descomentar la última línea (`setTimeout...`) si quieres probar si funciona el guardado básico.

Por favor, prueba esta versión (con tu API Key) y dime si ahora **ves el diseño del océano** como esperabas. A partir de ahí, podemos ver si las notas se muestran y si la funcionalidad de añadir/editar/eliminar funciona, revisando la consola si es necesar
