<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notas Oce√°nicas - Polaroid</title>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
  <style>
    /* Estilos CSS */
    html, body {
      margin: 0; padding: 0; height: 100vh; overflow: hidden;
      background: linear-gradient(to bottom, #a2dff7 0%, #a2dff7 40%, #03254c 100%);
      font-family: Arial, sans-serif;
    }
    .container {
      height: 100%; width: 100%; padding: 2cm; box-sizing: border-box;
      display: flex; flex-direction: column; position: relative; overflow: hidden;
    }
    #notaDisplay {
      flex-grow: 1; width: 100%; overflow-y: auto; overflow-x: hidden;
      position: relative;
      /* Fondo y borde para debugging - ¬°Quitar si todo funciona! */
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px dashed #ccc;
      border-radius: 5px;
    }
    .grid-stack-placeholder { display: none !important; }
    .grid-stack-item {
      transition: transform 0.4s cubic-bezier(0.25,1,0.5,1);
      overflow: visible !important;
       /* Fondo y borde para debugging - ¬°Quitar si todo funciona! */
       /* background-color: rgba(0, 255, 0, 0.05); */
       /* border: 1px dashed green; */
    }
    .grid-stack-item-content {
        overflow: visible !important; height: 100%; width: 100%;
        display: flex; flex-direction: column; background-color: #fff;
        border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        border: 1px solid #0077a3;
    }
    .grid-stack { padding-bottom: 1px; }

    /* Estilos Tarjetas */
    .card-wrapper, .text-card { display: flex; flex-direction: column; position: relative; height: 100%; box-sizing: border-box; }
    .image-container { width: 100%; height: 180px; /* Altura reducida para probar */ overflow: hidden; position: relative; flex-shrink: 0; border-top-left-radius: 8px; border-top-right-radius: 8px; background-color: #f0f0f0; /* Fondo mientras carga */ display: flex; align-items: center; justify-content: center; }
    .image-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .image-error-placeholder { padding: 10px; text-align: center; font-size: 12px; color: red; }
    .note-content { background-color: #fff; padding: 10px; text-align: left; font-size: 14px; color: #333; min-height: 30px; box-sizing: border-box; word-wrap: break-word; overflow-y: auto; /* Permitir scroll si el texto es largo */ flex-grow: 1; line-height: 1.4; max-height: 150px; /* Limitar altura m√°xima del texto */ }
    .note-content a { color: #0077a3; text-decoration: underline; } .note-content a:hover { color: #0288D1; }

    /* Men√∫ Tarjeta */
    .menu-bar { background-color: #f0f0f0; padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-top: 1px solid #ddd; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
    .menu-icon { background: none; border: none; font-size: 18px; color: #555; cursor: pointer; padding: 3px 5px; border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease; }
    .menu-icon:hover { background-color: #e0e0e0; color: #000; } .menu-icon:disabled { color: #bbb; cursor: not-allowed; }
    .bubble-icon { color: #FFB300; font-size: 20px; } .bubble-icon:hover { color: #FFA000; }
    .menu-actions { display: flex; gap: 4px; }

    /* Bot√≥n A√±adir (+) */
    #addNoteButton { position: absolute; bottom: 30px; right: 30px; background-color: #006994; color: #fff; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: background-color 0.3s ease, transform 0.3s ease; z-index: 1001; }
    #addNoteButton:hover { background-color: #005577; transform: scale(1.05); }

    /* Modales */
    #addNoteOptions { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(40, 40, 40, 0.9); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); display: none; flex-direction: row; justify-content: center; align-items: center; gap: 25px; padding: 30px 35px; z-index: 1002; }
    #addNoteOptions .card { background-color: #3a3a3a; border: 1px solid #0077a3; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; width: 180px; color: #eee; }
    #addNoteOptions .card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 6px 12px rgba(0, 119, 163, 0.5); }
    #addNoteOptions .card h2 { color: #64c8ff; margin-bottom: 10px; } #addNoteOptions .card p { color: #ccc; font-size: 14px; }
    #inputArea { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #ffffff; padding: 25px 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; flex-direction: column; gap: 15px; width: 90%; max-width: 550px; z-index: 1002; }
    #inputArea label { font-weight: bold; color: #333; margin-bottom: 3px; font-size: 14px; }
    #inputArea textarea, #inputArea input[type="text"] { padding: 12px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; width: 100%; box-sizing: border-box; line-height: 1.5; font-size: 16px; background-color: #f9f9f9; }
    #inputArea textarea:focus, #inputArea input[type="text"]:focus { border-color: #0077a3; box-shadow: 0 0 0 2px rgba(0, 119, 163, 0.2); outline: none; }
    #inputArea textarea { min-height: 80px; } #inputArea textarea#textNote { min-height: 120px; }
    #inputArea button { padding: 10px 20px; background-color: #006994; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; align-self: flex-end; margin-top: 10px; font-size: 16px; font-weight: bold; }
    #inputArea button:hover { background-color: #005577; } #inputArea button:active { transform: scale(0.98); }
    #inputArea button:disabled { background-color: #aaa; cursor: not-allowed; }
    .input-group { display: flex; flex-direction: column; gap: 5px; width: 100%;}

    /* Calendario */
    .calendar-icon { position: absolute; bottom: 30px; left: 30px; width: 45px; height: 45px; background-color: #fff; border: 1px solid #ccc; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #333; font-size: 24px; cursor: pointer; z-index: 1001; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: transform 0.2s ease; }
    .calendar-icon:hover { transform: scale(1.1); }
    .calendar-widget { position: absolute; bottom: 85px; left: 20px; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); padding: 15px; display: none; z-index: 1001; width: 320px; min-height: 300px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .calendar-header button { background: none; border: none; cursor: pointer; font-size: 20px; color: #0077a3; padding: 5px 8px; border-radius: 4px; transition: background-color 0.2s ease; }
    .calendar-header button:hover:not(:disabled) { background-color: #e0f7fa; } .calendar-header button:disabled { color: #ccc; cursor: default; }
    .calendar-header span { font-weight: bold; color: #333; font-size: 18px; }
    .calendar-days-header, .calendar-dates-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 6px; }
    .calendar-days-header { margin-bottom: 10px; font-weight: bold; color: #555; padding-bottom: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
    .calendar-day { padding: 3px; }
    .calendar-date { padding: 0; border-radius: 50%; color: #333; border: 2px solid transparent; cursor: pointer; position: relative; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; margin: 0 auto; line-height: 1; font-size: 14px; transition: background-color 0.2s ease, border-color 0.2s ease; }
    .calendar-date.empty { background: none; cursor: default; opacity: 0; }
    .calendar-date:not(.empty):hover { background-color: #e0f7fa; border-color: #b3e5fc; }
    .calendar-date.today { border-color: #0077a3; font-weight: bold; color: #005577; }
    .calendar-date.drag-over { background-color: #a2dff7 !important; border-color: #0077a3 !important; transform: scale(1.1); }
    .assigned-bubble { color: #FFB300; font-size: 11px; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); line-height: 1; text-shadow: 0 0 1px rgba(0,0,0,0.5); pointer-events: none; }
    .calendar-date .assigned-bubble + .assigned-bubble { bottom: -2px; }

    /* Fondo Borroso */
    .blur-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); display: none; z-index: 1000; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div id="notaDisplay" class="grid-stack"></div>
    <button id="addNoteButton" title="A√±adir nueva nota o imagen">+</button>
    <div id="addNoteOptions">
      <div class="card" id="addImageLinkOption" title="A√±adir imagen desde enlace"><h2>üñºÔ∏è Imagen</h2><p>Guardar link.</p></div>
      <div class="card" id="addTextNoteOption" title="A√±adir nota de texto"><h2>üìù Nota</h2><p>Escribir texto.</p></div>
    </div>
    <div id="inputArea">
      <div id="imageLinkInputArea" style="display: none;"><div class="input-group"><label for="imageLink">Link de la imagen:</label><input type="text" id="imageLink" placeholder="Pega URL (https://...)" /></div><div class="input-group"><label for="imageNoteText">Texto (opcional):</label><textarea id="imageNoteText" placeholder="Descripci√≥n..." rows="3"></textarea></div><button id="saveImageLink">Guardar Imagen</button></div>
      <div id="textNoteInputArea" style="display: none;"><div class="input-group"><label for="textNote">Nota:</label><textarea id="textNote" placeholder="Escribe tu nota..." rows="5"></textarea></div><button id="saveTextNote">Guardar Nota</button></div>
    </div>
    <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">üìÖ</div>
    <div id="calendarWidget" class="calendar-widget"></div>
    <div class="blur-background"></div>
  </div>

  <script>
    /**************************************************************************
     * Utilidades y Configuraci√≥n de Firebase
     **************************************************************************/
    function linkify(text) {
        if (!text) return "";
        const urlRegex = /(?<!href=["']|src=["'])(https?:\/\/[^\s<>"']+)/g;
        const replacedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        return replacedText.replace(/\n/g, '<br>');
    }

    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // <-- ¬°¬°¬° PON TU API KEY REAL AQU√ç !!!
        authDomain: "oasis-b036d.firebaseapp.com",
        projectId: "oasis-b036d",
        storageBucket: "oasis-b036d.appspot.com",
        messagingSenderId: "141546637821",
        appId: "1:141546637821:web:0a861aeb13831774ed3194",
        measurementId: "G-HB2P17H5YL"
    };

    let db; // Instancia Firestore
    try {
        if (!firebase.apps.length) {
             firebase.initializeApp(firebaseConfig);
             console.log("Firebase inicializado correctamente.");
        } else {
             firebase.app();
             console.log("Firebase ya estaba inicializado.");
        }
        db = firebase.firestore();
        console.log("Instancia de Firestore obtenida.");
        // Puedes a√±adir una verificaci√≥n m√°s robusta si quieres, pero la quitamos por ahora.

    } catch (e) {
        console.error("Error CR√çTICO inicializando Firebase:", e);
        alert("Error cr√≠tico: No se pudo inicializar Firebase. Revisa tu API Key y la consola (F12).");
    }

    /**************************************************************************
     * Inicializaci√≥n de GridStack
     **************************************************************************/
    let grid; // Instancia GridStack
    const gridContainer = document.getElementById('notaDisplay');

    if (gridContainer && typeof GridStack !== 'undefined') {
        try {
            grid = GridStack.init({
                column: 24,
                margin: 10,
                // --- DEBUGGING: Altura fija ---
                // Cambiado a 150 para dar m√°s espacio inicial.
                // Si esto funciona, las notas deber√≠an aparecer.
                // Luego puedes intentar volver a 'auto' o ajustar el CSS.
                cellHeight: 150,
                // cellHeight: 'auto', // <- Valor original
                // --- Fin Debugging ---
                disableResize: true,
                float: false,
                animate: true,
                alwaysShowResizeHandle: false,
                draggable: { handle: '.menu-bar', scroll: true, appendTo: 'body' }
            });
            console.log("GridStack inicializado correctamente con cellHeight:", grid.opts.cellHeight);

            grid.on('change', function(event, items) {
                console.log("GridStack 'change' event:", items.length, "items changed.");
                items.forEach(function(item) {
                    const noteId = item.el?.getAttribute('data-note-id');
                    if (noteId && typeof item.x === 'number' && typeof item.y === 'number' && db) {
                        console.log(`   - Saving position for Note ID: ${noteId} -> x:${item.x}, y:${item.y}`);
                        db.collection('notas').doc(noteId).update({ x: item.x, y: item.y })
                            .catch(err => console.error(`Error saving position for ${noteId}: ${err}`));
                    } else { console.warn(`   - Could not save position. Missing data/DB. ID: ${noteId}, x:${item.x}, y:${item.y}, DB: ${!!db}`); }
                });
            });
            grid.on('dragstop', function(event, element) {
                const node = grid.engine.nodes.find(n => n.el === element);
                if (node) { const noteId = node.el?.getAttribute('data-note-id') || node.id || '?'; console.log(`GridStack 'dragstop': ${noteId} dropped at x=${node.x}, y=${node.y}`); }
            });
            console.log(">>> GridStack event listeners attached <<<");

        } catch (e) {
            console.error("Error inicializando GridStack:", e);
            alert("Error al iniciar el √°rea de notas. Revisa la consola (F12).");
        }
    } else {
        console.error("Error: Contenedor #notaDisplay o GridStack JS no encontrado.");
        alert("Error cr√≠tico: No se puede inicializar el √°rea de notas.");
    }

    /**************************************************************************
     * Utilidades UI
     **************************************************************************/
    if (gridContainer) { gridContainer.addEventListener('wheel', (event) => {}, { passive: true }); }
    function autoResizeTextarea(el) { if (!el) return; el.style.height = 'auto'; el.style.height = (el.scrollHeight + 2) + 'px'; }
    const textNoteInputElem = document.getElementById('textNote');
    const imageNoteTextElem = document.getElementById('imageNoteText');
    if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
    if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));

    /**************************************************************************
     * Renderizaci√≥n, Edici√≥n y Eliminaci√≥n de Notas
     **************************************************************************/
    function crearWidgetNota(doc) {
        const notaData = doc.data();
        const noteId = doc.id;

        if (!notaData || (!notaData.url && !notaData.nota)) {
             console.warn(`Nota ${noteId} inv√°lida o sin contenido. No se mostrar√°.`);
             return null;
        }
        console.log(`Creando widget para ${noteId} con datos:`, notaData);

        let gridItem = document.createElement('div');
        gridItem.classList.add('grid-stack-item');
        gridItem.setAttribute('data-note-id', noteId);
        gridItem.setAttribute('gs-id', noteId); // Usar ID de Firestore como ID de GridStack

        const content = document.createElement('div');
        content.classList.add('grid-stack-item-content');

        let card;
        let noteContentElement;

        // Crear Tarjeta Imagen
        if (notaData.url) {
            card = document.createElement('div');
            card.classList.add('card-wrapper');
            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-container');
            const img = document.createElement('img');
            img.src = notaData.url;
            img.alt = notaData.texto || 'Imagen de nota';
            img.loading = 'lazy';
            img.onerror = function() { // Usar function() para tener 'this'
                console.error(`Error al cargar imagen: ${this.src} para nota ${noteId}`);
                imageContainer.innerHTML = `<div class="image-error-placeholder">‚ö†Ô∏è<br/>Error al<br/>cargar imagen</div>`;
            }
            imageContainer.appendChild(img);
            card.appendChild(imageContainer);

            if (notaData.texto) {
                noteContentElement = document.createElement('div');
                noteContentElement.classList.add('note-content');
                noteContentElement.innerHTML = linkify(notaData.texto);
                card.appendChild(noteContentElement);
            }
        // Crear Tarjeta Texto
        } else { // notaData.nota debe existir
            card = document.createElement('div');
            card.classList.add('text-card');
            noteContentElement = document.createElement('div');
            noteContentElement.classList.add('note-content');
            noteContentElement.innerHTML = linkify(notaData.nota);
            card.appendChild(noteContentElement);
        }

        // Linkificar contenido
        if (noteContentElement) {
            Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            });
        }

        // Crear Barra de Men√∫
        const menuBar = document.createElement('div'); menuBar.classList.add('menu-bar');
        const bubbleButton = document.createElement('button'); bubbleButton.classList.add('menu-icon', 'bubble-icon'); bubbleButton.innerHTML = '‚óè'; bubbleButton.setAttribute('draggable', 'true'); bubbleButton.id = `bubble-${noteId}`; bubbleButton.title = "Arrastrar al calendario"; bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';
        bubbleButton.addEventListener('dragstart', (e) => { /* ... */ var imgGhost = new Image(); imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; e.dataTransfer.setDragImage(imgGhost, 0, 0); e.dataTransfer.setData("application/note-id", noteId); e.dataTransfer.effectAllowed = "move"; openCalendar(); });
        bubbleButton.addEventListener('click', (e) => { e.stopPropagation(); openCalendar(); });
        const menuActions = document.createElement('div'); menuActions.classList.add('menu-actions');
        const editButton = document.createElement('button'); editButton.classList.add('menu-icon'); editButton.innerHTML = '‚úé'; editButton.title = "Editar";
        const deleteButton = document.createElement('button'); deleteButton.classList.add('menu-icon'); deleteButton.innerHTML = '‚úñ'; deleteButton.title = "Eliminar";
        // Asignar handlers despu√©s para asegurar que 'card' y otros elementos est√©n definidos
        editButton.onclick = (e) => { e.stopPropagation(); if (typeof iniciarEdicionNota === 'function') { iniciarEdicionNota(card, noteId, notaData, menuActions, editButton, deleteButton); } else { console.error("iniciarEdicionNota no definida."); } };
        deleteButton.onclick = (e) => { e.stopPropagation(); if (confirm(`¬øEliminar esta nota?`)) { if (typeof eliminarNota === 'function') { eliminarNota(noteId, gridItem); } else { console.error("eliminarNota no definida."); alert("Error interno."); } } };
        menuActions.appendChild(editButton); menuActions.appendChild(deleteButton); menuBar.appendChild(bubbleButton); menuBar.appendChild(menuActions); card.appendChild(menuBar);

        // Ensamblar
        content.appendChild(card);
        gridItem.appendChild(content);

        // Posici√≥n GridStack
        const position = {
            x: typeof notaData.x === 'number' ? notaData.x : undefined,
            y: typeof notaData.y === 'number' ? notaData.y : undefined,
            w: notaData.w || 6, // Ancho por defecto (6 de 24 columnas = 1/4)
            // h: notaData.h || 4, // Podr√≠amos definir una altura m√≠nima si cellHeight=150 no es suficiente
            id: noteId,
            autoPosition: (notaData.x === undefined || notaData.y === undefined)
        };

        gridItem.docData = notaData; // Guardar datos para referencia

        console.log(`   -> Widget preparado para ${noteId} con posici√≥n:`, position);
        return { element: gridItem, position: position };
    }

    function iniciarEdicionNota(cardElement, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
        // ... (L√≥gica interna sin cambios significativos, pero asegurando que db existe al guardar) ...
        let targetElement = cardElement.querySelector('.note-content'); const isImageNote = !!notaData.url; if (isImageNote && !targetElement) { targetElement = document.createElement('div'); targetElement.classList.add('note-content'); cardElement.insertBefore(targetElement, cardElement.querySelector('.menu-bar')); } else if (!targetElement) { console.error("Error: No .note-content para editar:", noteId); alert("Error al editar."); return; } const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || ''); targetElement.innerHTML = ''; const editInput = document.createElement('textarea'); editInput.value = currentText; editInput.style.cssText = `width: 100%; min-height: 80px; height: auto; box-sizing: border-box; border: 1px dashed #ccc; padding: 8px; resize: vertical; font-family: inherit; font-size: inherit; line-height: inherit;`; targetElement.appendChild(editInput); autoResizeTextarea(editInput); editInput.addEventListener('input', () => autoResizeTextarea(editInput)); editInput.focus(); const saveEditButton = document.createElement('button'); saveEditButton.classList.add('menu-icon'); saveEditButton.innerHTML = 'üíæ'; saveEditButton.title = "Guardar"; saveEditButton.onclick = (e) => { e.stopPropagation(); const newText = editInput.value.trim(); const updateData = isImageNote ? { texto: newText || firebase.firestore.FieldValue.delete() } : { nota: newText }; if (!isImageNote && !newText) { alert("Nota vac√≠a."); editInput.focus(); return; } saveEditButton.disabled = true; saveEditButton.innerHTML = '‚è≥'; if (!db) { console.error("DB no disponible al guardar."); alert("Error conexi√≥n."); saveEditButton.disabled = false; saveEditButton.innerHTML = 'üíæ'; return; } db.collection('notas').doc(noteId).update(updateData).then(() => { console.log(`Nota ${noteId} actualizada.`); /* Listener se encarga de UI */ }).catch((error) => { console.error('Error al actualizar:', error); alert("Error al guardar."); targetElement.innerHTML = linkify(currentText); menuActionsContainer.innerHTML = ''; menuActionsContainer.appendChild(editButton); menuActionsContainer.appendChild(deleteButton); }); }; const cancelEditButton = document.createElement('button'); cancelEditButton.classList.add('menu-icon'); cancelEditButton.innerHTML = '‚Ü©Ô∏è'; cancelEditButton.title = "Cancelar"; cancelEditButton.onclick = (e) => { e.stopPropagation(); targetElement.innerHTML = linkify(currentText); menuActionsContainer.innerHTML = ''; menuActionsContainer.appendChild(editButton); menuActionsContainer.appendChild(deleteButton); }; menuActionsContainer.innerHTML = ''; menuActionsContainer.appendChild(saveEditButton); menuActionsContainer.appendChild(cancelEditButton);
    }

    function eliminarNota(noteId, gridItemElement) {
        // ... (L√≥gica interna sin cambios significativos, pero asegurando que db existe) ...
        console.log("Intentando eliminar:", noteId); const deleteButton = gridItemElement?.querySelector('.menu-icon[title="Eliminar"]'); if (deleteButton) deleteButton.disabled = true; if (!db) { console.error("DB no disponible al eliminar."); alert("Error conexi√≥n."); if (deleteButton) deleteButton.disabled = false; return; } db.collection('notas').doc(noteId).delete().then(() => { console.log(`Nota ${noteId} eliminada Firestore.`); document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove()); if (notesDataCache[noteId]?.assignedDate) { delete notesDataCache[noteId]; fetchAllAssignedNotes().then(() => { if (currentCalendarMonth !== undefined) generateCalendar(currentCalendarMonth, currentCalendarYear); }); } else { delete notesDataCache[noteId]; } }).catch((error) => { console.error("Error al eliminar Firestore:", error); alert("Error al eliminar."); if (deleteButton) deleteButton.disabled = false; });
    }


    /**************************************************************************
     * Escucha de Cambios en Firestore
     **************************************************************************/
    let notesDataCache = {}; // Cach√© de datos de notas

    if (db && typeof db.collection === 'function' && grid) {
        const notesCollection = db.collection('notas');
        console.log("Adjuntando listener a Firestore...");

        notesCollection.orderBy('createdAt', 'desc') // Ordenar puede ayudar a la consistencia inicial
          .onSnapshot((snapshot) => {
            console.log(`Firestore snapshot recibido. Cambios: ${snapshot.docChanges().length}, Documentos totales: ${snapshot.size}`);
            if (!grid) { console.error("GridStack no disponible en onSnapshot."); return; }

            let needsCalendarUpdate = false;

            snapshot.docChanges().forEach((change) => {
                const noteId = change.doc.id;
                const notaData = change.doc.data();
                const changeType = change.type;
                console.log(`  -> Procesando Cambio: ${changeType}, ID=${noteId}`);

                const widgetElement = grid.engine.nodes.find(n => n.id === noteId)?.el;

                try { // Envolver en try/catch para aislar errores por widget
                    switch (changeType) {
                        case "added":
                            if (!widgetElement) {
                                console.log(`    Intentando a√±adir widget ${noteId}`);
                                const result = crearWidgetNota(change.doc);
                                if (result) {
                                    // Doble check para evitar a√±adir si ya existe (por si acaso)
                                    if (!grid.engine.nodes.find(n => n.id === noteId)) {
                                        const addedNode = grid.addWidget(result.element, result.position);
                                        console.log(`    ‚úÖ Widget ${noteId} a√±adido a GridStack. Nodo:`, addedNode);
                                        notesDataCache[noteId] = notaData;
                                        if (notaData.assignedDate) needsCalendarUpdate = true;
                                    } else { console.warn(`    Widget ${noteId} ya exist√≠a (added). Ignorando.`); }
                                } else { console.warn(`    Widget ${noteId} no se pudo crear (datos inv√°lidos?).`); }
                            } else {
                                 console.log(`    Widget ${noteId} ya exist√≠a (added). Verificando/Actualizando.`);
                                 updateWidgetContentAndPosition(widgetElement, notaData, noteId, widgetElement.docData || {});
                                 if (!notesDataCache[noteId]) notesDataCache[noteId] = notaData;
                                 if (notaData.assignedDate && !widgetElement.docData?.assignedDate) needsCalendarUpdate = true;
                                 widgetElement.docData = notaData; // Actualizar datos cacheados
                            }
                            break;
                        case "modified":
                            if (widgetElement) {
                                console.log(`    Modificando widget ${noteId}`);
                                const oldData = widgetElement.docData || notesDataCache[noteId] || {};
                                updateWidgetContentAndPosition(widgetElement, notaData, noteId, oldData);
                                if (notaData.assignedDate !== oldData.assignedDate) needsCalendarUpdate = true;
                                notesDataCache[noteId] = notaData;
                                widgetElement.docData = notaData;
                            } else {
                                console.warn(`    'modified' para ${noteId} no encontrado. Intentando a√±adir...`);
                                const result = crearWidgetNota(change.doc);
                                if (result) {
                                    if (!grid.engine.nodes.find(n => n.id === noteId)) {
                                        grid.addWidget(result.element, result.position);
                                        console.log(`    ‚úÖ Widget ${noteId} (modificado) a√±adido.`);
                                        notesDataCache[noteId] = notaData;
                                        if (notaData.assignedDate) needsCalendarUpdate = true;
                                    } else { console.warn(`    Widget ${noteId} ya exist√≠a (modified). Ignorando.`); }
                                }
                            }
                            break;
                        case "removed":
                            if (widgetElement) {
                                console.log(`    Eliminando widget ${noteId}`);
                                try {
                                    grid.removeWidget(widgetElement, false); // false: no disparar evento 'change'
                                    console.log(`    ‚úÖ Widget ${noteId} eliminado de GridStack.`);
                                    if (notesDataCache[noteId]?.assignedDate) needsCalendarUpdate = true;
                                    delete notesDataCache[noteId];
                                    document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
                                } catch (removeError) {
                                    console.warn(`    ‚ö†Ô∏è Error leve al eliminar ${noteId} de GridStack (puede ser normal):`, removeError);
                                    delete notesDataCache[noteId]; // Asegurar limpieza cach√©
                                }
                            } else {
                                console.log(`    Widget ${noteId} (eliminado) no encontrado.`);
                                delete notesDataCache[noteId];
                            }
                            break;
                    } // Fin switch
                } catch (widgetError) {
                     console.error(`‚ùå Error procesando ${changeType} para widget ${noteId}:`, widgetError);
                     // Continuar con el siguiente cambio
                }
            }); // Fin forEach

            // Actualizar calendario si es necesario
            if (needsCalendarUpdate && currentCalendarMonth !== undefined) {
                console.log("Actualizando calendario...");
                fetchAllAssignedNotes().then(() => {
                    generateCalendar(currentCalendarMonth, currentCalendarYear);
                });
            } else if (needsCalendarUpdate) {
                 fetchAllAssignedNotes(); // Actualizar cach√© aunque no est√© visible
            }
            console.log("Procesamiento de snapshot completado.");

          }, (error) => {
            console.error("Error en listener de Firestore:", error);
            alert("Error al sincronizar notas. Revisa la consola (F12) y las reglas de Firestore.");
          });
    } else {
        console.error("Listener de Firestore NO SE ADJUNTAR√Å (DB o GridStack fallaron). Las notas no se cargar√°n ni actualizar√°n.");
        if (!db) alert("Error cr√≠tico: No hay conexi√≥n a la base de datos.");
        if (!grid) alert("Error cr√≠tico: El layout de notas no funciona.");
    }

    /** Actualiza contenido, posici√≥n y burbuja de un widget */
    function updateWidgetContentAndPosition(widgetElement, newData, noteId, oldData) {
        // ... (L√≥gica interna sin cambios significativos) ...
        const noteContentElement = widgetElement.querySelector('.note-content'); const isImageNote = !!newData.url; const newText = isImageNote ? (newData.texto || '') : (newData.nota || ''); const oldText = isImageNote ? (oldData.texto || '') : (oldData.nota || ''); if (noteContentElement && newText !== oldText && !noteContentElement.querySelector('textarea')) { console.log(`      - Actualizando texto ${noteId}`); noteContentElement.innerHTML = linkify(newText); Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => { link.setAttribute('target', '_blank'); link.setAttribute('rel', 'noopener noreferrer'); }); } else if (!noteContentElement && newData.texto && isImageNote) { console.log(`      - A√±adiendo texto a imagen ${noteId}`); const newNoteContentElement = document.createElement('div'); newNoteContentElement.classList.add('note-content'); newNoteContentElement.innerHTML = linkify(newData.texto); widgetElement.querySelector('.card-wrapper').insertBefore(newNoteContentElement, widgetElement.querySelector('.menu-bar')); Array.from(newNoteContentElement.getElementsByTagName('a')).forEach(link => { link.setAttribute('target', '_blank'); link.setAttribute('rel', 'noopener noreferrer'); }); } else if (noteContentElement && !newData.texto && isImageNote && oldData.texto) { console.log(`      - Eliminando texto de imagen ${noteId}`); noteContentElement.remove(); } if (isImageNote && newData.url !== oldData.url) { console.log(`      - Actualizando URL imagen ${noteId}`); const img = widgetElement.querySelector('.image-container img'); if (img) img.src = newData.url; } const currentNode = grid.engine.nodes.find(n => n.id === noteId); if (currentNode) { const positionChangedInFirestore = (typeof newData.x === 'number' && newData.x !== oldData.x) || (typeof newData.y === 'number' && newData.y !== oldData.y); const positionNeedsUpdateLocally = (typeof newData.x === 'number' && newData.x !== currentNode.x) || (typeof newData.y === 'number' && newData.y !== currentNode.y); if (positionChangedInFirestore && positionNeedsUpdateLocally) { console.log(`      - Actualizando posici√≥n ${noteId} desde Firestore`); try { grid.update(widgetElement, { x: newData.x, y: newData.y }); } catch (updateError) { console.error(`      - Error al actualizar pos ${noteId}:`, updateError); } } else if (positionChangedInFirestore) { console.log(`      - Posici√≥n ${noteId} coincide localmente.`); } } const bubbleButton = widgetElement.querySelector(`#bubble-${noteId}`); if (bubbleButton) { const shouldDisplayBubble = !newData.assignedDate; const isCurrentlyDisplayed = bubbleButton.style.display !== 'none'; if (shouldDisplayBubble && !isCurrentlyDisplayed) { console.log(`      - Mostrando burbuja ${noteId}`); bubbleButton.style.display = 'inline-block'; } else if (!shouldDisplayBubble && isCurrentlyDisplayed) { console.log(`      - Ocultando burbuja ${noteId}`); bubbleButton.style.display = 'none'; } } const saveButton = widgetElement.querySelector('.menu-icon[title="Guardar cambios"]'); if (saveButton) { console.log(`      - Cancelando edici√≥n ${noteId}`); const menuActionsContainer = widgetElement.querySelector('.menu-actions'); if (menuActionsContainer) { menuActionsContainer.innerHTML = ''; const cardElement = widgetElement.querySelector('.card-wrapper') || widgetElement.querySelector('.text-card'); const recreatedEditButton = document.createElement('button'); recreatedEditButton.classList.add('menu-icon'); recreatedEditButton.innerHTML = '‚úé'; recreatedEditButton.title = "Editar"; const recreatedDeleteButton = document.createElement('button'); recreatedDeleteButton.classList.add('menu-icon'); recreatedDeleteButton.innerHTML = '‚úñ'; recreatedDeleteButton.title = "Eliminar"; recreatedEditButton.onclick = (e) => { e.stopPropagation(); iniciarEdicionNota(cardElement, noteId, newData, menuActionsContainer, recreatedEditButton, recreatedDeleteButton); }; recreatedDeleteButton.onclick = (e) => { e.stopPropagation(); if (confirm(`¬øSeguro...?`)) { eliminarNota(noteId, widgetElement); } }; menuActionsContainer.appendChild(recreatedEditButton); menuActionsContainer.appendChild(recreatedDeleteButton); } if(noteContentElement) noteContentElement.innerHTML = linkify(newText); }
    }

    /**************************************************************************
     * Manejo UI para Agregar Notas
     **************************************************************************/
    const addNoteButtonElem = document.getElementById('addNoteButton');
    const addNoteOptionsElem = document.getElementById('addNoteOptions');
    const addImageLinkOptionElem = document.getElementById('addImageLinkOption');
    const addTextNoteOptionElem = document.getElementById('addTextNoteOption');
    const inputAreaElem = document.getElementById('inputArea');
    const imageLinkInputAreaElem = document.getElementById('imageLinkInputArea');
    const imageLinkInputElem = document.getElementById('imageLink');
    // imageNoteTextElem ya definido
    const saveImageLinkButtonElem = document.getElementById('saveImageLink');
    const textNoteInputAreaElem = document.getElementById('textNoteInputArea');
    // textNoteInputElem ya definido
    const saveTextNoteButtonElem = document.getElementById('saveTextNote');
    const blurBackgroundElem = document.querySelector('.blur-background');

    function hideMenusAndResetForms() {
        // ... (sin cambios) ...
        if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if (inputAreaElem) inputAreaElem.style.display = 'none'; if (blurBackgroundElem) blurBackgroundElem.style.display = 'none'; if (imageLinkInputElem) imageLinkInputElem.value = ''; if (imageNoteTextElem) { imageNoteTextElem.value = ''; autoResizeTextarea(imageNoteTextElem); } if (textNoteInputElem) { textNoteInputElem.value = ''; autoResizeTextarea(textNoteInputElem); } if (saveImageLinkButtonElem) { saveImageLinkButtonElem.disabled = false; saveImageLinkButtonElem.textContent = 'Guardar Imagen'; } if (saveTextNoteButtonElem) { saveTextNoteButtonElem.disabled = false; saveTextNoteButtonElem.textContent = 'Guardar Nota'; }
    }
    function showBlurBackground() { if (blurBackgroundElem) blurBackgroundElem.style.display = 'block'; }

    // Listeners botones principales
    if (addNoteButtonElem) { addNoteButtonElem.onclick = (e) => { e.stopPropagation(); if (addNoteOptionsElem && addNoteOptionsElem.style.display === 'flex') { hideMenusAndResetForms(); } else if (addNoteOptionsElem) { hideMenusAndResetForms(); addNoteOptionsElem.style.display = 'flex'; showBlurBackground(); } }; }
    if (addImageLinkOptionElem) { addImageLinkOptionElem.onclick = (e) => { e.stopPropagation(); if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if(imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'block'; if(textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'none'; if(inputAreaElem) inputAreaElem.style.display = 'flex'; showBlurBackground(); if(imageLinkInputElem) imageLinkInputElem.focus(); }; }
    if (addTextNoteOptionElem) { addTextNoteOptionElem.onclick = (e) => { e.stopPropagation(); if(addNoteOptionsElem) addNoteOptionsElem.style.display = 'none'; if(imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'none'; if(textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'block'; if(inputAreaElem) inputAreaElem.style.display = 'flex'; showBlurBackground(); if(textNoteInputElem) textNoteInputElem.focus(); }; }
    if (blurBackgroundElem) { blurBackgroundElem.onclick = hideMenusAndResetForms; }

    // Funciones Guardar (con verificaci√≥n de 'db')
    function guardarLinkDeImagen() {
        if (!imageLinkInputElem || !saveImageLinkButtonElem) return;
        if (!db) { alert("Error: No hay conexi√≥n a la base de datos."); return; } // Verificar DB

        let link = imageLinkInputElem.value.trim();
        const texto = imageNoteTextElem ? imageNoteTextElem.value.trim() : '';

        if (link && (link.startsWith('http://') || link.startsWith('https://'))) {
            saveImageLinkButtonElem.disabled = true; saveImageLinkButtonElem.textContent = 'Guardando...';
            db.collection('notas').add({ url: link, texto: texto || null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tipo: 'imagen' })
            .then((docRef) => { console.log("Imagen guardada:", docRef.id); hideMenusAndResetForms(); })
            .catch((error) => { console.error('Error guardando imagen:', error); alert("Error al guardar. Verifica el link y tu conexi√≥n."); })
            .finally(() => { /* Resetear bot√≥n en hideMenus... */ });
        } else { alert("Introduce un link de imagen v√°lido (http:// o https://)."); imageLinkInputElem.focus(); }
    }
    function guardarNotaTexto() {
        if (!textNoteInputElem || !saveTextNoteButtonElem) return;
        if (!db) { alert("Error: No hay conexi√≥n a la base de datos."); return; } // Verificar DB

        const nota = textNoteInputElem.value.trim();
        if (nota) {
            saveTextNoteButtonElem.disabled = true; saveTextNoteButtonElem.textContent = 'Guardando...';
            db.collection('notas').add({ nota: nota, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tipo: 'texto' })
            .then((docRef) => { console.log("Nota guardada:", docRef.id); hideMenusAndResetForms(); })
            .catch((error) => { console.error('Error guardando nota:', error); alert("Error al guardar la nota. Verifica tu conexi√≥n."); })
            .finally(() => { /* Resetear bot√≥n en hideMenus... */ });
        } else { alert("Escribe algo en la nota."); textNoteInputElem.focus(); }
    }
    if(saveImageLinkButtonElem) saveImageLinkButtonElem.onclick = guardarLinkDeImagen;
    if(saveTextNoteButtonElem) saveTextNoteButtonElem.onclick = guardarNotaTexto;

    /**************************************************************************
     * Calendario y Asignaci√≥n
     **************************************************************************/
    // ... (Sin cambios en l√≥gica de calendario: getChileDate, initCalendarDate, getMonthName, fetchAllAssignedNotes, generateCalendar, show/hide/openCalendar, listeners) ...
    let currentCalendarMonth, currentCalendarYear; let assignedDatesCache = {};
    const calendarIconElem = document.getElementById('calendarIcon'); const calendarWidgetElem = document.getElementById('calendarWidget'); let calendarTimeout;
    function getChileDate() { try { const opts = { timeZone: 'America/Santiago', year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false }; const fmt = new Intl.DateTimeFormat('en-CA', opts); const parts = fmt.formatToParts(new Date()); const d = {}; parts.forEach(({ type, value }) => { if (['year', 'month', 'day', 'hour', 'minute', 'second'].includes(type)) { d[type] = parseInt(value, 10); } }); return new Date(Date.UTC(d.year, d.month - 1, d.day, d.hour, d.minute, d.second)); } catch (e) { console.warn("Intl fallback", e); return new Date(); } } function initCalendarDate() { let today = getChileDate(); let year = today.getFullYear(); let month = today.getMonth(); const minY = 2024; const minM = 11; if (year < minY || (year === minY && month < minM)) { return { month: minM, year: minY }; } return { month, year }; } function getMonthName(idx) { const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; return months[idx % 12] || ''; }
    async function fetchAllAssignedNotes() { console.log("Fetching assigned notes..."); assignedDatesCache = {}; if (!db) { console.error("DB no disponible fetchAllAssignedNotes."); return; } try { const snapshot = await db.collection('notas').where('assignedDate', '!=', null).get(); console.log(`Found ${snapshot.docs.length} assigned notes.`); snapshot.forEach(doc => { const noteId = doc.id; const notaData = doc.data(); notesDataCache[noteId] = notaData; const dateStr = notaData.assignedDate; if (dateStr) { if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = []; if (!assignedDatesCache[dateStr].includes(noteId)) assignedDatesCache[dateStr].push(noteId); } }); console.log("Assigned notes cache updated."); } catch (err) { console.error("Error fetching assigned notes:", err); } }
    async function generateCalendar(month, year) { const assignedNotesExist = Object.values(notesDataCache).some(note => note.assignedDate); if (Object.keys(assignedDatesCache).length === 0 && assignedNotesExist) { console.log("Recargando cach√© asignadas para calendario..."); await fetchAllAssignedNotes(); } if (!calendarWidgetElem) { console.error("calendarWidget no encontrado."); return; } calendarWidgetElem.innerHTML = ''; const today = getChileDate(); const header = document.createElement('div'); header.className = 'calendar-header'; const prevButton = document.createElement('button'); prevButton.innerHTML = '&lt;'; prevButton.title = "Mes anterior"; const nextButton = document.createElement('button'); nextButton.innerHTML = '&gt;'; nextButton.title = "Mes siguiente"; const title = document.createElement('span'); title.textContent = `${getMonthName(month)} ${year}`; const minCalYear = 2024; const minCalMonth = 11; if (year === minCalYear && month === minCalMonth) { prevButton.disabled = true; } else { prevButton.onclick = () => { generateCalendar(month === 0 ? 11 : month - 1, month === 0 ? year - 1 : year); }; } nextButton.onclick = () => { generateCalendar(month === 11 ? 0 : month + 1, month === 11 ? year + 1 : year); }; header.appendChild(prevButton); header.appendChild(title); header.appendChild(nextButton); calendarWidgetElem.appendChild(header); const daysHeader = document.createElement('div'); daysHeader.className = 'calendar-days-header'; ['Do','Lu','Ma','Mi','Ju','Vi','S√°'].forEach(day => { const d = document.createElement('div'); d.className = 'calendar-day'; d.textContent = day; daysHeader.appendChild(d); }); calendarWidgetElem.appendChild(daysHeader); const datesGrid = document.createElement('div'); datesGrid.className = 'calendar-dates-grid'; const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); for (let i = 0; i < firstDayOfMonth; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesGrid.appendChild(e); } for (let date = 1; date <= daysInMonth; date++) { const dateCell = document.createElement('div'); dateCell.className = 'calendar-date'; dateCell.textContent = date; const dateString = `${date}/${month + 1}/${year}`; if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) { dateCell.classList.add('today'); } if (assignedDatesCache[dateString]) { assignedDatesCache[dateString].forEach(noteId => { const bubble = document.createElement("span"); bubble.className = "assigned-bubble"; bubble.setAttribute("data-note", noteId); bubble.textContent = "‚óè"; const noteInfo = notesDataCache[noteId]; if(noteInfo) { bubble.title = noteInfo.url ? (noteInfo.texto || 'Imagen') : (noteInfo.nota || 'Nota'); } dateCell.appendChild(bubble); }); } dateCell.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; dateCell.classList.add('drag-over'); }); dateCell.addEventListener('dragleave', (e) => { dateCell.classList.remove('drag-over'); }); dateCell.addEventListener('drop', async (e) => { e.preventDefault(); dateCell.classList.remove('drag-over'); const noteId = e.dataTransfer.getData("application/note-id"); if (noteId && db) { console.log(`Nota ${noteId} drop en ${dateString}`); const oldDateStr = notesDataCache[noteId]?.assignedDate; try { await db.collection('notas').doc(noteId).update({ assignedDate: dateString }); console.log(`Nota ${noteId} actualizada fecha.`); if (notesDataCache[noteId]) { notesDataCache[noteId].assignedDate = dateString; } else { notesDataCache[noteId] = { assignedDate: dateString }; } if (oldDateStr && assignedDatesCache[oldDateStr]) { assignedDatesCache[oldDateStr] = assignedDatesCache[oldDateStr].filter(id => id !== noteId); if (assignedDatesCache[oldDateStr].length === 0) delete assignedDatesCache[oldDateStr]; } if (!assignedDatesCache[dateString]) assignedDatesCache[dateString] = []; if (!assignedDatesCache[dateString].includes(noteId)) assignedDatesCache[dateString].push(noteId); const bubbleInCard = document.getElementById(`bubble-${noteId}`); if (bubbleInCard) bubbleInCard.style.display = 'none'; generateCalendar(currentCalendarMonth, currentCalendarYear); } catch (err) { console.error(`Error asignando fecha ${noteId}:`, err); alert("Error asignando fecha."); } } }); datesGrid.appendChild(dateCell); } const totalCells = firstDayOfMonth + daysInMonth; const cellsNeeded = totalCells <= 35 ? 35 : 42; for (let i = totalCells; i < cellsNeeded; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesGrid.appendChild(e); } calendarWidgetElem.appendChild(datesGrid); currentCalendarMonth = month; currentCalendarYear = year; }
    function showCalendar() { if (!calendarWidgetElem) return; clearTimeout(calendarTimeout); if (calendarWidgetElem.style.display !== 'block') { if (currentCalendarMonth === undefined || currentCalendarYear === undefined) { const { month, year } = initCalendarDate(); generateCalendar(month, year); } else { fetchAllAssignedNotes().then(() => { generateCalendar(currentCalendarMonth, currentCalendarYear); }); } calendarWidgetElem.style.display = 'block'; } } function hideCalendar() { if (!calendarWidgetElem) return; calendarTimeout = setTimeout(() => { calendarWidgetElem.style.display = 'none'; }, 300); } if (calendarIconElem) { calendarIconElem.addEventListener('mouseenter', showCalendar); calendarIconElem.addEventListener('mouseleave', hideCalendar); calendarIconElem.addEventListener('click', showCalendar); } if (calendarWidgetElem) { calendarWidgetElem.addEventListener('mouseenter', () => clearTimeout(calendarTimeout)); calendarWidgetElem.addEventListener('mouseleave', hideCalendar); } function openCalendar() { showCalendar(); }
    if(db) { fetchAllAssignedNotes(); } // Cargar fechas asignadas al inicio si DB est√° lista

  </script>
</body>
</html>
