"use client"

import { useEffect, useRef, useState } from "react"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import { Trash, Pencil } from "lucide-react"
import { motion } from "framer-motion"

interface Note {
  id: string
  content: string
  x: number
  y: number
}

export default function StickyNotes() {
  const [notes, setNotes] = useState<Note[]>([])
  const [editingNoteId, setEditingNoteId] = useState<string | null>(null)
  const containerRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    const savedNotes = localStorage.getItem("sticky-notes")
    if (savedNotes) {
      setNotes(JSON.parse(savedNotes))
    }
  }, [])

  const saveNotes = () => {
    localStorage.setItem("sticky-notes", JSON.stringify(notes))
  }

  const createNote = () => {
    const newNote: Note = {
      id: Date.now().toString(),
      content: "",
      x: 50,
      y: 50,
    }
    const updatedNotes = [...notes, newNote]
    setNotes(updatedNotes)
    saveNotes()
    setEditingNoteId(newNote.id)
  }

  const updateNote = (id: string, content: string) => {
    const updatedNotes = notes.map((note) =>
      note.id === id ? { ...note, content } : note
    )
    setNotes(updatedNotes)
  }

  const deleteNote = (id: string) => {
    const updatedNotes = notes.filter((note) => note.id !== id)
    setNotes(updatedNotes)
    saveNotes()
  }

  const handleDragEnd = (id: string, x: number, y: number) => {
    const updatedNotes = notes.map((note) =>
      note.id === id ? { ...note, x, y } : note
    )
    setNotes(updatedNotes)
    saveNotes()
  }

  return (
    <div className="relative w-full h-[100vh] bg-neutral-100" ref={containerRef}>
      <Button
        onClick={createNote}
        className="absolute top-4 left-4 z-10"
      >
        Crear nota
      </Button>

      {notes.map((note) => (
        <motion.div
          key={note.id}
          drag
          dragConstraints={containerRef}
          onDragEnd={(_, info) =>
            handleDragEnd(note.id, info.point.x, info.point.y)
          }
          initial={{ x: note.x, y: note.y }}
          animate={{ x: note.x, y: note.y }}
          className="absolute"
        >
          <div className="bg-yellow-100 rounded-xl p-4 w-[200px] h-[200px] flex flex-col justify-between">
            <Textarea
              value={note.content}
              onChange={(e) => updateNote(note.id, e.target.value)}
              onBlur={saveNotes}
              className="bg-yellow-100 resize-none border-none shadow-none focus-visible:ring-0 focus-visible:ring-offset-0 p-0"
            />
            <div className="flex justify-end gap-2 mt-2">
              <Button
                size="sm"
                variant="ghost"
                onClick={() => deleteNote(note.id)}
              >
                <Trash className="h-4 w-4 text-red-500" />
              </Button>
              <Button
                size="sm"
                variant="ghost"
                onClick={() => setEditingNoteId(note.id)}
              >
                <Pencil className="h-4 w-4 text-blue-500" />
              </Button>
            </div>
          </div>
        </motion.div>
      ))}
    </div>
  )
}
