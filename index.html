<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notas Oce√°nicas - Polaroid</title>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>
  <style>
    /* Estilos CSS */
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(to bottom, #a2dff7 0%, #a2dff7 40%, #03254c 100%);
      font-family: Arial, sans-serif;
    }

    .container {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    #notaDisplay {
      flex-grow: 1;
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      min-width: 1000px;
    }

    .grid-stack-placeholder {
      display: none !important;
    }

    .grid-stack-item {
      transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      overflow: visible !important;
      margin-bottom: 1cm; /* Espacio adicional debajo de cada nota */
    }

    .grid-stack-item-content {
      overflow: visible !important;
      height: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .card-wrapper,
    .text-card {
      background-color: #fff;
      border: 2px solid #0077a3;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 240px;
      display: flex;
      flex-direction: column;
      position: relative;
      height: auto;
      box-sizing: border-box;
    }

    .image-container {
      width: 100%;
      height: 240px;
      overflow: hidden;
      position: relative;
      flex-shrink: 0;
    }

    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .note-content {
      background-color: #fff;
      padding: 10px;
      text-align: left;
      font-size: 16px;
      color: #333;
      min-height: 50px;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow: hidden;
      flex-grow: 1;
    }

    .note-content a {
      color: #0077a3;
      text-decoration: underline;
    }

    .menu-bar {
      background-color: #0288D1;
      padding: 5px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      border-top: 1px solid #0077a3;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
    }

    .menu-icon {
      background: none;
      border: none;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      padding: 2px 4px;
    }

    .bubble-icon {
      color: #FFCD05;
      font-size: 22px;
    }

    .menu-actions {
      display: flex;
      gap: 4px;
    }

    #addNoteButton {
      position: absolute;
      bottom: 30px;
      right: 30px;
      background-color: #006994;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, transform 0.3s ease;
      z-index: 1001;
    }

    #addNoteButton:hover {
      background-color: #005577;
      transform: scale(1.05);
    }

    #addNoteOptions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.85);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 25px;
      padding: 25px;
      z-index: 1002;
    }

    #addNoteOptions .card {
      background-color: #2c2c2c;
      border: 1px solid #0077a3;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 180px;
    }

    #addNoteOptions .card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 119, 163, 0.5);
    }

    #addNoteOptions .card h2 {
      color: #36a2eb;
      margin-bottom: 10px;
    }

    #addNoteOptions .card p {
      color: #ccc;
      font-size: 14px;
    }

    #inputArea {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ffffff;
      padding: 25px 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      gap: 15px;
      width: 90%;
      max-width: 550px;
      z-index: 1002;
    }

    #inputArea label {
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
      font-size: 14px;
    }

    #inputArea textarea,
    #inputArea input[type="text"] {
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      width: 100%;
      box-sizing: border-box;
      line-height: 1.5;
      font-size: 16px;
    }

    #inputArea textarea {
      min-height: 80px;
    }

    #inputArea textarea#textNote {
      min-height: 120px;
    }

    #inputArea button {
      padding: 10px 20px;
      background-color: #006994;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      align-self: flex-end;
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
    }

    #inputArea button:hover {
      background-color: #005577;
    }

    #inputArea button:active {
      transform: scale(0.98);
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      width: 100%;
    }

    .calendar-icon {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 45px;
      height: 45px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .calendar-widget {
      position: absolute;
      bottom: 85px;
      left: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      padding: 15px;
      display: none;
      z-index: 1001;
      width: 320px;
      min-height: 300px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .calendar-header button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #0077a3;
      padding: 5px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    .calendar-header button:hover:not(:disabled) {
      background-color: #e0f7fa;
    }

    .calendar-header button:disabled {
      color: #ccc;
      cursor: default;
    }

    .calendar-header span {
      font-weight: bold;
      color: #333;
      font-size: 18px;
    }

    .calendar-days-header,
    .calendar-dates-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 6px;
    }

    .calendar-days-header {
      margin-bottom: 10px;
      font-weight: bold;
      color: #555;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }

    .calendar-day {
      padding: 3px;
    }

    .calendar-date {
      padding: 0;
      border-radius: 50%;
      color: #333;
      border: 2px solid transparent;
      cursor: pointer;
      position: relative;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      line-height: 1;
      font-size: 14px;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    .calendar-date.empty {
      background: none;
      cursor: default;
      opacity: 0;
    }

    .calendar-date:not(.empty):hover {
      background-color: #e0f7fa;
      border-color: #b3e5fc;
    }

    .calendar-date.today {
      border-color: #0077a3;
      font-weight: bold;
      color: #005577;
    }

    .calendar-date.drag-over {
      background-color: #a2dff7 !important;
      border-color: #0077a3 !important;
    }

    .assigned-bubble {
      color: #FFCD05;
      font-size: 11px;
      position: absolute;
      bottom: 3px;
      left: 50%;
      transform: translateX(-50%);
      line-height: 1;
      text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    .calendar-date .assigned-bubble+.assigned-bubble {
      bottom: -2px;
    }

    .blur-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      z-index: 1000;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="notaDisplay" class="grid-stack"></div>
    <button id="addNoteButton" title="A√±adir nueva nota o imagen">+</button>
    <div id="addNoteOptions">
      <div class="card" id="addImageLinkOption" title="A√±adir una nota con imagen desde un enlace web">
        <h2>üñºÔ∏è Imagen</h2>
        <p>Guardar link de imagen.</p>
      </div>
      <div class="card" id="addTextNoteOption" title="A√±adir una nota de texto simple">
        <h2>üìù Nota</h2>
        <p>Subir nota de texto.</p>
      </div>
    </div>
    <div id="inputArea">
      <div id="imageLinkInputArea" style="display: none;">
        <div class="input-group">
          <label for="imageLink">Link de la imagen:</label>
          <input type="text" id="imageLink" placeholder="Pega aqu√≠ la URL de la imagen (ej: https://...)" />
        </div>
        <div class="input-group">
          <label for="imageNoteText">Texto adicional (opcional):</label>
          <textarea id="imageNoteText" placeholder="Escribe aqu√≠ una descripci√≥n o nota relacionada con la imagen..." rows="3"></textarea>
        </div>
        <button id="saveImageLink">Guardar Imagen</button>
      </div>
      <div id="textNoteInputArea" style="display: none;">
        <div class="input-group">
          <label for="textNote">Nota:</label>
          <textarea id="textNote" placeholder="Escribe tu nota aqu√≠..." rows="5"></textarea>
        </div>
        <button id="saveTextNote">Guardar Nota</button>
      </div>
    </div>
    <div id="calendarIcon" class="calendar-icon" title="Mostrar/Ocultar Calendario">üìÖ</div>
    <div id="calendarWidget" class="calendar-widget"></div>
    <div class="blur-background"></div>
  </div>
  <script>
    /****************** Utilidades y Configuraci√≥n de Firebase ******************/
    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(?<!href=["'])(https?:\/\/[^\s<>"']+)/g;
      const replacedText = text.replace(urlRegex, '<a href="\$1" target="_blank" rel="noopener noreferrer">\$1</a>');
      return replacedText.replace(/\n/g, '<br>');
    }
    const firebaseConfig = {
      apiKey: "AIzaSyCHa373WgLLHsy8wZXK9zr_HVieQvlrhUs",
      authDomain: "oasis-b036d.firebaseapp.com",
      projectId: "oasis-b036d",
      storageBucket: "oasis-b036d.appspot.com",
      messagingSenderId: "141546637821",
      appId: "1:141546637821:web:0a861aeb13831774ed3194",
      measurementId: "G-HB2P17H5YL"
    };
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) {
      console.error("Error inicializando Firebase:", e);
    }
    const db = firebase.firestore();
    /****************** Inicializaci√≥n de GridStack ******************/
    let grid;
    try {
      grid = GridStack.init({
        column: 12, // Permitir movimiento horizontal
        margin: 10, // Margen entre elementos
        cellHeight: '80px', // Altura de cada celda
        disableResize: true, // Deshabilitar redimensionamiento
        float: true,
        animate: true,
        alwaysShowResizeHandle: false,
        draggable: {
          handle: '.menu-bar',
          scroll: true,
          appendTo: 'body'
        }
      });
    } catch (e) {
      console.error("Error inicializando GridStack:", e);
      alert("Error al iniciar el √°rea de notas.");
    }
    /****************** Escucha de Cambios en GridStack (Drag/Drop) ******************/
    if (grid) { // Aseg√∫rate que grid se inicializ√≥ bien
      // Listener para el evento 'change' (cuando algo cambia en el grid, INCLUYENDO drag/drop)
      grid.on('change', function (event, items) {
        console.log("Evento 'change' de GridStack disparado.");
        items.forEach(function (item) {
          // Intentamos obtener el ID de la nota del atributo data-note-id
          const noteId = item.el?.getAttribute('data-note-id') || item.id || '(desconocido)';
          console.log(` - Nota ID: ${noteId}, Posici√≥n final seg√∫n GridStack: x=${item.x}, y=${item.y}, w=${item.w}, h=${item.h}`);
          // IMPORTANTE: Aqu√≠ es donde deber√≠amos guardar la posici√≥n final en Firestore
          // si GridStack es quien decide la posici√≥n final despu√©s de un drag/drop.
          const noteIdToSave = item.el?.getAttribute('data-note-id');
          // Guardamos si tenemos datos v√°lidos. Podr√≠amos necesitar m√°s l√≥gica para evitar guardar
          // en cambios que no son de drag/drop si eso causa problemas.
          if (noteIdToSave && typeof item.x === 'number' && typeof item.y === 'number') {
            console.log(`¬† ¬†(Considerando guardar x:${item.x}, y:${item.y} para ${noteIdToSave} en Firestore desde 'change')`);
            // DESCOMENTA la l√≠nea de abajo para activar el guardado autom√°tico desde aqu√≠ (QUITANDO // ):
            db.collection('notas').doc(noteIdToSave).update({
              x: item.x,
              y: item.y
            }).catch(err => console.error(`Error guardando posici√≥n desde 'change': ${err}`));
          }
        });
      });
      // Listener para 'dragstop' (solo para ver d√≥nde se suelta inicialmente)
      grid.on('dragstop', function (event, element) {
        const node = grid.engine.nodes.find(n => n.el === element); //
        if (node) {
          const noteId = node.el?.getAttribute('data-note-id') || node.id || '(desconocido)';
          console.log(`Evento 'dragstop': Nota ID: ${noteId} soltada en x=${node.x}, y=${node.y}`);
        }
      });
      // L√≠nea de verificaci√≥n para saber si estos listeners se a√±adieron
      console.log(">>> LISTENER ATTACHED TO GRID <<<");
    } // Fin del if (grid)
    /****************** Utilidades UI (Scroll, Resize Textarea) ******************/
    const gridContainer = document.getElementById('notaDisplay');
    if (gridContainer) gridContainer.addEventListener('wheel', (event) => {}, { passive: true });
    function autoResizeTextarea(el) { if (!el) return; el.style.height = 'auto'; el.style.height = (el.scrollHeight + 2) + 'px'; }
    const textNoteInputElem = document.getElementById('textNote');
    const imageNoteTextElem = document.getElementById('imageNoteText');
    if (textNoteInputElem) textNoteInputElem.addEventListener('input', () => autoResizeTextarea(textNoteInputElem));
    if (imageNoteTextElem) imageNoteTextElem.addEventListener('input', () => autoResizeTextarea(imageNoteTextElem));
    /****************** Renderizaci√≥n, Edici√≥n y Eliminaci√≥n de Notas ******************/
    const displayedNotes = new Map();
    // --- FUNCI√ìN PARA MOSTRAR NOTA ---
    function mostrarNotaEnPantalla(doc) {
      const notaData = doc.data();
      const noteId = doc.id;
      let gridItem = document.createElement('div');
      gridItem.classList.add('grid-stack-item');
      gridItem.setAttribute('data-note-id', noteId);
      const content = document.createElement('div');
      content.classList.add('grid-stack-item-content');
      let card;
      let noteContentElement;
      if (notaData.url) { // Tarjeta Imagen
        card = document.createElement('div');
        card.classList.add('card-wrapper');
        const imageContainer = document.createElement('div');
        imageContainer.classList.add('image-container');
        const img = document.createElement('img');
        img.src = notaData.url;
        img.alt = notaData.texto || 'Imagen de la nota';
        img.loading = 'lazy';
        img.onerror = () => { imageContainer.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; background-color:#eee; color:red; text-align:center; padding:10px;">‚ö†Ô∏è<br/>Error al<br/>cargar imagen</div>`; }
        imageContainer.appendChild(img);
        card.appendChild(imageContainer);
        if (notaData.texto) {
          noteContentElement = document.createElement('div');
          noteContentElement.classList.add('note-content');
          noteContentElement.innerHTML = linkify(notaData.texto);
          card.appendChild(noteContentElement);
        }
      } else if (notaData.nota) { // Tarjeta Texto
        card = document.createElement('div');
        card.classList.add('text-card');
        noteContentElement = document.createElement('div');
        noteContentElement.classList.add('note-content');
        noteContentElement.innerHTML = linkify(notaData.nota);
        card.appendChild(noteContentElement);
      } else {
        return null;
      } // Nota vac√≠a
      if (noteContentElement) {
        Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        });
      }
      // Barra de Men√∫
      const menuBar = document.createElement('div');
      menuBar.classList.add('menu-bar');
      const bubbleButton = document.createElement('button');
      bubbleButton.classList.add('menu-icon', 'bubble-icon');
      bubbleButton.innerHTML = '‚óè';
      bubbleButton.setAttribute('draggable', 'true');
      bubbleButton.id = `bubble-${noteId}`;
      bubbleButton.title = "Arrastrar al calendario";
      bubbleButton.style.display = notaData.assignedDate ? 'none' : 'inline-block';
      bubbleButton.addEventListener('dragstart', (e) => {
        var imgGhost = new Image();
        imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
        e.dataTransfer.setDragImage(imgGhost, 0, 0);
        e.dataTransfer.setData("application/note-id", noteId);
        e.dataTransfer.effectAllowed = "move";
        openCalendar();
      });
      bubbleButton.addEventListener('click', (e) => {
        e.stopPropagation();
        openCalendar();
      });
      const menuActions = document.createElement('div');
      menuActions.classList.add('menu-actions');
      const editButton = document.createElement('button');
      editButton.classList.add('menu-icon');
      editButton.innerHTML = '‚úé';
      editButton.title = "Editar";
      const deleteButton = document.createElement('button');
      deleteButton.classList.add('menu-icon');
      deleteButton.innerHTML = '‚úñ';
      deleteButton.title = "Eliminar";
      // onclick de deleteButton (SIN confirmaci√≥n)
      deleteButton.onclick = (e) => {
        e.stopPropagation();
        if (typeof deleteNote === 'function') deleteNote(noteId, gridItem);
        else {
          console.error("Funci√≥n deleteNote no encontrada");
          alert("Error interno al eliminar.");
        }
      };
      editButton.onclick = (e) => {
        e.stopPropagation();
        if (typeof editNoteContent === 'function') editNoteContent(card, noteId, notaData, menuActions, editButton, deleteButton);
        else console.error("Funci√≥n editNoteContent no encontrada");
      };
      menuActions.appendChild(editButton);
      menuActions.appendChild(deleteButton);
      menuBar.appendChild(bubbleButton);
      menuBar.appendChild(menuActions);
      card.appendChild(menuBar);
      content.appendChild(card);
      gridItem.appendChild(content);
      // Posici√≥n Gridstack
      const pos = {
        x: notaData.x,
        y: notaData.y,
        w: notaData.w || 2,
        id: noteId,
        autoPosition: (notaData.x === undefined || notaData.y === undefined)
      };
      gridItem.docData = notaData; // Guardar datos para referencia
      return {
        element: gridItem,
        position: pos
      };
    }
    // --- FUNCI√ìN PARA EDITAR NOTA ---
    function editNoteContent(card, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
      let targetElement = card.querySelector('.note-content');
      if (!targetElement && notaData.url) { // Solo crear si es nota de imagen sin texto previo
        targetElement = document.createElement('div');
        targetElement.classList.add('note-content');
        card.insertBefore(targetElement, card.querySelector('.menu-bar'));
      } else if (!targetElement && !notaData.url) { // Si es nota de texto, deber√≠a existir; si no, hay error
        console.error("Error: No se encontr√≥ .note-content para editar texto en nota:", noteId);
        return;
      }
      const isImageNote = !!notaData.url;
      const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');
      targetElement.innerHTML = '';
      const editInput = document.createElement('textarea');
      editInput.value = currentText;
      editInput.style.cssText = "width:100%; min-height:80px; height:auto; box-sizing:border-box; border:1px dashed #ccc; resize:vertical;";
      targetElement.appendChild(editInput);
      autoResizeTextarea(editInput);
      editInput.addEventListener('input', () => autoResizeTextarea(editInput));
      editInput.focus();
      const saveEditButton = document.createElement('button');
      saveEditButton.classList.add('menu-icon');
      saveEditButton.innerHTML = 'üíæ';
      saveEditButton.title = "Guardar";
      saveEditButton.onclick = (e) => {
        e.stopPropagation();
        const newText = editInput.value.trim();
        const updateData = isImageNote ? {
          texto: newText || null
        } : {
          nota: newText
        };
        saveEditButton.disabled = true;
        saveEditButton.innerHTML = '‚è≥';
        db.collection('notas').doc(noteId).update(updateData)
          .then(() => {
            menuActionsContainer.replaceChild(editButton, saveEditButton);
            menuActionsContainer.appendChild(deleteButton);
          }) // Restaurar botones originales
          .catch((error) => {
            console.error('Error al actualizar:', error);
            alert("Error al guardar.");
            saveEditButton.disabled = false;
            saveEditButton.innerHTML = 'üíæ';
            menuActionsContainer.replaceChild(editButton, saveEditButton);
            menuActionsContainer.appendChild(deleteButton);
          }); // Restaurar botones en error
      };
      menuActionsContainer.innerHTML = '';
      menuActionsContainer.appendChild(saveEditButton); // Mostrar solo guardar
    }
    // --- FUNCI√ìN PARA ELIMINAR NOTA ---
    function deleteNote(noteId, gridItem) {
      console.log("Eliminando nota:", noteId);
      db.collection('notas').doc(noteId).delete()
        .then(() => {
          console.log(`Nota ${noteId} eliminada de Firestore.`);
          displayedNotes.delete(noteId);
          document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove()); // Quitar del calendario
        })
        .catch((error) => {
          console.error("Error al eliminar:", error);
          alert("Error al eliminar la nota.");
        });
    }
    /****************** Escucha de Cambios en Firestore (SIMPLIFICADA) ******************/
    if (db && typeof db.collection === 'function') {
      db.collection('notas')
        .onSnapshot((snapshot) => {
          if (!grid) {
            console.error("GridStack no inicializado.");
            return;
          }
          let needsCalendarUpdate = false; // Bandera para saber si refrescar calendario
          // Procesamos SOLO los cambios detectados por Firestore
          snapshot.docChanges().forEach((change) => {
            const noteId = change.doc.id;
            const notaData = change.doc.data();
            console.log(`Cambio detectado: Tipo=${change.type}, ID=${noteId}`); // Log para depurar
            if (change.type === "added") {
              // Se a√±adi√≥ una nueva nota a Firestore
              // Verificamos si ya existe en el grid (por si acaso, ej: carga inicial)
              const existingElement = grid.engine.nodes.find(n => n.id === noteId)?.el; // Busca por ID de gridstack
              // O alternativamente: document.querySelector(`.grid-stack-item[data-note-id="${noteId}"]`);
              if (!existingElement) {
                console.log(`A√±adiendo widget para ${noteId}`);
                const result = mostrarNotaEnPantalla(change.doc);
                if (result) {
                  // A√±adimos el nuevo widget al grid
                  grid.addWidget(result.element, result.position);
                  if (notaData.assignedDate) needsCalendarUpdate = true; // Marcar si afecta calendario
                }
              } else {
                console.log(`Widget para ${noteId} ya exist√≠a, no se a√±ade de nuevo.`);
                // Podr√≠amos querer actualizar su contenido/posici√≥n si los datos son diferentes
                // (C√≥digo de 'modified' podr√≠a ir aqu√≠ tambi√©n para la carga inicial)
              }
            } else if (change.type === "modified") {
              // Una nota existente cambi√≥ (contenido, posici√≥n, fecha asignada)
              console.log(`Modificando widget para ${noteId}`);
              const widgetElement = grid.engine.nodes.find(n => n.id === noteId)?.el; // Busca por ID de gridstack
              // O alternativamente: document.querySelector(`.grid-stack-item[data-note-id="${noteId}"]`);
              if (widgetElement) {
                const oldData = widgetElement.docData || {}; // Usamos los datos guardados en el elemento si existen
                // 1. Actualizar Contenido (Texto/Imagen) si cambi√≥
                const noteContentElement = widgetElement.querySelector('.note-content');
                const newText = notaData.url ? (notaData.texto || '') : (notaData.nota || '');
                const oldText = notaData.url ? (oldData.texto || '') : (oldData.nota || '');
                if (noteContentElement && newText !== oldText) {
                  console.log(` - Actualizando contenido de texto para ${noteId}`);
                  noteContentElement.innerHTML = linkify(newText);
                  // Re-aplicar target blank a los links si es necesario
                  Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');
                  });
                }
                // Si es imagen y la URL cambi√≥ (menos com√∫n)
                if (notaData.url && notaData.url !== oldData.url) {
                  console.log(` - Actualizando URL de imagen para ${noteId}`);
                  const img = widgetElement.querySelector('.image-container img');
                  if (img) img.src = notaData.url;
                }
                // 2. Actualizar Posici√≥n si cambi√≥ (y si no es la que estamos arrastrando nosotros mismos)
                // (Puede ser complejo evitar actualizar si el cambio de X,Y fue por el drag local)
                // Por ahora, actualizamos si Firestore dice que cambi√≥:
                if ((typeof notaData.x === 'number' && notaData.x !== oldData.x) || (typeof notaData.y === 'number' && notaData.y !== oldData.y)) {
                  // Solo si la posici√≥n en Firestore es diferente a la actual en GridStack
                  const currentNode = grid.engine.nodes.find(n => n.id === noteId);
                  if (currentNode && (currentNode.x !== notaData.x || currentNode.y !== notaData.y)) {
                    console.log(` - Actualizando posici√≥n para ${noteId} a (${notaData.x}, ${notaData.y})`);
                    //grid.update(widgetElement, {
                     //x: notaData.x,
                      //y: notaData.y
                     //});
                  }
                }
                // 3. Actualizar estado de la burbuja del calendario
                const bubbleButton = widgetElement.querySelector(`#bubble-${noteId}`);
                const needsBubble = !notaData.assignedDate; // Se muestra si NO tiene fecha
                if (bubbleButton) {
                  const shouldDisplayBubble = bubbleButton.style.display !== 'none';
                  if (needsBubble && !shouldDisplayBubble) {
                    console.log(` - Mostrando burbuja para ${noteId}`);
                    bubbleButton.style.display = 'inline-block';
                  } else if (!needsBubble && shouldDisplayBubble) {
                    console.log(` - Ocultando burbuja para ${noteId}`);
                    bubbleButton.style.display = 'none';
                  }
                }
                // Marcar si afecta calendario
                if (notaData.assignedDate !== oldData.assignedDate) {
                  needsCalendarUpdate = true;
                }
                // Actualizar los datos cacheados en el elemento
                widgetElement.docData = notaData;
                // Actualizar cach√© global para el calendario
                notesDataCache[noteId] = notaData;
              } else {
                console.warn(`Se recibi√≥ 'modified' para ${noteId}, pero no se encontr√≥ el widget en el grid.`);
                // Podr√≠a ser una nota que se modific√≥ y elimin√≥ r√°pidamente.
              }
            } else if (change.type === "removed") {
              // Una nota fue eliminada de Firestore
              console.log(`Eliminando widget para ${noteId}`);
              const widgetElement = grid.engine.nodes.find(n => n.id === noteId)?.el;
              // O alternativamente: document.querySelector(`.grid-stack-item[data-note-id="${noteId}"]`);
              if (widgetElement) {
                // Eliminamos el widget del grid
                grid.removeWidget(widgetElement); // El tercer par√°metro `false` evita que se guarde la eliminaci√≥n (ya viene de Firestore)
                if (notesDataCache[noteId]?.assignedDate) needsCalendarUpdate = true; // Marcar si afecta calendario
                delete notesDataCache[noteId]; // Limpiar cach√©
                // Podr√≠amos necesitar limpiar `assignedDatesCache` tambi√©n, pero fetchAll lo har√°
              } else {
                console.warn(`Se recibi√≥ 'removed' para ${noteId}, pero no se encontr√≥ el widget.`);
              }
            }
          }); // Fin del forEach(change)
          // Actualiza el calendario SI alg√∫n cambio lo requiri√≥
          if (needsCalendarUpdate && currentCalendarMonth !== undefined) {
            console.log("Actualizando calendario debido a cambios...");
            // Usamos fetchAllAssignedNotes para asegurar que la cach√© est√© actualizada
            fetchAllAssignedNotes().then(() => {
              generateCalendar(currentCalendarMonth, currentCalendarYear);
              // Podr√≠as querer quitar tambi√©n las burbujas del DOM manualmente si es necesario
              // document.querySelectorAll(`.assigned-bubble[data-note='${noteId_eliminado}']`).forEach(b => b.remove());
            });
          } else if (needsCalendarUpdate) {
            // Si el calendario no se ha mostrado nunca, solo actualizamos la cach√©
            fetchAllAssignedNotes();
          }
        }, (error) => {
          console.error("Error Firestore:", error);
          alert("Error al cargar notas.");
        });
    } else {
      console.error("Firestore (db) no inicializado.");
      alert("Error: No se pudo conectar a la base de datos.");
    }
    /****************** Manejo de la Interfaz para Agregar Notas ******************/
    const addNoteButtonElem = document.getElementById('addNoteButton');
    const addNoteOptionsElem = document.getElementById('addNoteOptions');
    const addImageLinkOptionElem = document.getElementById('addImageLinkOption');
    const addTextNoteOptionElem = document.getElementById('addTextNoteOption');
    const inputAreaElem = document.getElementById('inputArea');
    const imageLinkInputAreaElem = document.getElementById('imageLinkInputArea');
    const imageLinkInputElem = document.getElementById('imageLink');
    const saveImageLinkButtonElem = document.getElementById('saveImageLink');
    const textNoteInputAreaElem = document.getElementById('textNoteInputArea');
    const saveTextNoteButtonElem = document.getElementById('saveTextNote');
    const blurBackgroundElem = document.querySelector('.blur-background');
    function hideMenus() {
      if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
      if (inputAreaElem) inputAreaElem.style.display = 'none';
      if (blurBackgroundElem) blurBackgroundElem.style.display = 'none';
      if (imageLinkInputElem) imageLinkInputElem.value = '';
      if (imageNoteTextElem) {
        imageNoteTextElem.value = '';
        autoResizeTextarea(imageNoteTextElem);
      }
      if (textNoteInputElem) {
        textNoteInputElem.value = '';
        autoResizeTextarea(textNoteInputElem);
      }
    }
    if (addNoteButtonElem) addNoteButtonElem.onclick = (e) => {
      e.stopPropagation();
      if (addNoteOptionsElem && addNoteOptionsElem.style.display === 'flex') {
        hideMenus();
      } else if (addNoteOptionsElem && blurBackgroundElem) {
        hideMenus();
        addNoteOptionsElem.style.display = 'flex';
        blurBackgroundElem.style.display = 'block';
      }
    };
    if (addImageLinkOptionElem) addImageLinkOptionElem.onclick = (e) => {
      e.stopPropagation();
      if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
      if (imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'block';
      if (textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'none';
      if (inputAreaElem) inputAreaElem.style.display = 'flex';
      if (blurBackgroundElem) blurBackgroundElem.style.display = 'block';
      if (imageLinkInputElem) imageLinkInputElem.focus();
    };
    if (addTextNoteOptionElem) addTextNoteOptionElem.onclick = (e) => {
      e.stopPropagation();
      if (addNoteOptionsElem) addNoteOptionsElem.style.display = 'none';
      if (imageLinkInputAreaElem) imageLinkInputAreaElem.style.display = 'none';
      if (textNoteInputAreaElem) textNoteInputAreaElem.style.display = 'block';
      if (inputAreaElem) inputAreaElem.style.display = 'flex';
      if (blurBackgroundElem) blurBackgroundElem.style.display = 'block';
      if (textNoteInputElem) textNoteInputElem.focus();
    };
    if (blurBackgroundElem) blurBackgroundElem.onclick = hideMenus;
    function guardarLinkDeImagen() {
      if (!imageLinkInputElem) return;
      let link = imageLinkInputElem.value.trim();
      const texto = imageNoteTextElem ? imageNoteTextElem.value.trim() : '';
      if (link) {
        if (saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = true;
        db.collection('notas').add({
          url: link,
          texto: texto || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tipo: 'imagen'
        })
        .then(() => {
          hideMenus();
        }).catch((error) => {
          console.error('Error al guardar link:', error);
          alert("Error al guardar imagen.");
        })
        .finally(() => {
          if (saveImageLinkButtonElem) saveImageLinkButtonElem.disabled = false;
        });
      } else {
        alert("Introduce un link v√°lido.");
        imageLinkInputElem.focus();
      }
    }
    function guardarNotaTexto() {
      if (!textNoteInputElem) return;
      const nota = textNoteInputElem.value.trim();
      if (nota) {
        if (saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = true;
        db.collection('notas').add({
          nota: nota,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tipo: 'texto'
        })
        .then(() => {
          hideMenus();
        }).catch((error) => {
          console.error('Error al guardar nota:', error);
          alert("Error al guardar nota.");
        })
        .finally(() => {
          if (saveTextNoteButtonElem) saveTextNoteButtonElem.disabled = false;
        });
      } else {
        alert("Escribe algo en la nota.");
      
