<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notas Oce√°nicas - Polaroid v3</title>

    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/gridstack@8.3.0/dist/gridstack-all.js"></script>

    <style>
        /* --- Estilos Generales --- */
        :root {
            --primary-color: #006994;
            --primary-light: #0077a3;
            --primary-dark: #005577;
            --secondary-color: #a2dff7;
            --accent-color: #FFB300; /* Naranja/Amarillo para burbujas */
            --bg-gradient-start: #a2dff7;
            --bg-gradient-end: #03254c;
            --card-bg: #ffffff;
            --card-border: #ddd;
            --text-color: #333;
            --menu-bg: #f0f0f0;
            --menu-icon-color: #555;
            --error-color: #c0392b;
            --error-bg: #f9eaea;
        }

        html, body {
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background: linear-gradient(to bottom, var(--bg-gradient-start) 0%, var(--bg-gradient-start) 40%, var(--bg-gradient-end) 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 16px;
            color: var(--text-color);
        }

        .container {
            height: 100%; width: 100%; padding: 1.5rem; /* Usar rem */
            box-sizing: border-box; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        /* --- GridStack y Notas --- */
        #notesGrid { /* Cambiado ID para claridad */
            flex-grow: 1; width: 100%; overflow-y: auto; overflow-x: hidden;
            position: relative;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px; /* Peque√±o padding interno */
            box-sizing: border-box;
        }
        .grid-stack { /* Estilo base para el contenedor de GridStack */
             background: transparent; /* El fondo est√° en #notesGrid */
             padding-bottom: 1px; /* Evitar espacio extra */
        }
        .grid-stack-placeholder { display: none !important; }

        .grid-stack-item {
            transition: transform 0.3s ease-out;
            overflow: visible !important; /* Necesario para sombras y a veces para drag handle */
        }

        .grid-stack-item-content {
            overflow: hidden; /* Contener todo dentro */
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--card-border);
            box-sizing: border-box;
            position: relative; /* Para posicionar elementos internos si es necesario */
        }

        /* Estructura interna de la tarjeta */
        .note-card {
            display: flex; flex-direction: column;
            height: 100%; width: 100%;
        }

        .note-image-container {
            width: 100%;
            height: 180px; /* Altura fija para la imagen */
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            border-top-left-radius: 8px; border-top-right-radius: 8px;
            background-color: #eee; /* Fondo mientras carga */
            display: flex; align-items: center; justify-content: center;
        }
        .note-image-container img {
            width: 100%; height: 100%; object-fit: cover; display: block;
        }
        .note-image-error {
            padding: 10px; text-align: center; font-size: 0.8rem; color: var(--error-color);
            font-weight: normal; width: 100%; height: 100%; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            background-color: var(--error-bg);
        }
        .note-image-error span { font-size: 1.5rem; margin-bottom: 5px; }

        .note-text-content {
            padding: 12px;
            font-size: 0.9rem; color: var(--text-color);
            min-height: 40px;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-y: auto; /* Scroll si el texto es muy largo */
            flex-grow: 1; /* Ocupa espacio vertical restante */
            line-height: 1.5;
        }
        .note-text-content a { color: var(--primary-light); text-decoration: underline; }
        .note-text-content a:hover { color: var(--primary-dark); }

        /* Men√∫ inferior de la tarjeta */
        .note-menu-bar {
            background-color: var(--menu-bg);
            padding: 5px 10px;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
            border-top: 1px solid var(--card-border);
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
        }
        .note-menu-icon {
            background: none; border: none; font-size: 1.1rem; color: var(--menu-icon-color);
            cursor: pointer; padding: 4px 6px; border-radius: 4px;
            transition: background-color 0.2s ease, color 0.2s ease;
            line-height: 1; /* Alinear iconos verticalmente */
        }
        .note-menu-icon:hover:not(:disabled) { background-color: #e0e0e0; color: #000; }
        .note-menu-icon:disabled { color: #ccc; cursor: not-allowed; }
        .note-bubble-icon { color: var(--accent-color); font-size: 1.2rem; }
        .note-bubble-icon:hover:not(:disabled) { color: #e69900; } /* Naranja m√°s oscuro */
        .note-menu-actions { display: flex; gap: 5px; }

        /* --- Bot√≥n Flotante (+) --- */
        #addNoteFab { /* Cambiado ID */
            position: absolute; bottom: 30px; right: 30px;
            background-color: var(--primary-color); color: white;
            border: none; border-radius: 50%; width: 60px; height: 60px;
            font-size: 2rem; display: flex; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 1001;
        }
        #addNoteFab:hover { background-color: var(--primary-dark); transform: scale(1.05); }
        #addNoteFab:active { transform: scale(0.95); }

        /* --- Modales --- */
        .modal-overlay { /* Fondo borroso */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            display: none; /* Oculto por defecto */
            z-index: 1000; cursor: pointer;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { display: block; opacity: 1; }

        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: var(--card-bg); border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 1002; padding: 25px 30px; box-sizing: border-box;
            display: none; /* Oculto por defecto */
            opacity: 0; transform: translate(-50%, -45%) scale(0.95); /* Animaci√≥n entrada */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal.visible { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* Modal de Opciones */
        #addNoteOptionsModal {
            display: none; /* Se controla visibilidad con JS */
            flex-direction: row; justify-content: center; align-items: center; gap: 25px;
            background-color: #333; /* Fondo oscuro para este modal */
            padding: 35px 40px;
        }
        #addNoteOptionsModal .option-card {
            background-color: #444; border: 1px solid var(--primary-light);
            border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 160px; color: #eee;
        }
        #addNoteOptionsModal .option-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 6px 12px rgba(0, 119, 163, 0.4); }
        #addNoteOptionsModal .option-card h3 { color: var(--secondary-color); margin-top: 0; margin-bottom: 10px; font-size: 1.1rem; }
        #addNoteOptionsModal .option-card p { color: #ccc; font-size: 0.85rem; }

        /* Modal de Input */
        #noteInputModal {
            display: none; /* Se controla visibilidad con JS */
            flex-direction: column; gap: 15px;
            width: 90%; max-width: 550px;
        }
        #noteInputModal h2 { margin-top: 0; color: var(--primary-color); text-align: center; }
        .input-group { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        #noteInputModal label { font-weight: bold; color: #555; margin-bottom: 3px; font-size: 0.9rem; }
        #noteInputModal textarea, #noteInputModal input[type="text"] {
            padding: 10px 12px; border: 1px solid #ccc; border-radius: 5px;
            resize: vertical; width: 100%; box-sizing: border-box;
            line-height: 1.5; font-size: 1rem; background-color: #fdfdfd;
        }
        #noteInputModal textarea:focus, #noteInputModal input[type="text"]:focus {
            border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(0, 119, 163, 0.15);
            outline: none;
        }
        #noteInputModal textarea { min-height: 80px; }
        #noteInputModal textarea#textNoteInput { min-height: 120px; } /* Espec√≠fico para nota de texto */
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .modal-button {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
            font-size: 0.95rem; font-weight: bold; transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .modal-button.primary { background-color: var(--primary-color); color: white; }
        .modal-button.primary:hover { background-color: var(--primary-dark); }
        .modal-button.secondary { background-color: #ccc; color: #333; }
        .modal-button.secondary:hover { background-color: #bbb; }
        .modal-button:active { transform: scale(0.97); }
        .modal-button:disabled { background-color: #e0e0e0; color: #aaa; cursor: not-allowed; }

        /* --- Calendario --- */
        .calendar-icon-container { /* Contenedor para posicionar icono y widget */
            position: absolute; bottom: 30px; left: 30px; z-index: 1001;
        }
        #calendarIcon {
            width: 45px; height: 45px; background-color: white; border: 1px solid #ccc;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #333; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); transition: transform 0.2s ease;
        }
        #calendarIcon:hover { transform: scale(1.1); }

        #calendarWidget {
            position: absolute; bottom: 60px; /* Encima del icono */ left: 0;
            background: white; border: 1px solid #ddd; border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); padding: 15px;
            display: none; /* Controlado por JS */ width: 320px; min-height: 300px;
            opacity: 0; transform: translateY(10px); /* Animaci√≥n entrada */
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
         #calendarWidget.visible { display: block; opacity: 1; transform: translateY(0); }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-header button { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--primary-light); padding: 5px 8px; border-radius: 4px; transition: background-color 0.2s ease; }
        .calendar-header button:hover:not(:disabled) { background-color: #e0f7fa; } .calendar-header button:disabled { color: #ccc; cursor: default; }
        .calendar-header span { font-weight: bold; color: #333; font-size: 1.1rem; }
        .calendar-days-header, .calendar-dates-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 5px; }
        .calendar-days-header { margin-bottom: 10px; font-weight: bold; color: #555; padding-bottom: 8px; border-bottom: 1px solid #eee; font-size: 0.8rem; }
        .calendar-day { padding: 3px; }
        .calendar-date {
            padding: 0; border-radius: 50%; color: #333; border: 2px solid transparent;
            cursor: pointer; position: relative; width: 34px; height: 34px; /* Ligeramente m√°s peque√±o */
            display: flex; align-items: center; justify-content: center; margin: 0 auto;
            line-height: 1; font-size: 0.85rem; transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .calendar-date.empty { background: none; cursor: default; opacity: 0; }
        .calendar-date:not(.empty):hover { background-color: #e0f7fa; border-color: #b3e5fc; }
        .calendar-date.today { border-color: var(--primary-light); font-weight: bold; color: var(--primary-dark); }
        .calendar-date.drag-over { background-color: var(--secondary-color) !important; border-color: var(--primary-light) !important; transform: scale(1.1); }
        .assigned-bubble {
            color: var(--accent-color); font-size: 0.7rem; position: absolute; bottom: 2px;
            left: 50%; transform: translateX(-50%); line-height: 1;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.4); pointer-events: none;
        }
        .calendar-date .assigned-bubble + .assigned-bubble { bottom: -3px; } /* Ajuste para segunda burbuja */

    </style>
</head>
<body>
    <div class="container">

        <div id="notesGrid" class="grid-stack"></div>

        <button id="addNoteFab" title="A√±adir nueva nota">+</button>

        <div class="calendar-icon-container">
             <div id="calendarIcon" title="Mostrar/Ocultar Calendario">üìÖ</div>
             <div id="calendarWidget">
                 </div>
        </div>

    </div><div id="modalOverlay" class="modal-overlay"></div>

    <div id="addNoteOptionsModal" class="modal">
        <div class="option-card" data-type="image">
            <h3>üñºÔ∏è Imagen</h3>
            <p>Guardar desde enlace web.</p>
        </div>
        <div class="option-card" data-type="text">
            <h3>üìù Nota</h3>
            <p>Escribir texto.</p>
        </div>
    </div>

    <div id="noteInputModal" class="modal">
        <h2 id="noteInputTitle">A√±adir Nota</h2>
        <div id="imageInputArea" style="display: none;">
            <div class="input-group">
                <label for="imageLinkInput">Link de la imagen:</label>
                <input type="text" id="imageLinkInput" placeholder="Pega URL (https://...)" />
            </div>
            <div class="input-group">
                <label for="imageNoteTextInput">Texto adicional (opcional):</label>
                <textarea id="imageNoteTextInput" placeholder="Descripci√≥n..." rows="3"></textarea>
            </div>
        </div>
        <div id="textInputArea" style="display: none;">
            <div class="input-group">
                <label for="textNoteInput">Nota:</label>
                <textarea id="textNoteInput" placeholder="Escribe tu nota aqu√≠..." rows="5"></textarea>
            </div>
        </div>
        <div class="modal-actions">
            <button id="cancelInputButton" class="modal-button secondary">Cancelar</button>
            <button id="saveNoteButton" class="modal-button primary">Guardar</button>
        </div>
    </div>


    <script>
        /**************************************************************************
         * CONFIGURACI√ìN Y VARIABLES GLOBALES
         **************************************************************************/
        console.log("Inicializando script...");

        // --- Configuraci√≥n Firebase ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // <-- ¬°¬°¬° REEMPLAZA CON TU API KEY REAL !!!
            authDomain: "oasis-b036d.firebaseapp.com",
            projectId: "oasis-b036d",
            storageBucket: "oasis-b036d.appspot.com",
            messagingSenderId: "141546637821",
            appId: "1:141546637821:web:0a861aeb13831774ed3194",
            measurementId: "G-HB2P17H5YL"
        };

        // --- Instancias Globales ---
        let db;         // Instancia Firestore
        let grid;       // Instancia GridStack
        let notesDataCache = {}; // Cach√© local de datos de notas { noteId: data }
        let assignedDatesCache = {}; // Cach√© de fechas asignadas { "d/m/yyyy": [noteId1,...] }
        let currentCalendarMonth, currentCalendarYear; // Estado del calendario
        let currentNoteTypeToAdd = null; // 'text' o 'image'

        // --- Selectores DOM ---
        const notesGridElement = document.getElementById('notesGrid');
        const addNoteFabElement = document.getElementById('addNoteFab');
        const modalOverlayElement = document.getElementById('modalOverlay');
        const addNoteOptionsModalElement = document.getElementById('addNoteOptionsModal');
        const noteInputModalElement = document.getElementById('noteInputModal');
        const noteInputTitleElement = document.getElementById('noteInputTitle');
        const imageInputAreaElement = document.getElementById('imageInputArea');
        const textInputAreaElement = document.getElementById('textInputArea');
        const imageLinkInputElement = document.getElementById('imageLinkInput');
        const imageNoteTextInputElement = document.getElementById('imageNoteTextInput');
        const textNoteInputElement = document.getElementById('textNoteInput');
        const cancelInputButtonElement = document.getElementById('cancelInputButton');
        const saveNoteButtonElement = document.getElementById('saveNoteButton');
        const calendarIconElement = document.getElementById('calendarIcon');
        const calendarWidgetElement = document.getElementById('calendarWidget');

        /**************************************************************************
         * INICIALIZACI√ìN (Firebase, GridStack)
         **************************************************************************/

        /** Inicializa Firebase */
        function initializeFirebase() {
            console.log("Intentando inicializar Firebase...");
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("Firebase inicializado correctamente.");
                } else {
                    firebase.app(); // Obtener la app ya inicializada
                    console.log("Firebase ya estaba inicializado.");
                }
                db = firebase.firestore();
                console.log("Instancia de Firestore obtenida.");
                return true; // √âxito
            } catch (error) {
                console.error("Error CR√çTICO inicializando Firebase:", error);
                showErrorMessage("Error cr√≠tico al conectar con la base de datos. Revisa la configuraci√≥n y la consola (F12).");
                return false; // Fallo
            }
        }

        /** Inicializa GridStack */
        function initializeGridstack() {
            console.log("Intentando inicializar GridStack...");
            if (!notesGridElement || typeof GridStack === 'undefined') {
                console.error("Error: Contenedor #notesGrid o GridStack JS no encontrado.");
                showErrorMessage("Error cr√≠tico: No se puede inicializar el layout de notas.");
                return false; // Fallo
            }
            try {
                grid = GridStack.init({
                    column: 24,
                    margin: 10,
                    // Usar altura fija inicialmente para asegurar visibilidad
                    cellHeight: 150, // Puedes ajustar este valor
                    // cellHeight: 'auto', // Opci√≥n alternativa si ajustas bien el CSS
                    disableResize: true,
                    float: false,
                    animate: true,
                    draggable: { handle: '.note-menu-bar', scroll: true, appendTo: 'body' }
                });
                console.log("GridStack inicializado. cellHeight:", grid.opts.cellHeight);

                // --- Listeners de GridStack ---
                grid.on('change', handleGridChange);
                grid.on('dragstop', handleGridDragStop);
                console.log("Listeners de GridStack adjuntados.");
                return true; // √âxito
            } catch (error) {
                console.error("Error inicializando GridStack:", error);
                showErrorMessage("Error al iniciar el layout de notas. Revisa la consola (F12).");
                return false; // Fallo
            }
        }

        /**************************************************************************
         * MANEJO DE DATOS (Firestore)
         **************************************************************************/

        /** Guarda una nueva nota en Firestore */
        async function addNoteToFirestore(noteData) {
            if (!db) {
                showErrorMessage("Error: No hay conexi√≥n a la base de datos.");
                return null;
            }
            console.log("A√±adiendo nota a Firestore:", noteData);
            try {
                const docRef = await db.collection('notas').add({
                    ...noteData, // Incluye 'url', 'texto' o 'nota', y 'tipo'
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // Posici√≥n (x, y) se a√±adir√° despu√©s por el listener 'change' de GridStack
                });
                console.log("Nota a√±adida con ID:", docRef.id);
                return docRef.id; // Devuelve el ID de la nueva nota
            } catch (error) {
                console.error("Error a√±adiendo nota a Firestore:", error);
                showErrorMessage("Error al guardar la nota. Int√©ntalo de nuevo.");
                return null;
            }
        }

        /** Actualiza datos de una nota (ej. texto) */
        async function updateNoteInFirestore(noteId, updateData) {
            if (!db) { showErrorMessage("Error de conexi√≥n."); return false; }
            console.log(`Actualizando nota ${noteId} en Firestore:`, updateData);
            try {
                await db.collection('notas').doc(noteId).update(updateData);
                console.log(`Nota ${noteId} actualizada correctamente.`);
                return true;
            } catch (error) {
                console.error(`Error actualizando nota ${noteId}:`, error);
                showErrorMessage("Error al guardar los cambios.");
                return false;
            }
        }

        /** Actualiza la posici√≥n (x, y) de una nota */
        function updateNotePosition(noteId, x, y) {
            if (!db) return; // No mostrar error aqu√≠, es una operaci√≥n frecuente
            // Actualizaci√≥n "silenciosa" en segundo plano
            db.collection('notas').doc(noteId).update({ x, y })
                .then(() => console.log(`   - Posici√≥n guardada para ${noteId}: (${x},${y})`))
                .catch(err => console.error(`Error guardando posici√≥n para ${noteId}: ${err}`));
        }

        /** Elimina una nota de Firestore */
        async function deleteNoteFromFirestore(noteId) {
            if (!db) { showErrorMessage("Error de conexi√≥n."); return false; }
            console.log(`Intentando eliminar nota ${noteId} de Firestore...`);
            try {
                await db.collection('notas').doc(noteId).delete();
                console.log(`Nota ${noteId} eliminada de Firestore.`);
                return true;
            } catch (error) {
                console.error(`Error eliminando nota ${noteId}:`, error);
                showErrorMessage("Error al eliminar la nota.");
                return false;
            }
        }

        /** Carga todas las notas con fecha asignada */
        async function fetchAllAssignedNotes() {
            console.log("Fetching assigned notes...");
            assignedDatesCache = {}; // Resetear cach√© de fechas
            if (!db) { console.error("DB no disponible fetchAllAssignedNotes."); return; }
            try {
                const snapshot = await db.collection('notas').where('assignedDate', '!=', null).get();
                console.log(`Encontradas ${snapshot.docs.length} notas asignadas.`);
                snapshot.forEach(doc => {
                    const noteId = doc.id;
                    const notaData = doc.data();
                    // Actualizar cach√© general (no sobreescribir si ya existe)
                    if (!notesDataCache[noteId]) notesDataCache[noteId] = {};
                    Object.assign(notesDataCache[noteId], notaData); // Fusionar datos

                    const dateStr = notaData.assignedDate;
                    if (dateStr) {
                        if (!assignedDatesCache[dateStr]) assignedDatesCache[dateStr] = [];
                        if (!assignedDatesCache[dateStr].includes(noteId)) assignedDatesCache[dateStr].push(noteId);
                    }
                });
                console.log("Cach√© de notas asignadas actualizada.");
            } catch (err) { console.error("Error fetching assigned notes:", err); }
        }

        /** Asigna o desasigna una fecha a una nota */
        async function assignDateToNote(noteId, dateString) { // dateString puede ser null para desasignar
            if (!db) { showErrorMessage("Error de conexi√≥n."); return false; }
            console.log(`Asignando fecha ${dateString || 'null'} a nota ${noteId}`);
            try {
                await db.collection('notas').doc(noteId).update({
                    assignedDate: dateString || firebase.firestore.FieldValue.delete() // Eliminar campo si dateString es null
                });
                console.log(`Fecha actualizada para ${noteId}.`);
                return true;
            } catch (error) {
                console.error(`Error asignando fecha a ${noteId}:`, error);
                showErrorMessage("Error al asignar la fecha.");
                return false;
            }
        }


        /**************************************************************************
         * RENDERIZACI√ìN UI (Notas, Calendario)
         **************************************************************************/

        /** Crea el elemento HTML para una nota */
        function renderNoteCard(doc) {
            const noteData = doc.data();
            const noteId = doc.id;

            if (!noteData || (!noteData.url && !noteData.nota)) {
                console.warn(`Nota ${noteId} inv√°lida o sin contenido.`);
                return null; // No renderizar si no hay contenido √∫til
            }
            console.log(`Renderizando widget para ${noteId}`);

            // Contenedor principal del widget GridStack
            const gridItem = document.createElement('div');
            gridItem.className = 'grid-stack-item';
            gridItem.setAttribute('data-note-id', noteId);
            gridItem.setAttribute('gs-id', noteId); // ID para GridStack

            // Contenido interno (el que tiene el estilo y overflow:hidden)
            const gridContent = document.createElement('div');
            gridContent.className = 'grid-stack-item-content';

            // Div de la tarjeta (estructura interna)
            const card = document.createElement('div');
            card.className = 'note-card';

            let noteContentElement; // Para el texto

            // --- Contenido espec√≠fico (Imagen o Texto) ---
            if (noteData.url) { // Es una nota de imagen
                const imageContainer = document.createElement('div');
                imageContainer.className = 'note-image-container';
                const img = document.createElement('img');
                img.src = noteData.url;
                img.alt = noteData.texto || 'Imagen de nota';
                img.loading = 'lazy';
                img.onerror = function() { // Manejador de error
                    console.error(`Error cargando imagen: ${this.src} (Nota ID: ${noteId})`);
                    imageContainer.innerHTML = `
                        <div class="note-image-error">
                            <span>üñºÔ∏è</span>
                            No se pudo cargar la imagen.
                        </div>`;
                };
                imageContainer.appendChild(img);
                card.appendChild(imageContainer);

                // A√±adir texto si existe
                if (notaData.texto) {
                    noteContentElement = document.createElement('div');
                    noteContentElement.className = 'note-text-content';
                    noteContentElement.innerHTML = linkify(notaData.texto); // Convertir links y saltos de l√≠nea
                    card.appendChild(noteContentElement);
                }
            } else { // Es una nota de texto (notaData.nota debe existir)
                noteContentElement = document.createElement('div');
                noteContentElement.className = 'note-text-content';
                noteContentElement.innerHTML = linkify(notaData.nota);
                card.appendChild(noteContentElement);
            }

            // Asegurar que los links se abran en nueva pesta√±a
            if (noteContentElement) {
                Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                });
            }

            // --- Barra de Men√∫ ---
            const menuBar = document.createElement('div');
            menuBar.className = 'note-menu-bar'; // Usar como handle de drag

            const bubbleButton = document.createElement('button');
            bubbleButton.className = 'note-menu-icon note-bubble-icon';
            bubbleButton.innerHTML = '‚óè';
            bubbleButton.draggable = true;
            bubbleButton.id = `bubble-${noteId}`;
            bubbleButton.title = "Arrastrar al calendario para asignar fecha";
            bubbleButton.style.display = noteData.assignedDate ? 'none' : 'inline-block'; // Mostrar si no est√° asignada
            bubbleButton.addEventListener('dragstart', handleBubbleDragStart);
            bubbleButton.addEventListener('click', (e) => { e.stopPropagation(); showCalendarWidget(); }); // Abrir calendario al hacer clic tambi√©n

            const menuActions = document.createElement('div');
            menuActions.className = 'note-menu-actions';

            const editButton = document.createElement('button');
            editButton.className = 'note-menu-icon'; editButton.innerHTML = '‚úé'; editButton.title = "Editar";
            editButton.addEventListener('click', (e) => { e.stopPropagation(); startNoteEdit(card, noteId, noteData, menuActions, editButton, deleteButton); });

            const deleteButton = document.createElement('button');
            deleteButton.className = 'note-menu-icon'; deleteButton.innerHTML = '‚úñ'; deleteButton.title = "Eliminar";
            deleteButton.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteNote(noteId, gridItem); });

            menuActions.appendChild(editButton);
            menuActions.appendChild(deleteButton);
            menuBar.appendChild(bubbleButton); // Burbuja a la izquierda
            menuBar.appendChild(menuActions);  // Acciones a la derecha
            card.appendChild(menuBar);         // Men√∫ al final de la tarjeta

            // --- Ensamblar ---
            gridContent.appendChild(card);
            gridItem.appendChild(gridContent);

            // --- Posici√≥n para GridStack ---
            const position = {
                x: typeof noteData.x === 'number' ? noteData.x : undefined,
                y: typeof noteData.y === 'number' ? noteData.y : undefined,
                w: noteData.w || 6, // Ancho por defecto (6 de 24 columnas = 1/4)
                // h: notaData.h || 4, // Dejar que la altura se ajuste por cellHeight fijo
                id: noteId, // ID para GridStack
                autoPosition: (noteData.x === undefined || noteData.y === undefined) // Auto-posicionar si no hay coords
            };

            gridItem.docData = { ...notaData }; // Guardar copia de datos en el elemento

            console.log(`   -> Widget HTML creado para ${noteId}`);
            return { element: gridItem, position: position };
        }

        /** Actualiza el contenido visual de una nota existente */
        function updateNoteCardContent(widgetElement, newData, oldData) {
            const noteId = widgetElement.getAttribute('data-note-id');
            console.log(`   -> Actualizando contenido visual de ${noteId}`);

            const cardElement = widgetElement.querySelector('.note-card');
            if (!cardElement) return; // No deber√≠a pasar

            const isImageNote = !!newData.url;
            const newText = isImageNote ? (newData.texto || '') : (newData.nota || '');
            const oldText = isImageNote ? (oldData.texto || '') : (oldData.nota || '');

            // Actualizar imagen si cambi√≥ la URL
            if (isImageNote && newData.url !== oldData.url) {
                const imgContainer = cardElement.querySelector('.note-image-container');
                const img = imgContainer?.querySelector('img');
                if (img) img.src = newData.url; // onerror se encargar√° si falla
                console.log(`      - URL de imagen actualizada para ${noteId}`);
            }

            // Actualizar/A√±adir/Quitar texto
            let noteContentElement = cardElement.querySelector('.note-text-content');
            // Si no est√° en modo edici√≥n (no hay textarea)
            if (!cardElement.querySelector('textarea')) {
                if (newText && !noteContentElement) { // A√±adir div de texto si no exist√≠a
                    noteContentElement = document.createElement('div');
                    noteContentElement.className = 'note-text-content';
                    cardElement.insertBefore(noteContentElement, cardElement.querySelector('.note-menu-bar'));
                    console.log(`      - Div de texto a√±adido para ${noteId}`);
                } else if (!newText && noteContentElement) { // Quitar div de texto si ahora est√° vac√≠o
                    noteContentElement.remove();
                    noteContentElement = null; // Asegurar que no se use despu√©s
                    console.log(`      - Div de texto eliminado para ${noteId}`);
                }

                // Actualizar contenido del texto si existe y cambi√≥
                if (noteContentElement && newText !== oldText) {
                    noteContentElement.innerHTML = linkify(newText);
                    Array.from(noteContentElement.getElementsByTagName('a')).forEach(link => {
                        link.target = '_blank'; link.rel = 'noopener noreferrer';
                    });
                    console.log(`      - Contenido de texto actualizado para ${noteId}`);
                }
            }

            // Actualizar visibilidad de la burbuja
            const bubbleButton = cardElement.querySelector(`#bubble-${noteId}`);
            if (bubbleButton) {
                const shouldShow = !newData.assignedDate;
                bubbleButton.style.display = shouldShow ? 'inline-block' : 'none';
            }

            // Cancelar edici√≥n si estaba activa (la fuente de verdad es Firestore)
            const saveButton = cardElement.querySelector('.note-menu-icon[title="Guardar"]');
             if (saveButton) {
                 console.log(`      - Cancelando edici√≥n local de ${noteId} por modificaci√≥n externa.`);
                 const menuActionsContainer = cardElement.querySelector('.note-menu-actions');
                 // Restaurar botones originales
                 if (menuActionsContainer) {
                     menuActionsContainer.innerHTML = ''; // Limpiar (Save/Cancel)
                     const editButton = document.createElement('button'); /*...*/
                     const deleteButton = document.createElement('button'); /*...*/
                     // Recrear botones y sus listeners (c√≥digo similar a crearWidgetNota)
                     editButton.className = 'note-menu-icon'; editButton.innerHTML = '‚úé'; editButton.title = "Editar";
                     deleteButton.className = 'note-menu-icon'; deleteButton.innerHTML = '‚úñ'; deleteButton.title = "Eliminar";
                     editButton.addEventListener('click', (e) => { e.stopPropagation(); startNoteEdit(cardElement, noteId, newData, menuActionsContainer, editButton, deleteButton); });
                     deleteButton.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteNote(noteId, widgetElement); });
                     menuActionsContainer.appendChild(editButton);
                     menuActionsContainer.appendChild(deleteButton);
                 }
                 // Restaurar contenido visual (ya hecho arriba al actualizar texto)
             }

            // Actualizar datos cacheados en el elemento
            widgetElement.docData = { ...newData };
        }

        /** Inicia la edici√≥n del texto de una nota */
        function startNoteEdit(cardElement, noteId, notaData, menuActionsContainer, editButton, deleteButton) {
            console.log(`Iniciando edici√≥n para ${noteId}`);
            let targetElement = cardElement.querySelector('.note-text-content');
            const isImageNote = !!notaData.url;

            // Crear div de texto si no existe (para notas de imagen sin texto previo)
            if (isImageNote && !targetElement) {
                targetElement = document.createElement('div');
                targetElement.className = 'note-text-content';
                cardElement.insertBefore(targetElement, menuActionsContainer.parentElement); // Insertar antes del men√∫
            } else if (!targetElement) {
                console.error("Error: No se encontr√≥ d√≥nde editar el texto:", noteId);
                showErrorMessage("Error al intentar editar.");
                return;
            }

            const currentText = isImageNote ? (notaData.texto || '') : (notaData.nota || '');

            // Guardar el contenido original por si se cancela
            const originalHTML = targetElement.innerHTML;

            // Crear Textarea
            targetElement.innerHTML = ''; // Limpiar
            const editInput = document.createElement('textarea');
            editInput.value = currentText;
            editInput.style.cssText = `width: 100%; min-height: 80px; height: auto; box-sizing: border-box; border: 1px dashed #ccc; padding: 8px; resize: vertical; font-family: inherit; font-size: inherit; line-height: inherit; margin-bottom: 10px;`; // Estilo inline simple
            targetElement.appendChild(editInput);
            autoResizeTextarea(editInput); // Ajustar altura inicial
            editInput.addEventListener('input', () => autoResizeTextarea(editInput));
            editInput.focus();

            // Crear botones Guardar/Cancelar
            const saveEditButton = document.createElement('button');
            saveEditButton.className = 'note-menu-icon'; saveEditButton.innerHTML = 'üíæ'; saveEditButton.title = "Guardar";
            saveEditButton.onclick = async (e) => {
                e.stopPropagation();
                const newText = editInput.value.trim();
                const fieldToUpdate = isImageNote ? 'texto' : 'nota';
                let updateData = {};

                // Para notas de texto, no permitir guardar vac√≠o
                if (!isImageNote && !newText) {
                    showErrorMessage("La nota de texto no puede estar vac√≠a.");
                    editInput.focus();
                    return;
                }

                // Si el texto est√° vac√≠o en nota de imagen, eliminar el campo 'texto'
                if (isImageNote && !newText) {
                    updateData['texto'] = firebase.firestore.FieldValue.delete();
                } else {
                    updateData[fieldToUpdate] = newText;
                }

                // Deshabilitar botones
                saveEditButton.disabled = true; cancelEditButton.disabled = true; saveEditButton.innerHTML = '‚è≥';

                const success = await updateNoteInFirestore(noteId, updateData);

                // Si fall√≥, Firestore ya mostr√≥ error. Restaurar UI aqu√≠.
                if (!success) {
                    targetElement.innerHTML = originalHTML; // Restaurar contenido
                    menuActionsContainer.innerHTML = ''; // Limpiar botones Guardar/Cancelar
                    menuActionsContainer.appendChild(editButton); // Restaurar Editar
                    menuActionsContainer.appendChild(deleteButton); // Restaurar Eliminar
                }
                // Si tuvo √©xito, el listener de Firestore actualizar√° la UI.
                // No es necesario restaurar botones aqu√≠.
            };

            const cancelEditButton = document.createElement('button');
            cancelEditButton.className = 'note-menu-icon'; cancelEditButton.innerHTML = '‚Ü©Ô∏è'; cancelEditButton.title = "Cancelar";
            cancelEditButton.onclick = (e) => {
                e.stopPropagation();
                targetElement.innerHTML = originalHTML; // Restaurar contenido
                menuActionsContainer.innerHTML = ''; // Limpiar botones Guardar/Cancelar
                menuActionsContainer.appendChild(editButton); // Restaurar Editar
                menuActionsContainer.appendChild(deleteButton); // Restaurar Eliminar
            };

            // Reemplazar botones Editar/Eliminar con Guardar/Cancelar
            menuActionsContainer.innerHTML = '';
            menuActionsContainer.appendChild(saveEditButton);
            menuActionsContainer.appendChild(cancelEditButton);
        }

        /**************************************************************************
         * MANEJO DE EVENTOS (GridStack, Botones, Modales, Calendario)
         **************************************************************************/

        /** Maneja el evento 'change' de GridStack (guardar posici√≥n) */
        function handleGridChange(event, items) {
            console.log(`GridStack 'change': ${items?.length || 0} items cambiaron.`);
            items?.forEach(item => {
                const noteId = item.el?.getAttribute('data-note-id');
                // Solo guardar si tenemos ID y coordenadas v√°lidas
                if (noteId && typeof item.x === 'number' && typeof item.y === 'number') {
                    updateNotePosition(noteId, item.x, item.y);
                }
            });
        }

        /** Maneja el evento 'dragstop' de GridStack (solo para log) */
        function handleGridDragStop(event, element) {
            const node = grid.engine.nodes.find(n => n.el === element);
            if (node) {
                const noteId = node.el?.getAttribute('data-note-id') || node.id || '?';
                console.log(`GridStack 'dragstop': ${noteId} soltado en (${node.x},${node.y})`);
            }
        }

        /** Maneja el clic en el bot√≥n Eliminar Nota */
        function handleDeleteNote(noteId, gridItemElement) {
            // La confirmaci√≥n ya est√° en el listener del bot√≥n
            console.log(`Solicitando eliminar nota ${noteId}`);
            const deleteButton = gridItemElement?.querySelector('.note-menu-icon[title="Eliminar"]');
            if (deleteButton) deleteButton.disabled = true; // Deshabilitar mientras se procesa

            deleteNoteFromFirestore(noteId).then(success => {
                if (!success && deleteButton) {
                    deleteButton.disabled = false; // Rehabilitar si fall√≥
                }
                // Si tiene √©xito, el listener 'removed' de Firestore quitar√° el widget
            });
        }

        /** Maneja el inicio de arrastre de la burbuja de calendario */
        function handleBubbleDragStart(event) {
            const noteId = event.target.id.replace('bubble-', '');
            console.log(`Arrastrando burbuja para nota ${noteId}`);
            // Usar imagen fantasma transparente
            var imgGhost = new Image();
            imgGhost.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
            event.dataTransfer.setDragImage(imgGhost, 0, 0);
            event.dataTransfer.setData("application/note-id", noteId);
            event.dataTransfer.effectAllowed = "move";
            showCalendarWidget(); // Mostrar calendario al arrastrar
        }

        /** Maneja el evento 'drop' en una fecha del calendario */
        async function handleCalendarDateDrop(event) {
            event.preventDefault();
            const targetCell = event.target.closest('.calendar-date');
            if (!targetCell) return;

            targetCell.classList.remove('drag-over');
            const noteId = event.dataTransfer.getData("application/note-id");
            const dateString = targetCell.dataset.date; // Espera formato "d/m/yyyy"

            if (noteId && dateString) {
                console.log(`Nota ${noteId} soltada en fecha ${dateString}`);
                const success = await assignDateToNote(noteId, dateString);
                // Si tiene √©xito, el listener de Firestore ('modified') actualizar√° la UI
                // (ocultar√° burbuja, regenerar√° calendario si es necesario)
            }
        }

        /** Muestra el modal de opciones (Texto/Imagen) */
        function showAddOptionsModal() {
            console.log("Mostrando modal de opciones...");
            currentNoteTypeToAdd = null; // Resetear tipo
            showModal(addNoteOptionsModalElement);
        }

        /** Muestra el modal de input seg√∫n el tipo elegido */
        function showInputModal(type) { // type = 'text' o 'image'
            console.log(`Mostrando modal de input para tipo: ${type}`);
            currentNoteTypeToAdd = type;

            // Ocultar modal de opciones
            hideModal(addNoteOptionsModalElement, false); // No ocultar overlay a√∫n

            // Configurar y mostrar modal de input
            if (type === 'image') {
                noteInputTitleElement.textContent = "A√±adir Imagen desde Link";
                imageInputAreaElement.style.display = 'block';
                textInputAreaElement.style.display = 'none';
                imageLinkInputElement.value = ''; // Limpiar campos
                imageNoteTextInputElement.value = '';
                autoResizeTextarea(imageNoteTextInputElement);
            } else { // 'text'
                noteInputTitleElement.textContent = "A√±adir Nota de Texto";
                imageInputAreaElement.style.display = 'none';
                textInputAreaElement.style.display = 'block';
                textNoteInputElement.value = ''; // Limpiar campo
                autoResizeTextarea(textNoteInputElement);
            }
            saveNoteButtonElement.disabled = false; // Habilitar bot√≥n guardar
            saveNoteButtonElement.textContent = 'Guardar';
            showModal(noteInputModalElement, true); // Mostrar input modal y overlay si no estaba
        }

        /** Maneja el guardado desde el modal de input */
        async function handleSaveNote() {
            if (!currentNoteTypeToAdd) return;

            saveNoteButtonElement.disabled = true;
            saveNoteButtonElement.textContent = 'Guardando...';

            let noteData = { tipo: currentNoteTypeToAdd };
            let isValid = false;

            if (currentNoteTypeToAdd === 'image') {
                const url = imageLinkInputElement.value.trim();
                const texto = imageNoteTextInputElement.value.trim();
                if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                    noteData.url = url;
                    if (texto) noteData.texto = texto;
                    isValid = true;
                } else {
                    showErrorMessage("Por favor, introduce un link de imagen v√°lido (http:// o https://).");
                    imageLinkInputElement.focus();
                }
            } else { // 'text'
                const nota = textNoteInputElement.value.trim();
                if (nota) {
                    noteData.nota = nota;
                    isValid = true;
                } else {
                    showErrorMessage("Por favor, escribe algo en la nota.");
                    textNoteInputElement.focus();
                }
            }

            if (isValid) {
                const newNoteId = await addNoteToFirestore(noteData);
                if (newNoteId) {
                    hideAllModals(); // Cerrar todo si se guard√≥ bien
                } else {
                    // Si fall√≥, Firestore ya mostr√≥ error, solo rehabilitar bot√≥n
                    saveNoteButtonElement.disabled = false;
                    saveNoteButtonElement.textContent = 'Guardar';
                }
            } else {
                // Si no es v√°lido, rehabilitar bot√≥n
                saveNoteButtonElement.disabled = false;
                saveNoteButtonElement.textContent = 'Guardar';
            }
        }

        /** Funci√≥n gen√©rica para mostrar un modal y el overlay */
        function showModal(modalElement, showOverlay = true) {
            if (!modalElement) return;
            if (showOverlay && modalOverlayElement) {
                modalOverlayElement.classList.add('visible');
            }
            modalElement.classList.add('visible');
        }

        /** Funci√≥n gen√©rica para ocultar un modal */
        function hideModal(modalElement, hideOverlay = true) {
            if (!modalElement) return;
            modalElement.classList.remove('visible');
            if (hideOverlay && modalOverlayElement) {
                modalOverlayElement.classList.remove('visible');
            }
        }

        /** Oculta todos los modales abiertos */
        function hideAllModals() {
            hideModal(addNoteOptionsModalElement, false); // Ocultar sin quitar overlay a√∫n
            hideModal(noteInputModalElement, true);      // Ocultar y quitar overlay
            currentNoteTypeToAdd = null; // Resetear
        }

        /** Muestra el widget del calendario */
        function showCalendarWidget() {
            if (!calendarWidgetElement) return;
            if (!calendarWidgetElement.classList.contains('visible')) {
                // Generar contenido si es la primera vez o si necesita actualizarse
                if (currentCalendarMonth === undefined || currentCalendarYear === undefined) {
                    const { month, year } = initCalendarDate();
                    renderCalendar(month, year);
                } else {
                    // Podr√≠amos forzar recarga de datos aqu√≠ si fuera necesario
                     fetchAllAssignedNotes().then(() => {
                         renderCalendar(currentCalendarMonth, currentCalendarYear);
                     });
                }
                calendarWidgetElement.classList.add('visible');
            }
             // Cancelar timeout de ocultaci√≥n si existe
            clearTimeout(calendarWidgetElement.hideTimeout);
        }

        /** Oculta el widget del calendario con un retraso */
        function hideCalendarWidget() {
             if (!calendarWidgetElement) return;
             // Iniciar timeout para ocultar
             calendarWidgetElement.hideTimeout = setTimeout(() => {
                 calendarWidgetElement.classList.remove('visible');
             }, 300); // 300ms de retraso
        }

        /** Muestra un mensaje de error simple (reemplaza alert) */
        function showErrorMessage(message) {
            // Implementaci√≥n simple con alert por ahora, podr√≠a mejorarse con un div de notificaci√≥n
            console.error("Error para el usuario:", message);
            alert(message);
        }

        /**************************************************************************
         * L√ìGICA DEL CALENDARIO
         **************************************************************************/

        /** Obtiene la fecha actual en Chile */
        function getChileDate() {
            try {
                const opts = { timeZone: 'America/Santiago', year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false };
                const fmt = new Intl.DateTimeFormat('en-CA', opts);
                const parts = fmt.formatToParts(new Date());
                const d = {}; parts.forEach(({ type, value }) => { if (['year', 'month', 'day', 'hour', 'minute', 'second'].includes(type)) { d[type] = parseInt(value, 10); } });
                return new Date(Date.UTC(d.year, d.month - 1, d.day, d.hour, d.minute, d.second));
            } catch (e) { console.warn("Intl fallback", e); return new Date(); }
        }

        /** Determina mes/a√±o inicial del calendario */
        function initCalendarDate() {
            let today = getChileDate(); let year = today.getFullYear(); let month = today.getMonth();
            const minYear = 2024; const minMonth = 11; // Diciembre (0-indexed)
            if (year < minYear || (year === minYear && month < minMonth)) { return { month: minMonth, year: minYear }; }
            return { month, year };
        }

        /** Devuelve nombre del mes */
        function getMonthName(monthIndex) {
            const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            return months[monthIndex % 12] || '';
        }

        /** Genera el HTML del calendario */
        function renderCalendar(month, year) {
            if (!calendarWidgetElement) { console.error("calendarWidget no encontrado."); return; }
            console.log(`Renderizando calendario para ${month + 1}/${year}`);
            calendarWidgetElement.innerHTML = ''; // Limpiar

            const today = getChileDate();
            const currentMonthStr = `${getMonthName(month)} ${year}`;

            // --- Cabecera ---
            const header = document.createElement('div'); header.className = 'calendar-header';
            const prevButton = document.createElement('button'); prevButton.innerHTML = '&lt;'; prevButton.title = "Mes anterior";
            const nextButton = document.createElement('button'); nextButton.innerHTML = '&gt;'; nextButton.title = "Mes siguiente";
            const title = document.createElement('span'); title.textContent = currentMonthStr;
            const minCalYear = 2024; const minCalMonth = 11; // Dic 2024
            if (year === minCalYear && month === minCalMonth) { prevButton.disabled = true; }
            else { prevButton.onclick = () => renderCalendar(month === 0 ? 11 : month - 1, month === 0 ? year - 1 : year); }
            nextButton.onclick = () => renderCalendar(month === 11 ? 0 : month + 1, month === 11 ? year + 1 : year);
            header.appendChild(prevButton); header.appendChild(title); header.appendChild(nextButton);
            calendarWidgetElement.appendChild(header);

            // --- D√≠as Semana ---
            const daysHeader = document.createElement('div'); daysHeader.className = 'calendar-days-header';
            ['Do','Lu','Ma','Mi','Ju','Vi','S√°'].forEach(day => { const d = document.createElement('div'); d.className = 'calendar-day'; d.textContent = day; daysHeader.appendChild(d); });
            calendarWidgetElement.appendChild(daysHeader);

            // --- Grid Fechas ---
            const datesGrid = document.createElement('div'); datesGrid.className = 'calendar-dates-grid';
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Dom, 6=Sab
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Celdas vac√≠as iniciales
            for (let i = 0; i < firstDayOfMonth; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesGrid.appendChild(e); }

            // Celdas de d√≠as
            for (let date = 1; date <= daysInMonth; date++) {
                const dateCell = document.createElement('div');
                dateCell.className = 'calendar-date';
                dateCell.textContent = date;
                const dateString = `${date}/${month + 1}/${year}`; // Formato clave "d/m/yyyy"
                dateCell.dataset.date = dateString; // Guardar fecha en data attribute

                // Marcar hoy
                if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) { dateCell.classList.add('today'); }

                // A√±adir burbujas
                if (assignedDatesCache[dateString]) {
                    assignedDatesCache[dateString].forEach(noteId => {
                        const bubble = document.createElement("span");
                        bubble.className = "assigned-bubble";
                        bubble.setAttribute("data-note", noteId);
                        bubble.textContent = "‚óè";
                        const noteInfo = notesDataCache[noteId];
                        if (noteInfo) { bubble.title = noteInfo.url ? (noteInfo.texto || 'Imagen') : (noteInfo.nota || 'Nota'); }
                        dateCell.appendChild(bubble);
                    });
                }

                // Listeners Drag & Drop
                dateCell.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; dateCell.classList.add('drag-over'); });
                dateCell.addEventListener('dragleave', (e) => { dateCell.classList.remove('drag-over'); });
                dateCell.addEventListener('drop', handleCalendarDateDrop); // Funci√≥n separada

                datesGrid.appendChild(dateCell);
            }

            // Celdas vac√≠as finales
            const totalCells = firstDayOfMonth + daysInMonth;
            const cellsNeeded = totalCells <= 35 ? 35 : (totalCells <= 42 ? 42 : 49); // Ajustar a 5, 6 o 7 filas
            for (let i = totalCells; i < cellsNeeded; i++) { const e = document.createElement('div'); e.className = 'calendar-date empty'; datesGrid.appendChild(e); }

            calendarWidgetElement.appendChild(datesGrid);

            // Actualizar estado global
            currentCalendarMonth = month;
            currentCalendarYear = year;
        }


        /**************************************************************************
         * LISTENER PRINCIPAL (Firestore Realtime Updates)
         **************************************************************************/

        /** Procesa los cambios recibidos de Firestore */
        function handleFirestoreSnapshot(snapshot) {
            console.log(`Firestore Snapshot: Cambios=${snapshot.docChanges().length}, Docs=${snapshot.size}`);
            if (!grid) { console.error("GridStack no disponible en Snapshot."); return; }

            let needsCalendarUpdate = false;

            snapshot.docChanges().forEach((change) => {
                const noteId = change.doc.id;
                const notaData = change.doc.data();
                const changeType = change.type;
                console.log(`  -> Procesando: ${changeType}, ID=${noteId}`);

                const widgetElement = grid.engine.nodes.find(n => n.id === noteId)?.el;

                try {
                    switch (changeType) {
                        case "added":
                            // A√±adir a cach√© local
                            notesDataCache[noteId] = { ...notaData };
                            if (notaData.assignedDate) needsCalendarUpdate = true;

                            if (!widgetElement) { // Si no existe visualmente, a√±adirlo
                                console.log(`    A√±adiendo widget ${noteId} al grid`);
                                const result = renderNoteCard(change.doc);
                                if (result) {
                                     // Doble check por si se a√±adi√≥ entretanto
                                    if (!grid.engine.nodes.find(n => n.id === noteId)) {
                                        grid.addWidget(result.element, result.position);
                                        console.log(`    ‚úÖ Widget ${noteId} a√±adido.`);
                                    } else { console.warn(`    Widget ${noteId} ya exist√≠a (added).`); }
                                } else { console.warn(`    Widget ${noteId} no renderizado (datos?).`); }
                            } else { // Si ya exist√≠a (quiz√°s por carga inicial + listener)
                                console.log(`    Widget ${noteId} ya exist√≠a (added). Actualizando.`);
                                updateNoteCardContent(widgetElement, notaData, widgetElement.docData || {});
                            }
                            break;

                        case "modified":
                            const oldData = { ...(notesDataCache[noteId] || {}) }; // Copia de datos viejos
                            // Actualizar cach√© local
                            notesDataCache[noteId] = { ...notaData };
                            // Marcar para actualizar calendario si cambi√≥ la fecha
                            if (notaData.assignedDate !== oldData.assignedDate) needsCalendarUpdate = true;

                            if (widgetElement) { // Si existe visualmente, actualizarlo
                                console.log(`    Modificando widget ${noteId}`);
                                updateNoteCardContent(widgetElement, notaData, oldData);
                            } else { // Si no existe (raro), intentar a√±adirlo
                                console.warn(`    'modified' para ${noteId} no encontrado. A√±adiendo...`);
                                const result = renderNoteCard(change.doc);
                                if (result && !grid.engine.nodes.find(n => n.id === noteId)) {
                                    grid.addWidget(result.element, result.position);
                                    console.log(`    ‚úÖ Widget ${noteId} (mod) a√±adido.`);
                                }
                            }
                            break;

                        case "removed":
                            const wasAssigned = !!notesDataCache[noteId]?.assignedDate;
                            // Eliminar de cach√© local
                            delete notesDataCache[noteId];
                            if (wasAssigned) needsCalendarUpdate = true; // Marcar si estaba asignada

                            if (widgetElement) { // Si existe visualmente, quitarlo
                                console.log(`    Eliminando widget ${noteId} del grid`);
                                try {
                                    grid.removeWidget(widgetElement, false); // false = no disparar 'change'
                                    console.log(`    ‚úÖ Widget ${noteId} eliminado.`);
                                } catch (removeError) { console.warn(`    ‚ö†Ô∏è Error leve al eliminar ${noteId}:`, removeError); }
                            } else { console.log(`    Widget ${noteId} (rem) no encontrado.`); }
                            // Quitar burbujas del calendario (por si acaso)
                            document.querySelectorAll(`.assigned-bubble[data-note='${noteId}']`).forEach(b => b.remove());
                            break;
                    } // Fin switch
                } catch (widgetError) {
                     console.error(`‚ùå Error procesando ${changeType} para ${noteId}:`, widgetError);
                }
            }); // Fin forEach

            // Actualizar calendario si hubo cambios relevantes
            if (needsCalendarUpdate) {
                console.log("Actualizaci√≥n de calendario necesaria.");
                fetchAllAssignedNotes().then(() => {
                    if (currentCalendarMonth !== undefined) { // Solo si ya se mostr√≥ alguna vez
                        renderCalendar(currentCalendarMonth, currentCalendarYear);
                    }
                });
            }
            console.log("Snapshot procesado.");
        } // Fin handleFirestoreSnapshot

        /** Adjunta el listener de Firestore */
        function attachFirestoreListener() {
            if (!db || !grid) {
                console.error("No se puede adjuntar listener: DB o GridStack no inicializados.");
                return;
            }
            console.log("Adjuntando listener a Firestore...");
            db.collection('notas')
              .orderBy('createdAt', 'desc') // Ordenar ayuda a la consistencia
              .onSnapshot(handleFirestoreSnapshot, (error) => {
                  console.error("Error en listener de Firestore:", error);
                  showErrorMessage("Error al sincronizar notas. Revisa consola y reglas Firestore.");
              });
        }

        /**************************************************************************
         * SETUP INICIAL y EVENT LISTENERS UI
         **************************************************************************/

        /** Funci√≥n principal que se ejecuta al cargar la p√°gina */
        function main() {
            console.log("Ejecutando main()...");
            if (!initializeFirebase()) return; // Salir si Firebase falla
            if (!initializeGridstack()) return; // Salir si GridStack falla

            // --- Listeners de UI ---
            // Bot√≥n (+)
            addNoteFabElement?.addEventListener('click', showAddOptionsModal);

            // Overlay (cerrar modales)
            modalOverlayElement?.addEventListener('click', hideAllModals);

            // Opciones del modal A√±adir (Texto/Imagen)
            addNoteOptionsModalElement?.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    const type = event.currentTarget.dataset.type; // 'text' o 'image'
                    if (type) showInputModal(type);
                });
            });

            // Botones del modal de Input
            cancelInputButtonElement?.addEventListener('click', hideAllModals);
            saveNoteButtonElement?.addEventListener('click', handleSaveNote);

            // Calendario (Icono y Widget)
            calendarIconElement?.addEventListener('mouseenter', showCalendarWidget);
            calendarIconElement?.addEventListener('mouseleave', hideCalendarWidget);
            calendarIconElement?.addEventListener('click', showCalendarWidget); // Tambi√©n al hacer clic
            calendarWidgetElement?.addEventListener('mouseenter', () => clearTimeout(calendarWidgetElement.hideTimeout)); // Mantener abierto
            calendarWidgetElement?.addEventListener('mouseleave', hideCalendarWidget); // Ocultar al salir

            // Cargar datos iniciales y empezar a escuchar
            fetchAllAssignedNotes().then(() => { // Cargar fechas primero
                 attachFirestoreListener(); // Empezar a escuchar cambios en notas
            });

            console.log("Setup inicial completado.");
        }

        // --- Ejecutar main cuando el DOM est√© listo ---
        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>
